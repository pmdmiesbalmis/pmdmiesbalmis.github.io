<!DOCTYPE html><html><head>
      <title>Subir im√°genes a Azure usando SDK o ApiRest</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.markdown-preview.markdown-preview .caso_estudio {
  background-color: #f5f5f5;
  border: 2px solid #969696;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .ejercicio {
  background-color: #f5faf5;
  border: 2px solid #969b96;
  padding-left: 15px;
  padding-right: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.markdown-preview.markdown-preview .fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.markdown-preview.markdown-preview .cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.markdown-preview.markdown-preview .abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.markdown-preview.markdown-preview .cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.markdown-preview.markdown-preview .autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
.markdown-preview.markdown-preview .flotante {
  display: flex;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: center;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: space-between;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: row;
  }
}
.markdown-preview.markdown-preview .flotante_izq {
  margin-right: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: auto;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: auto;
  }
}
.markdown-preview.markdown-preview .galeria_imagenes {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: row;
  }
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="subir-im√°genes-a-azure-usando-sdk-o-apirest">Subir im√°genes a Azure usando SDK o Apirest </h1>
<p>Descargar estos apuntes <a href="./anexo_subir_imagenes_azure.pdf">pdf</a> o <a href="./anexo_subir_imagenes_azure.html">html</a></p>
<h2 id="√≠ndice">√çndice </h2>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#subir-im√°genes-a-azure-usando-sdk-o-apirest" class="md-toc-link"><p>Subir im√°genes a Azure usando SDK o Apirest</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#crear-un-contenedor-para-las-im√°genes-en-el-portal-de-azure" class="md-toc-link">
            <p>Crear un contenedor para las im√°genes en el portal de Azure</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#subir-las-im√°genes-a-azure" class="md-toc-link"><p>Subir las im√°genes a Azure</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#usando-apirest" class="md-toc-link">
            <p>Usando ApiRest</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#usando-el-sdk" class="md-toc-link">
            <p>Usando el SDK</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 id="crear-un-contenedor-para-las-im√°genes-en-el-portal-de-azure">Crear un contenedor para las im√°genes en el portal de Azure </h2>
<p>Antes de codificar en la App lo necesario para subir las im√°genes al servidor, deberemos de preparar este para que pueda contener estos archivos. Para ello tendremos que entrar en el portar de Azures con la cuenta de Microsoft de alumno, y crear una cuenta de almacenamiento donde se alojen las im√°genes, los pasos para hacerlo ser√°n los siguientes.</p>
<ol>
<li>Iniciar sesi√≥n en el <a href="https://azure.microsoft.com/es-es/get-started/azure-portal/">Portal de Azure</a>, con la cuenta de alumno @alu.edu.gva.es</li>
<li>Una vez dentro localizar entre los servicios, la <strong>Cuenta de almacenamiento</strong>(pod√©is realizar una b√∫squeda)</li>
</ol>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen1.png">
</div>
<p>Dentro del nives Cuenta de almacenamiento se pulsa en <strong>Crear</strong> para acceder a los pasos para crear el almacenamiento</p>
<div class="galeria_imagenes">
    <img height="200" src="./assets/imagenes/imagen2_1.png">
</div>
<p>Pasaremos a la siguiente ventana, donde Azure nos pedir√° a√±adir el recurso que vamos a crear a un Grupo de recursos, si no tenemos ninguno o queremos a√±adirlo en uno nuevo, deberemos pulsar en <strong>Crear nuevo</strong> y a√±adir el nombre que queramos dar al grupo de recursos. Tambi√©n habr√° que rellenar el nombre de la cuenta de almacenamiento, indicar que el Servicio principal es Azure Blob Storage o ...<br>
y dejar el resto de elementos del formulario como se ven en la captura de ventana inferior.</p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen2.png">
</div>
<p>Despu√©s pulsaremos sobre el bot√≥n <strong>Siguiente</strong> para avanzar a la siguiente ventana. Que nos llevar√° a la pesta√±a de Avanzado y en la que deberemos activar <strong>Permitir acceso</strong> an√≥nimo, <strong>Habilitar el acceso a las claves</strong> y indicar que el √Åmbito esta permitido desde cualquier cuenta de almacenamiento. F√≠jate en la captura para dar los permisos necesarios, ya que despu√©s de la creaci√≥n de la cuenta de almacenamiento, no se pueden modificar algunas de las opciones.</p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen4.png">
</div>
<p>Ahora ya se puede saltar al √∫ltimo paso el de <strong>Revisar y crear</strong>, que pasar√° a la √∫ltima pesta√±a donde podremos ver un resumen de las selecciones elegidas y al pulsar <strong>Crear</strong> pasar√° a crear el recurso.</p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen5.png">
</div>
<p>Una vez creado, podremos verlo en los recursos de Inicio, o podemos pulsar sobre <strong>ir a recurso</strong> para acceder de forma directa.</p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen6.png">
</div>
<p>Dentro de la cuenta de almacenamiento, deberemos crear un contenedor para poder a√±adir el contenido en este. Para crear el contenedor sobre el formulario de <strong>Contenedores</strong> solo habr√° que pulsar sobre el s√≠mbolo + que est√° rodeado en la imagen. A√±adir un nombre al contenedor y muy importante, seleccionar el <strong>nivel de acceso Contenedor</strong></p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen7.png">
 </div>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td>
<div align="center">
    <img height="250" src="./assets/imagenes/imagen8.png">
</div>
</td>
<td>
<div align="center">
    <img height="250" src="./assets/imagenes/imagen9.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<p>Una vez hecho esto tendremos todos los pasos completados y podremos seleccionar el contenedor creado para a√±adir directamente contenido o gestionar el contenido subido desde la App.</p>
<h2 id="subir-las-im√°genes-a-azure">Subir las im√°genes a Azure </h2>
<p>Para subir las im√°genes al contenedor que hemos creado en la cuenta de almacenamiento de Azure, podemos elegir entre las siguientes dos t√©cnicas, accediendo al ApiRest que Azure dispone para ello o usando los m√©todos del Azure SDK.</p>
<h3 id="usando-apirest">Usando ApiRest </h3>
<p>Si usamos Apirest, tendremos que crear una interface para el servicio de im√°genes, como la siguiente:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ImageService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@PUT</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">subirImagen</span><span class="token punctuation">(</span>
        <span class="token comment">// La URL completa del Blob Storage con SAS Token</span>
        <span class="token annotation builtin">@Url</span> url<span class="token operator">:</span> String<span class="token punctuation">,</span> 
        <span class="token comment">//Pasamos la imagen en el Body como stream</span>
        <span class="token annotation builtin">@Body</span> requestBody<span class="token operator">:</span> RequestBody<span class="token punctuation">,</span> 
        <span class="token comment">//Indicamos a Azure que tipo de elemento se est√° subiendo, </span>
        <span class="token comment">//BlockBlob es el m√°s com√∫n y sirve para im√°genes</span>
        <span class="token annotation builtin">@Header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"x-ms-blob-type"</span></span><span class="token punctuation">)</span> blobType<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>Siguiendo el patr√≥n usado en clase, deberemos a√±adir al AppModule el proveedor de Retrofit con la url que corresponda al contenedor donde estamos guardando las im√°genes.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code> <span class="token annotation builtin">@Provides</span>
 <span class="token annotation builtin">@Singleton</span>
 <span class="token comment">//Importante nombrar a este proveedor, para que el cliente sepa a que </span>
 <span class="token comment">//objeto Retrofit se est√° refiriendo ya que tendremos m√°s de uno, </span>
 <span class="token comment">//el de la BD y el de im√°genes</span>
 <span class="token annotation builtin">@Named</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"AzureRetrofit"</span></span><span class="token punctuation">)</span>
 <span class="token keyword keyword-fun">fun</span> <span class="token function">provideRetrofitAzure</span><span class="token punctuation">(</span>
     okHttpClient<span class="token operator">:</span> OkHttpClient
 <span class="token punctuation">)</span> <span class="token operator">:</span> Retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>okHttpClient<span class="token punctuation">)</span>
     <span class="token comment">//url de acceso a nuestro contenedor</span>
     <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"https://almacenimagenes.blob.core.windows.net/contenedor1/"</span></span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>La url la podemos conseguirla al acceder a una imagen del contenedor, aunque su formato es <strong><code>http://nombre_de_tu_cuenta.blob.core.windows.net/nombre_de_tu_contenedor/ </code></strong></p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen11.png">
</div>
<p>Adem√°s habr√° que a√±adir el proveedor para ImageService que relaciona el proveedor anterior con el ImageService para las peticiones a Azure</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token comment">//Con @Named se identifica el proveedor de Retrofit que corresponde, </span>
<span class="token comment">//el otro proveedor que tengamos tambi√©n se tendr√° </span>
<span class="token comment">//que identificar con @Named</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideImageService</span><span class="token punctuation">(</span><span class="token annotation builtin">@Named</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"AzureRetrofit"</span></span><span class="token punctuation">)</span>
     retrofit<span class="token operator">:</span> Retrofit
<span class="token punctuation">)</span> <span class="token operator">:</span> ImageService <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ImageService<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</code></pre><p>Tendremos que a√±adir una funci√≥n que acceda al m√©todo subirImagen de ImageService. Para poder hacer esto, tendremos que haberlo injectado anteriormente al constructor de la clase:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> ContactoServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoService<span class="token punctuation">,</span>
    <span class="token comment">//tambi√©n se injecta un objeto de ImageService</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> imageService<span class="token operator">:</span> ImageService
<span class="token punctuation">)</span> 
</code></pre><p>En la funci√≥n <strong>subirImagen</strong> seguiremos el mismo formato de todas las de las clases ServiceImplementation. Le pasaremos como par√°metro el nombre de la imagen y un RequestBody (stream de la imagen). Necesitaremos completar el nombre de la imagen con un SasToken que tendremos que recuperar del portal de azure. Para ello deberemos acceder a Token de acceso compartido del contenedor de nuestras imagenes, seleccionaremos los permisos marcados</p>
<div class="galeria_imagenes">
    <img height="" src="./assets/imagenes/imagen12.png">
</div>
<p>Configuraremos una fecha de vencimiento de nuestro token, seleccionaremos la zona de Bruselas, protocolo https y http y pulsaremos Generar Token, despu√©s de pulsar veremos que se mostrar√° una cadena que tendremos que copiar para a√±adirla al nombre de la imagen.</p>
<div class="galeria_imagenes">
    <img height="200" src="./assets/imagenes/imagen13.png">
</div>
<p>Al llamar a subirImagen, adem√°s del nombre con SasToken de la imagen, el stream de esta, tambi√©n habr√° que pasar el tipo de archivo que vamos a subir, en este caso <strong>BlockBlob</strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token comment">//SasToken recuperado de azure</span>
<span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> sasToken <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"sp=racwd***3D"</span></span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">subirImagen</span><span class="token punctuation">(</span>imagen<span class="token operator">:</span> String<span class="token punctuation">,</span> requestBody<span class="token operator">:</span> RequestBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> urlPartial <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">imagen</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">sasToken</span></span><span class="token string">"</span></span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se ha podido a√±adir la imagen"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//Llamada al m√©todo subirImagen de ImageService </span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span>
            imageService<span class="token punctuation">.</span><span class="token function">subirImagen</span><span class="token punctuation">(</span>urlPartial<span class="token punctuation">,</span> requestBody<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"BlockBlob"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (c√≥digo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><p>Tendremos que a√±adir una funci√≥n de suspensi√≥n en el Repository para que acceda a esta funci√≥n:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code> <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">subirImagen</span><span class="token punctuation">(</span>imagen<span class="token operator">:</span> String<span class="token punctuation">,</span> requestBody<span class="token operator">:</span> RequestBody<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            contactoService<span class="token punctuation">.</span><span class="token function">subirImagen</span><span class="token punctuation">(</span>imagen<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre><p>Y para finalizar en el ViewModel habr√° que llamar a la funci√≥n del repository pasando toda la informaci√≥n que necesita. Suponemos un evento de selecci√≥n de im√°genes dentro del ViewModel y que le asigna el nombre de la imagen a un contacto, adem√°s de actualizar el contacto en la BD y llamar al m√©todo de subirImagen anterior:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-fun">fun</span> <span class="token function">onContactoEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> ContactoEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-is">is</span> ContactoEvent<span class="token punctuation">.</span>OnChangeFoto <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//En el evento nos llegar√° el BitMap que habremos conseguido con el acceso a la c√°mara </span>
<span class="token comment">//o con selecci√≥n desde galer√≠a usando los permisos que ya se han explicado en clase</span>
<span class="token comment">//Llamamos al m√©todo extensionStream con el Bitmap para extraer el tipo de extensi√≥n</span>
<span class="token comment">//del archivo (el c√≥digo del m√©todo se pasa bajo de este c√≥digo)</span>
<span class="token keyword keyword-val">val</span> extension <span class="token operator">=</span> <span class="token function">extensionStream</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>imageBitmap<span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> mimeType <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">extension</span></span><span class="token string">"</span></span>

<span class="token keyword keyword-val">val</span> blobName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"imagen_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">extension</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
contactoState <span class="token operator">=</span> contactoState<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
       id <span class="token operator">=</span> e<span class="token punctuation">.</span>contactoUiState<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
       nombre <span class="token operator">=</span> e<span class="token punctuation">.</span>contactoUiState<span class="token punctuation">.</span>nombre<span class="token punctuation">,</span>
       urlFoto <span class="token operator">=</span> blobName
<span class="token punctuation">)</span>
<span class="token comment">//Se convierte la ImageBitmap a ByteArray con el m√©todo toBlob() de la librer√≠a </span>
<span class="token comment">//de utilities de com.github.pmdmiesbalmis</span>
<span class="token keyword keyword-val">val</span> byteArray <span class="token operator">=</span> e<span class="token punctuation">.</span>imageBitmap<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Convertimos todos los Bytes en un tipo RequestBody </span>
<span class="token keyword keyword-val">val</span> requestBody <span class="token operator">=</span>
    byteArray<span class="token punctuation">.</span><span class="token function">toRequestBody</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">.</span><span class="token function">toMediaTypeOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteArray<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
    contactoRepository<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contactoState<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//Llamamos al m√©todo del repository pasando el nombre y la imagen</span>
    contactoRepository<span class="token punctuation">.</span><span class="token function">subirImagen</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><p>El m√©todo que nos devuelve la extensi√≥n de objeto ImageBitmap seleccionado es el siguiente:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">extensionStream</span><span class="token punctuation">(</span>imageBitmap<span class="token operator">:</span> ImageBitmap<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> biteArray <span class="token operator">=</span> imageBitmap<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> inputStream <span class="token operator">=</span> <span class="token function">ByteArrayInputStream</span><span class="token punctuation">(</span>biteArray<span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> bytes <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> hexadecimal <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">joinToString</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" "</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"%02X"</span></span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-val">val</span> extension <span class="token operator">=</span> <span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>hexadecimal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"FF D8 FF E0"</span></span> <span class="token operator">-&gt;</span> <span class="token string-literal singleline"><span class="token string">"jpeg"</span></span>
        <span class="token string-literal singleline"><span class="token string">"89 50 4E 47"</span></span> <span class="token operator">-&gt;</span> <span class="token string-literal singleline"><span class="token string">"png"</span></span>
        <span class="token string-literal singleline"><span class="token string">"47 49 46 38"</span></span> <span class="token operator">-&gt;</span> <span class="token string-literal singleline"><span class="token string">"gif"</span></span>
        <span class="token string-literal singleline"><span class="token string">"25 50 44 46"</span></span> <span class="token operator">-&gt;</span> <span class="token string-literal singleline"><span class="token string">"pdf"</span></span>
        <span class="token keyword keyword-else">else</span> <span class="token operator">-&gt;</span> <span class="token string-literal singleline"><span class="token string">""</span></span>
    <span class="token punctuation">}</span>
    inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> extension
<span class="token punctuation">}</span>
</code></pre><p>Podemos ver que lo que hace es convertir la imagen a InputStream y leer los 4 primeros bytes de ese stream (esos primeros 4bits llevan la informaci√≥n del tipo de archivo). Los bites se unen en una cadena, separados por un espacio y se formatean a hexadecimal. Luego solo hay que comparar el resultado con los establecidos para cada uno de los tipos de imagenes m√°s comunes.</p>
<div style="page-break-after:always;"></div>
<h3 id="usando-el-sdk">Usando el SDK </h3>
<p>Lo primero que tendremos que hacer, es a√±adir las implementaciones necesarias que permitan instanciar la clase <strong><code>BlobClientBuilder()</code></strong>. Esta clase pertenece a la biblioteca Azure Storage SDK para Java y permite construir un cliente (BlobClient) para interactuar con Azure Blob Storage. BlobClient o BlobAsyncClient, ser√°n los que faciliten la cargar, descargar y manipulaci√≥n de blobs (archivos) en Azure Blob Storage.</p>
<p>En el cat√°logo de versiones <strong><code>lib.versions.toml</code></strong> deberemos definido las  librer√≠as:</p>
<pre data-role="codeBlock" data-info="toml" class="language-toml toml"><code><span class="token punctuation">[</span><span class="token table class-name">versions</span><span class="token punctuation">]</span>
<span class="token key property">azureStorage</span> <span class="token punctuation">=</span> <span class="token string">"12.29.1"</span>

<span class="token punctuation">[</span><span class="token table class-name">libraries</span><span class="token punctuation">]</span>

<span class="token key property">azure-storage</span><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.azure"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"azure-storage-blob"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"azureStorage"</span> <span class="token punctuation">}</span>
</code></pre><p>En el <strong><code>build.gradle.kts</code></strong> del <strong>m√≥dulo de la aplicaci√≥n</strong> (app) a√±adiremos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>dependencies <span class="token punctuation">{</span>
       <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>azure<span class="token punctuation">.</span>storage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>La versi√≥n de la librer√≠a puede cambiar, pero puedes ver los √∫ltimos releases de la misma en el siguiente enlace: <strong><a href="https://mvnrepository.com/artifact/com.azure/azure-storage-blob">azure-storage-blob</a></strong></p>
<p>Puede que nos ocurra un error de duplicidad en las entradas de la librer√≠a, por lo que si ocurre podremos solventarlo excluyendo las entradas en el <strong><code>build.gradle.kts</code></strong> del App de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>    packaging <span class="token punctuation">{</span>
        resources <span class="token punctuation">{</span>
            excludes <span class="token operator">+=</span> <span class="token string-literal singleline"><span class="token string">"/META-INF/{AL2.0,LGPL2.1}"</span></span>
            excludes <span class="token operator">+=</span> <span class="token string-literal singleline"><span class="token string">"/META-INF/INDEX.LIST"</span></span>
            excludes <span class="token operator">+=</span> <span class="token string-literal singleline"><span class="token string">"META-INF/io.netty.versions.properties"</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>Una vez tenemos preparado nuestro proyecto, podremos a√±adir el c√≥digo que permite subir las im√°genes, lo usual es que lo a√±adamos en el ViewModel que corresponda y lo que haremos ser√° contruir un BlobClient con el siguente constructor:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-val">val</span> blobClient <span class="token operator">=</span> <span class="token function">BlobClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">connectionString</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">containerName</span><span class="token punctuation">(</span>containerName<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">blobName</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">buildClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>Como se puede ver en el c√≥digo, para construir el BlobClient necesitamos a√±adir la cadena de conexi√≥n, el nombre del contenedor y el nombre que queremos darle al archivo (blobName).</p>
<ul>
<li>
<p>La cadena de conexi√≥n estar√° formada por el protocolo, el nombre de la cuenta, la clave de la cuenta y la url base de la siguiente (EndpointSuffix) forma:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-val">val</span> connectionString <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"DefaultEndpointsProtocol=https;AccountName=nombre_cuenta;AccountKey=clave_cuenta;EndpointSuffix=core.windows.net"</span></span>
</code></pre><ul>
<li>EndpointSuffix de azure va a ser "<a href="http://core.windows.net">core.windows.net</a>"</li>
<li>AccountKey lo podemos conseguir accediendo a "claves de acceso" de nuestro almac√©n, podemos ver que tenemos dos claves (podemos elegir cualquiera), adem√°s podemos acceder directamente a la cadena de conexi√≥n.</li>
<li>El nombre de la cuenta de nuestro ejemplo es "almacenimagenes"</li>
</ul>
</li>
<li>
<p>El nombre del contenedor de nuestro ejemplo es "contenedor1"</p>
</li>
</ul>
<div class="galeria_imagenes">
    <img height="70" src="./assets/imagenes/imagen10.png">
</div>
<ul>
<li>El blobName se puede generar autom√°ticamente a partir de los milisegundos del sistema, as√≠ nos aseguramos que sea √∫nico.</li>
</ul>
<p>una vez tenemos generado el blobClient, podemos subir la imagen a Azure de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>blobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>fileStream<span class="token punctuation">,</span> fileStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><p>Donde fileStream es un stream generado a partir de una imagen seleccionada, y el segundo argumento es el tama√±o que tiene ese stream. True sobreescribe si ya existe.</p>
<p>Un ejemplo que podr√≠amos localizar dentro de un evento de selecci√≥n de im√°genes dentro de un ViewModel y que le asigna el nombre de la imagen a un contacto, adem√°s de actualizar el contacto en la BD y de subir la imagen a Azure, ser√≠a el siguiente.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-fun">fun</span> <span class="token function">onContactoEvent</span><span class="token punctuation">(</span>e<span class="token operator">:</span> ContactoEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-is">is</span> ContactoEvent<span class="token punctuation">.</span>OnChangeFoto <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//En el evento nos llegar√° el BitMap que habremos conseguido con el acceso a la c√°mara </span>
<span class="token comment">//o con selecci√≥n desde galer√≠a usando los permisos que ya se han explicado en clase</span>
<span class="token comment">//Llamamos al m√©todo extensionStream con el Bitmap para extraer el tipo de extensi√≥n</span>
<span class="token comment">//del archivo (el c√≥digo del m√©todo se pasa bajo de este c√≥digo)</span>
  
   <span class="token comment">//La cadena de conexi√≥n que se ha explicado con anterioridad</span>
   <span class="token keyword keyword-val">val</span> connectionString <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"DefaultEndpointsProtocol=https;AccountName=almacenimagenes;"</span></span><span class="token operator">+</span>
   <span class="token string-literal singleline"><span class="token string">"AccountKey=E2XnA***==;EndpointSuffix=core.windows.net"</span></span>
   <span class="token keyword keyword-val">val</span> containerName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"contenedor1"</span></span>
   <span class="token comment">//Usamos el m√©todo extensionStream que nos devuelve la extensi√≥n del archivo </span>
   <span class="token comment">//de la ImageBitmap, este m√©todo est√° explicado con anterioridad</span>
   <span class="token keyword keyword-val">val</span> extension <span class="token operator">=</span> <span class="token function">extensionStream</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>imageBitmap<span class="token punctuation">)</span>
   <span class="token comment">//Creamos el nombre de la imagen a partir de los milisegundos del sistema </span>
   <span class="token comment">//y le a√±adimos la extensi√≥n</span>
   <span class="token keyword keyword-val">val</span> blobName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"imagen_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">extension</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
   <span class="token comment">//A partir de la ImageBitmap se crea el ByteArrayInputStream que se subir√° al servidor</span>
   <span class="token keyword keyword-val">val</span> biteArray <span class="token operator">=</span> e<span class="token punctuation">.</span>imageBitmap<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword keyword-val">val</span> stream <span class="token operator">=</span> <span class="token function">ByteArrayInputStream</span><span class="token punctuation">(</span>biteArray<span class="token punctuation">)</span>
   <span class="token comment">//Se crea el BlobClient</span>
   <span class="token keyword keyword-val">val</span> blobClient <span class="token operator">=</span> <span class="token function">BlobClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">connectionString</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">containerName</span><span class="token punctuation">(</span>containerName<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">blobName</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">buildClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">//Modificamos el estado del contacto</span>
   contactoState <span class="token operator">=</span> contactoState<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
       id <span class="token operator">=</span> e<span class="token punctuation">.</span>contactoUiState<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
       nombre <span class="token operator">=</span> e<span class="token punctuation">.</span>contactoUiState<span class="token punctuation">.</span>nombre<span class="token punctuation">,</span>
       urlFoto <span class="token operator">=</span> blobName
   <span class="token punctuation">)</span>
   viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
       contactoRepository<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contactoState<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token comment">//Subimos la imagen a Azure con el blobClient generado, pasando el ByteArrayInputStream y su tama√±l</span>
       blobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> stream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><p>Esta manera de subir la imagen es de forma s√≠ncrona (Es decir, el proceso se bloquea hasta que se termine de subir la imagen) es la m√°s com√∫n, si queremos hacerlo de forma concurrente, tendr√≠amos que usar <strong><code>BlobAsyncClient</code></strong>:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>BlobAsyncClient blobAsyncClient <span class="token operator">=</span> new <span class="token function">BlobClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">connectionString</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">containerName</span><span class="token punctuation">(</span>containerName<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">blobName</span><span class="token punctuation">(</span>foto<span class="token punctuation">.</span>jpg<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">buildAsyncClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Subir un archivo de forma as√≠ncrona</span>
blobAsyncClient<span class="token punctuation">.</span><span class="token function">uploadFromFile</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ruta/local/foto.jpg"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
        response <span class="token operator">-&gt;</span>  <span class="token comment">//C√≥digo cuando OK,</span>
        error <span class="token operator">-&gt;</span>  <span class="token comment">//error.getMessage()</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>