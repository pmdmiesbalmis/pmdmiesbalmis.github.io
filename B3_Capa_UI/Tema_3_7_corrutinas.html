<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 3.7 - Corrutinas</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face {
  font-family: "Material Icons";
  font-style: normal;
  font-weight: 400;
  src: local("Material Icons"), local("MaterialIcons-Regular"), url("data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAfIAAsAAAAADDAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7kosY21hcAAAAYAAAADTAAACjtP6ytBnbHlmAAACVAAAAxgAAAQ4zRtvlGhlYWQAAAVsAAAALwAAADYRwZsnaGhlYQAABZwAAAAcAAAAJAeKAzxobXR4AAAFuAAAABIAAAA8OGQAAGxvY2EAAAXMAAAAIAAAACAG5AfwbWF4cAAABewAAAAfAAAAIAEfAERuYW1lAAAGDAAAAVcAAAKFkAhoC3Bvc3QAAAdkAAAAYgAAAK2vz7wkeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkPsQ4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVLy4xKzzX4chhrmK4QpQmBEkBwAZygyweJzFkr0NwjAQhZ+TEP6CRUfHBEwRUWaQTICyQbpMwRCskA5RUIONxG0RnnNpKAIV4qzPku/8c353ACYAYrIjCWCuMAh2ptf0/hiL3p/gyPUWa3osqlt0L1zu9r71z8dGrJRykFoauXQd932Lj5vhG+MjxGeYI8MKETObMpslf5EyP8tg+vHun5r539PvlvXzaVhRFVQDTPEWKVQR90KhnnC5Ek67vUKN4VuFasM/ldARj43CCkCsEjpJSoVVgRyU0GVSK6wUpFFCx8lFgX0BiXpRPQB4nE2TTWjcRhTH3xttpDhxN7uxPlp3u/FK7moRPixafRijNosxSw/LUsIwNcaEHPZggo/FmEKMCKWU4kNOOftQSlhE8alnH0Ix9BqWnHooPRrTQ0+mnu2bXTu2pPdGM9LM/6c3fwECTM4gBBMYQNqxzLrZAjqYSlqu2TAHZQA0/DQJH6FtzqGDnvbt4Ggwvzw/nL8EfH8kW0fsuRqhgWXZnY7M1picaUL7Du5BHeDzMIl83dAt016wH1qmvtSMo5R6YRJHTR//FXsff/nj/tc/5K9P5d+nP22+fFK5u7v3K39SW3y+OtDKO3L85vD09PD9z5X17a2N1g4tqk01RlqX7gyoEmnsWQtVr4rtZMmukEaFBZxzefkCn11cyKMLZgshRwgTYNoLNXCBz2ja7HvZG7hDpPSNfoo5vs0knK/9hb+rNpu+8kHPgk/Ao4kK3tWtTpSEtvkA9c+wE6UaUdwieNkaHg55tBEtRiEPw1s0+FtrtTcc9two2lhMknV7PZF/cs6+uUFTmpTGbEx7sQCPSLOttHS3GRltqp7SNzVSKzl6aWnZT/CX5k6/v9N3Hh8fHBwffJVjhrC6OgH5dkIt/tPsq+d/PD5Qz7G7efzq1THFjdZVPe/N6ulQ3JnDWSE5junsFsVIiFwL/htf1S5gJ3BfOcUxfHKLnzqpFpyfZ9cX+/5WB6a+Y0pHpzkNrYNVDwMsikK+y7WuLCRg/oFHkA8VT3rDg5ZnU6ktzzINymV0m74Xd5pfIGXyFeVEQSShkzqG7TBBa2OxVRKitLXv7h3uuftXnXq7lz2tZ/WnWa9dx9dCjDhHzmuVQATlmljr9dZErUydSo2Hbi/b1vXtrOeGCk2/8s3ZlO8+ueJT8BVlw5pGw2oYccdSiHHqx0RlabHqdNR9jAETl6PreJcPBnnfpTLnOQ8C3OV8AmQGzouV1iZdeb5SSIoVc8W8/kcDtksUH5FrU6/aqBqNWcMEzxG4DAQ14qRQhi9mWU0rzepKezbjfgCwQKxVYq5ajRgpRqy45CqwkJydcEkbTkvRz8P5/2ZpDTN4nGNgZGBgAOKb6v+/xvPbfGXgZmEAgeuB2kkI+v8bFgbmKiCXg4EJJAoAPyAKhQB4nGNgZGBg1vmvwxDDwgACQJKRARXwAwAzZQHQeJxjYQCCFAYGFgbSMQAcWACdAAAAAAAAAAwALgBgAIQAmADSAQgBIgE8AVABoAHeAfwCHHicY2BkYGDgZ7BgYGMAASYg5gJCBob/YD4DAA/hAWQAeJxlkbtuwkAURMc88gApQomUJoq0TdIQzEOpUDokKCNR0BuzBiO/tF6QSJcPyHflE9Klyyekz2CuG8cr7547M3d9JQO4xjccnJ57vid2cMHqxDWc40G4Tv1JuEF+Fm6ijRfhM+oz4Ra6eBVu4wZvvMFpXLIa40PYQQefwjVc4Uu4Tv1HuEH+FW7i1mkKn6Hj3Am3sHC6wm08Ou8tpSZGe1av1PKggjSxPd8zJtSGTuinyVGa6/Uu8kxZludCmzxMEzV0B6U004k25W35fj2yNlCBSWM1paujKFWZSbfat+7G2mzc7weiu34aczzFNYGBhgfLfcV6iQP3ACkSaj349AxXSN9IT0j16JepOb01doiKbNWt1ovippz6sVYYwsXgX2rGVFIkq7Pl2PNrI6qW6eOshj0xaSq9mpNEZIWs8LZUfOouNkVXxp/d5woqebeYIf4D2J1ywQB4nG3LOw6AIBAE0B384B+PAkgEa+QwNnYmHt+EpXSal5lkSBBnoP8oCFSo0aCFRIceA0ZMmLFAYSW88rmvtMUjG3RiQ9HvpfusM6zWNmtc5H/iPewha50tOt5PS/QBx2IeSwAA") format("woff");
}

.admonition {
  box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 1px 5px 0 rgba(0, 0, 0, .12), 0 3px 1px -2px rgba(0, 0, 0, .2);
  position: relative;
  margin: 1.5625em 0;
  padding: 0 1.2rem;
  border-left: .4rem solid rgba(68, 138, 255, .8);
  border-radius: .2rem;
  background-color: rgba(255, 255, 255, 0.05);
  overflow: auto;
}

.admonition>p {
  margin-top: .8rem;
}

.admonition>.admonition-title {
  margin: 0 -1.2rem;
  padding: .8rem 1.2rem .8rem 3.6rem;
  border-bottom: 1px solid rgba(68, 138, 255, .2);
  background-color: rgba(68, 138, 255, .1);
  font-weight: 700;
}

.admonition>.admonition-title:before {
  position: absolute;
  left: 1.2rem;
  font-size: 1.5rem;
  color: rgba(68, 138, 255, .8);
  content: "\E3C9";
}

.admonition>.admonition-title:before {
  font-family: Material Icons;
  font-style: normal;
  font-variant: normal;
  font-weight: 400;
  line-height: 2rem;
  text-transform: none;
  white-space: nowrap;
  speak: none;
  word-wrap: normal;
  direction: ltr;
}

.admonition.summary,
.admonition.abstract,
.admonition.tldr {
  border-left-color: rgba(0, 176, 255, .8);
}

.admonition.summary>.admonition-title,
.admonition.abstract>.admonition-title,
.admonition.tldr>.admonition-title {
  background-color: rgba(0, 176, 255, .1);
  border-bottom-color: rgba(0, 176, 255, .2);
}

.admonition.summary>.admonition-title:before,
.admonition.abstract>.admonition-title:before,
.admonition.tldr>.admonition-title:before {
  color: rgba(0, 176, 255, 1);
  ;
  content: "\E8D2";
}

.admonition.hint,
.admonition.tip {
  border-left-color: rgba(0, 191, 165, .8);
}

.admonition.hint>.admonition-title,
.admonition.tip>.admonition-title {
  background-color: rgba(0, 191, 165, .1);
  border-bottom-color: rgba(0, 191, 165, .2);
}

.admonition.hint>.admonition-title:before,
.admonition.tip>.admonition-title:before {
  color: rgba(0, 191, 165, 1);
  content: "\E80E";
}

.admonition.info,
.admonition.todo {
  border-left-color: rgba(0, 184, 212, .8);
}

.admonition.info>.admonition-title,
.admonition.todo>.admonition-title {
  background-color: rgba(0, 184, 212, .1);
  border-bottom-color: rgba(0, 184, 212, .2);
}

.admonition.info>.admonition-title:before,
.admonition.todo>.admonition-title:before {
  color: rgba(0, 184, 212, 1);
  ;
  content: "\E88E";
}

.admonition.success,
.admonition.check,
.admonition.done {
  border-left-color: rgba(0, 200, 83, .8);
}

.admonition.success>.admonition-title,
.admonition.check>.admonition-title,
.admonition.done>.admonition-title {
  background-color: rgba(0, 200, 83, .1);
  border-bottom-color: rgba(0, 200, 83, .2);
}

.admonition.success>.admonition-title:before,
.admonition.check>.admonition-title:before,
.admonition.done>.admonition-title:before {
  color: rgba(0, 200, 83, 1);
  ;
  content: "\E876";
}

.admonition.question,
.admonition.help,
.admonition.faq {
  border-left-color: rgba(100, 221, 23, .8);
}

.admonition.question>.admonition-title,
.admonition.help>.admonition-title,
.admonition.faq>.admonition-title {
  background-color: rgba(100, 221, 23, .1);
  border-bottom-color: rgba(100, 221, 23, .2);
}

.admonition.question>.admonition-title:before,
.admonition.help>.admonition-title:before,
.admonition.faq>.admonition-title:before {
  color: rgba(100, 221, 23, 1);
  ;
  content: "\E887";
}

.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-left-color: rgba(255, 145, 0, .8);
}

.admonition.warning>.admonition-title,
.admonition.attention>.admonition-title,
.admonition.caution>.admonition-title {
  background-color: rgba(255, 145, 0, .1);
  border-bottom-color: rgba(255, 145, 0, .2);
}

.admonition.attention>.admonition-title:before {
  color: rgba(255, 145, 0, 1);
  content: "\E417";
}

.admonition.warning>.admonition-title:before,
.admonition.caution>.admonition-title:before {
  color: rgba(255, 145, 0, 1);
  content: "\E002";
}

.admonition.failure,
.admonition.fail,
.admonition.missing {
  border-left-color: rgba(255, 82, 82, .8);
}

.admonition.failure>.admonition-title,
.admonition.fail>.admonition-title,
.admonition.missing>.admonition-title {
  background-color: rgba(255, 82, 82, .1);
  border-bottom-color: rgba(255, 82, 82, .2);
}

.admonition.failure>.admonition-title:before,
.admonition.fail>.admonition-title:before,
.admonition.missing>.admonition-title:before {
  color: rgba(255, 82, 82, 1);
  ;
  content: "\E14C";
}

.admonition.danger,
.admonition.error,
.admonition.bug {
  border-left-color: rgba(255, 23, 68, .8);
}

.admonition.danger>.admonition-title,
.admonition.error>.admonition-title,
.admonition.bug>.admonition-title {
  background-color: rgba(255, 23, 68, .1);
  border-bottom-color: rgba(255, 23, 68, .2);
}

.admonition.danger>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E3E7";
}

.admonition.error>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E14C";
}

.admonition.bug>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E868";
}

.admonition.example,
.admonition.snippet {
  border-left-color: rgba(0, 184, 212, .8);
}

.admonition.example>.admonition-title,
.admonition.snippet>.admonition-title {
  background-color: rgba(0, 184, 212, .1);
  border-bottom-color: rgba(0, 184, 212, .2);
}

.admonition.example>.admonition-title:before,
.admonition.snippet>.admonition-title:before {
  color: rgba(0, 184, 212, 1);
  ;
  content: "\E242";
}

.admonition.quote,
.admonition.cite {
  border-left-color: rgba(158, 158, 158, .8);
}

.admonition.quote>.admonition-title,
.admonition.cite>.admonition-title {
  background-color: rgba(158, 158, 158, .1);
  border-bottom-color: rgba(158, 158, 158, .2);
}

.admonition.quote>.admonition-title:before,
.admonition.cite>.admonition-title:before {
  color: rgba(158, 158, 158, 1);
  ;
  content: "\E244";
}

/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  background-color: #FFFF;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header" id="tema-37-corrutinasignoretrue">Tema 3.7 - Corrutinas{ignore=true}</h1>

<p>Descargar estos apuntes <a href="./Tema_3_7_corrutinas.pdf">pdf</a> o <a href="./Tema_3_7_corrutinas.html">html</a></p>
<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>

<ol>
<li><a href="#tema-37-corrutinasignoretrue">Tema 3.7 - Corrutinas{ignore=true}</a>
<ol>
<li><a href="#introducci%C3%B3n">Introducci&#xF3;n</a></li>
<li><a href="#corrutinas-en-kotlin">Corrutinas en Kotlin</a>
<ol>
<li><a href="#anatom%C3%ADa-de-una-corrutina">Anatom&#xED;a de una corrutina</a></li>
<li><a href="#primer-ejemplo-b%C3%A1sico">Primer ejemplo b&#xE1;sico</a></li>
<li><a href="#concurrencia-estructurada">Concurrencia estructurada</a></li>
<li><a href="#funciones-de-suspensi%C3%B3n-con-suspend">Funciones de suspensi&#xF3;n con <strong><code>suspend</code></strong></a></li>
<li><a href="#profundizando-en-el-constructor-de-alcance-coroutinescope">Profundizando en el constructor de alcance <strong><code>CoroutineScope</code></strong></a></li>
<li><a href="#controlando-el-estado-de-una-corrutina-con-job">Controlando el estado de una corrutina con <strong><code>Job</code></strong></a></li>
<li><a href="#jobs-as%C3%ADncronos-que-devuelven-un-resultado-asyncawait">Jobs as&#xED;ncronos que devuelven un resultado <strong><code>async/await</code></strong></a></li>
<li><a href="#dispatchers-e-hilos">Dispatchers e hilos</a>
<ol>
<li><a href="#cambiando-el-contexto-de-una-corrutina-con-withcontext">Cambiando el contexto de una corrutina con <strong><code>withContext</code></strong></a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#corrutinas-en-android">Corrutinas en Android</a>
<ol>
<li><a href="#coroutinescopes-m%C3%A1s-comunes-en-android">CoroutineScopes m&#xE1;s comunes en Android</a></li>
<li><a href="#side-effects-y-corrutinas-en-compose">Side-effects y corrutinas en Compose</a>
<ol>
<li><a href="#launchedeffect">LaunchedEffect</a></li>
<li><a href="#cargando-im%C3%A1genes-de-forma-as%C3%ADncrona-coil">Cargando Im&#xE1;genes de forma as&#xED;ncrona (Coil)</a></li>
</ol>
</li>
<li><a href="#ejemplo-de-uso-de-corrutinas-en-android">Ejemplo de uso de corrutinas en Android</a></li>
</ol>
</li>
</ol>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h2>

<ul>
<li>Documentaci&#xF3;n oficial: <strong><a href="https://kotlinlang.org/docs/coroutines-guide.html">Lenguaje Kotlin</a></strong></li>
<li>Documentaci&#xF3;n oficial: <strong><a href="https://developer.android.com/kotlin/coroutines?hl=es-419">Android</a></strong></li>
<li>V&#xED;deo: <strong><a href="https://www.youtube.com/watch?v=ZTDXo0-SKuU">Android Developers</a></strong></li>
<li>V&#xED;deo: <strong><a href="https://www.youtube.com/watch?v=56yLoJNCa2I">Martin Kiperszmid</a></strong></li>
<li>Lista de reproducci&#xF3;n: <strong><a href="https://www.youtube.com/watch?v=2QInrEaXyMo&amp;list=PLSrm9z4zp4mE-o3sPq-PqzGHoFAIsQFI6">Stevdza-San (Ingl&#xE9;s)</a></strong></li>
<li>Lista de reproducci&#xF3;n: <strong><a href="https://www.youtube.com/watch?v=ShNhJ3wMpvQ&amp;list=PLQkwcJG4YTCQcFEPuYGuv54nYai_lwil_">Philipp Lackner (Ingl&#xE9;s)</a></strong></li>
</ul>
<p>En primer lugar comentar que las corrutinas no son un concepto exclusivo de Kotlin, ya que existen en otros lenguajes como C#, Python, Go, JavaScript, etc. En Kotlin, las corrutinas son una caracter&#xED;stica del lenguaje que implementa un patr&#xF3;n que <strong>nos permite escribir c&#xF3;digo as&#xED;ncrono de manera secuencial</strong>. Esto significa que podemos escribir <strong>c&#xF3;digo as&#xED;ncrono como si fuera c&#xF3;digo s&#xED;ncrono</strong>, sin tener que preocuparnos por los callbacks, los hilos, etc. Esto hace que el c&#xF3;digo sea m&#xE1;s f&#xE1;cil de leer y de mantener.</p>
<p>&#xBF;Quiere decir esto que no podamos gestionar la concurrencia como lo hacemos en Java?. No, podemos seguir usando hilos tal cual lo hacemos en Java a trav&#xE9;s del paquete <strong><code>kotlin.concurrent</code></strong>. Sin embargo, las corrutinas nos permiten gestionar la concurrencia de una manera m&#xE1;s sencilla y segura ya no est&#xE1;n vinculada a ning&#xFA;n hilo en particular. Puede suspender su ejecuci&#xF3;n en un hilo y reanudarse en otro.</p>
<p>Ser&#xE1;n &#xFA;tiles para tener:</p>
<ul>
<li>
<p><strong>Ligereza</strong>: Puedes ejecutar muchas corrutinas de forma concurrente en un solo hilo debido a la compatibilidad con la suspensi&#xF3;n, que no bloquea el hilo en el que se ejecuta la corrutina.</p>
</li>
<li>
<p><strong>Menos fugas de memoria</strong>: Puedo ejecutar un proceso dentro de un determinado &apos;<strong>scope</strong>&apos; o alcance, y cuando el alcance se cierra, todas las corrutinas que se ejecutan dentro de ese alcance se cancelan autom&#xE1;ticamente. Esto significa que no hay fugas de memoria.</p>
</li>
<li>
<p><strong>Compatibilidad con cancelaci&#xF3;n incorporada</strong>: Se propaga autom&#xE1;ticamente la cancelaci&#xF3;n a trav&#xE9;s de la jerarqu&#xED;a de corrutinas en ejecuci&#xF3;n.</p>
</li>
<li>
<p><strong>Integraci&#xF3;n con Jetpack</strong>: Muchas bibliotecas de Jetpack incluida Compose. Estas bibliotecas incluyen extensiones que proporcionan compatibilidad total con corrutinas.</p>
</li>
</ul>
<p>Las corrutinas forman parte de la librer&#xED;a est&#xE1;ndar de Kotlin. No obstante para usarlas necesitamos a&#xF1;adir como dependencia la librer&#xED;a de extensi&#xF3;n (<strong><code>kotlinx.coroutines</code></strong>) donde se implementan en el fichero <strong><code>build.gradle.kts</code></strong> del m&#xF3;dulo app:</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Podemos ver las versi&#xF3;n actual de corrutinas en el siguiente <strong><a href="https://github.com/Kotlin/kotlinx.coroutines">repositorio de Kotlin</a></strong>. <strong>Adem&#xE1;s, debemos fijarnos cual es la vers&#xED;on de Kotlin m&#xED;nima asociada a la versi&#xF3;n de corrutinas que queremos usar</strong>.</p>
</blockquote>
<p>Por ejemplo si us&#xE1;ramos un <strong>programa de consola</strong> tendr&#xED;amos que a&#xF1;adir:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token comment">// Gradle (Kotlin DSL)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3&quot;</span><span class="token punctuation">)</span>
</pre><p>En un <strong>proyecto Android</strong> posiblemente no necesitemos a&#xF1;adirla porque ya estar&#xE1; incluida la librer&#xED;a a trav&#xE9;s de alguna otra dependencia. Pero si no fuera as&#xED;, tendr&#xED;amos que a&#xF1;adir m&#xED;nimo la implementaci&#xF3;n espec&#xED;fica para Android:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token comment">// Gradle (Kotlin DSL)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3&quot;</span><span class="token punctuation">)</span>
</pre><div style="page-break-after:always;"></div>
<h2 class="mume-header" id="corrutinas-en-kotlin">Corrutinas en Kotlin</h2>

<blockquote>
<p>&#x270B; para probar el c&#xF3;digo, puedes crear un <strong>proyecto de consola</strong> en Kotlin o usar el <strong><a href="https://play.kotlinlang.org/">playground</a></strong></p>
</blockquote>
<h3 class="mume-header" id="anatom%C3%ADa-de-una-corrutina">Anatom&#xED;a de una corrutina</h3>

<p>Estar&#xE1; formada por las siguientes partes del esquema:</p>
<p align="center" style="zoom:0.7"><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: G Pages: 1 -->
<svg width="472pt" height="336pt" viewBox="0.00 0.00 471.53 336.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 332)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-332 467.5275,-332 467.5275,4 -4,4"/>
<g id="clust1" class="cluster">
<title>clusterScope</title>
<path fill="none" stroke="#36648b" d="M20,-8C20,-8 443.5275,-8 443.5275,-8 449.5275,-8 455.5275,-14 455.5275,-20 455.5275,-20 455.5275,-308 455.5275,-308 455.5275,-314 449.5275,-320 443.5275,-320 443.5275,-320 20,-320 20,-320 14,-320 8,-314 8,-308 8,-308 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="231.7638" y="-298" font-family="Arial" font-size="20.00" fill="#36648b">CoroutineScope</text>
</g>
<g id="clust3" class="cluster">
<title>clusterChildScope1</title>
<path fill="none" stroke="#36648b" d="M53.9968,-192C53.9968,-192 114.0032,-192 114.0032,-192 120.0032,-192 126.0032,-198 126.0032,-204 126.0032,-204 126.0032,-256 126.0032,-256 126.0032,-262 120.0032,-268 114.0032,-268 114.0032,-268 53.9968,-268 53.9968,-268 47.9968,-268 41.9968,-262 41.9968,-256 41.9968,-256 41.9968,-204 41.9968,-204 41.9968,-198 47.9968,-192 53.9968,-192"/>
<text text-anchor="middle" x="84" y="-255" font-family="Arial" font-size="10.00" fill="#36648b">ChildScope</text>
</g>
<g id="clust4" class="cluster">
<title>clusterChildScope2</title>
<path fill="none" stroke="#36648b" d="M151.8333,-192C151.8333,-192 211.8397,-192 211.8397,-192 217.8397,-192 223.8397,-198 223.8397,-204 223.8397,-204 223.8397,-256 223.8397,-256 223.8397,-262 217.8397,-268 211.8397,-268 211.8397,-268 151.8333,-268 151.8333,-268 145.8333,-268 139.8333,-262 139.8333,-256 139.8333,-256 139.8333,-204 139.8333,-204 139.8333,-198 145.8333,-192 151.8333,-192"/>
<text text-anchor="middle" x="181.8365" y="-255" font-family="Arial" font-size="10.00" fill="#36648b">ChildScope</text>
</g>
<g id="clust2" class="cluster">
<title>clusterContext</title>
<path fill="none" stroke="#4f94cd" d="M40,-28C40,-28 423.5275,-28 423.5275,-28 429.5275,-28 435.5275,-34 435.5275,-40 435.5275,-40 435.5275,-160 435.5275,-160 435.5275,-166 429.5275,-172 423.5275,-172 423.5275,-172 40,-172 40,-172 34,-172 28,-166 28,-160 28,-160 28,-40 28,-40 28,-34 34,-28 40,-28"/>
<text text-anchor="middle" x="231.7638" y="-150" font-family="Arial" font-size="20.00" fill="#4f94cd">CoroutineContext</text>
</g>
<!-- Job -->
<g id="node1" class="node">
<title>Job</title>
<path fill="#104e8b" stroke="#104e8b" d="M108,-120C108,-120 60,-120 60,-120 54,-120 48,-114 48,-108 48,-108 48,-60 48,-60 48,-54 54,-48 60,-48 60,-48 108,-48 108,-48 114,-48 120,-54 120,-60 120,-60 120,-108 120,-108 120,-114 114,-120 108,-120"/>
<text text-anchor="middle" x="84" y="-79.5" font-family="Arial" font-size="15.00" fill="#ffffff">Job</text>
</g>
<!-- Dispatcher -->
<g id="node2" class="node">
<title>Dispatcher</title>
<path fill="#104e8b" stroke="#104e8b" d="M213.5101,-120C213.5101,-120 150.1629,-120 150.1629,-120 144.1629,-120 138.1629,-114 138.1629,-108 138.1629,-108 138.1629,-60 138.1629,-60 138.1629,-54 144.1629,-48 150.1629,-48 150.1629,-48 213.5101,-48 213.5101,-48 219.5101,-48 225.5101,-54 225.5101,-60 225.5101,-60 225.5101,-108 225.5101,-108 225.5101,-114 219.5101,-120 213.5101,-120"/>
<text text-anchor="middle" x="181.8365" y="-79.5" font-family="Arial" font-size="15.00" fill="#ffffff">Dispatcher</text>
</g>
<!-- Job&#45;&gt;Dispatcher -->
<!-- Exception -->
<g id="node3" class="node">
<title>Exception</title>
<path fill="#104e8b" stroke="#104e8b" d="M313.4549,-120C313.4549,-120 255.7456,-120 255.7456,-120 249.7456,-120 243.7456,-114 243.7456,-108 243.7456,-108 243.7456,-60 243.7456,-60 243.7456,-54 249.7456,-48 255.7456,-48 255.7456,-48 313.4549,-48 313.4549,-48 319.4549,-48 325.4549,-54 325.4549,-60 325.4549,-60 325.4549,-108 325.4549,-108 325.4549,-114 319.4549,-120 313.4549,-120"/>
<text text-anchor="middle" x="284.6002" y="-88.5" font-family="Arial" font-size="15.00" fill="#ffffff">Exception</text>
<text text-anchor="middle" x="284.6002" y="-70.5" font-family="Arial" font-size="15.00" fill="#ffffff">handler</text>
</g>
<!-- Dispatcher&#45;&gt;Exception -->
<!-- Other -->
<g id="node4" class="node">
<title>Other</title>
<path fill="#104e8b" stroke="#104e8b" d="M403.5275,-120C403.5275,-120 355.5275,-120 355.5275,-120 349.5275,-120 343.5275,-114 343.5275,-108 343.5275,-108 343.5275,-60 343.5275,-60 343.5275,-54 349.5275,-48 355.5275,-48 355.5275,-48 403.5275,-48 403.5275,-48 409.5275,-48 415.5275,-54 415.5275,-60 415.5275,-60 415.5275,-108 415.5275,-108 415.5275,-114 409.5275,-120 403.5275,-120"/>
<text text-anchor="middle" x="379.5275" y="-79.5" font-family="Arial" font-size="15.00" fill="#ffffff">...</text>
</g>
<!-- Exception&#45;&gt;Other -->
<!-- ChildContext1 -->
<g id="node5" class="node">
<title>ChildContext1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M104.0064,-238C104.0064,-238 63.9936,-238 63.9936,-238 57.9936,-238 51.9936,-232 51.9936,-226 51.9936,-226 51.9936,-214 51.9936,-214 51.9936,-208 57.9936,-202 63.9936,-202 63.9936,-202 104.0064,-202 104.0064,-202 110.0064,-202 116.0064,-208 116.0064,-214 116.0064,-214 116.0064,-226 116.0064,-226 116.0064,-232 110.0064,-238 104.0064,-238"/>
<text text-anchor="middle" x="84" y="-217.6" font-family="Arial" font-size="8.00" fill="#104e8b">Child Context</text>
</g>
<!-- ChildContext2 -->
<g id="node6" class="node">
<title>ChildContext2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.8429,-238C201.8429,-238 161.8301,-238 161.8301,-238 155.8301,-238 149.8301,-232 149.8301,-226 149.8301,-226 149.8301,-214 149.8301,-214 149.8301,-208 155.8301,-202 161.8301,-202 161.8301,-202 201.8429,-202 201.8429,-202 207.8429,-202 213.8429,-208 213.8429,-214 213.8429,-214 213.8429,-226 213.8429,-226 213.8429,-232 207.8429,-238 201.8429,-238"/>
<text text-anchor="middle" x="181.8365" y="-217.6" font-family="Arial" font-size="8.00" fill="#104e8b">Child Context</text>
</g>
<!-- ChildContext1&#45;&gt;ChildContext2 -->
</g>
</svg>
</p><p>Definiciones b&#xE1;sicas:</p>
<ul>
<li>
<p><strong>CoroutinesScope</strong>: Es el <strong>&#xE1;mbito</strong> en el que se ejecuta la corrutina. Por ejemplo, si lanzamos una corrutina desde una actividad, el &#xE1;mbito de la corrutina ser&#xE1; la actividad. Cuando la actividad se destruya, la corrutina se cancelar&#xE1; autom&#xE1;ticamente.</p>
</li>
<li>
<p><strong>CoroutineContext</strong>: Es el <strong>contexto</strong> en el que se ejecuta la corrutina y est&#xE1; forma por un conjunto de elementos que definen el comportamiento de la corrutina</p>
<ul>
<li><strong>Job</strong>: Objeto que representa la tarea concurrente que se est&#xE1; ejecutando. Podemos usar este objeto para controlar el estado de la corrutina, por ejemplo, para esperarla o cancelarla. El ciclo de vida del trabajo asociado a una corrutina lo puedes ver en el siguiente diagrama.</li>
</ul>
</li>
</ul>
<p align="center" style="zoom:0.7"><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: G Pages: 1 -->
<svg width="682pt" height="312pt" viewBox="0.00 0.00 681.67 312.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 308)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-308 677.667,-308 677.667,4 -4,4"/>
<g id="clust1" class="cluster">
<title>clusterJonCycle</title>
<path fill="none" stroke="#36648b" d="M20,-8C20,-8 653.667,-8 653.667,-8 659.667,-8 665.667,-14 665.667,-20 665.667,-20 665.667,-284 665.667,-284 665.667,-290 659.667,-296 653.667,-296 653.667,-296 20,-296 20,-296 14,-296 8,-290 8,-284 8,-284 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="336.8335" y="-274" font-family="Arial" font-size="20.00" fill="#36648b">Job Lifecycle</text>
</g>
<!-- New -->
<g id="node1" class="node">
<title>New</title>
<path fill="#104e8b" stroke="#104e8b" d="M88,-64C88,-64 40,-64 40,-64 34,-64 28,-58 28,-52 28,-52 28,-40 28,-40 28,-34 34,-28 40,-28 40,-28 88,-28 88,-28 94,-28 100,-34 100,-40 100,-40 100,-52 100,-52 100,-58 94,-64 88,-64"/>
<text text-anchor="middle" x="64" y="-43" font-family="Arial" font-size="10.00" fill="#ffffff">New</text>
</g>
<!-- Active -->
<g id="node2" class="node">
<title>Active</title>
<path fill="#1874cd" stroke="#1874cd" d="M257.446,-64C257.446,-64 209.446,-64 209.446,-64 203.446,-64 197.446,-58 197.446,-52 197.446,-52 197.446,-40 197.446,-40 197.446,-34 203.446,-28 209.446,-28 209.446,-28 257.446,-28 257.446,-28 263.446,-28 269.446,-34 269.446,-40 269.446,-40 269.446,-52 269.446,-52 269.446,-58 263.446,-64 257.446,-64"/>
<text text-anchor="middle" x="233.446" y="-43" font-family="Arial" font-size="10.00" fill="#ffffff">Active</text>
</g>
<!-- New&#45;&gt;Active -->
<g id="edge1" class="edge">
<title>New-&gt;Active</title>
<path fill="none" stroke="#104e8b" stroke-width="1.5" d="M100.1239,-46C106.5764,-46 113.237,-46 119.5,-46 119.5,-46 119.5,-46 177.946,-46 180.9797,-46 184.1066,-46 187.2579,-46"/>
<polygon fill="#104e8b" stroke="#104e8b" stroke-width="1.5" points="187.3221,-49.5001 197.3221,-46 187.322,-42.5001 187.3221,-49.5001"/>
<text text-anchor="middle" x="148.723" y="-49" font-family="Arial" font-size="10.00" fill="#104e8b">start</text>
</g>
<!-- Completing -->
<g id="node3" class="node">
<title>Completing</title>
<path fill="#1e90ff" stroke="#1e90ff" d="M460.4403,-147C460.4403,-147 406.0077,-147 406.0077,-147 400.0077,-147 394.0077,-141 394.0077,-135 394.0077,-135 394.0077,-123 394.0077,-123 394.0077,-117 400.0077,-111 406.0077,-111 406.0077,-111 460.4403,-111 460.4403,-111 466.4403,-111 472.4403,-117 472.4403,-123 472.4403,-123 472.4403,-135 472.4403,-135 472.4403,-141 466.4403,-147 460.4403,-147"/>
<text text-anchor="middle" x="433.224" y="-132" font-family="Arial" font-size="10.00" fill="#ffffff">Completing</text>
<text text-anchor="middle" x="433.224" y="-120" font-family="Arial" font-size="10.00" fill="#ffffff">(wait children)</text>
</g>
<!-- Active&#45;&gt;Completing -->
<g id="edge2" class="edge">
<title>Active-&gt;Completing</title>
<path fill="none" stroke="#104e8b" stroke-width="1.5" d="M247.9502,-64.1274C258.1391,-74.7109 272.7931,-86 288.946,-86 288.946,-86 288.946,-86 374.616,-86 388.695,-86 401.6335,-94.1663 411.7517,-103.3813"/>
<polygon fill="#104e8b" stroke="#104e8b" stroke-width="1.5" points="409.3571,-105.9361 418.9116,-110.5146 414.2976,-100.9772 409.3571,-105.9361"/>
<text text-anchor="middle" x="331.781" y="-89" font-family="Arial" font-size="10.00" fill="#104e8b">complete</text>
</g>
<!-- Cancelling -->
<g id="node5" class="node">
<title>Cancelling</title>
<path fill="#ff4500" stroke="#ff4500" d="M257.446,-244C257.446,-244 209.446,-244 209.446,-244 203.446,-244 197.446,-238 197.446,-232 197.446,-232 197.446,-220 197.446,-220 197.446,-214 203.446,-208 209.446,-208 209.446,-208 257.446,-208 257.446,-208 263.446,-208 269.446,-214 269.446,-220 269.446,-220 269.446,-232 269.446,-232 269.446,-238 263.446,-244 257.446,-244"/>
<text text-anchor="middle" x="233.446" y="-223" font-family="Arial" font-size="10.00" fill="#ffffff">Cancelling</text>
</g>
<!-- Active&#45;&gt;Cancelling -->
<g id="edge4" class="edge">
<title>Active-&gt;Cancelling</title>
<path fill="none" stroke="#ff0000" stroke-width="1.5" d="M233.446,-64.2499C233.446,-95.7314 233.446,-160.4498 233.446,-197.7751"/>
<polygon fill="#ff0000" stroke="#ff0000" stroke-width="1.5" points="229.9461,-197.9694 233.446,-207.9694 236.9461,-197.9694 229.9461,-197.9694"/>
<text text-anchor="middle" x="224.446" y="-133" font-family="Arial" font-size="10.00" fill="#ff0000">cancel/falil</text>
</g>
<!-- Completed -->
<g id="node4" class="node">
<title>Completed</title>
<path fill="#006400" stroke="#006400" d="M633.667,-147C633.667,-147 585.667,-147 585.667,-147 579.667,-147 573.667,-141 573.667,-135 573.667,-135 573.667,-123 573.667,-123 573.667,-117 579.667,-111 585.667,-111 585.667,-111 633.667,-111 633.667,-111 639.667,-111 645.667,-117 645.667,-123 645.667,-123 645.667,-135 645.667,-135 645.667,-141 639.667,-147 633.667,-147"/>
<text text-anchor="middle" x="609.667" y="-126" font-family="Arial" font-size="10.00" fill="#ffffff">Completed</text>
</g>
<!-- Completing&#45;&gt;Completed -->
<g id="edge3" class="edge">
<title>Completing-&gt;Completed</title>
<path fill="none" stroke="#104e8b" stroke-width="1.5" d="M472.6311,-129C479.0488,-129 485.6252,-129 491.832,-129 491.832,-129 491.832,-129 554.167,-129 557.2007,-129 560.3276,-129 563.4789,-129"/>
<polygon fill="#104e8b" stroke="#104e8b" stroke-width="1.5" points="563.5431,-132.5001 573.5431,-129 563.543,-125.5001 563.5431,-132.5001"/>
<text text-anchor="middle" x="522.9995" y="-132" font-family="Arial" font-size="10.00" fill="#104e8b">finish</text>
</g>
<!-- Completing&#45;&gt;Cancelling -->
<g id="edge5" class="edge">
<title>Completing-&gt;Cancelling</title>
<path fill="none" stroke="#ff0000" stroke-width="1.5" d="M423.7262,-147.0091C413.8206,-163.0494 396.6629,-184 374.616,-184 288.946,-184 288.946,-184 288.946,-184 275.5976,-184 263.4348,-191.8207 253.9199,-200.7126"/>
<polygon fill="#ff0000" stroke="#ff0000" stroke-width="1.5" points="251.349,-198.336 246.8849,-207.9445 256.3666,-203.2171 251.349,-198.336"/>
<text text-anchor="middle" x="331.781" y="-187" font-family="Arial" font-size="10.00" fill="#ff0000">cancel/falil</text>
</g>
<!-- Cancelled -->
<g id="node6" class="node">
<title>Cancelled</title>
<path fill="#ff0000" stroke="#ff0000" d="M633.667,-244C633.667,-244 585.667,-244 585.667,-244 579.667,-244 573.667,-238 573.667,-232 573.667,-232 573.667,-220 573.667,-220 573.667,-214 579.667,-208 585.667,-208 585.667,-208 633.667,-208 633.667,-208 639.667,-208 645.667,-214 645.667,-220 645.667,-220 645.667,-232 645.667,-232 645.667,-238 639.667,-244 633.667,-244"/>
<text text-anchor="middle" x="609.667" y="-223" font-family="Arial" font-size="10.00" fill="#ffffff">Cancelled</text>
</g>
<!-- Cancelling&#45;&gt;Cancelled -->
<g id="edge6" class="edge">
<title>Cancelling-&gt;Cancelled</title>
<path fill="none" stroke="#ff0000" stroke-width="1.5" d="M269.5699,-226C276.0224,-226 282.683,-226 288.946,-226 288.946,-226 288.946,-226 554.167,-226 557.2007,-226 560.3276,-226 563.4789,-226"/>
<polygon fill="#ff0000" stroke="#ff0000" stroke-width="1.5" points="563.5431,-229.5001 573.5431,-226 563.543,-222.5001 563.5431,-229.5001"/>
<text text-anchor="middle" x="433.224" y="-229" font-family="Arial" font-size="10.00" fill="#ff0000">finish</text>
</g>
</g>
</svg>
</p><ul>
<li>
<p><strong>Dispatcher</strong>: Podemos decir que es el <strong>hilo</strong> en el que se ejecuta la corrutina. Por defecto, las corrutinas se ejecutan en el hilo de la corrutina que las lanza. Pero <strong>podemos cambiar el hilo de ejecuci&#xF3;n de una en el contexto de la misma</strong>.</p>
<ul>
<li><strong>CoroutineExceptionHandler</strong>: Permite que la corrutina tenga un <strong>manejo de excepciones personalizado en su contexto</strong>.</li>
</ul>
</li>
<li>
<p><strong>Corrutinas &apos;<em>Hijas</em>&apos;</strong>: Dentro de una corrutina podemos lanzar otras corrutinas. El &#xE1;mbito de estas corrutinas secundarias (<strong><code>ChildScope</code></strong>) se ejecutar&#xE1;n dentro del &#xE1;mbito o (<strong><code>CoroutinesScope</code></strong>) corrutina principal. Esto significa que si la corrutina principal se cancela, tambi&#xE9;n se cancelar&#xE1;n las corrutinas secundarias. Es por eso que el Job o Tarea del contexto de la corrutina espera a que todas las corrutinas secundarias finalicen antes de finalizar su ciclo de vida.</p>
</li>
</ul>
<p>Vamos a ir adentr&#xE1;ndonos con ejemplos en las anteriores definiciones...</p>
<h3 class="mume-header" id="primer-ejemplo-b%C3%A1sico">Primer ejemplo b&#xE1;sico</h3>

<p>Veamos el siguiente ejemplo extra&#xED;do de la documentaci&#xF3;n oficial de Kotlin:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-import">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span> <span class="token comment">// Corrutina 1</span>
    launch <span class="token punctuation">{</span>  <span class="token comment">// Corrutina 2</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</pre><p>Mostrar&#xE1; por pantalla:</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>Hola
Mundo!
</code></pre><p>Vamos a desglosar lo que hace este c&#xF3;digo....</p>
<ul>
<li>
<p><strong><code>runBlocking</code></strong> es un constructor de corrutinas, esto es, define un bloque de c&#xF3;digo que se ejecuta como una corrutina. En este caso, el bloque de c&#xF3;digo <strong>se ejecuta en el hilo principal</strong> (ser&#xE1; el Dispatcher por defecto de su contexto si no especificamos otro). <strong><code>runBlocking</code></strong> es una funci&#xF3;n de suspensi&#xF3;n que <strong>bloquea el hilo donde se ejecuta</strong> mientras se ejecuta el bloque de c&#xF3;digo. <strong>Esto se hace para evitar que el programa finalice antes de que se ejecute la corrutina</strong>.</p>
</li>
<li>
<p><strong><code>launch</code></strong> es un constructor de corrutinas. Lanza una nueva corrutina en paralelo con el resto del c&#xF3;digo, que contin&#xFA;a funcionando de forma independiente. Es por eso que se muestra primero &apos;<em>Hola</em>&apos;</p>
</li>
<li>
<p><strong><code>delay</code></strong> es una funci&#xF3;n de suspensi&#xF3;n especial. Suspende la corrutina durante un tiempo espec&#xED;fico.</p>
</li>
</ul>
<p align="center" style="zoom:1"><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: G Pages: 1 -->
<svg width="1095pt" height="388pt" viewBox="0.00 0.00 1095.00 388.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 384)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-384 1091,-384 1091,4 -4,4"/>
<g id="clust1" class="cluster">
<title>clusterMainThread</title>
<path fill="#daeeff" stroke="#daeeff" d="M20,-8C20,-8 1067,-8 1067,-8 1073,-8 1079,-14 1079,-20 1079,-20 1079,-360 1079,-360 1079,-366 1073,-372 1067,-372 1067,-372 20,-372 20,-372 14,-372 8,-366 8,-360 8,-360 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="543.5" y="-350" font-family="Arial" font-size="20.00" fill="#36648b">Main Thread / Hilo Principal</text>
</g>
<!-- pmain -->
<!-- main -->
<g id="node2" class="node">
<title>main</title>
<path fill="#1e90ff" stroke="#1e90ff" d="M160,-310C160,-310 112,-310 112,-310 106,-310 100,-304 100,-298 100,-298 100,-286 100,-286 100,-280 106,-274 112,-274 112,-274 160,-274 160,-274 166,-274 172,-280 172,-286 172,-286 172,-298 172,-298 172,-304 166,-310 160,-310"/>
<text text-anchor="middle" x="136" y="-295" font-family="Arial" font-size="10.00" fill="#ffffff">main()</text>
<text text-anchor="middle" x="136" y="-283" font-family="Arial" font-size="10.00" fill="#ffffff">ACTIVE</text>
</g>
<!-- pmain&#45;&gt;main -->
<g id="edge1" class="edge">
<title>pmain-&gt;main</title>
<path fill="none" stroke="#104e8b" d="M28.4219,-292C48.8861,-292 69.3502,-292 89.8144,-292"/>
<polygon fill="#104e8b" stroke="#104e8b" points="89.8605,-295.5001 99.8605,-292 89.8604,-288.5001 89.8605,-295.5001"/>
</g>
<!-- mainb -->
<g id="node3" class="node">
<title>mainb</title>
<path fill="#1e90ff" stroke="#1e90ff" d="M824.926,-320C824.926,-320 759.074,-320 759.074,-320 753.074,-320 747.074,-314 747.074,-308 747.074,-308 747.074,-276 747.074,-276 747.074,-270 753.074,-264 759.074,-264 759.074,-264 824.926,-264 824.926,-264 830.926,-264 836.926,-270 836.926,-276 836.926,-276 836.926,-308 836.926,-308 836.926,-314 830.926,-320 824.926,-320"/>
<text text-anchor="middle" x="792" y="-307" font-family="Arial" font-size="10.00" fill="#ffffff">main()</text>
<text text-anchor="middle" x="792" y="-295" font-family="Arial" font-size="10.00" fill="#ffffff">bloqueado hasta</text>
<text text-anchor="middle" x="792" y="-283" font-family="Arial" font-size="10.00" fill="#ffffff">fin Corrutina 1</text>
<text text-anchor="middle" x="792" y="-271" font-family="Arial" font-size="10.00" fill="#ffffff">COMPLETING</text>
</g>
<!-- main&#45;&gt;mainb -->
<g id="edge8" class="edge">
<title>main-&gt;mainb</title>
<path fill="none" stroke="#104e8b" stroke-dasharray="1,5" d="M172.2038,-292C281.126,-292 606.3122,-292 736.8607,-292"/>
<polygon fill="#104e8b" stroke="#104e8b" points="737.0306,-295.5001 747.0306,-292 737.0305,-288.5001 737.0306,-295.5001"/>
<text text-anchor="middle" x="459.5185" y="-310" font-family="Arial" font-size="10.00" fill="#104e8b">Hilo Principal</text>
<text text-anchor="middle" x="459.5185" y="-298" font-family="Arial" font-size="10.00" fill="#104e8b">Bloquedao</text>
</g>
<!-- rb -->
<g id="node4" class="node">
<title>rb</title>
<path fill="#1874cd" stroke="#1874cd" d="M374,-190C374,-190 326,-190 326,-190 320,-190 314,-184 314,-178 314,-178 314,-158 314,-158 314,-152 320,-146 326,-146 326,-146 374,-146 374,-146 380,-146 386,-152 386,-158 386,-158 386,-178 386,-178 386,-184 380,-190 374,-190"/>
<text text-anchor="middle" x="350" y="-177" font-family="Arial" font-size="10.00" fill="#ffffff">Corrutina 1</text>
<text text-anchor="middle" x="350" y="-165" font-family="Arial" font-size="10.00" fill="#ffffff">runBlocking</text>
<text text-anchor="middle" x="350" y="-153" font-family="Arial" font-size="10.00" fill="#ffffff">ACTIVE</text>
</g>
<!-- main&#45;&gt;rb -->
<g id="edge2" class="edge">
<title>main-&gt;rb</title>
<path fill="none" stroke="#104e8b" d="M167.1174,-273.9693C203.4048,-252.943 263.6817,-218.0162 305.0501,-194.0457"/>
<polygon fill="#104e8b" stroke="#104e8b" points="306.9363,-196.9979 313.834,-188.956 303.4268,-190.9412 306.9363,-196.9979"/>
<text text-anchor="middle" x="313.564" y="-236" font-family="Arial" font-size="10.00" fill="#104e8b">start</text>
<text text-anchor="middle" x="313.564" y="-224" font-family="Arial" font-size="10.00" fill="#104e8b">corrutina 1</text>
<text text-anchor="middle" x="313.564" y="-212" font-family="Arial" font-size="10.00" fill="#104e8b">con runBlocking</text>
</g>
<!-- fmain -->
<g id="node9" class="node">
<title>fmain</title>
<path fill="#006400" stroke="#006400" d="M1047.2213,-310C1047.2213,-310 992.7787,-310 992.7787,-310 986.7787,-310 980.7787,-304 980.7787,-298 980.7787,-298 980.7787,-286 980.7787,-286 980.7787,-280 986.7787,-274 992.7787,-274 992.7787,-274 1047.2213,-274 1047.2213,-274 1053.2213,-274 1059.2213,-280 1059.2213,-286 1059.2213,-286 1059.2213,-298 1059.2213,-298 1059.2213,-304 1053.2213,-310 1047.2213,-310"/>
<text text-anchor="middle" x="1020" y="-295" font-family="Arial" font-size="10.00" fill="#ffffff">main()</text>
<text text-anchor="middle" x="1020" y="-283" font-family="Arial" font-size="10.00" fill="#ffffff">COMPLETED</text>
</g>
<!-- mainb&#45;&gt;fmain -->
<g id="edge10" class="edge">
<title>mainb-&gt;fmain</title>
<path fill="none" stroke="#104e8b" d="M837.0455,-292C875.5251,-292 930.7939,-292 970.5015,-292"/>
<polygon fill="#104e8b" stroke="#104e8b" points="970.7507,-295.5001 980.7507,-292 970.7506,-288.5001 970.7507,-295.5001"/>
<text text-anchor="middle" x="908.9263" y="-298" font-family="Arial" font-size="10.00" fill="#104e8b">finish</text>
</g>
<!-- hola -->
<g id="node5" class="node">
<title>hola</title>
<path fill="#1874cd" stroke="#1874cd" d="M522.5364,-186C522.5364,-186 469.4636,-186 469.4636,-186 463.4636,-186 457.4636,-180 457.4636,-174 457.4636,-174 457.4636,-162 457.4636,-162 457.4636,-156 463.4636,-150 469.4636,-150 469.4636,-150 522.5364,-150 522.5364,-150 528.5364,-150 534.5364,-156 534.5364,-162 534.5364,-162 534.5364,-174 534.5364,-174 534.5364,-180 528.5364,-186 522.5364,-186"/>
<text text-anchor="middle" x="496" y="-171" font-family="Arial" font-size="10.00" fill="#ffffff">prinln (&quot;Hola&quot;)</text>
<text text-anchor="middle" x="496" y="-159" font-family="Arial" font-size="10.00" fill="#ffffff">ACTIVE</text>
</g>
<!-- rb&#45;&gt;hola -->
<g id="edge4" class="edge">
<title>rb-&gt;hola</title>
<path fill="none" stroke="#104e8b" d="M386.2148,-168C406.6075,-168 427.0001,-168 447.3927,-168"/>
<polygon fill="#104e8b" stroke="#104e8b" points="447.4037,-171.5001 457.4037,-168 447.4036,-164.5001 447.4037,-171.5001"/>
</g>
<!-- launch -->
<g id="node7" class="node">
<title>launch</title>
<path fill="#104e8b" stroke="#104e8b" d="M464,-72C464,-72 416,-72 416,-72 410,-72 404,-66 404,-60 404,-60 404,-40 404,-40 404,-34 410,-28 416,-28 416,-28 464,-28 464,-28 470,-28 476,-34 476,-40 476,-40 476,-60 476,-60 476,-66 470,-72 464,-72"/>
<text text-anchor="middle" x="440" y="-59" font-family="Arial" font-size="10.00" fill="#ffffff">Corrutina 2</text>
<text text-anchor="middle" x="440" y="-47" font-family="Arial" font-size="10.00" fill="#ffffff">launch</text>
<text text-anchor="middle" x="440" y="-35" font-family="Arial" font-size="10.00" fill="#ffffff">ACTIVE</text>
</g>
<!-- rb&#45;&gt;launch -->
<g id="edge3" class="edge">
<title>rb-&gt;launch</title>
<path fill="none" stroke="#104e8b" d="M366.9283,-145.8051C381.0704,-127.2632 401.3712,-100.6466 416.9878,-80.1715"/>
<polygon fill="#104e8b" stroke="#104e8b" points="419.866,-82.1692 423.1476,-72.0954 414.3001,-77.924 419.866,-82.1692"/>
<text text-anchor="middle" x="432.176" y="-118" font-family="Arial" font-size="10.00" fill="#104e8b">start</text>
<text text-anchor="middle" x="432.176" y="-106" font-family="Arial" font-size="10.00" fill="#104e8b">corrutina 2</text>
<text text-anchor="middle" x="432.176" y="-94" font-family="Arial" font-size="10.00" fill="#104e8b">con launch</text>
</g>
<!-- frb -->
<g id="node6" class="node">
<title>frb</title>
<path fill="#1874cd" stroke="#1874cd" d="M709.419,-190C709.419,-190 618.581,-190 618.581,-190 612.581,-190 606.581,-184 606.581,-178 606.581,-178 606.581,-158 606.581,-158 606.581,-152 612.581,-146 618.581,-146 618.581,-146 709.419,-146 709.419,-146 715.419,-146 721.419,-152 721.419,-158 721.419,-158 721.419,-178 721.419,-178 721.419,-184 715.419,-190 709.419,-190"/>
<text text-anchor="middle" x="664" y="-177" font-family="Arial" font-size="10.00" fill="#ffffff">Corrutina 1 bloqueada</text>
<text text-anchor="middle" x="664" y="-165" font-family="Arial" font-size="10.00" fill="#ffffff">hasta fin Corrutina 2</text>
<text text-anchor="middle" x="664" y="-153" font-family="Arial" font-size="10.00" fill="#ffffff">COMPLETING</text>
</g>
<!-- hola&#45;&gt;frb -->
<g id="edge5" class="edge">
<title>hola-&gt;frb</title>
<path fill="none" stroke="#104e8b" stroke-dasharray="1,5" d="M534.5426,-168C552.8578,-168 575.2989,-168 596.3215,-168"/>
<polygon fill="#104e8b" stroke="#104e8b" points="596.5034,-171.5001 606.5034,-168 596.5034,-164.5001 596.5034,-171.5001"/>
<text text-anchor="middle" x="570.654" y="-186" font-family="Arial" font-size="10.00" fill="#104e8b">Corrutina 1</text>
<text text-anchor="middle" x="570.654" y="-174" font-family="Arial" font-size="10.00" fill="#104e8b">Bloqueada</text>
</g>
<!-- frb&#45;&gt;mainb -->
<g id="edge9" class="edge">
<title>frb-&gt;mainb</title>
<path fill="none" stroke="#104e8b" d="M686.9669,-190.2492C706.0705,-208.7558 733.6079,-235.4327 755.6939,-256.8284"/>
<polygon fill="#104e8b" stroke="#104e8b" points="753.3371,-259.4183 762.9548,-263.8625 758.2077,-254.3906 753.3371,-259.4183"/>
<text text-anchor="middle" x="753.6675" y="-224" font-family="Arial" font-size="10.00" fill="#104e8b">finish</text>
</g>
<!-- mundo -->
<g id="node8" class="node">
<title>mundo</title>
<path fill="#104e8b" stroke="#104e8b" d="M666.3236,-72C666.3236,-72 599.6764,-72 599.6764,-72 593.6764,-72 587.6764,-66 587.6764,-60 587.6764,-60 587.6764,-40 587.6764,-40 587.6764,-34 593.6764,-28 599.6764,-28 599.6764,-28 666.3236,-28 666.3236,-28 672.3236,-28 678.3236,-34 678.3236,-40 678.3236,-40 678.3236,-60 678.3236,-60 678.3236,-66 672.3236,-72 666.3236,-72"/>
<text text-anchor="middle" x="633" y="-59" font-family="Arial" font-size="10.00" fill="#ffffff">delay (1000L)</text>
<text text-anchor="middle" x="633" y="-47" font-family="Arial" font-size="10.00" fill="#ffffff">prinln (&quot;Mundo!&quot;)</text>
<text text-anchor="middle" x="633" y="-35" font-family="Arial" font-size="10.00" fill="#ffffff">ACTIVE</text>
</g>
<!-- launch&#45;&gt;mundo -->
<g id="edge6" class="edge">
<title>launch-&gt;mundo</title>
<path fill="none" stroke="#104e8b" d="M476.1875,-50C510.0101,-50 543.8327,-50 577.6553,-50"/>
<polygon fill="#104e8b" stroke="#104e8b" points="577.6714,-53.5001 587.6714,-50 577.6714,-46.5001 577.6714,-53.5001"/>
</g>
<!-- mundo&#45;&gt;frb -->
<g id="edge7" class="edge">
<title>mundo-&gt;frb</title>
<path fill="none" stroke="#104e8b" d="M638.8047,-72.0954C643.5386,-90.1146 650.2885,-115.8078 655.6105,-136.0659"/>
<polygon fill="#104e8b" stroke="#104e8b" points="652.243,-137.0226 658.1691,-145.8051 659.0133,-135.244 652.243,-137.0226"/>
<text text-anchor="middle" x="664.6675" y="-106" font-family="Arial" font-size="10.00" fill="#104e8b">finish</text>
</g>
</g>
</svg>
</p><p>Tanto el c&#xF3;digo de la <strong>corrutina 1</strong> (bloque <strong><code>runBlocking</code></strong>) y el c&#xF3;digo de la <strong>corrutina 2</strong> (bloque <strong><code>launch</code></strong>) <strong>se ejecutan en el hilo principal de forma concurrente</strong>.</p>
<ol>
<li>Tras el primer <strong><code>runBlocking</code></strong>, el <strong><code>main</code></strong> se queda esperando a que termine la <strong>corrutina 1</strong>, por lo que se <strong>bloquea el hilo principal</strong>.</li>
<li>La <strong>corrutina 1</strong> lanza la <strong>corrutina 2</strong> y sigue ejecutando su c&#xF3;digo <strong><code>println (&quot;Hola&quot;)</code></strong>.</li>
<li>La <strong>corrutina 2</strong> se suspende durante 1 segundo y luego imprime <strong><code>println (&quot;Mundo!&quot;)</code></strong> pero la corrutina 1 ya habr&#xE1; terminado y se habr&#xE1; unido al hilo principal bloqueado que contin&#xFA;a con la ejecuci&#xF3;n del <strong><code>main</code></strong>.</li>
</ol>
<h3 class="mume-header" id="concurrencia-estructurada">Concurrencia estructurada</h3>

<p>Las corrutinas siguen un principio de concurrencia estructurada, lo que significa que solo se pueden lanzar nuevas corrutinas en un <strong><code>CoroutineScope</code></strong> espec&#xED;fico que <strong>delimita la vida &#xFA;til de la corrutina</strong> como ya hemos comentado.</p>
<p>El ejemplo anterior muestra que <strong><code>runBlocking</code></strong> establece el alcance correspondiente y es por eso que el ejemplo anterior espera hasta que <strong><code>Mundo!</code></strong> se imprime despu&#xE9;s de un segundo de retraso y solo entonces sale.</p>
<p>En una aplicaci&#xF3;n real, lanzar&#xE1;s muchas corrutinas. La concurrencia estructurada garantiza que no se pierdan. Un &#xE1;mbito externo no puede completarse hasta que se completen todas sus rutinas secundarias. La simultaneidad estructurada tambi&#xE9;n garantiza que cualquier error en el c&#xF3;digo se informe correctamente y nunca se pierda.</p>
<h3 class="mume-header" id="funciones-de-suspensi%C3%B3n-con-suspend">Funciones de suspensi&#xF3;n con <strong><code>suspend</code></strong></h3>

<p>El c&#xF3;digo de ejemplo est&#xE1; escrito en un solo bloque. <strong>&#xBF;C&#xF3;mo podr&#xED;amos separar en diferentes funciones el bloque de las corrutinas?</strong>.</p>
<p>Si extraemos el bloque de c&#xF3;digo interno de la <strong>corrutina 2</strong> <strong><code>launch { ... }</code></strong> a una funci&#xF3;n separada. Cuando se realiza la refactorizaci&#xF3;n &apos;<em>Extraer funci&#xF3;n</em>&apos; en este c&#xF3;digo, obtiene una nueva funci&#xF3;n con el modificador <strong><code>suspend</code></strong>. Esta es nuestra primera <strong>funci&#xF3;n de suspensi&#xF3;n</strong>.</p>
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 50%">
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    launch <span class="token punctuation">{</span> 
        <span class="token function">doMundo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">doMundo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre></div>
<div style="width: auto">
<img height="275px" src="assets/imagenes/tema_3_7/ejemplo1_refactorizado.png">
</div>
</div>
<p>Las <strong>funciones de suspensi&#xF3;n</strong> se pueden usar dentro de las corrutinas al igual que las funciones normales, pero su caracter&#xED;stica adicional es que, a su vez, pueden usar otras funciones de suspensi&#xF3;n (como <strong><code>delay</code></strong> este ejemplo) para suspender la ejecuci&#xF3;n de una corrutina.</p>
<p>F&#xED;jate que en el c&#xF3;digo del editor, las funciones de suspensi&#xF3;n se muestran con un icono de <em>&apos;flecha suspendida&apos;</em>. Esto es una ayuda visual para distinguir las funciones de suspensi&#xF3;n de las funciones normales indic&#xE1;ndome que el la corrutina se suspender&#xE1; en ese punto y continuar&#xE1; con la ejecuci&#xF3;n cuando finalice dicha funci&#xF3;n.</p>
<blockquote>
<p>&#x270B; <strong>Importante</strong>: Una funci&#xF3;n de suspensi&#xF3;n (<strong><code>suspend</code></strong>), solo puede llamarse dentro de otra funci&#xF3;n de suspensi&#xF3;n o dentro de una corrutina. Si intentas llamar a una funci&#xF3;n de suspensi&#xF3;n desde una funci&#xF3;n normal, el compilador te dar&#xE1; un error.</p>
</blockquote>
<blockquote>
<p>&#x1F4E3; Podemos resumir diciendo que una funci&#xF3;n modificada con <strong><code>suspend</code></strong> (funci&#xF3;n de suspensi&#xF3;n) es una funci&#xF3;n que <strong>solo puede ser ejecutada de forma as&#xED;ncrona</strong> dentro de una corrutina o dentro de otra funci&#xF3;n de suspensi&#xF3;n.</p>
</blockquote>
<h3 class="mume-header" id="profundizando-en-el-constructor-de-alcance-coroutinescope">Profundizando en el constructor de alcance <strong><code>CoroutineScope</code></strong></h3>

<p>Al usar <strong><code>runBlocking</code></strong> o <strong><code>launch</code></strong> dentro de un bloque de c&#xF3;digo, se crea un <strong><code>CoroutineScope</code></strong>. <strong><code>CoroutineScope</code></strong> es una interfaz que representa un &#xE1;mbito de corrutina. <strong>El &#xE1;mbito de corrutina es responsable de cancelar todas las corrutinas que se ejecutan en &#xE9;l cuando se cierra</strong>.</p>
<p>Adem&#xE1;s de los alcances definidos por los constructores que ya hemos definido. Es posible declarar nuestro propio alcance utilizando el constructor <strong><code>coroutineScope</code></strong>. Este crea un alcance de rutina y no se finaliza hasta que todos las corrutinas lanzadas dentro de &#xE9;l no finalicen.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">doMundo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">doMundo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope <span class="token punctuation">{</span>
    launch <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Los constructores <strong><code>runBlocking</code></strong> y <strong><code>coroutineScope</code></strong> pueden parecer similares porque ambos esperan a que se completen su bloque y todos sus corrutinas secundarias. La principal diferencia es que <strong><code>runBlocking</code></strong> <strong>bloquea el hilo actual</strong> en espera, mientras que <strong><code>coroutineScope</code></strong> suspende la corrutina actual liberando el hilo subyacente para otros usos. Por tanto, <strong><code>coroutineScope</code> es una funci&#xF3;n de suspensi&#xF3;n</strong> y solo puede ser llamado dentro de otra funci&#xF3;n de suspensi&#xF3;n o dentro de una corrutina.</p>
<p>Adem&#xE1;s, todas las corrutinas que se ejecuten dentro del mismo <strong><code>CorrutineScope</code></strong> se ejecutar&#xE1;n de forma <strong>concurrente</strong> en el mismo hilo.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">doMundo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope <span class="token punctuation">{</span>
    launch <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo 2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    launch <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo 1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<h3 class="mume-header" id="controlando-el-estado-de-una-corrutina-con-job">Controlando el estado de una corrutina con <strong><code>Job</code></strong></h3>

<p>Cuando lanzamos una corrutina con <strong><code>launch</code></strong>, se devuelve un objeto <strong><code>Job</code></strong> que representa la tarea que se est&#xE1; ejecutando en el contexto de la corrutina. Como ya hemos comentado, podemos usar este objeto para controlar el estado de la corrutina, por ejemplo, para esperarla o cancelarla.</p>
<ul>
<li>
<p><strong><code>job.join()</code></strong>: funci&#xF3;n de suspensi&#xF3;n que espera a que la corrutina termine;</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> job <span class="token operator">:</span> Job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola&quot;</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Fin&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</pre></li>
<li>
<p><strong><code>job.cancelAndJoin()</code></strong>: Notifica al trabajo su cancelaci&#xF3;n y espera a que termine ordenadamente. El trabajo internamente debe verificar peri&#xF3;dicamente el estado de cancelaci&#xF3;n usando la propiedad de solo acceso de del <strong><code>CorrutineScope</code></strong> <strong><code>isActive</code></strong>. Adem&#xE1;s, las funciones de suspensi&#xF3;n cancelables producen <strong><code>CancellationException</code></strong> en la cancelaci&#xF3;n, que se puede controlar de la manera habitual por ejemplo con un finally para realizar las acciones de limpieza necesarias.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> job <span class="token operator">:</span> Job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-var">var</span> nextPrintTime <span class="token operator">=</span> startTime
            <span class="token keyword keyword-var">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// cancellable computation loop</span>
                <span class="token comment">// print a message twice a second</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> nextPrintTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;job: I&apos;m sleeping <span class="token interpolation"><span class="token delimiter variable">${</span>i<span class="token operator">++</span><span class="token delimiter variable">}</span></span> ...&quot;</span><span class="token punctuation">)</span>
                    nextPrintTime <span class="token operator">+=</span> <span class="token number">500L</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-finally">finally</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;job: I&apos;m resuming the execution&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span> <span class="token comment">// Espera un rato</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main: I&apos;m tired of waiting!&quot;</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancelAndJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Cancela el trabajo y espera a que termine</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main: Now I can quit.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Mostrar&#xE1; ...</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>job: I&apos;m sleeping 0 ...
job: I&apos;m sleeping 1 ...
job: I&apos;m sleeping 2 ...
main: I&apos;m tired of waiting!
job: I&apos;m resuming the execution
main: Now I can quit.
</code></pre></li>
<li>
<p><strong><code>withTimeout(timeout: Long) { }</code></strong> Para generar un <strong>contexto de corrutina</strong> que expira despu&#xE9;s de un tiempo determinado generando un evento de cancelaci&#xF3;n y la excepci&#xF3;n <strong><code>TimeoutCancellationException</code></strong>.</p>
<p><strong><code>withTimeout</code></strong> es una <strong>funci&#xF3;n de suspensi&#xF3;n</strong>. Por ejemplo, podemos reescribir el c&#xF3;digo anterior de la siguiente forma:</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=1}" class="language-kotlin" data-line="1"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">trabajoBloqueante</span><span class="token punctuation">(</span>timeout<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> nextPrintTime <span class="token operator">=</span> startTime
        <span class="token keyword keyword-var">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">// Se ejecuta hasta que se cumple el timeout</span>
        <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> nextPrintTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;job: I&apos;m sleeping <span class="token interpolation"><span class="token delimiter variable">${</span>i<span class="token operator">++</span><span class="token delimiter variable">}</span></span> ...&quot;</span><span class="token punctuation">)</span>
                nextPrintTime <span class="token operator">+=</span> <span class="token number">500L</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-finally">finally</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;job: I&apos;m resuming the execution&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main: Waiting for job 1.3 secs.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token function">trabajoBloqueante</span><span class="token punctuation">(</span><span class="token number">1300L</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Espera a que termine o expire el trabajo</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main: Now I can quit.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="1" data-start="1">
</div></div></pre><p>Mostrar&#xE1; ...</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>main: Waiting for job 1.3 secs.
job: I&apos;m sleeping 0 ...
job: I&apos;m sleeping 1 ...
job: I&apos;m sleeping 2 ...
job: I&apos;m resuming the execution
main: Now I can quit.
</code></pre></li>
</ul>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="jobs-as%C3%ADncronos-que-devuelven-un-resultado-asyncawait">Jobs as&#xED;ncronos que devuelven un resultado <strong><code>async/await</code></strong></h3>

<p>Hasta ahora hemos visto que las corrutinas se ejecutan de forma concurrente, pero no hemos visto c&#xF3;mo obtener un resultado de una corrutina. Para ello, podemos usar el constructor <strong><code>async</code></strong>. Este constructor es similar a <strong><code>launch</code></strong>, pero devuelve un objeto <strong><code>Deferred</code></strong> que representa un resultado futuro.</p>
<p><strong><code>Deferred</code></strong> es una <strong>subclase</strong> de <strong><code>Job</code></strong> y, por lo tanto, tambi&#xE9;n se puede cancelar. Adem&#xE1;s, tiene una funci&#xF3;n de suspensi&#xF3;n <strong><code>await()</code></strong> que devuelve el resultado cuando est&#xE1; listo.</p>
<p>Veamos un ejemplo donde tenemos la funci&#xF3;n as&#xED;ncrona <strong><code>esPrimo(n: Long)</code></strong> que devuelve un booleano indicando si el n&#xFA;mero pasado como par&#xE1;metro es primo o no.</p>
<p>Puesto que <strong><code>async</code></strong> debe ejecutarse dentro de un <strong><code>CoroutineScope</code></strong>, lo lanzamos dentro del <strong><code>GlobalScope</code></strong>. <strong><code>GlobalScope</code></strong> es un <strong>alcance global</strong> que no est&#xE1; vinculado a ning&#xFA;n hilo en particular y, por lo tanto, no bloquea el hilo principal.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Aunque en este ejemplo hemos usado <strong><code>GlobalScope</code></strong> para lanzar la corrutina, <strong>no es recomendable usarlo</strong> y solo se ha usado para simplificar el ejemplo. Puedes ver m&#xE1;s informaci&#xF3;n en <a href="https://kotlinlang.org/docs/composing-suspending-functions.html#async-style-functions">https://kotlinlang.org/docs/composing-suspending-functions.html#async-style-functions</a></p>
</div>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">esPirmo</span><span class="token punctuation">(</span>n<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Deferred<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> <span class="token operator">=</span> GlobalScope<span class="token punctuation">.</span><span class="token function">async</span> <span class="token punctuation">{</span>
    n <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> until n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> n <span class="token operator">%</span> it <span class="token operator">==</span> <span class="token number">0L</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> n <span class="token operator">=</span> <span class="token number">1000000007L</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Viendo si es primo el n&#xFA;umero <span class="token interpolation variable">$n</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> job <span class="token operator">:</span> Deferred<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">esPirmo</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Esperando c&#xE1;lculo &quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// Vamos a mostrar un punto cada 100 ms mientras vemos</span>
    <span class="token comment">// si el n&#xFA;mero es primo o no </span>
    <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>job<span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    job<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\nEl numero <span class="token interpolation variable">$n</span> ${if (it) &quot;</span>es<span class="token string">&quot; else &quot;</span>no es<span class="token string">&quot;} primo&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Mostrar&#xE1; ...</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>Viendo si es primo el n&#xFA;mero 1000000007
Esperando c&#xE1;lculo ....................
El numero 1000000007 es primo
</code></pre><h3 class="mume-header" id="dispatchers-e-hilos">Dispatchers e hilos</h3>

<p>Como hemos comentado, el contexto de corrutina incluye un CoroutineDispatcher o <em>&apos;despachador&apos;</em> de corrutina que determina qu&#xE9; subproceso utiliza la corrutina correspondiente para su ejecuci&#xF3;n.</p>
<p>Todos los constructores de corrutinas, como <strong><code>launch</code></strong> y <strong><code>async</code></strong> , aceptan un par&#xE1;metro <strong><code>CoroutineContext</code></strong> <strong>opcional</strong> que se puede usar para especificar expl&#xED;citamente el despachador de la nueva rutina y otros elementos de contexto.</p>
<p>Hay 5 tipos de Dispatchers:</p>
<ul>
<li><strong><code>Dispatchers.Main</code></strong>, este es el hilo principal. A diferencia de los dem&#xE1;s, a veces tenemos que definirlo expl&#xED;citamente (por ejemplo, en el entorno de prueba).</li>
<li><strong><code>Dispatchers.IO</code></strong>, esto para el proceso de Redes y Discos. Cualquier cosa que tenga que ver con la <strong>extracci&#xF3;n o env&#xED;o de datos</strong>.</li>
<li><strong><code>Dispatchers.Default</code></strong>, esto es para cualquier otro subproceso de trabajo que no sea principal (es decir, en segundo plano) y se asigna autom&#xE1;ticamente.</li>
<li><strong><code>Dispatcher.Unconfined</code></strong>, este es un despachador especial que permite que la tarea cambie sus procesos espec&#xED;ficos cuando suspende y reanuda su tarea.</li>
<li><strong><code>newSingleThreadContex</code></strong>, permite al usuario definir sus propios procesos.</li>
</ul>
<p>Cuando <strong><code>launch { ... }</code></strong> se usa sin par&#xE1;metros, hereda el contexto (y por lo tanto el despachador) del CoroutineScope desde el que se inicia. En este caso, hereda el contexto de la corrutina principal que se ejecuta en el hilo principal <strong><code>Dispatchers.Main</code></strong>.</p>
<p>Vamos a definir la siguiente funci&#xF3;n de extensi&#xF3;n para obtener informaci&#xF3;n de nuestro contexto:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
<span class="token string">&quot;\nCorrutina: {\n\tContexto: <span class="token interpolation"><span class="token delimiter variable">${</span><span class="token keyword keyword-this">this</span><span class="token delimiter variable">}</span></span>, \n\tProceso: <span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>\n}&quot;</span>
</pre><p>Si volvemos a ejecutar el ejemplo inicial...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    launch <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo! <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Mostrar&#xE1; ...</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>Hola
Corrutina: {
	Contexto: [BlockingCoroutine{Active}@7d4793a8, BlockingEventLoop@449b2d27], 
	Proceso: main 
}
Mundo! 
Corrutina: {
	Contexto: [StandaloneCoroutine{Active}@1ae369b7, BlockingEventLoop@449b2d27], 
	Proceso: main 
}
</code></pre><p>Ahora modificamos el contexto de la corrutina 2 para que se ejecute en el hilo <strong><code>Dispatchers.Default</code></strong> y adem&#xE1;s le asignamos un nombre ambas corrutinas para poder identificarlas:</p>
<pre data-role="codeBlock" data-info="kotlin  {highlight=2}" class="language-kotlin" data-line="2"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">runBlocking</span><span class="token punctuation">(</span><span class="token function">CoroutineName</span><span class="token punctuation">(</span><span class="token string">&quot;CORRUTINA 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">launch</span> <span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default <span class="token operator">+</span> <span class="token function">CoroutineName</span><span class="token punctuation">(</span><span class="token string">&quot;CORRUTINA 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mundo! <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hola <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div></pre><p>Ahora la salida nos mostrar&#xE1; el nombre de la corrutina y el proceso en el que se ejecuta:</p>
<pre data-role="codeBlock" data-info="cmd {code_chunk_offset=3, highlight=[4,9]}" class="language-cmd" data-line="4,9"><code>Hola 
Corrutina: {
	Contexto: [CoroutineName(CORRUTINA 1), BlockingCoroutine{Active}@1bc6a36e, BlockingEventLoop@1ff8b8f], 
	Proceso: main
}
Mundo! 
Corrutina: {
	Contexto: [CoroutineName(CORRUTINA 2), StandaloneCoroutine{Active}@f4e4ec0, Dispatchers.Default], 
	Proceso: DefaultDispatcher-worker-2
}
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">







<div aria-hidden="true" class="line-highlight" data-range="9" data-start="9">
</div></div></pre><div style="page-break-after:always;"></div>
<h4 class="mume-header" id="cambiando-el-contexto-de-una-corrutina-con-withcontext">Cambiando el contexto de una corrutina con <strong><code>withContext</code></strong></h4>

<p>Podemos cambiar el contexto de una corrutina en cualquier momento usando la funci&#xF3;n de suspensi&#xF3;n <strong><code>withContext</code></strong>. Esta <strong>funci&#xF3;n de suspensi&#xF3;n</strong> crea un nuevo contexto de corrutina con el <em>&apos;dispatcher&apos;</em> especificado y ejecuta el bloque de c&#xF3;digo en &#xE9;l. Cuando el bloque de c&#xF3;digo finaliza, la corrutina vuelve al contexto anterior.</p>
<p>Normalmente, <strong><code>withContext</code></strong> se utiliza en situaciones en las que desea cambiar temporalmente a un contexto de ejecuci&#xF3;n diferente para realizar una operaci&#xF3;n que sea m&#xE1;s apropiada para ese contexto, como realizar una solicitud de red, E/S de disco o c&#xE1;lculos que requieren un uso intensivo de la CPU.</p>
<p>Por ejemplo ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">peticionREST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Dato <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">getDato</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">realizaProcesoPesado</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">proceso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</pre><p>Volvamos al c&#xE1;lculo de n&#xFA;meros primos. Pero esta vez vamos a implementarlo de forma m&#xE1;s adecuada sin usar <strong><code>GlobalScope</code></strong>. Pasando el proceso de ver si un n&#xFA;mero es primo o no, a un contexto diferente con el <strong><code>Dispatcher.Default</code></strong>. Adem&#xE1;s, ahora tanto calcular si un n&#xFA;mero es primo como mostrar el progreso del c&#xE1;lculo se ejecutar&#xE1;n de forma as&#xED;ncrona en procesos diferentes.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;\nCorrutina: {\n\tContexto: <span class="token interpolation"><span class="token delimiter variable">${</span><span class="token keyword keyword-this">this</span><span class="token delimiter variable">}</span></span>, \n\tProceso: <span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>\n}&quot;</span>

<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">esPirmo</span><span class="token punctuation">(</span>n<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Boolean
<span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default <span class="token operator">+</span> <span class="token function">CoroutineName</span><span class="token punctuation">(</span><span class="token string">&quot;ESPRIMO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> until n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">none</span> <span class="token punctuation">{</span> n <span class="token operator">%</span> it <span class="token operator">==</span> <span class="token number">0L</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">muestraProgreso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope<span class="token punctuation">{</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Esperando c&#xE1;lculo &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> CancellationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\nProgreso cancelado <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> n <span class="token operator">=</span> <span class="token number">1000000007L</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Viendo si es primo el n&#xFA;umero <span class="token interpolation variable">$n</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> jobPrimo <span class="token operator">=</span> async <span class="token punctuation">{</span> <span class="token function">esPirmo</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-val">val</span> jobProgreso <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default <span class="token operator">+</span> <span class="token function">CoroutineName</span><span class="token punctuation">(</span><span class="token string">&quot;PROGRESO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">muestraProgreso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;En main esperando a esPrimio() <span class="token interpolation"><span class="token delimiter variable">${</span>coroutineContext<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
    jobPrimo<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\nEl numero <span class="token interpolation variable">$n</span> ${if (it) &quot;</span>es<span class="token string">&quot; else &quot;</span>no es<span class="token string">&quot;} primo&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    jobProgreso<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Mostrar&#xE1; ...</p>
<pre data-role="codeBlock" data-info="cmd" class="language-cmd"><code>Viendo si es primo el n&#xFA;umero 1000000007
En main esperando a esPrimio() 
Corrutina: {
	Contexto: [BlockingCoroutine{Active}@47fd17e3, BlockingEventLoop@7cdbc5d3], 
	Proceso: main
}

Corrutina: {
	Contexto: [CoroutineName(ESPRIMO), DispatchedCoroutine{Active}@472bb070, Dispatchers.Default], 
	Proceso: DefaultDispatcher-worker-2
}

Corrutina: {
	Contexto: [CoroutineName(PROGRESO), ScopeCoroutine{Active}@5931574c, Dispatchers.Default], 
	Proceso: DefaultDispatcher-worker-1
}
Esperando c&#xE1;lculo ..................
El numero 1000000007 es primo

Progreso cancelado 
Corrutina: {
	Contexto: [CoroutineName(PROGRESO), ScopeCoroutine{Cancelling}@5931574c, Dispatchers.Default], 
	Proceso: DefaultDispatcher-worker-2
}
</code></pre><div style="page-break-after:always;"></div>
<h2 class="mume-header" id="corrutinas-en-android">Corrutinas en Android</h2>

<p>Utilizaremos los conceptos ya vistos pero adaptados a Android. Alguna de las cosas que deberemos tener en cuenta son:</p>
<ol>
<li>
<p>&#x274C; No debemos usar <strong><code>runBlocking</code></strong> en el hilo principal porque lo bloquear&#xE1;.En su lugar, podemos usar <strong><code>runBlocking</code></strong> en un hilo secundario.</p>
</li>
<li>
<p>&#x274C; No deber&#xED;amos lanzar corrutinas en el <strong><a href="https://developer.android.com/kotlin/coroutines/coroutines-best-practices#global-scope">GlobalScope</a></strong> porque no se cancelar&#xE1;n autom&#xE1;ticamente cuando se destruya el componente de Android.</p>
</li>
<li>
<p>Las funciones de suspensi&#xF3;n deber&#xED;an ser seguras para su llamada desde el subproceso principal. Por ejemplo, cambiando el contexto de ejecuci&#xF3;n para realizar una solicitud de red con <strong><code>withContext(Dispatchers.IO)</code></strong>.</p>
</li>
<li>
<p>&#x274C; No debemos actualizar la UI desde una corrutina que se ejecute en un contexto diferente al del hilo principal. Deberemos usar <strong><code>withContext(Dispatchers.Main)</code></strong> para cambiar al contexto del hilo principal y actualizar la UI.</p>
</li>
<li>
<p>&#x274C; No debemos lanzar una corrutina que modifique un estado antes de finalizar la composici&#xF3;n de la UI.</p>
</li>
<li>
<p>Si la aplicaci&#xF3;n entra en segundo plano. En aquellos alcances de corrutina que est&#xE9;n vinculados al ciclo de vida de un componente de Android, se cancelar&#xE1;n autom&#xE1;ticamente solo cuando el componente se destruya. Pero si no es as&#xED;, <strong>deberemos cancelar manualmente</strong> las corrutinas que se est&#xE9;n ejecutando en segundo plano si queremos que se paren.</p>
</li>
<li>
<p>&#x274C; No debemos exponer m&#xE9;todos de suspensi&#xF3;n p&#xFA;blicos en el ViewModel. Pero s&#xED; puede lanzar corrutinas en su alcance o mejor exponer flujos de datos que se puedan observar desde la UI.</p>
</li>
</ol>
<h3 class="mume-header" id="coroutinescopes-m%C3%A1s-comunes-en-android">CoroutineScopes m&#xE1;s comunes en Android</h3>

<p>Los alcances (<strong><code>CoroutineScope</code></strong>) de las corrutinas se pueden vincular a los ciclos de vida de los componentes de Android.</p>
<ul>
<li>
<p><strong><code>rememberCoroutineScope()</code></strong> Vinculado al ciclo de vida de un componente de Android como un <strong>Composable</strong>. Se cancela cuando el componente se destruye.</p>
<p><strong>Lo vamos a usar solo cuando queramos ejecutar una acci&#xF3;n sobre un componente tras un evento.</strong> Ejemplo extra&#xED;do de <strong><a href="https://developer.android.com/jetpack/compose/side-effects?hl=es-419#remembercoroutinescope">documentaci&#xF3;n oficial de Android</a></strong>:</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[3-5,12-17]}" class="language-kotlin" data-line="3-5,12-17"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">MoviesScreen</span><span class="token punctuation">(</span>scaffoldState<span class="token operator">:</span> ScaffoldState <span class="token operator">=</span> <span class="token function">rememberScaffoldState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Crea un CoroutineScope vinculado al ciclo de vida de MoviesScreen</span>
    <span class="token comment">// este alcance es recordado en la recomposici&#xF3;n.</span>
    <span class="token keyword keyword-val">val</span> scope <span class="token operator">=</span> <span class="token function">rememberCoroutineScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">Scaffold</span><span class="token punctuation">(</span>scaffoldState <span class="token operator">=</span> scaffoldState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Column <span class="token punctuation">{</span>
            <span class="token comment">/* ... */</span>
            <span class="token function">Button</span><span class="token punctuation">(</span>
                onClick <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Crea una nueva corrutina en el manejador del </span>
                    <span class="token comment">// evento del bot&#xF3;n para mostrar el snackbar asociado al Scaffold</span>
                    scope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
                        <span class="token comment">// showSnackbar es una funci&#xF3;n de suspensi&#xF3;n</span>
                        scaffoldState<span class="token punctuation">.</span>snackbarHostState<span class="token punctuation">.</span><span class="token function">showSnackbar</span><span class="token punctuation">(</span><span class="token string">&quot;Something happened!&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">&quot;Press me&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3-5" data-start="3" data-end="5">


</div></div><div class="line-highlight-wrapper">










<div aria-hidden="true" class="line-highlight" data-range="12-17" data-start="12" data-end="17">





</div></div></pre></li>
</ul>
<div style="page-break-after:always;"></div>
<ul>
<li>
<p><strong><code>viewModelScope</code></strong>: Vinculado al ciclo de vida del <strong>ViewModel</strong>. Se cancela cuando el ViewModel se destruye.</p>
<p>Dentro de cualquier clase que herede de <strong><code>ViewModel</code></strong> dispondremos de la propiedad <strong><code>viewModelScope</code></strong> que ser&#xE1; un CorourineScope vinculado al ciclo de vida del mismo. Crear una corrutina de las formas que hemos visto es tan simple como hacer...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword keyword-val">val</span> deferredJob <span class="token operator">=</span> viewModelScope<span class="token punctuation">.</span><span class="token function">async</span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</pre><p>Recuerda poara crear una corrutina hija dentro de otra corrutina, debemos usar el <strong><code>CoroutineScope</code></strong> de la corrutina padre. Por ejemplo, si queremos lanzar una corrutina desde un <strong>ViewModel</strong> que se ejecute en el hilo principal y que se cancele cuando el ViewModel se destruya, podemos hacerlo de la siguiente forma:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Corrutina hija en el alcance del padre, con su contexto espec&#xED;fico.</span>
    <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>ce<span class="token operator">:</span> CancellationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Manejo de la cancelaci&#xF3;n</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Esperar&#xE1; a que termine la corrutina hija</span>
<span class="token punctuation">}</span>
</pre><p>Para finaliar cualquier corrutina que se est&#xE9; ejecutando en el <strong><code>viewModelScope</code></strong> podemos usar la funci&#xF3;n <strong><code>viewModelScope.cancel()</code></strong> o <strong><code>viewModelScope.coroutineContext.cancelChildren()</code></strong>. Por ejemplo...</p>
<pre data-role="codeBlock" data-info="Kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">paraProceso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cancelar&#xE1; las corrutinas hijas creados dentro de su contexto.</span>
    <span class="token comment">// Provocar&#xE1; la excepci&#xF3;n CancellationException en las corrutinas hijas</span>
    viewModelScope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        
<span class="token punctuation">}</span>
</pre></li>
<li>
<p><strong><code>lifecycleScope</code></strong>: Vinculado al ciclo de vida de un componente de Android como una <strong>Activity</strong>. Se cancela cuando el componente se destruye.<br>
Es id&#xE9;ntico a <strong><code>viewModelScope</code></strong> pero su alcance es una Actividad o Fragment.</p>
</li>
</ul>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="side-effects-y-corrutinas-en-compose">Side-effects y corrutinas en Compose</h3>

<p>Un efecto lateral o side-effect de Compose es un cambio en el estado de la app que ocurre fuera del alcance de una funci&#xF3;n de componibilidad. Puesto que no podemos realizar ning&#xFA;n proceso bloqueante durante la composici&#xF3;n de la UI y adem&#xE1;s no tenemos ning&#xFA;n control sobre el momento, orden y finalizaci&#xF3;n de la misma. En el ejemplo anterior donde hemos visto como podemos usar <strong><code>rememberCoroutineScope()</code></strong> para mostrar una notificaci&#xF3;n en un <strong>Scaffold</strong> tras un evento de click en un bot&#xF3;n. Esto ser&#xED;a un efecto lateral fuera de la composici&#xF3;n de la UI. <strong>Por resumir, cuando un cambio de estado en la UI no lo controla la composici&#xF3;n, sino que necesitemos que sea predecible y as&#xED;nncrono, estaremos ante un efecto lateral</strong>.</p>
<h4 class="mume-header" id="launchedeffect">LaunchedEffect</h4>

<p>Ejecuta funciones de suspensi&#xF3;n en el alcance de un elemento componible.</p>
<p>Por ejemplo, para ejecutar una funci&#xF3;n de suspensi&#xF3;n ante uno o varios cambios de estado.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[6-17]}" class="language-kotlin" data-line="6-17"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">FlechaRotable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-var">var</span> rotationZAnimationSatate <span class="token operator">=</span> remember <span class="token punctuation">{</span> <span class="token function">Animatable</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-var">var</span> rotado <span class="token keyword keyword-by">by</span> remember <span class="token punctuation">{</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// Indico el estado o los estados que provocar&#xE1;n la ejecuci&#xF3;n de </span>
    <span class="token comment">// la o las funciones de suspensi&#xF3;n</span>
    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>rotado<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Estamos dentro de un CorourineScope</span>
        <span class="token comment">// esto se ejecuta de forma as&#xED;ncrona con la composici&#xF3;n de la UI</span>
        <span class="token comment">// por tanto las funcionen de suspensi&#xF3;n no la bloquean.</span>

        <span class="token comment">// Funci&#xF3;n de suspensi&#xF3;n </span>
        rotationZAnimationSatate<span class="token punctuation">.</span><span class="token function">animateTo</span><span class="token punctuation">(</span>
            targetValue <span class="token operator">=</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>rotado<span class="token punctuation">)</span> <span class="token number">180f</span> <span class="token keyword keyword-else">else</span> <span class="token number">0f</span><span class="token punctuation">,</span>
            animationSpec <span class="token operator">=</span> <span class="token function">tween</span><span class="token punctuation">(</span>durationMillis <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span> easing <span class="token operator">=</span> FastOutSlowInEasing<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">Icon</span><span class="token punctuation">(</span>
        painter <span class="token operator">=</span> <span class="token function">rememberVectorPainter</span><span class="token punctuation">(</span>image <span class="token operator">=</span> Icons<span class="token punctuation">.</span>Filled<span class="token punctuation">.</span>ArrowCircleUp<span class="token punctuation">)</span><span class="token punctuation">,</span>
        contentDescription <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
        modifier <span class="token operator">=</span> Modifier
            <span class="token punctuation">.</span><span class="token function">clickable</span> <span class="token punctuation">{</span> rotado <span class="token operator">=</span> <span class="token operator">!</span>rotado <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">graphicsLayer</span> <span class="token punctuation">{</span> rotationZ <span class="token operator">=</span> rotationZAnimationSatate<span class="token punctuation">.</span>value <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-17" data-start="6" data-end="17">











</div></div></pre><blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Si especificamos <strong><code>LaunchedEffect(Unit) { ... }</code></strong> la corrutina se ejecutar&#xE1; solo en la primera composici&#xF3;n del componente.</p>
</blockquote>
<p>Podr&#xED;amos reescribir el c&#xF3;digo de la funci&#xF3;n StateFul anterior gestionando el Side-effect en el manejador del evento con <strong><code>rememberCoroutineScope()</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[5,13-17]}" class="language-kotlin" data-line="5,13-17"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">FlechaRotable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-var">var</span> rotationZAnimationSatate <span class="token operator">=</span> remember <span class="token punctuation">{</span> <span class="token function">Animatable</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-var">var</span> rotado <span class="token keyword keyword-by">by</span> remember <span class="token punctuation">{</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-var">var</span> coroutineScope <span class="token operator">=</span> <span class="token function">rememberCoroutineScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">Icon</span><span class="token punctuation">(</span>
        painter <span class="token operator">=</span> <span class="token function">rememberVectorPainter</span><span class="token punctuation">(</span>image <span class="token operator">=</span> Icons<span class="token punctuation">.</span>Filled<span class="token punctuation">.</span>ArrowCircleUp<span class="token punctuation">)</span><span class="token punctuation">,</span>
        contentDescription <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
        modifier <span class="token operator">=</span> Modifier
            <span class="token punctuation">.</span><span class="token function">clickable</span> <span class="token punctuation">{</span>
                rotado <span class="token operator">=</span> <span class="token operator">!</span>rotado
                coroutineScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
                    rotationZAnimationSatate<span class="token punctuation">.</span><span class="token function">animateTo</span><span class="token punctuation">(</span>
                        targetValue <span class="token operator">=</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>rotado<span class="token punctuation">)</span> <span class="token number">180f</span> <span class="token keyword keyword-else">else</span> <span class="token number">0f</span><span class="token punctuation">,</span>
                        animationSpec <span class="token operator">=</span> <span class="token function">tween</span><span class="token punctuation">(</span>durationMillis <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span> easing <span class="token operator">=</span> FastOutSlowInEasing<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">graphicsLayer</span> <span class="token punctuation">{</span> rotationZ <span class="token operator">=</span> rotationZAnimationSatate<span class="token punctuation">.</span>value <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5" data-start="5">
</div></div><div class="line-highlight-wrapper">











<div aria-hidden="true" class="line-highlight" data-range="13-17" data-start="13" data-end="17">




</div></div></pre><div style="page-break-after:always;"></div>
<h4 class="mume-header" id="cargando-im%C3%A1genes-de-forma-as%C3%ADncrona-coil">Cargando Im&#xE1;genes de forma as&#xED;ncrona (Coil)</h4>

<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Coil es la librer&#xED;a recomendada por Google para cargar im&#xE1;genes en Android con Jetpack Compose. Puedes ver m&#xE1;s informaci&#xF3;n en <strong><a href="https://coil-kt.github.io/coil/compose/">https://coil-kt.github.io/coil/compose/</a></strong></p>
</blockquote>
<p>Para cargar im&#xE1;genes de forma <strong>as&#xED;ncrona</strong> podemos usar la librer&#xED;a <strong><a href="https://coil-kt.github.io/coil/compose/">Coil</a></strong>. Esta librer&#xED;a nos permite cargar im&#xE1;genes desde una URL, un archivo o un recurso de Android. Adem&#xE1;s, nos permite transformar la imagen antes de mostrarla, por ejemplo, para redimensionarla o aplicarle un filtro. Adem&#xE1;s, tambien nos permite <strong>cachear las im&#xE1;genes</strong> para que no tengamos que volver a descargarlas.</p>
<p>Veamos un ejemplo de como cargar una imagen desde una URL:</p>
<ol>
<li>
<p>A&#xF1;adimos la dependencia de Coil al m&#xF3;dulo App de nuestro proyecto:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">dependencies <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;io.coil-kt:coil-compose:2.5.0&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre></li>
<li>
<p>Puesto que vamos a cargar una imagen desde una URL, debemos a&#xF1;adir el permiso de acceso a Internet en el <strong>AndroidManifest.xml</strong>:</p>
<pre data-role="codeBlock" data-info="xml {highlight=[4-6]}" class="language-xml" data-line="4-6"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/apk/res/android<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/tools<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_NETWORK_STATE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_WIFI_STATE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.INTERNET<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4-6" data-start="4" data-end="6">


</div></div></pre></li>
<li>
<p>Ahora ya simplemente deberemos usar el composable <strong><code>AsyncImage</code></strong> que pos proporciona <strong>Coil</strong> con unas propiedades muy similares a las de <strong><code>Image</code></strong> por ejemplo:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">Imagen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">AsyncImage</span><span class="token punctuation">(</span>
    model <span class="token operator">=</span> <span class="token string">&quot;https://www.sportslab.com.au/wp-content/uploads/2023/07/resilientrunner3-wlogoweb.png&quot;</span><span class="token punctuation">,</span>
    contentDescription <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    contentScale <span class="token operator">=</span> ContentScale<span class="token punctuation">.</span>Crop<span class="token punctuation">,</span>
    modifier <span class="token operator">=</span> Modifier
        <span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>CircleShape<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</pre><p>F&#xED;jate que donde pone model es donde especificamos la URL de la imagen. Pero tambi&#xE9;n podr&#xED;amos hacer <strong><code>model = R.drawable.imagen</code></strong> o <strong><code>model = File(&quot;ruta de la imagen&quot;)</code></strong>, etc. (<strong><a href="https://coil-kt.github.io/coil/getting_started/#supported-data-types">Ver documentaci&#xF3;n</a></strong>).</p>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="ejemplo-de-uso-de-corrutinas-en-android">Ejemplo de uso de corrutinas en Android</h3>

<blockquote>
<p>&#x1F517; <strong>Dercarga</strong>: El proyecto con el c&#xF3;digo del ejemplo que vamos a ver lo puedes descargar de este <strong><a href="assets/codigo/tema_3_7/corrutinas_android_ejemplo.zip">enlace</a></strong></p>
</blockquote>
<p>Es la t&#xED;pica aplicaci&#xF3;n donde vamos a tener dos corrutinas a modo de corredores. Cada corredor se ejecutar&#xE1; en un hilo diferente y se mostrar&#xE1; su progreso en la UI. Adem&#xE1;s, tendremos un bot&#xF3;n para <strong>Empezar</strong> y <strong>Parar</strong> la carrera y otro que <strong>Reiniciar&#xE1;</strong> la carrera y estar&#xE1; activo solo cuando la carrera est&#xE9; parada. Adem&#xE1;s, al llegar ambos corredores al final del progreso la carrera parar&#xE1; autom&#xE1;ticamente. Tambi&#xE9;n parar&#xE1; autom&#xE1;ticamente si la aplicaci&#xF3;n pasa a segundo plano.</p>
<div style="display: flex; justify-content: space-around; align-items: center; margin-top: 15px; margin-bottom: 15px">
<img height="330px" src="assets/imagenes/tema_3_7/ejemplo_inicio.png">
<img height="330px" src="assets/imagenes/tema_3_7/ejemplo_corriendo.png">
<img height="330px" src="assets/imagenes/tema_3_7/ejemplo_pausa.png">
<img height="330px" src="assets/imagenes/tema_3_7/ejemplo_fin_carrera.png">
</div>
<p>En primer lugar en el paquete <strong><code>com.ejemplo_corrutinas.utilities</code></strong> hemos definido el fuente CoroutinesDebug.kt que nos permitir&#xE1; mostrar informaci&#xF3;n de las corrutinas en el Logcat. Para ello, hemos definido la siguiente funci&#xF3;n de extensi&#xF3;n a usar en un contexto de corrutina:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> CoroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    corrutina<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Corrutina&quot;</span><span class="token punctuation">,</span>
    accion<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;No especificada&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
        Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> corrutina<span class="token punctuation">,</span>
        <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>corrutina<span class="token delimiter variable">}</span></span>: {\n\tAccion: <span class="token interpolation"><span class="token delimiter variable">${</span>accion<span class="token delimiter variable">}</span></span>, \n\tContexto: <span class="token interpolation"><span class="token delimiter variable">${</span><span class="token keyword keyword-this">this</span><span class="token delimiter variable">}</span></span>\n}&quot;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>En el paquete <strong><code>com.ejemplo_corrutinas.ui.features.seguimientocarrera</code></strong> defiuniremos la pantalla de prueba de nuestra aplicaci&#xF3;n. El interfaz del componente de la pantalla ser&#xE1; el siguiente:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">SeguimientoCarreraScreen</span><span class="token punctuation">(</span>
    corredor1<span class="token operator">:</span> CorredorUiState<span class="token punctuation">,</span>
    corredor2<span class="token operator">:</span> CorredorUiState<span class="token punctuation">,</span>
    enCarrera<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    onSeguimientoCarreraEvent<span class="token operator">:</span> <span class="token punctuation">(</span>SeguimientoCarreraEvent<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">,</span>
    modifier<span class="token operator">:</span> Modifier <span class="token operator">=</span> Modifier
<span class="token punctuation">)</span>
</pre><div style="page-break-after:always;"></div>
<p>Donde el estado de cada corredor se representar&#xE1; por la siguiente clase:</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=7}" class="language-kotlin" data-line="7"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">CorredorUiState</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> porcentajeProgreso <span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Funci&#xF3;n de suspensi&#xF3;n que simula el avance del corredor en la</span>
    <span class="token comment">// carrera bloquer&#xE1; la corrutina con una espera entre 5 y 300 ms</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">avanza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CorredorUiState <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token operator">..</span><span class="token number">300L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> nuevoPorcentaje <span class="token operator">=</span> porcentajeProgreso <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword keyword-return">return</span> <span class="token function">copy</span><span class="token punctuation">(</span>porcentajeProgreso <span class="token operator">=</span> nuevoPorcentaje<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">reinicia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CorredorUiState <span class="token operator">=</span> <span class="token function">copy</span><span class="token punctuation">(</span>porcentajeProgreso <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7" data-start="7">
</div></div></pre><p>Adem&#xE1;s, dispondremos de un <em>&apos;State&apos;</em> <strong><code>enCarrera</code></strong> que me indicar&#xE1; si se est&#xE1; corriendo la carrera o no. Y un <strong><code>onSeguimientoCarreraEvent</code></strong> que ser&#xE1; el manejador de eventos de la pantalla y donde se controla la pulsaci&#xF3;n de ambos botones.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-sealed">sealed</span> <span class="token keyword keyword-interface">interface</span> SeguimientoCarreraEvent <span class="token punctuation">{</span>
    <span class="token keyword keyword-data">data</span> <span class="token keyword keyword-object">object</span> OnEmpezarPararClick <span class="token operator">:</span> SeguimientoCarreraEvent
    <span class="token keyword keyword-data">data</span> <span class="token keyword keyword-object">object</span> OnReiniciarClick <span class="token operator">:</span> SeguimientoCarreraEvent
<span class="token punctuation">}</span>
</pre><p>Podemos crear un <strong><code>@Preview</code></strong> de test similar a la carrera con corrutinas. Pero como se trata de un composable deberemos usar <strong><code>LaunchesEffect</code></strong> para ejecutar la simulaci&#xF3;n de la carrera en un <strong><code>CoroutineScope</code></strong> dentro de la composici&#xF3;n de dicho <em>preview</em> de prueba</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Preview</span>
<span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">SeguimientoCarreraScreenPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Creamos los estados a usar en la UI</span>
    <span class="token keyword keyword-var">var</span> corredor1 <span class="token keyword keyword-by">by</span> remember <span class="token punctuation">{</span>
        <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token function">CorredorUiState</span><span class="token punctuation">(</span>nombre <span class="token operator">=</span> <span class="token string">&quot;Corredor 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-var">var</span> corredor2 <span class="token keyword keyword-by">by</span> remember <span class="token punctuation">{</span>
        <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token function">CorredorUiState</span><span class="token punctuation">(</span>nombre <span class="token operator">=</span> <span class="token string">&quot;Corredor 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-var">var</span> enCarrera <span class="token keyword keyword-by">by</span> remember <span class="token punctuation">{</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token operator">..</span><span class="token punctuation">.</span>
</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Cada vez que hay un cambio en uno de estos estados se recompone la UI</span>
    <span class="token comment">// y se lanza el LaunchedEffect con las corrutinas de simulaci&#xF3;n de la carrera</span>
    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>
        key1 <span class="token operator">=</span> enCarrera<span class="token punctuation">,</span>
        key2 <span class="token operator">=</span> corredor1<span class="token punctuation">.</span>porcentajeProgreso<span class="token punctuation">,</span>
        key3 <span class="token operator">=</span> corredor2<span class="token punctuation">.</span>porcentajeProgreso
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cada corrutina hara que avance el corredor cambiando su estado</span>
        <span class="token comment">// y por tanto recomponinedo la UI y relanzando el LaunchedEffect</span>
        <span class="token comment">// Ambos procesos se ejecutan en un contexto de corrutina diferente</span>
        <span class="token comment">// con Dispatchers.Default para que el sistema decida el hilo m&#xE1;s adecuado para el preview</span>
        <span class="token keyword keyword-val">val</span> jobCorredor1 <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>enCarrera <span class="token operator">&amp;&amp;</span> corredor1<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
                corredor1 <span class="token operator">=</span> corredor1<span class="token punctuation">.</span><span class="token function">avanza</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-val">val</span> jobCorredor2 <span class="token operator">=</span> <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>enCarrera <span class="token operator">&amp;&amp;</span> corredor2<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
                corredor2 <span class="token operator">=</span> corredor2<span class="token punctuation">.</span><span class="token function">avanza</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Esperamos a que los dos correodres avancen si lo tienen que hacer</span>
        <span class="token function">joinAll</span><span class="token punctuation">(</span>jobCorredor1<span class="token punctuation">,</span> jobCorredor2<span class="token punctuation">)</span>
        <span class="token comment">// Si ambos corredores han llegado al 100% paramos la carrera</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>corredor1<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">==</span> <span class="token number">100</span> <span class="token operator">&amp;&amp;</span> corredor2<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span>
            enCarrera <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
</pre><p>Por &#xFA;iltimo, definimos el componente de nuestra pantalla...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token operator">..</span><span class="token punctuation">.</span>
    EjemploCorrutinasTheme <span class="token punctuation">{</span>
        Surface <span class="token punctuation">{</span>
            <span class="token function">SeguimientoCarreraScreen</span><span class="token punctuation">(</span>
                corredor1 <span class="token operator">=</span> corredor1<span class="token punctuation">,</span> 
                corredor2 <span class="token operator">=</span> corredor2<span class="token punctuation">,</span>
                enCarrera <span class="token operator">=</span> enCarrera<span class="token punctuation">,</span>
                onSeguimientoCarreraEvent <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        SeguimientoCarreraEvent<span class="token punctuation">.</span>OnEmpezarPararClick <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            enCarrera <span class="token operator">=</span> <span class="token operator">!</span>enCarrera
                        <span class="token punctuation">}</span>
                        SeguimientoCarreraEvent<span class="token punctuation">.</span>OnReiniciarClick <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            corredor1 <span class="token operator">=</span> corredor1<span class="token punctuation">.</span><span class="token function">reinicia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            corredor2 <span class="token operator">=</span> corredor2<span class="token punctuation">.</span><span class="token function">reinicia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<p>Bien, ahora vamos a definir un <strong>ViewModel</strong> para nuestro Screen y realizar el proceso de la carrera en el mismo. La cosa va a cambiar &apos;<em>un poco</em>&apos; puesto que las corrutinas se lanzar&#xE1;n desde ahora desde un <strong><code>CoroutineScope</code></strong> distinto al de la composici&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> SeguimientoCarreraViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Definimos los estados de la UI</span>
    <span class="token keyword keyword-var">var</span> corredor1 <span class="token keyword keyword-by">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span>
        <span class="token function">CorredorUiState</span><span class="token punctuation">(</span>nombre <span class="token operator">=</span> <span class="token string">&quot;Corredor 1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-set">set</span>
    <span class="token keyword keyword-var">var</span> corredor2 <span class="token keyword keyword-by">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span>
        <span class="token function">CorredorUiState</span><span class="token punctuation">(</span>nombre <span class="token operator">=</span> <span class="token string">&quot;Corredor 2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-set">set</span>
    <span class="token keyword keyword-var">var</span> enCarrera <span class="token keyword keyword-by">by</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-set">set</span>

    <span class="token comment">// Gesti&#xF3;n de los eventos del Screen</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onSeguimientoCarreraEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> SeguimientoCarreraEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SeguimientoCarreraEvent<span class="token punctuation">.</span>OnEmpezarPararClick <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>enCarrera<span class="token punctuation">)</span>
                    <span class="token comment">// Cambiamos el estado de enCarrera = false</span>
                    <span class="token comment">// y paramos las corrutinas que avanzan cambiando </span>
                    <span class="token comment">// el valor del estado del progreso</span>
                    <span class="token function">pararDeCorrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-else">else</span>
                    <span class="token comment">// Cambiamos el estado de enCarrera = false</span>
                    <span class="token comment">// e iniciamos las corrutinas que avanzan cambiando </span>
                    <span class="token comment">// el valor del estado del progreso</span>
                    <span class="token function">empezarACarrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            SeguimientoCarreraEvent<span class="token punctuation">.</span>OnReiniciarClick <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Ojo no deber&#xED;a llamar a Reiniciar si estoy en carrera</span>
                <span class="token comment">// ya que una corrutina suspendida en delay puede actualizar</span>
                <span class="token comment">// el estado de la UI tras el reset. Esto es porque guarda un</span>
                <span class="token comment">// el valor de un estado inmutable de la UI anterior.</span>
                corredor1 <span class="token operator">=</span> corredor1<span class="token punctuation">.</span><span class="token function">reinicia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                corredor2 <span class="token operator">=</span> corredor2<span class="token punctuation">.</span><span class="token function">reinicia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">pararDeCorrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cancelo las corrutinas hijas que se est&#xE9;n ejecutando</span>
        <span class="token comment">// en el contexto del viewModelScope que en mi caso son</span>
        <span class="token comment">// los dos corredores.</span>
        <span class="token comment">// Si tuviera m&#xE1;s corrutinas, tendr&#xE1; que guardarme los trabajos</span>
        <span class="token comment">// como propiedades privadas en el ViewModel y bucarlos en el</span>
        <span class="token comment">// contexto para cancelarlos de forma espec&#xED;fica.</span>
        viewModelScope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;CARRERA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Parando corredores...&quot;</span><span class="token punctuation">)</span>
        viewModelScope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
</pre><div style="page-break-after:always;"></div>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Lanza una corrutina que simula el avance de un corredor</span>
    <span class="token comment">// para ello recibe el estado inicial del corredor que se guarda en el VM</span>
    <span class="token comment">// una funci&#xF3;n que actualiza el estado de la UI</span>
    <span class="token comment">// Devolver&#xE1; un Job que se puede usar para cancelar la corrutina o esperar a que termine</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">lanzaCorredor</span><span class="token punctuation">(</span>
        estadoInicialCorredor<span class="token operator">:</span> CorredorUiState<span class="token punctuation">,</span>
        actualizaEstadoUi<span class="token operator">:</span> <span class="token punctuation">(</span>CorredorUiState<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit
    <span class="token punctuation">)</span><span class="token operator">:</span> Job <span class="token operator">=</span> launch <span class="token punctuation">{</span>
        <span class="token comment">// Guardamos el estado inicial del corredor en una variable mutable</span>
        <span class="token comment">// donde se ir&#xE1; actualizando el estado del corredor de forma local</span>
        <span class="token comment">// este estado servir&#xE1; para actualizar el estado de la UI del corredor correspondiente</span>
        <span class="token keyword keyword-var">var</span> estadoCorredorLocal <span class="token operator">=</span> estadoInicialCorredor
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            coroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;CARRERA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Corredor <span class="token interpolation"><span class="token delimiter variable">${</span>estadoCorredorLocal<span class="token punctuation">.</span>nombre<span class="token delimiter variable">}</span></span> corriendo&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>estadoCorredorLocal<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                estadoCorredorLocal <span class="token operator">=</span> estadoCorredorLocal<span class="token punctuation">.</span><span class="token function">avanza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// SUSPEND FUN</span>
                <span class="token function">actualizaEstadoUi</span><span class="token punctuation">(</span>estadoCorredorLocal<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            coroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;CARRERA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>estadoCorredorLocal<span class="token punctuation">.</span>nombre<span class="token delimiter variable">}</span></span> est&#xE1; en meta&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>ce<span class="token operator">:</span> CancellationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            coroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;CARRERA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>estadoCorredorLocal<span class="token punctuation">.</span>nombre<span class="token delimiter variable">}</span></span> se para&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">empezarACarrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token comment">// Lanzo una corrutina con el alcance en el que se encuentra el ViewModel</span>
        <span class="token comment">// y con el contexto de Dispatchers.Default</span>
        viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Si alguno de los corredores no ha llegado a la meta, sigo en carrera</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>corredor1<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">!=</span> <span class="token number">100</span> <span class="token operator">||</span> corredor2<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">!=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enCarrera <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-val">val</span> jobCorredor1 <span class="token operator">=</span> <span class="token function">lanzaCorredor</span><span class="token punctuation">(</span>corredor1<span class="token punctuation">)</span> <span class="token punctuation">{</span> corredor1 <span class="token operator">=</span> it <span class="token punctuation">}</span>
                    <span class="token keyword keyword-val">val</span> jobCorredor2 <span class="token operator">=</span> <span class="token function">lanzaCorredor</span><span class="token punctuation">(</span>corredor2<span class="token punctuation">)</span> <span class="token punctuation">{</span> corredor2 <span class="token operator">=</span> it <span class="token punctuation">}</span>
                    <span class="token comment">// Espero a que terminen las dos corrutinas o bien</span>
                    <span class="token comment">// porque alguno de los corredores ha llagado a la meta</span>
                    <span class="token comment">// o bien porque se han cancelado las corrutinas</span>
                    <span class="token function">joinAll</span><span class="token punctuation">(</span>jobCorredor1<span class="token punctuation">,</span> jobCorredor2<span class="token punctuation">)</span> <span class="token comment">// SUSPEND FUN</span>
                    <span class="token comment">// Si los dos corredores han llegado a la meta, termino la carrera</span>
                    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>corredor1<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">==</span> <span class="token number">100</span> <span class="token operator">&amp;&amp;</span> corredor2<span class="token punctuation">.</span>porcentajeProgreso <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span>
                        enCarrera <span class="token operator">=</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>ce<span class="token operator">:</span> CancellationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    enCarrera <span class="token operator">=</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
                viewModelScope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;CARRERA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Corredores parados&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<p>Por &#xFA;ltimo, vamos a examinar el c&#xF3;digo en la MainActivity.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> MainActivity <span class="token operator">:</span> <span class="token function">ComponentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Definimos el ViewModel como propiedad delegada y as&#xED; usarla en</span>
    <span class="token comment">// los m&#xE9;todos del ciclo de vida de la actividad</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> vm <span class="token keyword keyword-by">by</span> viewModels<span class="token operator">&lt;</span>SeguimientoCarreraViewModel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        setContent <span class="token punctuation">{</span>
            EjemploCorrutinasTheme <span class="token punctuation">{</span>
                <span class="token function">Surface</span><span class="token punctuation">(</span>
                    modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    color <span class="token operator">=</span> MaterialTheme<span class="token punctuation">.</span>colorScheme<span class="token punctuation">.</span>background
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">SeguimientoCarreraScreen</span><span class="token punctuation">(</span>
                        corredor1 <span class="token operator">=</span> vm<span class="token punctuation">.</span>corredor1<span class="token punctuation">,</span>
                        corredor2 <span class="token operator">=</span> vm<span class="token punctuation">.</span>corredor2<span class="token punctuation">,</span>
                        enCarrera <span class="token operator">=</span> vm<span class="token punctuation">.</span>enCarrera<span class="token punctuation">,</span>
                        onSeguimientoCarreraEvent <span class="token operator">=</span> vm<span class="token operator">::</span>onSeguimientoCarreraEvent
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Al pausar la actividad por cualquier motivo, paramos la carrera</span>
    <span class="token comment">// a trav&#xE9;s del ViewModel que es quine gestiona las corrutinas de la misma</span>
    <span class="token comment">// Ten en cuenta que el Accance del ViewModel sigue vivo aunque la actividad</span>
    <span class="token comment">// est&#xE9; pausada y por tanto los corredores seguir&#xE1;n corriendo</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        vm<span class="token punctuation">.</span><span class="token function">pararDeCorrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Si quisieramos que la carrera empezara nada m&#xE1;s iniciarse la actividad, podr&#xED;amos hacerlo en el m&#xE9;todo <strong><code>onStart</code></strong> de la actividad. Donde ya sabemos que se ha creado la UI y por tanto podemos modificar el estado de la misma.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span><span class="token function">empezarACarrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre>
      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>