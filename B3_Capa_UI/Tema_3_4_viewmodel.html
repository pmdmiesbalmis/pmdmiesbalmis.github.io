<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 3.4 - ViewModel</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p,html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  300px/2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="tema-34---viewmodel">Tema 3.4 - ViewModel</h1>

<p>Descargar estos apuntes <a href="./Tema_3_4_viewmodel.pdf">pdf</a> o <a href="./Tema_3_4_viewmodel.html">html</a></p>
<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>


<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#introducci&#xF3;n" class="md-toc-link"><p>Introducci&#xF3;n</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#alcance-de-un-viewmodel-viewmodel-scope" class="md-toc-link"><p>Alcance de un ViewModel (ViewModel Scope)</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ciclo-de-vida-de-un-viewmodel" class="md-toc-link">
            <p>Ciclo de vida de un ViewModel</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#instanciando-un-viewmodel" class="md-toc-link">
            <p>Instanciando un ViewModel</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ejemplo-de-uso-y-definici&#xF3;n-de-un-viewmodel" class="md-toc-link">
            <p>Ejemplo de uso y definici&#xF3;n de un ViewModel</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#hand-pr&#xE1;cticas-no-recomendadas" class="md-toc-link">
            <p>&#x270B; Pr&#xE1;cticas no recomendadas</p>

          </a></div>
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h2>

<p>En anteriores temas cuando hablamos de la <strong>arquitectura de aplicaciones de Android</strong> ya mencionamos este componente como parte de la Capa de UI. En este tema vamos a centrarnos en &#xE9;l para concretar la implementaci&#xF3;n de MVVM en nuestra capa UI de la arquitectura.</p>
<p><strong><code>ViewModel</code></strong> es una de esas clases que <strong>Google</strong> defini&#xF3;, all&#xE1; por 2018, en la primera versi&#xF3;n de <strong>Jetpack</strong> para ayudar a los desarrolladores a crear aplicaciones de Android m&#xE1;s robustas y f&#xE1;ciles de mantener. <strong><code>ViewModel</code></strong> es una clase que est&#xE1; <strong>dise&#xF1;ada para almacenar y administrar datos relacionados con la interfaz de usuario de una manera que sobrevive a los cambios de configuraci&#xF3;n</strong>, como la rotaci&#xF3;n de la pantalla.</p>
<p>Los beneficios clave de la clase ViewModel son b&#xE1;sicamente dos:</p>
<ul>
<li>Te permite conservar el estado de la IU.</li>
<li>Proporciona acceso a la l&#xF3;gica empresarial, idealmente a trav&#xE9;s de casos de uso definidos en el dominio.</li>
</ul>
<h3 class="mume-header" id="alcance-de-un-viewmodel-viewmodel-scope">Alcance de un ViewModel (ViewModel Scope)</h3>

<p>Cuando se crea una instancia de <strong><code>ViewModel</code></strong>, se pasa un objeto que implementa la interfaz <strong><code>ViewModelStoreOwner</code></strong>.</p>
<p>Los objetos que implementan <strong><code>ViewModelStoreOwner</code></strong> puede ser por ejemplo:</p>
<ul>
<li>Una <strong><code>Activity</code></strong> o <strong><code>ComponentActivity</code></strong>.</li>
<li>Un <strong><code>Fragment</code></strong>.</li>
<li>Un destino de Navigation <strong><code>NavBackStackEntry</code></strong>.</li>
</ul>
<blockquote>
<p>&#x270B; <strong>Importante</strong>: El alcance de tu ViewModel se define en el Ciclo de vida del <strong><code>ViewModelStoreOwner</code></strong>. Esto es, Contin&#xFA;a en la memoria hasta que su <strong><code>ViewModelStoreOwner</code></strong> desaparece de forma permanente.</p>
</blockquote>
<p>Cuando se destruye el fragmento o la actividad para los que se defini&#xF3; el alcance del ViewModel, el trabajo as&#xED;ncrono contin&#xFA;a en el ViewModel espec&#xED;fico. Esta es la clave de la persistencia.</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Cuando se defini&#xF3; la clase <strong><code>ViewModel</code></strong> en la primera versi&#xF3;n de <strong>Jetpack</strong>, a&#xFA;n no existia <strong>Compose</strong> y se usaba asociado a una vista como un <strong><code>Activity</code></strong> o a un <strong><code>Fragment</code></strong>. Nuestras aplicaciones de Android se compon&#xED;an de una o m&#xE1;s <strong><code>Activity</code></strong> o <strong><code>Fragment</code></strong> y cada uno de ellos ten&#xED;a su propio <strong><code>ViewModel</code></strong> que se creaba como una <strong>instancia &#xFA;nica</strong>. <strong><code>ViewModel</code></strong> se usaba para almacenar datos que se necesitaban en la interfaz de usuario de la <strong><code>Activity/Fragment</code></strong> o el <strong><code>Fragment</code></strong> y quer&#xED;amos que sobrevivieran a los cambios de configuraci&#xF3;n o quer&#xED;amos compartir datos entre ellos.</p>
<p>Con la llegada de <strong>Jetpack Compose</strong> este enfoque ha cambiado y Google ahora <strong>recomienda aplicaciones de actividad &#xFA;nica</strong> donde las diferentes pantallas se cargan como contenido dentro de la misma actividad. Por tanto, un ViewModel utilizado por una actividad permanece en memoria hasta que la actividad finalice esto es hasta que la aplicaci&#xF3;n finalice.</p>
</blockquote>
<h4 class="mume-header" id="ciclo-de-vida-de-un-viewmodel">Ciclo de vida de un ViewModel</h4>

<ul>
<li>En el caso de una <strong><code>Activity</code></strong>, hasta que termina. (<strong>El m&#xE1;s com&#xFA;n</strong>)</li>
<li><s>En el caso de un <strong><code>Fragment</code></strong>, cuando se desvincula.</s> (No se usa en Compose)</li>
<li>En el caso de un <strong><code>NavBackStackEntry</code></strong>, hasta volvemos atr&#xE1;s en el grafo.</li>
</ul>
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 65%">
<p>En la imagen de la derecha vemos que el objeto <strong><code>ViewModel</code></strong> cuyo <strong>&apos;<em>propietario</em>&apos;</strong> (el <strong><code>ViewModelStoreOwner</code></strong>) es una <strong><code>Activity</code></strong> que tiene un cambio de configuraci&#xF3;n (rotaci&#xF3;n de pantalla) y por tanto se destruye y vuelve a crearse su vista asociada.</p>
<ol>
<li>
<p>Se crea al llamarse al m&#xE9;todo <strong><code>onCreate()</code></strong> de la <strong><code>Activity</code></strong> <strong>solo la primera vez</strong> y aunque se vuelva a llamar a <strong><code>onCreate()</code></strong> por un cambio de configuraci&#xF3;n, <strong>no se vuelve a crear</strong> permanece el mismo objeto <strong><code>ViewModel</code></strong> que se cre&#xF3; en la primera llamada.</p>
</li>
<li>
<p><strong>No se destruye</strong> aunque la <strong><code>Activity</code></strong>, destruya su vista y permanece en memoria hasta la finalizaci&#xF3;n de la <strong><code>Activity</code></strong>. En ese momento se llama al m&#xE9;todo <strong><code>onCleared()</code></strong> del <strong><code>ViewModel</code></strong> para que realice las tareas de limpieza necesarias.</p>
</li>
</ol>
</div>
<div style="width: auto">
    <img height="350px" src="assets/imagenes/tema_3_4/viewmodel-lifecycle.png">
</div>
</div>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="instanciando-un-viewmodel">Instanciando un ViewModel</h3>

<p>Hay muchas formas de instanciarlo y eso nos puede llevar a confusi&#xF3;n. Pero nosotros vamos a usar la m&#xE1;s sencilla y recomendada por Google. De todas formas, si quieres profundizar puedes ver el siguiente <em><strong><a href="https://developer.android.com/static/images/topic/libraries/architecture/viewmodel-apis-cheatsheet.png?hl=es-419">&apos;cheatsheet&apos;</a></strong></em> creado por los desarrolladores de Google.</p>
<ol>
<li>
<p>Para definirlo deberemos crear una clase que herede de <strong><code>ViewModel</code></strong> y que implemente la l&#xF3;gica de negocio que necesitemos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> MiViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</pre></li>
<li>
<p>&#x274C; <strong>No debemos hacer jam&#xE1;s una instancia direcra</strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-val">val</span> miVm <span class="token operator">=</span> <span class="token function">MiViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//&#x1F480;&#x1F480;</span>
</pre><p>Ya queel ciclo de vida de un ViewModel est&#xE1; asociado a un <strong><code>ViewModelStoreOwner</code></strong> y por tanto es la clase <strong><code>ViewModelProvider</code></strong> la que se encarga de crearlo y mantenerlo en memoria.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// activity es el objeto que implementa ViewModelStoreOwner</span>
<span class="token keyword keyword-val">val</span> miVm <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MiViewModel<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</pre><blockquote>
<p>&#x270B; <strong>Importante</strong>: Sin embargo nosotros <strong>no tendremos que crearlo as&#xED; nunca</strong> pues <strong>Jetpack</strong> nos proporciona formas m&#xE1;s sencillas de hacerlo.</p>
</blockquote>
</li>
<li>
<p>&#x26A0;&#xFE0F; Como en el fondo deber&#xED;a ser <strong><code>ViewModelProvider</code></strong> quien lo cree, <strong>si pasamos par&#xE1;metros al constructor</strong> de la clase <strong><code>MiViewModel</code></strong>, no podremos tendremos forma m&#xE1;s sencilla de crearlo. Por tanto, de momento, no deber&#xED;amos pasar par&#xE1;metros al constructor.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">MiViewModel</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> param<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>  <span class="token comment">//&#x1F480;&#x1F480;</span>
</pre><p>Si necesit&#xE1;ramos pasar par&#xE1;metros al constructor, deberemos crear una clase que implemente <strong><code>ViewModelProvider.Factory</code></strong> y que se encargue de crear el objeto <strong><code>MiViewModel</code></strong> como se indica en la <strong><a href="https://developer.android.com/topic/libraries/architecture/viewmodel/viewmodel-factories?hl=es-419">documentaci&#xF3;n oficial</a></strong>.</p>
<blockquote>
<p>&#x270B; <strong>Importante</strong>: Ya veremos m&#xE1;s adelante que la librer&#xED;a <strong>Hilt</strong> (Jetpack) para inyecci&#xF3;n de dependencias me facilita mucho esta tarea. As&#xED; pues, no tendremos nunca que crear una clase que implemente <strong><code>ViewModelProvider.Factory</code></strong> cuando pasemos par&#xE1;metros.</p>
</blockquote>
 <div style="page-break-after:always;"></div>
</li>
<li>
<p>Delegado  de creaci&#xF3;n <strong><code>by viewModels()</code></strong>, si el propietario es una <strong><code>Activity</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[2-7,12-16]}" class="language-kotlin" data-line="2-7,12-16"><span class="token keyword keyword-class">class</span> MainActivity <span class="token operator">:</span> <span class="token function">ComponentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Opci&#xF3;n 1</span>
    <span class="token comment">// Lo defino como propiedad de la clase y delego su creaci&#xF3;n que ser&#xE1; al ser usado por </span>
    <span class="token comment">// primera vez despu&#xE9;s de llamarse el m&#xE9;todo onCreate() de la Activity y puede ser </span>
    <span class="token comment">// accedido desde cualquier m&#xE9;todo de la Activity que usemos despu&#xE9;s del onCreate()</span>
    <span class="token comment">// El delegado internamente llama a ViewModelProvider</span>
    <span class="token keyword keyword-val">val</span> miVm<span class="token operator">:</span> MiViewModel <span class="token keyword keyword-by">by</span> <span class="token function">viewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>

        <span class="token comment">// Opci&#xF3;n 2</span>
        <span class="token comment">// Lo defino en el m&#xE9;todo onCreate() y lo clausuramos al definir el &#xE1;rbol de composici&#xF3;n.</span>
        <span class="token comment">// seguir&#xE1; siendo destruido por ViewModelProvider al destruirse la </span>
        <span class="token comment">// Activity que es el ViewModelStoreOwner</span>
        <span class="token keyword keyword-val">val</span> miVm<span class="token operator">:</span> MiViewModel <span class="token keyword keyword-by">by</span> <span class="token function">viewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        setContent <span class="token punctuation">{</span>
            <span class="token comment">// Clausura de miVm</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2-7" data-start="2" data-end="7">





</div></div><div class="line-highlight-wrapper">










<div aria-hidden="true" class="line-highlight" data-range="12-16" data-start="12" data-end="16">




</div></div></pre></li>
<li>
<p>Creaci&#xF3;n con <strong><code>viewModel()</code></strong>, si estamos dentro de una funci&#xF3;n <strong><code>@Composable</code></strong></p>
<p>El <strong><code>ViewModelStoreOwner</code></strong> ser&#xE1; la <strong><code>Activity</code></strong> que renderiza la composici&#xF3;n. No importa que <strong><code>viewModel()</code></strong> sea llamado m&#xE1;s veces a lo largo de las recomposiciones pues solo se instanciar&#xE1; en la primera llamada.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Composable</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">MiScreen</span><span class="token punctuation">(</span>miVm<span class="token operator">:</span> MiViewModel <span class="token operator">=</span> <span class="token function">viewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</pre></li>
</ol>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Existen m&#xE1;s formas de crear un <strong><code>ViewModel</code></strong> que veremos m&#xE1;s adelante.</p>
</blockquote>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="ejemplo-de-uso-y-definici%C3%B3n-de-un-viewmodel">Ejemplo de uso y definici&#xF3;n de un ViewModel</h3>

<p><mark><strong>TODO: AQUI VA AHORCADO EXPLICADO</strong></mark></p>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="hand-pr%C3%A1cticas-no-recomendadas">&#x270B; Pr&#xE1;cticas no recomendadas</h3>

<p>Las siguientes son varias pr&#xE1;cticas recomendadas clave que debes seguir cuando implementes <strong><code>ViewModel</code></strong>:</p>
<ul>
<li>
<p>&#x274C; <strong>NO</strong> definas <strong><code>ViewModel</code></strong> para <em>composables</em> reutilizables en tu UI o para componentes de IU que no sean de nivel superior. Deber&#xED;amos definirlos a nivel de Screen (pantalla).</p>
</li>
<li>
<p>&#x274C; Los ViewModels <strong>NO deber&#xED;an conocer los detalles de implementaci&#xF3;n de la IU</strong>. Mant&#xE9;n los nombres de los m&#xE9;todos que expone la API de ViewModel y los de los campos del UIState lo m&#xE1;s gen&#xE9;ricos posible.</p>
</li>
<li>
<p>&#x274C; Como pueden tener una vida m&#xE1;s larga que el <strong><code>ViewModelStoreOwner</code></strong>, los ViewModels <strong>NO deber&#xED;an contener ninguna referencia de APIs relacionadas con el ciclo de vida</strong>, como <strong><code>Context</code></strong> o <strong><code>Resources</code></strong> para evitar fugas de memoria.</p>
</li>
<li>
<p>&#x274C; <strong>NO pases ViewModels a funciones ni otros componentes de la IU</strong>. Esto evita que los componentes de nivel inferior accedan a m&#xE1;s datos y l&#xF3;gica de los que necesitan.</p>
</li>
<li>
<p>&#x274C; Derivado del anterior <strong>NO instancies directamente un objeto ViewModels</strong>. En su lugar, usa alg&#xFA;n tipo de <em>&apos;proveedor de ViewModels&apos;</em> para obtener una instancia del mismo.</p>
</li>
</ul>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>