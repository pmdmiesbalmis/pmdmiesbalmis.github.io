<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 10. Corrutinas y Servicios</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  background-color: #FFFF;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v8/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="apuntes">Apuntes</h1>

<p><a href="./tema10_Corrutinas_y_Servicios.pdf">Descargar estos apuntes</a></p>
<h1 class="mume-header undefined" id="tema-10-corrutinas-y-servicios">Tema 10. Corrutinas y Servicios</h1>

<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>

<ol>
<li><a href="#corrutinas-kotlin">Corrutinas Kotlin</a>
<ol>
<li><a href="#alcance-de-las-corrutinas">Alcance de las corrutinas</a></li>
<li><a href="#coroutinecontext">CoroutineContext</a></li>
<li><a href="#funciones-de-suspensi%C3%B3n">Funciones de Suspensi&#xF3;n</a></li>
<li><a href="#builders-de-corrutinas">Builders de corrutinas</a></li>
<li><a href="#viewmodel-y-corrutinas">ViewModel y Corrutinas</a></li>
</ol>
</li>
<li><a href="#servicios-y-tareas-de-larga-duraci%C3%B3n">Servicios y tareas de larga duraci&#xF3;n</a>
<ol>
<li><a href="#servicios">Servicios</a></li>
<li><a href="#broadcastreceiver">BroadCastReceiver</a></li>
<li><a href="#workmanager">WorkManager</a></li>
</ol>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="corrutinas-kotlin">Corrutinas Kotlin</h3>

<p>Una <a href="https://kotlinlang.org/docs/coroutines-guide.html">corrutina de Koytlin</a> es un conjunto de sentencias que realizan una tarea espec&#xED;fica, con la capacidad de suspender o resumir su ejecuci&#xF3;n sin bloquear un hilo. Esto permite que tengas diferentes corrutinas cooperando entre ellas y no significa que exista un hilo por cada corrutina, al contrario, puedes ejecutar varias en un solo.</p>
<p>Las corrutinas son parte del paquete kotlinx.coroutines, por lo que necesitas especificar la <a href="https://mvnrepository.com/artifact/org.jetbrains.kotlinx/kotlinx-coroutines-android">dependencia correspondiente</a> en en <strong><code>build.gradle</code></strong>. A d&#xED;a de hoy:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">implementation <span class="token string">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.5.1&quot;</span>
</pre><p>Las <a href="https://babel.es/es/Media/Blog/Julio-2021/Coroutines-en-el-desarrollo-de-Android">corrutinas en el desarrollo de Android</a>, aunque son un elemento que va a permitirnos crear c&#xF3;digos m&#xE1;s sencillos, al principio pueden parecer complejas debido a su nivel de abstracci&#xF3;n.</p>
<h4 class="mume-header" id="alcance-de-las-corrutinas">Alcance de las corrutinas</h4>

<p>Cuando creamos coroutines asumimos de manera impl&#xED;cita dos aspectos muy importantes: El &#xE1;mbito (CoroutineScope y GlobalScope) y el contexto (CoroutineContext).</p>
<p>El uso de <strong><code>GlobalScope</code></strong> permite crea corrutinas de nivel superior, esto quiere decir que tienen la capacidad de vivir hasta que termine la aplicaci&#xF3;n y es trabajo del desarrollador el control para su cancelaci&#xF3;n, por lo que no se aconseja usar este &#xE1;mbito.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">ejemploGlobalScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;GlobalScope&quot;</span><span class="token punctuation">,</span>
            Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; con <strong><code>launch</code></strong> lanzamos la corrutina en el contexto de la Main para poder mostrar el Toast y dentro de esta lanzamos otra para procesos largos (los tres segundos de retardo).</p>
</blockquote>
<p>Para reducir este alcance, Kotlin nos permite crear los espacios donde queremos que se d&#xE9; la concurrencia. Esto lo haremos mediante <strong><code>CoroutineScope</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token keyword">var</span> coroutineScope<span class="token operator">=</span> <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">ejemploCoroutineScopeConMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
       coroutineScope<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;[CoroutineScope-Main] I&apos;m alive on&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>!&quot;</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Al salir del fragment se cancela la corutina</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        coroutineScope<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC;esta corrutina permanece activa hasta  que sea cancelada de alguna forma. Est&#xE1; lanzada con <strong><code>launch</code></strong> y en el alcance de la Main, por lo que podremos usar el Toast para mostrar la informaci&#xF3;n. El alcance personalizado lo hemos conseguido con el constructor de <strong><code>CoroutineScope()</code></strong></p>
</blockquote>
<p>Cada vez que usamos un constructor de coroutines en realidad estamos haciendo una llamada a una funci&#xF3;n que recibe como primer par&#xE1;metro un objeto de tipo <strong><code>CoroutineContext</code></strong>.</p>
<h4 class="mume-header" id="coroutinecontext">CoroutineContext</h4>

<p>Las coroutines siempre se ejecutan en alg&#xFA;n contexto que est&#xE1; representado por un valor del tipo CoroutineContext.</p>
<div align="center">
    <img height src="./imagenes/corrutinas2.png">
</div>
<p>El contexto de Coroutine es un conjunto de varios elementos. Los elementos principales son el<br>
Job de la Coroutine, su dispatcher y tambi&#xE9;n su Exception handler.</p>
<ul>
<li>
<p><strong>Job</strong> De acuerdo con la documentaci&#xF3;n oficial &quot;Un Job es una cosa cancelable con un ciclo de vida que culmina con su finalizaci&#xF3;n. Los trabajos de coroutine se crean con <strong><code>launch coroutine builder</code></strong>. Ejecuta un bloque de c&#xF3;digo especificado y se completa a la finalizaci&#xF3;n de este bloque&quot;.</p>
<p>La ejecuci&#xF3;n de un trabajo no produce un valor de resultado. Deber&#xED;amos utilizar una interfaz <strong><code>Deferred</code></strong> para un trabajo que produzca un resultado. Un trabajo con resultado (Deferred), se crea con el <strong><code>async coroutine builder</code></strong> y el resultado se puede recuperar con el m&#xE9;todo <strong><code>await()</code></strong>, que lanza una excepci&#xF3;n si el Deferred ha fallado.</p>
<p>Los jobs tienen un par de funciones interesantes que pueden ser muy &#xFA;tiles. Pero es importante entender que un Job puede tener a su vez otro Job padre. Ese job padre tiene cierto control sobre los hijos, y ah&#xED; es donde entran en juego estas funciones:</p>
<ul>
<li>job.join -&gt; Con est&#xE1; funci&#xF3;n, se puede bloquear la corrutina asociada con el job hasta que todos los jobs hijos hayan finalizado. Todas las funciones de suspension que se llaman dentro de una corrutina est&#xE1;n vinculadas a job, as&#xED; que el job puede detectar cu&#xE1;ndo finalizan todos los jobs hijos y despu&#xE9;s continuar la ejecuci&#xF3;n. job.join() es una funci&#xF3;n de suspensi&#xF3;n en s&#xED; misma, por lo que debe llamarse dentro de otra corrutina.</li>
<li>job.cancel -&gt; Esta funci&#xF3;n cancelar&#xE1; todos sus jobs hijos asociados. job.cancel() esta es una funci&#xF3;n normal, por lo que no requiere una corrutina para ser llamada.</li>
</ul>
<blockquote>
<p>&#x270B; Con GlobalScope el padre no va a esperar la finalizaci&#xF3;n de sus hijos y una vez que el padre es cancelado, los otros trabajos van a seguir corriendo aparte. Es decir, en este caso es responsabilidad del desarrollador llevar el control del tiempo de vida de las coroutines porque no hay sincronizaci&#xF3;n con los trabajos hijos.</p>
</blockquote>
</li>
<li>
<p><strong>Dispacher</strong> En Kotlin, todas las Coroutines deben ejecutarse en un dispatcher incluso cuando se ejecutan en el hilo principal. los Dispatchers son un tipo de contextos de corrutina que especifican el hilo o hilos que pueden ser utilizados por la corrutina para ejecutar su c&#xF3;digo. Hay dispatchers que solo usan un hilo (como Main) y otros que definen un grupo de hilos que se optimizar&#xE1;n para ejecutar todas las corrutinas que reciben. Para especificar d&#xF3;nde deben ejecutarse las coroutines, Kotlin proporciona tres Dispatchers que puedes utilizar:</p>
<ul>
<li><strong><code>Dispatchers.Main</code></strong>. Hilo principal en Android, interact&#xFA;a con la UI y realiza trabajos ligeros como: llamar a funciones de suspensi&#xF3;n, llamar a funciones de la interfaz de usuario y actualizar LiveData</li>
<li><strong><code>Dispatchers.IO</code></strong>. En general, todas las tareas que bloquear&#xE1;n el hilo mientras esperan la respuesta. Optimizado para la E/S de disco y red fuera del hilo principal: solicitudes de bases de datos, lectura/escritura de archivos,sensores, conexi&#xF3;n en red, ...</li>
<li><strong><code>Dispatchers.Default</code></strong>. Optimizado para el trabajo intensivo de la CPU fuera del hilo principal: ordenar una lista, an&#xE1;lisis de JSON, utilidades</li>
</ul>
</li>
</ul>
 <div align="center">
    <img height="200" src="./imagenes/corrutinas1.png">
</div>
<ul>
<li><strong>Exception Handler</strong>. Este elemento es opcional del CoroutineContext, y nos permite manejar excepciones no capturadas. Y de esta forma mejorar la expericencia de usuario</li>
</ul>
<h4 class="mume-header" id="funciones-de-suspensi%C3%B3n">Funciones de Suspensi&#xF3;n</h4>

<p>Las corrutinas se basan en las <strong>funciones de suspension</strong>  que son funciones normales a las que se les agrega el modificador <strong><code>suspend</code></strong>, las funciones de suspensi&#xF3;n tienen la capacidad de bloquear la ejecuci&#xF3;n de la corrutina mientras est&#xE1;n haciendo su trabajo. Una vez que termina, el resultado de la operaci&#xF3;n se devuelve y se puede utilizar en la siguiente l&#xED;nea.<br>
De esta manera se agregan dos nuevas operaciones (adem&#xE1;s de invocar / llamar y regresar ):</p>
<ul>
<li>suspender - pausa la ejecuci&#xF3;n de la corrutina actual, guardando todas las variables locales. El hilo actual puede continuar con su trabajo, mientras que el c&#xF3;digo de suspensi&#xF3;n se ejecuta en otro hilo.</li>
<li>reanudar : contin&#xFA;a una corrutina suspendida desde el lugar donde se paus&#xF3; cuando el resultado est&#xE1; listo.</li>
</ul>
<p>Las funciones de suspensi&#xF3;n solo pueden llamarse o ejecutarse dentro de una corrutina o dentro de otra funci&#xF3;n de suspensi&#xF3;n.<br>
Algunas de las funciones usadas con frecuencias para lanzar corrutinas son funciones de suspensi&#xF3;n en si mismas, tales como <strong><code>delay, join, await, withContext, supervisorScope, etc.</code></strong>.</p>
<h5 class="mume-header" id="withcontext">withContext</h5>

<p>Esta es una funci&#xF3;n de suspensi&#xF3;n que permite cambiar f&#xE1;cilmente el contexto que se utilizar&#xE1; para ejecutar una parte del c&#xF3;digo dentro de una corrutina. <strong><code>WithContext</code></strong> es una funci&#xF3;n de suspensi&#xF3;n en s&#xED; misma.</p>
<h4 class="mume-header" id="builders-de-corrutinas">Builders de corrutinas</h4>

<p>Los constructores de coroutinas sirven para iniciar las corrutinas. Tenemos diferentes builders dependiendo de lo que queramos hacer, e incluso t&#xE9;cnicamente se pueden crear personalizados. Pero para la mayor&#xED;a de los casos son suficientes con los que proporciona la librer&#xED;a:</p>
<ul>
<li>
<p><strong><code>runBlocking</code></strong>, este builder bloquea el hilo actual hasta que se terminen todas las tareas dentro de esa corrutina. No suele ser una funcionalidad muy usada de las corrutinas, ya que precisamente lo que se pretende con estas es la sincronizaci&#xF3;n de m&#xE1;s de una tarea.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">ejemploRunBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
            <span class="token function">runBlocking</span> <span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//Lanzamos tres corrutinas con launch</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//delay es una funcion de suspensi&#xF3;n por lo que al</span>
                        <span class="token comment">//lanzar las tres corrutinas el tiempo no duran 5segundos</span>
                        <span class="token comment">//ya que se hacen las tres intercaladas</span>
                        <span class="token comment">//a diferencia de sleep</span>
                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;CORRUTINA&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Ya han terminado las tareas lanzadas&quot;</span><span class="token operator">+</span>
        <span class="token string">&quot;con el constructor runBlocking.&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\nSe desbloquea el hilo principal y se muestra este texto&quot;</span><span class="token punctuation">,</span>
        Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC;en este ejemplo lanzamos una corrutina que a su vez lanza otras tres corrutinas, la primera con <strong><code>runBlocking</code></strong> bloquear&#xE1; el hilo principal, por lo que el <strong><code>Toast</code></strong> no ocurrir&#xE1; hasta que no terminen todas las subrutinas hijas de <strong><code>runBlocking</code></strong>. <strong><code>launch</code></strong> se lanza, en este ejemplo, en un contexto que no es el Main, por lo que nunca podremos introducir ninguna interacci&#xF3;n con las vistas (por eso la salida la realizamos mediante log). Cada una de las tres corrutinas lanzadas por launch permanecer&#xE1; 5 segundos de espera, pero al realizarse al mismo tiempo, el retardo es de poco m&#xE1;s de 5 segundo. Si  el bucle no lanzara las tres subrutinas con launch y solo dejaramos el <strong><code>delay</code></strong> el retardo ser&#xED;a de unos 15 segundos aproximadamente.</p>
</blockquote>
</li>
<li>
<p><strong><code>launch</code></strong>, este es el builder m&#xE1;s usado. A diferencia de runBlocking, no bloquear&#xE1; el subproceso actual (si se usan los dispatchers adecuados).Launch devuelve un Job, que permitir&#xE1; realizar las funciones explicadas anteriormente.<br>
Cuando <strong>launch</strong> se usa sin par&#xE1;metros, hereda el contexto (y por lo tanto el dispatcher) del CoroutineScope desde el que se inicia. Puede iniciarse dentro de otra corrutina omitiendose o no el Dispachers, pero si no est&#xE1; dentro de una corrutina necesitar&#xE1; obligatoriamente especificar el alcance. Launch nos devuelve un Job, que permitir&#xE1; realizar las funciones explicadas anteriormente.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token comment">//launch especificando el alcance mediante CoroutineScope</span>
<span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment">//Al estar dentro de una corrutina padre, se puede omitir </span>
<span class="token comment">//el alcance e incluso el Dispatchers si no queremos cambiar </span>
<span class="token comment">//el contexto del padre, en este caso si lo cambiamos</span>
<span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token operator">..</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</pre></li>
<li>
<p><strong><code>async</code></strong>, este otro builder permite ejecutar varias tareas en segundo plano en paralelo. No es una funci&#xF3;n de suspensi&#xF3;n en s&#xED; misma, por lo que cuando ejecutamos async, el proceso en segundo plano se inicia, pero la siguiente l&#xED;nea se ejecuta de inmediato. <strong><code>async</code></strong> siempre debe llamarse dentro de otra corrutina, y devuelve un job especializado que se llama <strong><code>Deferred</code></strong>.<br>
<strong><code>Deferred</code></strong> tiene una nueva funci&#xF3;n de suspensi&#xF3;n  llamada <strong><code>await()</code></strong> que es la que bloquea. Llamaremos a await() solo cuando necesitemos el resultado. Si el resultado a&#xFA;n no esta listo, la corrutina se suspende en ese punto. Si ya tenemos el resultado, simplemente lo devolver&#xE1; y continuar&#xE1;.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">ejemploAsyncAway</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> cadena<span class="token operator">:</span>String<span class="token operator">?</span><span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> job<span class="token operator">=</span>async <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tiempo<span class="token punctuation">.</span>text <span class="token operator">=</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token string">&quot;Ha terminado la corrutina async&quot;</span>
        <span class="token punctuation">}</span>
        cadena<span class="token operator">=</span>job<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cadena<span class="token punctuation">,</span>Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; lanzamos el <strong><code>async</code></strong> dentro de una corrutina launch con contesto Main, para poder pintar cada segundo el texto que nos interese (en este caso un contador de 1 a 5). Cambiamos el Dispacher a IO para realizar el retardo y devolvemos una cadena como respuesta del <strong><code>async</code></strong>. Cuando termine el trabajo la corrutina, recuperaremos la cadena con <strong><code>await</code></strong> y se lanzar&#xE1; el Toast que la utiliza.</p>
</blockquote>
</li>
</ul>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Copia los c&#xF3;digos de los ejemplos y completalos hasta hacerlos funcionar. Para ayudarte en la comprensi&#xF3;n puedes analizar el ejercicio resuelto de la Barra de Progreso</span></p>
<h4 class="mume-header" id="viewmodel-y-corrutinas">ViewModel y Corrutinas</h4>

<p>ViewModel es extendido con una propiedad <strong><code>viewModelScope</code></strong> que se encarga de cancelar las corrutinas cuando ya no son necesarias.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">//propiedad viewModelScope extendida de CoroutineScope y</span>
<span class="token comment">//que a su vez extiende el ViewModel</span>
<span class="token keyword">val</span> ViewModel<span class="token punctuation">.</span>viewModelScope<span class="token operator">:</span> CoroutineScope
   <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Gracias al comportamiento de <strong><code>CoroutineScope</code></strong> a trav&#xE9;s de la propiedad <strong><code>viewModelScope</code></strong> se realiza un seguimiento de todas las corrutinas que se crean en este ambito. Por lo tanto, si se cancela un alcance, se cancelan todas las corrutinas creadas en &#xE9;l.</p>
<p>Por ejemplo, en el siguiente c&#xF3;digo creamos un ViewModel que nos gestionar&#xE1; un <strong><code>MutableLiveData</code></strong> de tipo ArrayList de Strings y que tiene un m&#xE9;todo que simula una descarga de datos que se guardar&#xE1;n en el objeto:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> ItemViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> valores <span class="token operator">=</span>
        <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;item1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item5&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item6&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item7&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;item8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> liveData <span class="token operator">=</span>
        MutableLiveData<span class="token operator">&lt;</span>ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//:MutableLiveData&lt;String&gt; by lazy { MutableLiveData&lt;String&gt;() }</span>
    <span class="token keyword">val</span> datos<span class="token operator">:</span> LiveData<span class="token operator">&lt;</span>ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> liveData

    <span class="token keyword">fun</span> <span class="token function">descargarDatos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> aux <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//Simulaci&#xF3;n de una descarga lenta de datos</span>
        <span class="token keyword">val</span> numeroElementos <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span><span class="token operator">..</span>numeroElementos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                aux<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>valores<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>valores<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            liveData<span class="token punctuation">.</span>value <span class="token operator">=</span> aux
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC;en el m&#xE9;todo <strong>descargarDatos</strong> se usa la propiedad <strong><code>viewModelScope</code></strong> para lanzar la corrutina que producir&#xE1; el retardo y la lista generada con elementos aleatorios.</p>
</blockquote>
<p>El uso del ViewModel desde las distintas partes de la aplicaci&#xF3;n, es igual al que hemos visto en temas anteriores.</p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Realiza el ejercicio propuesto del cron&#xF3;metro</span></p>
<h3 class="mume-header" id="servicios-y-tareas-de-larga-duraci%C3%B3n">Servicios y tareas de larga duraci&#xF3;n</h3>

<p>Las corrutinas est&#xE1;n dise&#xF1;adas para trabajar tareas que deben finalizar cuando el usuario sale de un determinado alcance o termina una interacci&#xF3;n, pero a la hora de realizar lo que llamamos <strong>long-time running tasks</strong>, es decir tareas que tienen que estar durante un gran tiempo en segundo plano y no tienen porqu&#xE9; estar ligadas a la actividad que las ha lanzado o a la interacci&#xF3;n con el usuario, es necesario pensar en otras respuestas:</p>
<ol>
<li>Tareas que necesitan ejecutarse de inmediato y procesarse de forma continua, incluso cuando el usuario coloca la aplicaci&#xF3;n en segundo plano o se reinicia el dispositivo. En este caso lo recomendable es el uso de <strong><code>WorkManager</code></strong>.</li>
<li>En casos concretos en los que se realizan tareas largas como la reproducci&#xF3;n de contenido multimedia o la navegaci&#xF3;n activa, se recomienda el uso de <strong><code>Servicios</code></strong> pero en primer plano.</li>
</ol>
<h4 class="mume-header" id="servicios">Servicios</h4>

<p>Los <a href="https://developer.android.com/guide/components/services?hl=es-419">Servicios</a> son componentes que se ejecutan en background (o segundo plano) y que que no proporciona una interfaz de usuario, por lo que no interact&#xFA;an con el usuario.<br>
La plataforma Android ofrece una gran cantidad de servicios predefinidos, disponibles regularmente a trav&#xE9;s de la clase Manager. De esta manera, en nuestras actividades podremos acceder a estos servicios a trav&#xE9;s del m&#xE9;todo <strong><code>getSystemService()</code></strong>.<br>
Si el servicio creado va a realizar tareas que tengan un coste computacional elevado, se pueden provocar problemas en la aplicaci&#xF3;n (Application Not Responding o ANR), para evitar situaciones como estas, el servicio puede ejecutarse en un hilo secundario. Si la aplicaci&#xF3;n est&#xE1; orientada al nivel de API 26 o un nivel superior, el sistema impone restricciones en la ejecuci&#xF3;n de servicios en segundo plano cuando la aplicaci&#xF3;n misma no se encuentra en primer plano. En estos casos es mejor usar una tarea programada, <strong><code>WorkManager</code></strong>.</p>
<blockquote>
<p>&#x26A0;&#xFE0F; Por otro lado, si necesitamos utilizar servicios propios, estos deben ir declarados en el archivo <strong><code>AndroidManifest.xml</code></strong>.</p>
</blockquote>
<p>Tenemos varias opciones para que nuestra activity se comunique con un servicio.</p>
<ul>
<li>Usar <strong>intent</strong>: es un escenario simple donde no se requiere comunicaci&#xF3;n directa ni notificaciones de procesos. El servicio recibe los datos v&#xED;a intent y realiza la tarea que sea necesaria sin devolver ning&#xFA;n tipo de dato. Un escenario donde podemos utilizar esto es cuando necesitamos actualizar un content provider. El servicio recibe los datos v&#xED;a intent, actualiza el content provider y este notifica a nuestra app que el contenido est&#xE1; actualizado, sin que se requiera alguna acci&#xF3;n extra por nuestro servicio.</li>
<li>Usar <strong>receivers</strong>: otro m&#xE9;todo es emitir eventos y registrar receptores (receivers, clase <strong><code>BroadcastReceiver</code></strong>) para establecer la comunicaci&#xF3;n. Por ejemplo, una activity registra din&#xE1;micamente un receiver para un evento, y el servicio es el encargado de emitir ese evento. Este escenario se usa cuando es necesario que el escenario notifique que termin&#xF3; de hacer alguna tarea.</li>
</ul>
<h5 class="mume-header" id="construyendo-un-servicio">Construyendo un Servicio</h5>

<p>Para crear un Servicio tendremos que extender de <strong><code>Service</code></strong> por lo que tendremos que redefinir y conocer 4 m&#xE9;todos principales:</p>
<ul>
<li><strong><code>onCreate</code></strong>: De manera similar a un Activity, se ejecuta la primera vez que se crea el servicio y sirve para inicializar variables.</li>
<li><strong><code>onStartCommand</code></strong>: Se ejecuta cuando el servicio recibe un intent lanzado mediante el comando startService. Si el servicio ya est&#xE1; iniciado, los intents sucesivos no volver&#xE1;n a generar un <strong><code>onCreate</code></strong> si no que pasaran directamente aqu&#xED;. Es importante tener en cuenta que si se crean hilos en este m&#xE9;todo, debe comprobarse que el hilo no est&#xE9; ya funcionando o podr&#xED;an accidentalmente crearse hilos nuevos cada vez que se pasa por aqu&#xED;.</li>
<li><strong><code>onBind</code></strong>: Este comando es llamado cuando se ejecuta un bindService() desde un Activity. Sirve para devolver una referencia a modo de IBinder al Activity de la instancia del servicio.</li>
<li><strong><code>onDestroy</code></strong>: Cuando se llama al comando <strong><code>stopService()</code></strong> o dentro del mismo service al m&#xE9;todo <strong><code>stopSelft()</code></strong> se pasa por este m&#xE9;todo, d&#xF3;nde deben terminarse hilos o tareas que puedan estar ejecut&#xE1;ndose.</li>
</ul>
<p>Ejemplo de un servicio sencillo, podemos analizar su funcionamiento visualizando las lineas de LogCat:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> MyService<span class="token operator">:</span> <span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Creando servicio....&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onStartCommand</span>
                <span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> startId<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Recibiendo Intent ....&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Mostrando intent ....+&quot;</span> <span class="token operator">+</span>
                           <span class="token string">&quot;${intent?.getStringExtra(&quot;</span>CADENA<span class="token string">&quot;)}&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> START_STICKY
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBind</span><span class="token punctuation">(</span>p0<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> IBinder<span class="token operator">?</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Enlazando Intent ....&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Destruyendo Intent ....&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; Hay que destacar que este tipo de servicios hay que pararlos expl&#xED;citamente, aunque el sistema tambi&#xE9;n podr&#xED;a pararlos si se encontrase escaso de memoria. Si en el m&#xE9;todo onStartCommand se ha devuelto <strong><code>START_STICKY</code></strong>, el sistema podr&#xE1; revivir el servicio cuando vuelva a tener memoria disponible, aunque hay que tener en cuenta que entonces el intent que recibir&#xE1; onStartCommand ser&#xE1; nulo (null).</p>
</blockquote>
<p>Una manera de inicializar este servicio, es desde una actividad y de forma muy parecida a iniciar una activity:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> intento<span class="token operator">:</span>Intent
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        findViewById<span class="token operator">&lt;</span>MaterialButton<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>boton<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
            intento<span class="token operator">=</span><span class="token function">Intent</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span>MyService<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
            intento<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token string">&quot;CADENA&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Dato Pasado desde Main&quot;</span><span class="token punctuation">)</span>
            <span class="token function">startService</span><span class="token punctuation">(</span>intento<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">stopService</span><span class="token punctuation">(</span>intento<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x26A0;&#xFE0F; No olvidar que se debe declarar los servicios usados en el manifest.<br>
<strong><code>&lt;service android:name=&quot;.MyService&quot;/&gt;</code></strong></p>
</blockquote>
<p>Como ya se ha indicado, todo este c&#xF3;digo funcionar&#xED;a en primer plano, si deseamos crear un hilo para realizar tareas en segundo plano, habr&#xED;a que hacerlo en onStartCommand:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> MyServiceSegundoPlano<span class="token operator">:</span> <span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">var</span> hilo<span class="token operator">=</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onStartCommand</span>
                <span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">,</span> startId<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span>
        <span class="token keyword">val</span> cadena<span class="token operator">=</span>intent<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token string">&quot;CADENA&quot;</span><span class="token punctuation">)</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Recibiendo Intent ....&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hilo<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>hilo<span class="token operator">?</span><span class="token punctuation">.</span>isAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hilo <span class="token operator">=</span> Thread <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mostrando intent ....&quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>cadena<span class="token delimiter variable">}</span></span>&quot;</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            hilo<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> START_STICKY
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBind</span><span class="token punctuation">(</span>p0<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> IBinder<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Destruyendo Intent ....&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Prueba los dos ejemplos anteriores y mira el resultado en el Logcat</span></p>
<p>Existen dos tipos de servicios. Aquel que se inicia expl&#xED;citamente a trav&#xE9;s del m&#xE9;todo <strong><code>startService()</code></strong> llamado <strong>Started Service</strong> y el que se liga a un componente con <strong><code>bindService()</code></strong> llamado <strong>Bound Service</strong>.</p>
<ul>
<li>Started: Una vez iniciado el servicio, se ejecuta de forma indefinida en segundo plano, incluso si se destruye el componente que lo inici&#xF3;.</li>
<li>Bound: En este caso, el servicio ofrece una interfaz de tipo cliente-servidor a aquellos componentes que se asocian o enlazan a dicho servicio. Los componentes asociados o enlazados (bound) al servicio pueden enviar peticiones, conseguir resultados y respuestas o, incluso, llevar a cabo tareas de comunicaci&#xF3;n con otros procesos. En este caso, el servicio s&#xF3;lo se ejecuta cuando hay alg&#xFA;n componente asociado o enlazado a &#xE9;l.</li>
</ul>
<h5 class="mume-header" id="aplicaci%C3%B3n-ejemplo-para-crear-un-servicio-para-poder-consumirlo-desde-una-actividad">Aplicaci&#xF3;n ejemplo para crear un servicio para poder consumirlo desde una actividad</h5>

<p>Vamos a crear un servicio para que desde una actividad podamos consumirlo. El objetivo del servicio ser&#xE1; recuperar datos de forma peri&#xF3;dica para que de esta forma la actividad pueda desplegarlos a trav&#xE9;s de una ListView, siempre pudiendo pedir los datos m&#xE1;s actualizados de este servicio.<br>
Vamos a enlazar el servicio enlaz&#xE1;ndolo con la actividad (Bound) Teniendo el concepto claro, pasemos a codificarlo:</p>
<ol>
<li>Creamos un nuevo proyecto llamado MiServicio.</li>
<li>Como dato adicional, a la actividad principal del proyecto la he llamado Consumer:</li>
<li>Creamos una nueva clase llamada MiServicio que es en d&#xF3;nde vamos a escribir todo el c&#xF3;digo correspondiente a lo que hace el servicio. A continuaci&#xF3;n te proporciono el c&#xF3;digo que deber&#xE1; tener esta clase:</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin{highlight=[15, [36-39]]}" class="language-kotlin" data-line="15,36-39">  <span class="token keyword">class</span> MiService <span class="token operator">:</span> <span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timer<span class="token operator">:</span> Timer<span class="token operator">?</span><span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">var</span> miBinder<span class="token operator">:</span> IBinder <span class="token operator">=</span> <span class="token function">MiBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> lista<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;blanco&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;azul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;verde&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> pos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">override</span>  <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pos <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        timer<span class="token operator">=</span><span class="token function">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        lista <span class="token operator">=</span> <span class="token function">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">pollForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fun</span> <span class="token function">pollForUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">override</span>  <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lista<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> array<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lista<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                lista<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
                pos<span class="token operator">++</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;=</span> array<span class="token punctuation">.</span>size<span class="token punctuation">)</span> pos <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> UPDATE_INTERVAL<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span>  <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        timer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBind</span><span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> IBinder <span class="token punctuation">{</span>
        <span class="token keyword">return</span> miBinder
    <span class="token punctuation">}</span>
    <span class="token keyword">fun</span> <span class="token function">getLista</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> lista
    <span class="token punctuation">}</span>
    <span class="token keyword">internal</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> MiBinder <span class="token operator">:</span> <span class="token function">Binder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> service<span class="token operator">:</span> MiService
            <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token label symbol">@MiService</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> UPDATE_INTERVAL<span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token number">5000</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">













<div aria-hidden="true" class="line-highlight" data-range="15" data-start="15">
</div></div><div class="line-highlight-wrapper">


































<div aria-hidden="true" class="line-highlight" data-range="36-39" data-start="36" data-end="39">



</div></div></pre><blockquote>
<p>&#x1F4CC;En primer lugar podemos observar que esta clase hereda de <strong><code>Service</code></strong>. Dentro de la clase MiServicio declaramos un <strong><code>Timer</code></strong> que nos ayudar&#xE1; a retardar las actualizaciones de la informaci&#xF3;n que proveer&#xE1; el servicio junto con la constante est&#xE1;tica UPDATE_INTERVAL que fijamos con un valor de 5 segundos.<br>
Tenemos un ArrayList y un arreglo de cadenas que nos servir&#xE1;n para jugar con la informaci&#xF3;n del servicio; y un IBinder que permite interactuar con un objeto de forma remota.<br>
Dentro de los m&#xE9;todos que estamos creando en nuestro servicio se encuentra <strong><code>pollForUpdates()</code></strong> en el que definimos la tarea cuya ejecuci&#xF3;n se repetir&#xE1; seg&#xFA;n el tiempo que hayamos establecido, mediante el m&#xE9;todo de la clase Timer <strong><code>scheduleAtFixedRat()</code></strong>, <strong>L&#xED;nea 15</strong><br>
Con respecto al uso de IBinder, la documentaci&#xF3;n de Android nos dice que no debemos implementarla de manera directa, y que para efectos pr&#xE1;cticos debemos utilizar una clase que extienda de Binder. Es por ello que creamos una clase interna llamada MyBinder <strong>L&#xED;neas 36-39</strong>. El resto es incluir los m&#xE9;todos anulados <strong><code>onDestroy()</code></strong> y <strong><code>onBind()</code></strong>, para cancelar el servicio o para devolverlo respectivamente.</p>
</blockquote>
<ol start="4">
<li>Ahora pasemos a codificar la actividad que consumir&#xE1; este servicio. Para la cu&#xE1;l definimos la interfaz gr&#xE1;fica con un bot&#xF3;n para refrescar la informaci&#xF3;n del servicio y una ListView para desplegar los datos del mismo.</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin{highlight=[[19-30],32,37]}" class="language-kotlin" data-line="19-30,32,37"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">Activity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> miservicio<span class="token operator">:</span> MiService<span class="token operator">?</span><span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">lateinit</span>  <span class="token keyword">var</span> values<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token keyword">lateinit</span>  <span class="token keyword">var</span> adapter<span class="token operator">:</span> ArrayAdapter<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token keyword">lateinit</span>  <span class="token keyword">var</span> lista<span class="token operator">:</span> ListView
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> boton<span class="token operator">:</span> Button
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        lista <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>listView<span class="token punctuation">)</span>
        boton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>button<span class="token punctuation">)</span>
        <span class="token function">doBindService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        values <span class="token operator">=</span> <span class="token function">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        adapter <span class="token operator">=</span> ArrayAdapter<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> android<span class="token punctuation">.</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>
                                       simple_list_item_1<span class="token punctuation">,</span> values<span class="token punctuation">)</span>
        lista<span class="token punctuation">.</span><span class="token function">setAdapter</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span>
        boton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>  <span class="token function">showServiceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mConnection<span class="token operator">:</span> ServiceConnection <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ServiceConnection 
    <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>name<span class="token operator">:</span> ComponentName<span class="token punctuation">,</span> 
                                        service<span class="token operator">:</span> IBinder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            miservicio <span class="token operator">=</span> <span class="token punctuation">(</span>service <span class="token keyword">as</span> MiBinder<span class="token punctuation">)</span><span class="token punctuation">.</span>service
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span> <span class="token string">&quot;Connectado&quot;</span><span class="token punctuation">,</span>
                        Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token operator">:</span> ComponentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            miservicio <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fun</span> <span class="token function">doBindService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bindService</span><span class="token punctuation">(</span><span class="token function">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MiService<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">,</span> mConnection<span class="token punctuation">,</span> 
                           BIND_AUTO_CREATE<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fun</span> <span class="token function">showServiceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>miservicio <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> listaTrabajo<span class="token operator">:</span> List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> miservicio<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">getLista</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            values<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            values<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>listaTrabajo<span class="token punctuation">)</span>
            adapter<span class="token punctuation">.</span><span class="token function">notifyDataSetChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">

















<div aria-hidden="true" class="line-highlight" data-range="19-30" data-start="19" data-end="30">











</div></div><div class="line-highlight-wrapper">






























<div aria-hidden="true" class="line-highlight" data-range="32" data-start="32">
</div></div><div class="line-highlight-wrapper">



































<div aria-hidden="true" class="line-highlight" data-range="37" data-start="37">
</div></div></pre><blockquote>
<p>&#x1F4CC; Declaramos un ArrayList y un objeto de tipo MiServicio. Para poder trabajar con el servicio ser&#xE1; indispensable crear un objeto de tipo <strong><code>ServiceConnection</code></strong> <strong>L&#xED;nea 19 - 30</strong> , por medio del cual realizaremos las funciones necesarias para que nuestra actividad pueda conectarse con el servicio creado y podamos as&#xED;, acceder a la informaci&#xF3;n que nos provee. Este objeto ser&#xE1; inicializado a trav&#xE9;s del m&#xE9;todo <strong><code>bindService()</code></strong> <strong>L&#xED;nea 32</strong>, que es llamado en el <strong><code>onCreate()</code></strong> de la activity. Como vamos a llenar una ListView con estos datos, es importante crear un adaptador. Luego, en el m&#xE9;todo propio <strong><code>showServiceData()</code></strong> actualizamos la lista con los datos recibidos del servicio <strong>L&#xED;nea 37</strong>.</p>
</blockquote>
<ol start="5">
<li>IMPORTANTE , una vez que hemos terminado la l&#xF3;gica de la aplicaci&#xF3;n nos faltar&#xE1; dar de alta el servicio creado, en el archivo AndroidManifest.xml.</li>
</ol>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Reconstruye el ejemplo para entender el funcionamiento del la comunicaci&#xF3;n mediante Bind</span></p>
<h4 class="mume-header" id="broadcastreceiver">BroadCastReceiver</h4>

<p>Un broadcast receiver es el componente que permite recibir y responder ante eventos del sistema (aviso de bater&#xED;a baja, un SMS recibido,&#x2026;) o eventos producidos por otras aplicaciones o servicios.<br>
Algunos eventos son de acceso privilegiado y hay que establecerlos en el archivo de manifiesto de la aplicaci&#xF3;n con la etiqueta <strong><code>&lt;uses_permission&gt;</code></strong>.<br>
Para crear un broadcast receiver simplemente tenemos que crear una clase que herede de <strong><code>BroadcastReceiver</code></strong> y anular el m&#xE9;todo <strong><code>onReceive()</code></strong>, que es el m&#xE9;todo que se ejecutar&#xE1; cada vez que se produzca el evento al que se suscriba nuestro broadcast receiver (similar al onCreate() de una activity).<br>
La clase BroadcastReceiver es capaz de recibir intents a trav&#xE9;s del m&#xE9;todo <strong><code>sendBroadcast()</code></strong>.<br>
Otra de las clase utiles es <strong><code>PendingIntent</code></strong>, que es un token que le damos a otra aplicaci&#xF3;n a trav&#xE9;s de un Notification Manager, Alarm Manager u otras aplicaciones de terceros, que les permiten a estos componentes utilizar los permisos de nuestra aplicaci&#xF3;n para ejecutar un trozo de c&#xF3;digo predefinido.</p>
<h5 class="mume-header" id="aplicaci%C3%B3n-ejemplo-para-activar-la-vibraci%C3%B3n-y-la-alarma-del-dispositivo">Aplicaci&#xF3;n ejemplo para activar la vibraci&#xF3;n y la alarma del dispositivo</h5>

<p>Vamos a definir un broadcast receiver que escuche los cambios de estado del tel&#xE9;fono. Queremos tener en la pantalla de nuestra aplicaci&#xF3;n un EditText para introducir los segundos que pasar&#xE1;n antes de que nos vibre el tel&#xE9;fono y un bot&#xF3;n para iniciar el conteo. El layout de la actividad principal se omite por su sencillez. Pasamos a explicar la clase que hereda de <strong><code>BroadCastReceiver</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> BroadCastAlarma <span class="token operator">:</span> <span class="token function">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation builtin">@RequiresApi</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O<span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            <span class="token string">&quot;Vibraci&#xF3;n activa porque el tiempo se ha terminado&quot;</span><span class="token punctuation">,</span>
            Toast<span class="token punctuation">.</span>LENGTH_LONG
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> vibrator <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>VIBRATOR_SERVICE<span class="token punctuation">)</span> 
                                                       <span class="token keyword">as</span> Vibrator
        vibrator<span class="token punctuation">.</span><span class="token function">vibrate</span><span class="token punctuation">(</span>VibrationEffect<span class="token punctuation">.</span><span class="token function">createOneShot</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> 
                                       VibrationEffect<span class="token punctuation">.</span>DEFAULT_AMPLITUDE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC;Como vemos implementamos el m&#xE9;todo <strong><code>onRecive()</code></strong> que recibe el contexto desde donde es llamado y el intent que lo disparar&#xE1;. Visualizamos un toast para indicar que el tiempo de espera finaliz&#xF3; y que el modo vibraci&#xF3;n se activar&#xE1;. A continuaci&#xF3;n activamos la vibraci&#xF3;n durante ocho segundos. Para ello definimos un objeto de tipo <strong><code>Vibrator</code></strong> que lo inicializamos con el servicio propio del sistema y llamamos al m&#xE9;todo <strong><code>vibrate(</code></strong>) de dicho objeto.</p>
</blockquote>
<p>En la activity principal solamente tenemos que implementar la pulsaci&#xF3;n del bot&#xF3;n, se recoger&#xE1; la informaci&#xF3;n introducida en el EditText, se programar&#xE1; una alarma y cuando esta termine se invocar&#xE1; al broadcast receiver definido anteriormente. Veamos el c&#xF3;digo:</p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[0,[13-15],[16-19]]}" class="language-kotlin" data-line="0,13-15,16-19"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span><span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> texto<span class="token operator">:</span>EditText
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        texto<span class="token operator">=</span>findViewById<span class="token operator">&lt;</span>EditText<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>editText<span class="token punctuation">)</span>
        texto<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
        findViewById<span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>button<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>  <span class="token function">activar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">activar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> tiempo <span class="token operator">=</span> texto<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>BroadCastAlarma<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
        <span class="token keyword">val</span> pendingIntent <span class="token operator">=</span> PendingIntent<span class="token punctuation">.</span><span class="token function">getBroadcast</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
                                                 REQUESTCODE<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> alarmManager <span class="token operator">=</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>ALARM_SERVICE<span class="token punctuation">)</span> <span class="token keyword">as</span> AlarmManager
        alarmManager<span class="token punctuation">[</span>AlarmManager<span class="token punctuation">.</span>RTC_WAKEUP<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                        <span class="token operator">+</span> tiempo <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span>
                                                             pendingIntent
        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;Has fijado la alarma en &quot;</span><span class="token operator">+</span>tiempo<span class="token operator">+</span><span class="token string">&quot;segundos&quot;</span><span class="token punctuation">,</span>
                                        Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span><span class="token punctuation">{</span>
        <span class="token keyword">val</span> REQUESTCODE<span class="token operator">=</span><span class="token number">1111</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="0" data-start="0">
</div></div><div class="line-highlight-wrapper">











<div aria-hidden="true" class="line-highlight" data-range="13-15" data-start="13" data-end="15">


</div></div><div class="line-highlight-wrapper">














<div aria-hidden="true" class="line-highlight" data-range="16-19" data-start="16" data-end="19">



</div></div></pre><blockquote>
<p>&#x1F4CC;Lo primero que hacemos es recuperar la referencia al EditText y parseamos el contenido a Integer. Visualizamos un toast para informar que se va a establecer la cuenta atr&#xE1;s en los segundos especificados en el EditText.<br>
<strong>&#xA1;&#xA1;Lo interesante!!</strong> Definimos un intent que apunta a nuestro broadcast receiver. Luego hacemos uso de un PendingIntent en el que se recoge el contexto en el que este objeto se ejecutar&#xE1; cuando sea atendido, un c&#xF3;digo de identificaci&#xF3;n, el intent donde se define la acci&#xF3;n y un flag. Nosotros lo hacemos con <strong><code>PendinIntent.getBroadcast()</code></strong>, porque lo que hemos definido o quien va atender esta petici&#xF3;n est&#xE1; en un BroadcastReceiver <strong>L&#xED;neas 13 - 15</strong>.<br>
<em>Usar&#xED;amos <strong><code>nombrePendinIntent.getActivity()</code></strong> si inici&#xE1;ramos una activity y <strong><code>nombrePendinIntent.getService()</code></strong> para un servicio.</em><br>
Finalmente creamos un objeto AlarmManager inicializ&#xE1;ndolo con el servicio propio del sistema (ALARM_SERVICE). Con el m&#xE9;todo set() definimos el tiempo en el que ser&#xE1; lanzada la alarma (i segundos despu&#xE9;s del actual) y el PendingIntent que resuelve la l&#xF3;gica de nuestra aplicaci&#xF3;n y que se ha definido anteriormente <strong>L&#xED;neas 16 - 19</strong>.</p>
</blockquote>
<blockquote>
<p>&#x26A0;&#xFE0F;Para probar esta aplicaci&#xF3;n es necesario un terminal real y no el emulador, ya que &#xE9;ste &#xFA;ltimo no puede reproducir la vibraci&#xF3;n.</p>
</blockquote>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Prueba el ejemplo del BroadcastReceiver</span></p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Sigue el ejercicio resuelto que muestra un Toast indicando si se ha conectado/desconectado el dispositivo a la alimentaci&#xF3;n</span></p>
<h4 class="mume-header" id="workmanager">WorkManager</h4>

<p>Android <a href="https://developer.android.com/topic/libraries/architecture/workmanager?hl=es">WorkManager</a> es una biblioteca de procesamiento que se utiliza para ejecutar tareas en segundo plano que deber&#xED;an ejecutarse de forma garantizada, pero no necesariamente de forma inmediata. Con WorkManager podemos poner en cola nuestro procesamiento en segundo plano incluso cuando la aplicaci&#xF3;n no se est&#xE1; ejecutando o el dispositivo se reinicia por alguna raz&#xF3;n. WorkManager tambi&#xE9;n nos permite definir las restricciones necesarias para ejecutar la tarea, por ejemplo, la disponibilidad de la red antes de iniciar la tarea en segundo plano.</p>
<p>Android WorkManager es parte de  Android Jetpack y es perfecta para usar cuando la tarea:</p>
<ol>
<li>No necesita ejecutarse en un momento espec&#xED;fico</li>
<li>Puede aplazarse su ejecuci&#xF3;n</li>
<li>Se necesita que se ejecute incluso despu&#xE9;s de que se elimine la aplicaci&#xF3;n o se reinicie el dispositivo.</li>
<li>Tiene que cumplir con limitaciones como el suministro de bater&#xED;a o la disponibilidad de la red antes de la ejecuci&#xF3;n.</li>
</ol>
<p>Para poder trabajar con <strong><code>WorkManager</code></strong> ser&#xE1; necesario incluir la siguiente implementaci&#xF3;n:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">   implementation &apos;androidx.work<span class="token operator">:</span>work-runtime-ktx<span class="token operator">:</span><span class="token number">2.6</span>.<span class="token number">0</span>&apos;
</pre><h5 class="mume-header" id="crear-un-trabajo">Crear un trabajo</h5>

<p>Para crear un trabajo de este tipo, se deber&#xE1; implementar una clase que herede de <strong><code>WorkManager</code></strong> y anular su m&#xE9;todo <strong><code>doWork()</code></strong> donde a&#xF1;adiremos el c&#xF3;digo que queramos que se ejecute en segundo plano (a diferencia de los servicios, no habr&#xE1; que crear ning&#xFA;n hilo ya que se encarga el sistema).</p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[0]}" class="language-kotlin" data-line="0"><span class="token keyword">class</span> <span class="token function">WorkManager</span><span class="token punctuation">(</span><span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> workerParams<span class="token operator">:</span> WorkerParameters<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">Worker</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> workerParams<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Result <span class="token punctuation">{</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span><span class="token operator">..</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
           Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATOS&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
        <span class="token keyword">var</span> intento<span class="token operator">=</span><span class="token function">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        intento<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>
            <span class="token function">ComponentName</span><span class="token punctuation">(</span><span class="token string">&quot;com.ejemplos.b10.ejemploviewmodelcorrutinas&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;com.ejemplos.b10.ejemploviewmodelcorrutinas.MainActivity&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment">//Se a&#xF1;ade el Flag para que se pueda abrir una activity</span>
        <span class="token comment">// desde un hilo en segundo plano</span>
        intento<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intento<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>packageManager<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>intento<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="0" data-start="0">
</div></div></pre><blockquote>
<p>&#x1F4CC; Este ejemplo crea una trabajo que realiza un retardo de 5 segundos y lanza un Intent para abrir otra aplicaci&#xF3;n. Como se puede ver todo el c&#xF3;digo est&#xE1; implementado en el m&#xE9;todo <strong><code>doWork()</code></strong>.</p>
</blockquote>
<h5 class="mume-header" id="iniciar-un-trabajo">Iniciar un trabajo</h5>

<p>Este tipo de trabajos permite definir si queremos el hilo como tarea &#xFA;nica o periodica cada <strong><code>X</code></strong> tiempo. Para ello se usan dos clases distintas <strong><code>OneTimeWorkRequestBuilder&lt;T&gt;()</code></strong> y <strong><code>PeriodicWorkRequestBuilder&lt;T&gt;()</code></strong>. Veamos ejemplos de la creaci&#xF3;n de trabajos de los dos tipos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">val</span> work <span class="token operator">=</span> OneTimeWorkRequestBuilder<span class="token operator">&lt;</span>MiWorkManager<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> workPeriodico <span class="token operator">=</span>PeriodicWorkRequestBuilder<span class="token operator">&lt;</span>MiWorkManager<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span>
                                                           <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>E el caso de tarea &#xFA;nica no hay nada que explicar, en cambio de la periodica podemos decir que le entra como primer argumento el intervalo que tiene que pasar hasta que se vuelva a realizar la siguiente iteraci&#xF3;n y el segundo argumento especifica las unidades del anterior (en este caso la tarea se repetir&#xE1; cada 16 minutos).</p>
<div style="page-break-after:always;"></div>
<blockquote>
<p>&#x270B; Algunos puntos importantes a tener en cuenta al trabajar con <strong><code>WorkManager</code></strong> son:</p>
<ul>
<li>La primera ejecuci&#xF3;n ocurre inmediatamente despu&#xE9;s de que se cumplen las restricciones mencionadas por la solicitud de trabajo</li>
<li>El trabajo se puede encadenar con otras solicitudes de trabajo.</li>
<li>Si no se cancela se seguir&#xE1; ejecutando hasta que acabe.</li>
</ul>
<p>Adem&#xE1;s de lo anterior en caso de  trabajos de tipo periodicos, <strong><code>PeriodicWorkRequest</code></strong>, tambi&#xE9;n se tendr&#xE1; en cuenta son:</p>
<ul>
<li>El trabajo se ejecuta varias veces.</li>
<li>Si no se cancela se seguir&#xE1; ejecutando peri&#xF3;dicamente.</li>
<li>La siguiente ejecuci&#xF3;n ocurre despu&#xE9;s de que transcurra el periodo de tiempo indicado en los argumentos.</li>
<li>El intervalo m&#xED;nimo de repetici&#xF3;n es de <em>15 minutos</em>.</li>
<li>El trabajo no se puede encadenar con otras solicitudes de &gt;trabajo.</li>
<li>El intervalo de tiempo entre 2 intervalos peri&#xF3;dicos puede diferir seg&#xFA;n las restricciones de optimizaci&#xF3;n del sistema operativo.</li>
</ul>
</blockquote>
<p>Una vez creado el objeto, para ejecutar la solicitud de trabajo necesitamos llamar al m&#xE9;todo <strong><code>enqueue()</code></strong> desde una instancia de <strong><code>WorkManager</code></strong> y pasar el <strong><code>WorkRequest</code></strong>:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">val</span> workPeriodico <span class="token operator">=</span> PeriodicWorkRequestBuilder<span class="token operator">&lt;</span>WorkPeriodico<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span>
                                                               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
WorkManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>workPeriodico<span class="token punctuation">)</span>
</pre><p>El m&#xE9;todo <strong><code>enqueue()</code></strong> pone en cola una o m&#xE1;s <strong><code>WorkRequests</code></strong> para que se ejecuten en segundo plano.</p>
<h5 class="mume-header" id="funcionalidad-de-workmanager">Funcionalidad de WorkManager</h5>

<p>Las instancias de <strong><code>WorkManager</code></strong> proporcionan una serie de funcionalidades para manejarnos con las tareas. Por ejemplo, podemos controlar si las tareas est&#xE1;n canceladas o cancelarlas si nos interesa, etc:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">val</span> workManager <span class="token operator">=</span> WorkManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> id<span class="token operator">:</span>UUID
id <span class="token operator">=</span> workPeriodico<span class="token punctuation">.</span>id
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>workManager<span class="token punctuation">.</span><span class="token function">getWorkInfoById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>isCancelled<span class="token punctuation">)</span>
                 workManager<span class="token punctuation">.</span><span class="token function">cancelWorkById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token comment">//En este caso se cancelan todas las tareas lanzadas por esta actividad</span>
workManager<span class="token punctuation">.</span><span class="token function">cancelAllWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Cuando cancelamos un trabajo, este no se cancela autom&#xE1;ticamente sino que es el sistema el que se encarga de informar de la cancelaci&#xF3;n. Por lo que ser&#xE1; tarea del programador atender a la informaci&#xF3;n del sistema para parar el trabajo. Esto se hace desde la clase que hereda de <strong><code>WorkManager</code></strong>, por ejemplo de las siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> <span class="token function">MiUnicoWork</span><span class="token punctuation">(</span><span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> workerParams<span class="token operator">:</span> WorkerParameters<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">Worker</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> workerParams<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Result <span class="token punctuation">{</span>
     <span class="token operator">..</span><span class="token punctuation">.</span>
     <span class="token comment">//isStopped devolver&#xE1; true cuando el sistema informe</span>
     <span class="token comment">//que el trabajo ha sido cancelado desde c&#xF3;digo</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>isStopped<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;DATOS&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Realizar tarea larga&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
     <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h5 class="mume-header" id="restricciones-de-workmanager">Restricciones de WorkManager</h5>

<p>Una de las ventajas que proporciona esta clase, es la de permitir <a href="https://developer.android.com/topic/libraries/architecture/workmanager/how-to/define-work#work-constraints">restringir</a> la funcionalidad de la tarea hasta que se cumplan una serie de condiciones que se le hayan asociado. Logicamente, estas restricciones se impondr&#xE1;n al ser necesarios algunos requisitos para la funcionalidad de la app. Por ejemplo, si se necesita Internet para realizar una descarga de datos. En el siguiente c&#xF3;digo se han a&#xF1;adido todas las restricciones posibles:</p>
<pre data-role="codeBlock" data-info="Kotlin" class="language-kotlin"><span class="token comment">//Se construyen las restricciones</span>
<span class="token keyword">val</span> constraints <span class="token operator">=</span> Constraints<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequiresBatteryNotLow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequiredNetworkType</span><span class="token punctuation">(</span>NetworkType<span class="token punctuation">.</span>CONNECTED<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequiresCharging</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequiresStorageNotLow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setRequiresDeviceIdle</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> workUnico <span class="token operator">=</span> OneTimeWorkRequestBuilder<span class="token operator">&lt;</span>MiUnicoWork<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Se a&#xF1;aden al trabajo</span>
workUnico<span class="token punctuation">.</span><span class="token function">setConstraints</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span>
WorkManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>workUnico<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><h5 class="mume-header" id="comunicaci%C3%B3n-con-workmanager">Comunicaci&#xF3;n con WorkManager</h5>

<p>Si queremos comunicar informaci&#xF3;n a la tarea, ya sea como datos de entrada antes de su ejecuci&#xF3;n o como datos de salida al terminar, se utiliza la clase <strong><code>Data.Builder</code></strong>. La informaci&#xF3;n se a&#xF1;ade al objeto mediante el ya conocido m&#xE9;todo del mapa clave-valor.<br>
Para acceder a estos datos de entrada dentro del Worker, se usa la propiedad <strong><code>inputData</code></strong> dentro del m&#xE9;todo <strong><code>doWork()</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">val</span> inputData <span class="token operator">=</span> Data<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">&quot;PASS&quot;</span><span class="token punctuation">,</span> pass<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> workUnico <span class="token operator">=</span> OneTimeWorkRequestBuilder<span class="token operator">&lt;</span>MiUnicoWork<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
workUnico<span class="token punctuation">.</span><span class="token function">setInputData</span><span class="token punctuation">(</span>inputData<span class="token punctuation">)</span>
WorkManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>workUnico<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword">class</span> <span class="token function">MiUnicoWork</span><span class="token punctuation">(</span><span class="token keyword">val</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> workerParams<span class="token operator">:</span> WorkerParameters<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">Worker</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> workerParams<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Result <span class="token punctuation">{</span>
     <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">val</span> user <span class="token operator">=</span> inputData<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> pass <span class="token operator">=</span> inputData<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;PASS&quot;</span><span class="token punctuation">)</span>
     <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Ejercicio resuelto n&#xFA;meros primos<br>
</span></p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Ejercicio propuesto temporizador con vibraci&#xF3;n<br>
</span></p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>