<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 11. Persistencia de Datos III Firebase</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview .slides > section {
  height: 100%;
  font-size: 90%;
  overflow-y: auto !important;
}
.markdown-preview.markdown-preview .slide code {
  color: yellow;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v17/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="apuntes">Apuntes</h1>

<p>Descargar estos apuntes en <a href="./tema11_3_Persistencia_de_Datos_III_firebase.pdf">pdf</a> y <a href="./tema11_3_Persistencia_de_Datos_III_firebase.html">html</a></p>
<h1 class="mume-header undefined" id="tema-113-persistencia-de-datos-iii-firebase">Tema 11.3. Persistencia de Datos III Firebase</h1>

<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>

<ol>
<li><a href="#acceso-a-base-de-datos-con-firebase">Acceso a Base de Datos con FIREBASE</a>
<ol>
<li><a href="#creando-un-app-de-firebase">Creando un app de Firebase</a></li>
<li><a href="#firestore-database">Firestore DataBase</a>
<ol>
<li><a href="#firebaseui-y-recyclerview">FirebaseUI y RecyclerView</a></li>
<li><a href="#filtrado-y-ordenaci%C3%B3n">Filtrado y ordenaci&#xF3;n</a></li>
</ol>
</li>
<li><a href="#firebase-auth-autenticaci%C3%B3n">Firebase Auth. Autenticaci&#xF3;n</a></li>
</ol>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="acceso-a-base-de-datos-con-firebase">Acceso a Base de Datos con FIREBASE</h2>

<p><a href="https://firebase.google.com/">Firebase</a> es una plataforma de backend para construir aplicaciones m&#xF3;viles y web, se encarga del manejo de la infraestructura permitiendo que el desarrollador se enfoque en otros aspectos de la aplicaci&#xF3;n. Entre sus caracter&#xED;sticas se incluye base de datos de tiempo real, autenticaci&#xF3;n de usuarios y almacenamiento (hosting) est&#xE1;tico. La idea de usar Firebase es no tener que escribir c&#xF3;digo del lado del servidor y aprovechar al m&#xE1;ximo las caracter&#xED;sticas que nos provee la plataforma. Para utilizar Firebase con Android disponemos de un SDK, lo que nos permitir&#xE1; integrarlo f&#xE1;cilmente a nuestra aplicaci&#xF3;n. Para este ejemplo vamos a construir un listado de cosas por hacer usando la base de datos de tiempo real de Firebase como backend y autenticaci&#xF3;n con email/password.</p>
<h3 class="mume-header" id="creando-un-app-de-firebase">Creando un app de Firebase</h3>

<p>El primer paso es asociar nuestra cuenta de Firebase a una de nuestras cuentas de correo electr&#xF3;nico:</p>
<div align="center">
    <img height="250" src="./imagenes/imagen16.png">
</div>
<p>Una vez est&#xE1; lista veremos la pantalla donde es posible visualizar nuestros proyectos o crear nuevos.</p>
<div align="center">
    <img height="250" src="./imagenes/imagen17.png">
</div>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td style="border: 0;">
Para crear un nuevo proyecto solamente tendremos que introducir un nombre y la organizaci&#xF3;n o carpeta principal del proyecto. Google nos pedir&#xE1; si queremos habilitar Google Analytics en el proyecto, lo dejaremos habilitado.
</td>
<td style="border: 0;">
<div align="center">
    <img width="1000" src="./imagenes/imagen18.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<div align="left">
    <img height="50" src="./imagenes/imagen19.png">
</div>
<p>Y lo asociaremos a la cuenta por defecto. Una vez realizados estos pasos, se crear&#xE1; el proyecto de firebase.</p>
<p>Posteriormente nos aparecer&#xE1; la pantalla que nos permitir&#xE1; a&#xF1;adir la aplicaci&#xF3;n a nuestro proyecto Cada proyecto estar&#xE1; asociado a una o m&#xE1;s aplicaciones, por lo que antes de crear el proyecto necesitaremos crear la aplicaci&#xF3;n o decidir el espacio de nombres de esta.</p>
<p><em>Vamos a crear una aplicaci&#xF3;n sencilla con el siguiente aspecto, que nos permita entender el funcionamiento de acceso a Firebase para enviar y recibir datos sin autentificaci&#xF3;n.</em></p>
<div align="center">
    <img height="200" src="./imagenes/imagen32.png">
</div>
<p>Cuando el usuario meta la informaci&#xF3;n en los TextView y pulse el bot&#xF3;n a&#xF1;adir, la informaci&#xF3;n se guarda en Firebase y cuando se modifique esta desde Firebase, se mostrar&#xE1; un mensaje con el texto modificado en el Txt de la aplicaci&#xF3;n.</p>
<div align="center">
    <img height="150" src="./imagenes/imagen20.png">
</div>
<p>Una vez tengamos el espacio de nombre, podremos seguir con los pasos que nos pide Firebase para crear la aplicaci&#xF3;n. En nuestro caso no ser&#xE1; necesario introducir la firma de certificaci&#xF3;n.</p>
<div align="center">
    <img height="350" src="./imagenes/imagen21.png">
</div>
<p>Justo en el momento que termina de crearse la aplicaci&#xF3;n, se descargara un archivo JSON que deberemos copiar en nuestro proyecto Android. Solo tendremos que seguir las instrucciones que proporciona muy claramente la p&#xE1;gina Web de Firebase (copiar el archivo y a&#xF1;adir las l&#xED;neas que indican que vamos a usar servicios de google en los build.gradle de la app y del proyecto).</p>
<ol>
<li>
<p>En el proyecto</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy">  dependencies <span class="token punctuation">{</span>
     classpath <span class="token string">&quot;com.android.tools.build:gradle:7.0.3&quot;</span>
     classpath <span class="token string">&quot;com.google.gms:google-services:4.3.10&quot;</span> <span class="token comment">//a&#xF1;adir esta l&#xED;nea</span>
     <span class="token punctuation">...</span>
  <span class="token punctuation">}</span>
</pre></li>
<li>
<p>En la APP</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy">plugins <span class="token punctuation">{</span>
   id <span class="token string">&apos;com.android.application&apos;</span>
   id <span class="token string">&apos;kotlin-android&apos;</span>
   id <span class="token string">&apos;com.google.gms.google-services&apos;</span>  <span class="token comment">// Google Services plugin</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>
    implementation <span class="token string">&apos;androidx.appcompat:appcompat:1.3.1&apos;</span>
    <span class="token comment">//a&#xF1;adir las siguientes dos l&#xED;neas</span>
    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">&apos;com.google.firebase:firebase-bom:28.4.1&apos;</span><span class="token punctuation">)</span>
    implementation <span class="token string">&apos;com.google.firebase:firebase-analytics&apos;</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</pre><p>La dependencia de firebase bom permitir&#xE1; evitar a&#xF1;adir la versi&#xF3;n al resto de dependencias de Firebase que incluyamos en nuestro proyecto, facilitando mucho el trabajo.</p>
<p>Muy importante no olvidar a&#xF1;adir en el SDK, el servicio de Google Play</p>
</li>
</ol>
<div align="center">
    <img height src="./imagenes/imagen22.png">
</div>
<p>En el modo consola podremos acceder a todos nuestros proyectos, y podemos comprobar la aplicaci&#xF3;n o aplicaciones a&#xF1;adidas sobre un proyecto (podemos a&#xF1;adir m&#xE1;s de una).</p>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td align="center" rowspan="2">
<div align="left">
    <img width="400" src="./imagenes/imagen24.png">
</div>
</td>
<td style="border:hidden;">
<div align="center">
    <img height="150" src="./imagenes/imagen23.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;">
Accediendo a la configuraci&#xF3;n de la aplicaci&#xF3;n o del proyecto, podremos ver informaci&#xF3;n sobre las claves, ID de aplicaci&#xF3;n y dem&#xE1;s. Tambi&#xE9;n podremos descargar de nuevo el .json de configuraci&#xF3;n de los servicios.
</td>
</tr>

</tbody></table>
</span>
<p>Todas las aplicaciones por defecto se encuentran en modo desarrollo y bajo el plan gratis que soporta hasta 100 conexiones concurrentes, 1GB de almacenamiento y 10GB de transferencia en el backend. Luego de creada el app nos dirigimos a ver sus detalles, podemos entrar en diversas pesta&#xF1;as que nos permitir&#xE1;n trabajar con la APP, pero a nosotros nos interesa la BD. Firebase ofrece dos soluciones de bases de datos en la nube y accesibles para los clientes que admiten sincronizaci&#xF3;n en tiempo real:</p>
<ul>
<li>
<p><strong><code>Firestore DataBase</code></strong> en ocasiones tambi&#xE9;n nombrada Cloud Firestores, es la base de datos m&#xE1;s reciente de Firebase. Aprovecha lo mejor de Realtime Database con un modelo de datos nuevo, permite consultas m&#xE1;s ricas y r&#xE1;pidas, y el escalamiento se ajusta a un nivel m&#xE1;s alto que Realtime Database.</p>
</li>
<li>
<p><strong><code>Realtime Database</code></strong> es la base de datos original de Firebase. Es una soluci&#xF3;n eficiente y de baja latencia destinada a las apps para dispositivos m&#xF3;viles que necesitan estados sincronizados entre los clientes en tiempo real. Es similar a la anterior en su uso, por lo que no la explicaremos.</p>
</li>
</ul>
<div align="center">
    <img height="250" src="./imagenes/imagen25.png">
</div>
<h3 class="mume-header" id="firestore-database">Firestore DataBase</h3>

<p>Base de datos NoSQL flexible, escalable y en la nube a fin de almacenar y sincronizar datos para la programaci&#xF3;n en el lado del cliente y del servidor. Al igual que <a href="https://firebase.google.com/docs/database">Firebase Realtime Database</a> mantiene los datos sincronizados entre apps cliente a trav&#xE9;s de agentes de escucha en tiempo real. El modelo de datos de <a href="https://firebase.google.com/docs/firestore">Firebase Firestore DataBase</a> admite estructuras de datos flexibles y jer&#xE1;rquicas.</p>
<p>Almacena los datos en documentos organizados en colecciones, los documentos pueden contener objetos anidados complejos, adem&#xE1;s de subcolecciones. Est&#xE1; optimizada para almacenar grandes colecciones de documentos peque&#xF1;os. El modelo de datos est&#xE1; formado por documentos, cada documento contiene un conjunto de pares clave-valor. Todos los documentos se deben almacenar en colecciones, los documentos pueden contener subcolecciones y objetos anidados, y ambos pueden incluir campos primitivos como strings o tipos de objetos complejos como listas. Las colecciones y los documentos se crean de manera impl&#xED;cita en <strong><code>Firestore DataBase</code></strong>. Solo debes asignar datos a un documento dentro de una colecci&#xF3;n. Si la colecci&#xF3;n o el documento no existen,  <strong><code>Firestore DataBase</code></strong> los crea. Cada documento est&#xE1; identificado por una clave &#xFA;nica, que puede generarse autom&#xE1;ticamente o que se puede a&#xF1;adir a la vez que el documento:</p>
<div align="center">
    <img width src="./imagenes/imagen26.png">
</div>
<p>Son muy similares a JSON, de hecho, b&#xE1;sicamente son JSON. Existen algunas diferencias, por ejemplo: los documentos admiten <strong>tipos de datos adicionales</strong> y su tama&#xF1;o se limita a 1 MB, pero en general, puedes tratar los documentos como registros JSON livianos. Los documentos viven en colecciones, que simplemente son contenedores de documentos. Por ejemplo, podr&#xED;as tener una colecci&#xF3;n llamada users con los distintos usuarios de tu app, en la que haya un documento que represente a cada uno:</p>
<div align="center">
    <img height="250" src="./imagenes/imagen27.png">
</div>
<p><em>Usando el ejercicio del que hemos creado el layout de inicio, vamos a a&#xF1;adir el c&#xF3;digo necesario para que nos permita interactuar con Firebase. La aplicaci&#xF3;n  guardar&#xE1; usuarios con contrase&#xF1;a en la base de datos con <strong><code>Firebase Cloud Firestone</code></strong> y adem&#xE1;s permitir&#xE1; la autenticaci&#xF3;n con <strong><code>Firebase Auth</code></strong>.</em></p>
<p><em>En el proyecto de Firebase que acabamos de crear, a&#xF1;adiremos una base de datos <strong>Firestore DataBase</strong>.</em></p>
<div align="center">
    <img height="200" src="./imagenes/imagen28.png">
</div>
<p><em>Deberemos seleccionar la ubicaci&#xF3;n de nuestra Base de Datos, podemos seleccionar Z&#xDA;RICH(europe-west6)</em>. Un elemento importante y que todav&#xED;a no hemos mencionado, son la Reglas. La Firebase Cloud Firestore proporciona un lenguaje de reglas flexibles basadas en expresiones y sintaxis similar a la de JavaScript <a href="https://firebase.google.com/docs/firestore/security/get-started?authuser=0">https://firebase.google.com/docs/firestore/security/get-started?authuser=0</a>, que permite definir f&#xE1;cilmente la manera en que tus datos deben estructurarse e indexarse, y el momento en que pueden someterse a lectura y escritura. Estas reglas las podremos configurar desde la pesta&#xF1;a RULES de nuestra BD,</p>
<div align="center">
    <img height="150" src="./imagenes/imagen29.png">
</div>
<p>Por defecto vendr&#xED;an configuradas para modo producci&#xF3;n, aunque para iniciarse podemos seleccionar modo de prueba (dura 30 d&#xED;as).</p>
<div align="center">
    <img height="220" src="./imagenes/imagen30.png">
</div>
<div align="center">
    <img height="150" src="./imagenes/imagen31.png">
</div>
<p>Si nos hubi&#xE9;semos confundido o quisi&#xE9;ramos cambiar las reglas, habr&#xED;a que cambiar su valor y sobre todo <strong>No olvidar Publicar</strong>.</p>
<p>Antes de comenzar con el c&#xF3;digo de acceso a la BD, tendremos que a&#xF1;adir la dependencia que nos permitir&#xE1; hacerlo:</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy">implementation <span class="token string">&apos;com.google.firebase:firebase-firestore&apos;</span>
</pre><p>Para referenciar a nuestra base de datos solamente tendremos que crear un objeto de tipo <strong><code>FirebaseFirestore</code></strong>. El archivo que descargamos al enlazar la app con el proyecto, es el que se encarga de todo el trabajo interno para la conexi&#xF3;n:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-val">val</span> firebaseFirestore <span class="token operator">=</span> FirebaseFirestore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Para hacer referencia a una colecci&#xF3;n existente o a&#xF1;adirla en caso de no existir, utilizaremos el m&#xE9;todo <strong><code>collection</code></strong> con el nombre de la colecci&#xF3;n como argumento.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
</pre><p>Este m&#xE9;todo devuelve una referencia a la colecci&#xF3;n seleccionada, y con &#xE9;l podremos a&#xF1;adir nuevos elementos a ella (la colecci&#xF3;n se crear&#xE1; al a&#xF1;adir el primer documento, en caso de haber sido creada anteriormente har&#xE1; la referencia solamente).</p>
<p>Para a&#xF1;adir un objeto (documento) a la colecci&#xF3;n lo podremos hacer de dos maneras:</p>
<ol>
<li>
<p>Dejando que la plataforma genere una clave aleat&#xF3;ria, para eso utilizaremos el m&#xE9;todo add.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Usuario</span><span class="token punctuation">(</span><span class="token string">&quot;Pepe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;correo@gmail.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre> <div align="center">
     <img height="95" src="./imagenes/imagen33.png">
 </div>
</li>
<li>
<p>A&#xF1;adiendo nosotros la clave, esta debe ser &#xFA;nica para que el usuario se a&#xF1;ada.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
</pre> <div align="center">
 <img height="95" src="./imagenes/imagen34.png">
 </div>
</li>
</ol>
<p>Para insertar el valor del nuevo hijo hemos utilizado un objeto de la clase Pojo Usuario, que nos habremos creado con anterioridad*, Firestore convierte autom&#xE1;ticamente los atributos con sus valores para poder guardarlos correctamente. <strong>Cuidado deberemos tener los atributos p&#xFA;blicos o usar getter y setter.</strong></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> Usuario <span class="token operator">:</span> Serializable <span class="token punctuation">{</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> usuario<span class="token operator">:</span> String
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> correo<span class="token operator">:</span> String

    <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> String<span class="token punctuation">,</span> correo<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>usuario <span class="token operator">=</span> usuario
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>correo <span class="token operator">=</span> correo
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>El c&#xF3;digo completo para crear la aplicaci&#xF3;n que nos a&#xF1;adir&#xE1; un usuario cada vez que pulsemos el bot&#xF3;n a&#xF1;adir, de forma que el id del usuario sea el correo, ser&#xE1; el siguiente:</p>
<pre data-role="codeBlock" data-info="kotlin{class=&quot;line-numbers&quot;}" class="language-kotlin line-numbers"><span class="token keyword keyword-class">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> firebaseFirestore<span class="token operator">:</span> FirebaseFirestore
    <span class="token keyword keyword-var">var</span> listenerRegistration<span class="token operator">:</span> ListenerRegistration<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        firebaseFirestore <span class="token operator">=</span> FirebaseFirestore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> usuarioET <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextInputLayout<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> correoET <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextInputLayout<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> a&#xF1;adir <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>anyadir<span class="token punctuation">)</span>

        <span class="token keyword keyword-val">val</span> salida <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextView<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>salida<span class="token punctuation">)</span>
        a&#xF1;adir<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> usuario <span class="token operator">=</span> <span class="token function">Usuario</span><span class="token punctuation">(</span>usuarioET<span class="token punctuation">.</span>editText<span class="token operator">?</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  correoET<span class="token punctuation">.</span>editText<span class="token operator">?</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addOnSuccessListener</span> <span class="token punctuation">{</span>
                              Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                              <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                              <span class="token string">&quot;Usuario A&#xF1;adido&quot;</span><span class="token punctuation">,</span>
                              Toast<span class="token punctuation">.</span>LENGTH_SHORT
                              <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
                             <span class="token punctuation">.</span><span class="token function">addOnFailureListener</span> <span class="token punctuation">{</span> e <span class="token operator">-&gt;</span>
                             Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                             <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                             <span class="token string">&quot;Error&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                             Toast<span class="token punctuation">.</span>LENGTH_SHORT
                             <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Como se puede ven en el c&#xF3;digo del OnClick, a&#xF1;adimos el usuario recogido de los EditText creando como clave el correo, como se ha explicado anteriormente en el tema.Adem&#xE1;s a los m&#xE9;todos de a&#xF1;adir objeto (set o add) se le pueden asignar&#xE1;n distintos escuchadores para comprobar el estado del proceso. <strong>L&#xED;nea 19 y 25</strong>.</p>
</blockquote>
<p>Para <a href="https://cloud.google.com/firestore/docs/query-data/queries?hl=es">buscar un documento en Cloud Firestore</a>, existen distintas posibilidades  basadas en la clausula <strong>Where</strong>. <em>Por ejemplo, si quisieramos comprobar si el id del usuario no est&#xE1; repetido y solo en ese caso a&#xF1;adirlo, podr&#xED;amos modificar el anterior c&#xF3;digo de la siguiente manera:</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token keyword keyword-fun">fun</span> <span class="token function">compruebaSiExisteyAnayade</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span>FieldPath<span class="token punctuation">.</span><span class="token function">documentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span>OnCompleteListener<span class="token operator">&lt;</span>QuerySnapshot<span class="token operator">?</span><span class="token operator">&gt;</span>
             <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">anyadeUsuario</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span> 
                    <span class="token keyword keyword-else">else</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                        <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;El correo ya existe, introduce uno nuevo&quot;</span><span class="token punctuation">,</span>
                        Toast<span class="token punctuation">.</span>LENGTH_LONG
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                    Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">anyadeUsuario</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnSuccessListener</span> <span class="token punctuation">{</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Usuario A&#xF1;adido&quot;</span><span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">addOnFailureListener</span> <span class="token punctuation">{</span> e <span class="token operator">-&gt;</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Error&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p>Si quisieramos dar funcionalidad al bot&#xF3;n <strong>Eliminar</strong>, podemos hacer algo parecido a lo siguiente. En este caso se est&#xE1; eliminando por nombre de usuario, as&#xED; que en el caso de existir m&#xE1;s de un documento con el mismo nombre, se eliminar&#xE1;n todos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">Elimina</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;usuario&quot;</span><span class="token punctuation">,</span> usuario<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span> 
               <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>documento <span class="token keyword keyword-in">in</span> task<span class="token punctuation">.</span>result<span class="token operator">!!</span><span class="token punctuation">)</span> documento<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                                   <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p>Si lo que queremos es controlar los cambios que ocurren en la BD, sea a trav&#xE9;s de una aplicaci&#xF3;n o directamente desde la consola de Firebase, tendremos que registrar un listener del tipo ListenerRegistration, que se inicializar&#xE1; sobre la consulta que deseemos con <strong><code>addSnapshotListener</code></strong>. <em>En el siguiente ejemplo ponemos a escuchar todos los documentos de la colecci&#xF3;n Usuarios, mostrando en el TextView (que est&#xE1; bajo los botones) el resultado de cualquier modificaci&#xF3;n en cualquier documento de la colecci&#xF3;n.</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">listarUsuarios</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> query <span class="token operator">=</span> firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
        listenerRegistration <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">addSnapshotListener</span> <span class="token punctuation">{</span>value<span class="token punctuation">,</span> error<span class="token operator">-&gt;</span>
           <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>dc <span class="token keyword keyword-in">in</span> value<span class="token operator">!!</span><span class="token punctuation">.</span>documentChanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>dc<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>ADDED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\nSe ha a&#xF1;adido:&quot;</span><span class="token operator">+</span>
                             <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>MODIFIED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\n Se ha modificado:&quot;</span><span class="token operator">+</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>REMOVED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\nSe ha eliminado:&quot;</span><span class="token operator">+</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>  Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> <span class="token string">&quot;No se puede listar&quot;</span><span class="token operator">+</span>error<span class="token punctuation">,</span> 
                                  Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p>Se puede realizar la consulta sobre cualquier elemento de la colecci&#xF3;n despu&#xE9;s de haber sido seleccionado, de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">query<span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;correo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;manuel@gamil.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSnapshotListener</span><span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x26A0;&#xFE0F; <strong>Aviso:</strong> Otro tema importante a tener en cuenta, es que la suscripci&#xF3;n a una referencia de una base de datos de Firebase, es decir, el hecho de asignar un listener a una ubicaci&#xF3;n del &#xE1;rbol para estar al tanto de sus cambios <strong>no es algo gratuito</strong> desde el punto de vista de consumo de recursos. Por tanto, es recomendable eliminar esa suscripci&#xF3;n cuando ya no la necesitamos. Para hacer esto basta con llamar al m&#xE9;todo <strong><code>remove()</code></strong> del listener registrado, cuando no deseemos seguir escuchando.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        listenerRegistration<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre></blockquote>
<h4 class="mume-header" id="firebaseui-y-recyclerview">FirebaseUI y RecyclerView</h4>

<p><a href="https://github.com/firebase/FirebaseUI-Android">FirebaseUI</a> nos permite asociar f&#xE1;cilmente a un control <strong><code>ListView</code></strong> o <strong><code>RecyclerView</code></strong>, una referencia a una lista de elementos de una base de datos Firebase. De esta forma, el control se actualizar&#xE1; autom&#xE1;ticamente cada vez que se produzca cualquier cambio en la lista, sin tener que gestionar manualmente por nuestra parte los eventos de la lista, ni tener que almacenar en una estructura paralela la informaci&#xF3;n, ni tener que construir gran parte de los adaptadores necesarios&#x2026; en resumen, ahorrando muchas l&#xED;neas de c&#xF3;digo y evitando muchos posibles errores. Para utilizar <strong><code>FirebaseUI</code></strong> lo primero que tendremos que hacer ser&#xE1; a&#xF1;adir la referencia a la librer&#xED;a en el fichero build.gradle de nuestro m&#xF3;dulo principal. Hay que tener en cuenta que cada versi&#xF3;n de <strong><code>FirebaseUI</code></strong> es compatible &#xFA;nicamente con una versi&#xF3;n concreta de Firebase, por lo que debemos asegurar que las versiones utilizadas de ambas librer&#xED;as son coherentes. En la p&#xE1;gina de <strong><code>FirebaseUI</code></strong> ten&#xE9;is disponible la tabla de compatibilidades entre versiones. En el momento de actualizaci&#xF3;n de estos apuntes:</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy">implementation <span class="token string">&apos;com.firebaseui:firebase-ui-firestore:8.0.0&apos;</span>
</pre><p>Esta librer&#xED;a nos provee de una Adaptador derivado de <strong><code>RecyclerView.ViewAdapter</code></strong> que gestionar&#xE1; autom&#xE1;ticamente la carga de los datos que le pasemos como referencia en la vista asignada por el <strong><code>Holder</code></strong>, para ello lo primero que deberemos crear es el ViewHolder personalizado que gestione los datos de nuestras aplicaci&#xF3;n (retomamos el ejemplo e implementamos el bot&#xF3;n listar, podemos crear un fragment o activity para mostrar).</p>
<pre data-role="codeBlock" data-info="kotlin{class=&quot;line-numbers&quot;}" class="language-kotlin line-numbers"><span class="token keyword keyword-class">class</span> <span class="token function">Adaptador</span><span class="token punctuation">(</span>options<span class="token operator">:</span> FirestoreRecyclerOptions<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    FirestoreRecyclerAdapter<span class="token operator">&lt;</span>Usuario<span class="token punctuation">,</span> Adaptador<span class="token punctuation">.</span>Holder<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    View<span class="token punctuation">.</span><span class="token function">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> listener<span class="token operator">:</span> View<span class="token punctuation">.</span>OnClickListener<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-override">override</span>  <span class="token keyword keyword-fun">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> Holder<span class="token punctuation">,</span> position<span class="token operator">:</span> Int<span class="token punctuation">,</span> 
                                   model<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        holder<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">,</span> viewType<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> 
                                    Holder <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> view<span class="token operator">:</span> View <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>linea_recycler<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        view<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token function">Holder</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onClickListener</span><span class="token punctuation">(</span>listener<span class="token operator">:</span> View<span class="token punctuation">.</span>OnClickListener<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> listener
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onClick</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
   <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">Holder</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> usuario<span class="token operator">:</span> TextView
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> correo<span class="token operator">:</span> TextView
        <span class="token keyword keyword-fun">fun</span> <span class="token function">bind</span><span class="token punctuation">(</span>item<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            usuario<span class="token punctuation">.</span>text <span class="token operator">=</span> item<span class="token punctuation">.</span>usuario
            correo<span class="token punctuation">.</span>text <span class="token operator">=</span> item<span class="token punctuation">.</span>correo
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
            usuario <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
            correo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Definimos un adaptador como ya hemos hecho anteriormente, con el Holder para controlar las vistas de las l&#xED;neas del recycler <strong>L&#xED;nea 22 a 28</strong>, en donde sobrescribir&#xED;amos, obligatoriamente, los dos m&#xE9;todos y el constructor. He implementar&#xED;amos los listener necesarios para el funcionamiento de los eventos. La principal diferencia es que el Adaptador hereda de la clase <strong><code>FirestoreRecyclerAdapter</code></strong>. FirebaseUI nos facilita el listado de los elementos extraidos de la BD proporcionando esta libreria. A esta clase le tenemos que indicar  que los elementos usados son: el ViewHolder personalizado que acabamos de crear y la clase java que utilicemos para encapsular la informaci&#xF3;n de cada elemento de la lista <strong><code>FirestoreRecyclerAdapter&lt;Usuario, Adaptador.Holder&gt;</code></strong>.<br>
Al crear un objeto de esta clase, debemos pasarle un objeto de la misma librer&#xED;a, de tipo <strong><code>FirestoreRecyclerOptions</code></strong>.</p>
</blockquote>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token keyword keyword-val">val</span> firestoreRecyclerOptions <span class="token operator">=</span> FirestoreRecyclerOptions<span class="token punctuation">.</span>Builder<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Usuario<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Al que debemos pasarle la siguiente informaci&#xF3;n:</p>
<ul>
<li>El objeto clase de nuestro Item (Usuario.class),</li>
<li>La referencia al nodo de la base de datos que contiene la lista de elementos que queremos mostrar en el control.</li>
</ul>
<p>Ahora solo quedar&#xED;a crear un objeto del tipo adaptador que nos hemos creado, pas&#xE1;ndole el elemento <strong><code>firebaseRecyclerOption</code></strong> y ya tendr&#xED;amos casi todo hecho.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">cargarRecycler</span><span class="token punctuation">(</span>query<span class="token operator">:</span> Query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> firestoreRecyclerOptions <span class="token operator">=</span> FirestoreRecyclerOptions<span class="token punctuation">.</span>
                                       Builder<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Usuario<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        recyclerView <span class="token operator">=</span> vista<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>recycler<span class="token punctuation">)</span>
        adapter <span class="token operator">=</span> <span class="token function">Adaptador</span><span class="token punctuation">(</span>firestoreRecyclerOptions<span class="token punctuation">)</span>
        <span class="token comment">//Click para eliminar elementos</span>
        adapter<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">onClickListener</span><span class="token punctuation">{</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Elemento eliminado&quot;</span> <span class="token operator">+</span> recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>
                                           <span class="token function">getChildAdapterPosition</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                adapter<span class="token operator">!!</span><span class="token punctuation">.</span>snapshots<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>
                                            <span class="token function">getChildAdapterPosition</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                            reference<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>adapter <span class="token operator">=</span> adapter
        recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>layoutManager <span class="token operator">=</span> <span class="token function">LinearLayoutManager</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre><p>No deberemos olvidar iniciar el escuchador del adaptador al comenzar la aplicaci&#xF3;n y cerrarlo al acabar.</p>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td>
<div align="center">
    <img height src="./imagenes/imagen36.png">
</div></td>
<td style="border:hidden;">
<div align="center">
    <img height src="./imagenes/imagen35.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<h4 class="mume-header" id="filtrado-y-ordenaci%C3%B3n">Filtrado y ordenaci&#xF3;n</h4>

<p>Lo primero que debemos tener en cuenta es que en las BD de Firebase no vamos a tener todas las facilidades de ordenaci&#xF3;n y filtrado que suelen encontrarse en bases de datos SQL tradicionales. Para las consultas podemos encontrar la informaci&#xF3;n que necesitamos en el siguiente enlace <a href="https://firebase.google.com/docs/firestore/query-data/queries">https://firebase.google.com/docs/firestore/query-data/queries</a>.</p>
<p>Para realizar consultas se utiliza cualquiera de los m&#xE9;todos <strong><code>where</code></strong> que indican que tipo de consulta necesitamos:</p>
<div align="center">
    <img height="110" src=".\imagenes/imagen37.png">
</div>
<p>Usando la colecci&#xF3;n del ejemplo que nos encontramos en el enlace de la p&#xE1;gina de documentaci&#xF3;n de firestore, <em>con la expresi&#xF3;n siguiente recuperar&#xED;amos todos los documentos que tienen una poblaci&#xF3;n menor a 100000 habitantes.</em></p>
<div align="center">
    <img height="20" src=".\imagenes/imagen38.png">
</div>
<p>Se pueden enlazar b&#xFA;squedas con <strong><code>where</code></strong>, de la siguiente manera:</p>
<div align="center">
    <img height="20" src=".\imagenes/imagen39.png">
</div>
<p><em>En este caso se buscar&#xE1;n todos los documentos de estado igual a CA y del resultado de esa b&#xFA;squeda se extraer&#xE1;n solo aquellos que tengan una poblaci&#xF3;n menor a 100000.</em></p>
<p>Tambi&#xE9;n est&#xE1; la opci&#xF3;n de buscar dentro de una colecci&#xF3;n directamente. Si algunos de nuestros documentos tienen un miembro que es una colecci&#xF3;n, podremos realizar la consulta sobre este elemento usando alguna de las sobrecargas de <strong><code>whereArrayContains</code></strong></p>
<div align="center">
    <img height="30" src=".\imagenes/imagen40.png">
</div>
<p><em>En los datos &#x2018;regions&#x2019; se refiere a un array con los nombres de las regiones a las que pertenece cada ciudad, por lo que con la consulta anterior se extraer&#xE1;n todas las ciudades que en ese array tengan la entrada &#x2018;west_coast&#x2019;, si la tienen repetida solo aparecer&#xE1;n una vez en los resultados.</em><br>
Si lo que queremos hacer es ordenar los datos obtenidos, tenemos toda la informaci&#xF3;n en la url <a href="https://firebase.google.com/docs/firestore/query-data/orderlimitdata?hl=es">https://firebase.google.com/docs/firestore/query-data/orderlimitdata?hl=es</a>  Se utilizar&#xE1; cualquiera de las sobrecargas del m&#xE9;todo <strong><code>orderBy</code></strong></p>
<div align="center">
    <img height="100" src=".\imagenes/imagen41.png">
</div>
<p>Por ejemplo, se pueden combinar m&#xE1;s de un <strong><code>orderBy</code></strong> para realizar la consulta que necesitemos. En este caso se ordena por el nombre del estado y a partir de ah&#xED; por n&#xFA;mero de poblaci&#xF3;n y en orden descendiente.</p>
<div align="center">
    <img height="30" src=".\imagenes/imagen42.png">
</div>
<p>Una cl&#xE1;usula <strong><code>orderBy</code></strong> tambi&#xE9;n filtra en busca de la existencia del campo dado. El conjunto de resultados no incluir&#xE1; documentos que no contengan el campo correspondiente.  Como es de esperar, tambi&#xE9;n se pueden ordenar los datos despu&#xE9;s de realizar una consulta <strong><code>where</code></strong>,  pero con la condici&#xF3;n que debe ser sobre el mismo campo por el que se ha hecho la b&#xFA;squeda.</p>
<div align="center">
    <img height="33" src=".\imagenes/imagen43.png">
</div>
<p>Si con orderBy se puede especificar el orden de clasificaci&#xF3;n de los datos, con limit puedes limitar la cantidad de documentos recuperados.</p>
<p><em>Devuelve los nombres de las tres primeras ciudades</em></p>
<div align="center">
    <img height="25" src=".\imagenes/imagen44.png">
</div>
<p><em>Devuelve los nombres de las tres &#xFA;ltimas ciudades</em></p>
<div align="center">
    <img height="25" src=".\imagenes/imagen45.png">
</div>
<p>Otros cursores de consultas que est&#xE1;n disponibles son:</p>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td style="border:hidden;">
<ul>
<li><strong><code>startAt</code></strong> -&gt; La consulta s&#xF3;lo devolver&#xE1; los elementos cuyo<br>
valor sea igual o superior al dato pasado como par&#xE1;metro.<br>
<em>Ciudades con n&#xFA;mero de habitantes 100000 y ordenados por n&#xFA;mero de poblaci&#xF3;n</em></li>
</ul>
</td>
<td style="border:hidden;">
<div align="center">
    <img height src=".\imagenes/imagen46.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;" colspan="2">
<ul>
<li><strong><code>startAfter</code></strong> -&gt; Id&#xE9;ntico al anterior pero para valores superiores, no incluye los documentos con valor igual.</li>
</ul>
</td>
</tr>
<tr>
<td style="border:hidden;">
<ul>
<li><strong><code>endAt</code></strong> -&gt; La consulta s&#xF3;lo devolver&#xE1; los elementos cuyo valor sea igual o inferior al dato pasado como par&#xE1;metro.<br>
<em>Ciudades con n&#xFA;mero de habitantes &lt;= 100000 y ordenados por n&#xFA;mero de poblaci&#xF3;n</em></li>
</ul>

</td>
<td style="border:hidden;">
<div align="center">
    <img width="400" src=".\imagenes/imagen47.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;" colspan="2">
<ul>
<li><strong><code>endBefore</code></strong> -&gt; Id&#xE9;ntico al anterior pero para valores inferiores, no incluye los documentos con valor igual.</li></ul></td>


</tr>
</tbody></table>
</span>
<p>Tambi&#xE9;n podremos utilizar varios criterios de filtrado en la misma consulta, es decir podremos combinar varios de los m&#xE9;todos anteriores para obtener s&#xF3;lo el rango de elementos necesario.</p>
<div align="center">
    <img width="300" src=".\imagenes/imagen48.png">
</div>
<h3 class="mume-header" id="firebase-auth-autenticaci%C3%B3n">Firebase Auth. Autenticaci&#xF3;n</h3>

<p><a href="https://firebase.google.com/docs/auth">Firebase Authentication</a> proporciona servicios de backend, SDK f&#xE1;ciles de usar y bibliotecas de IU ya elaboradas para autenticar a los usuarios en la app. <em>Vamos a iniciarnos en su uso modificando el proyecto anterior, para ello crearemos otro Fragment que ser&#xE1; el primero que se inicie en la aplicaci&#xF3;n. Nos permitir&#xE1; crear una cuenta o autenticarnos con una ya existente, si la autenticaci&#xF3;n es correcta se cargar&#xE1; el fragment con el que se iniciaba nuestro proyecto anteriormente.</em></p>
<p>Si queremos autentificarnos como usuarios, tenemos varias opciones:<strong><code>email/password, google, tel&#xE9;fono, Facebook, twitter, github, anonymous</code></strong>.* Nosotros vamos a ver el ejemplo de email/password y el de anonymous, en el resto de autentificaciones pod&#xE9;is seguir la documentaci&#xF3;n de FireBase.*</p>
<p>El primer paso ser&#xED;a a&#xF1;adir la dependencia de autenticaci&#xF3;n, que como tenemos incluido la de firebase-bom, no necesitar&#xE1; n&#xFA;mero de versi&#xF3;n:</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy"> implementation <span class="token string">&apos;com.google.firebase:firebase-auth&apos;</span>
</pre><p><em>Tendremos que codificar un layout que permita introducir el usuario y la contrase&#xF1;a para poder logearnos.</em></p>
<div align="center">
    <img width="200" src=".\imagenes/imagen49.png">
</div>
<p>Lo siguiente ser&#xE1; activar los proveedores con los que queremos iniciar sesi&#xF3;n. Nos vamos a la opci&#xF3;n Authentication y dentro de este a la pesta&#xF1;a M&#xE9;todos de inicio de sesi&#xF3;n. Tendremos que seleccionar ambos casos y habilitar el estado.</p>
<div align="center">
    <img width="500" src=".\imagenes/imagen50.png">
</div>
<p>Una vez a&#xF1;adido los proveedores, tendremos dos formas de crear los usuarios: <strong>a trav&#xE9;s de la consola y desde la aplicaci&#xF3;n</strong>. Desde la consola nos tendremos que ir a la pesta&#xF1;a usuarios, aqu&#xED; podremos crear los usuarios que necesitemos. Los usuarios an&#xF3;nimos aparecer&#xE1;n solamente con el id &#xFA;nico que asigna Firebase a cada usuario creado.</p>
<p>El otro caso ser&#xE1; al codificar la aplicaci&#xF3;n. Para todos los casos de autentificaci&#xF3;n necesitamos una instancia de <strong><code>FirebaseAuth.getInstance()</code></strong>, a partir de esta podremos a&#xF1;adir los escuchadores necesarios:</p>
<p>El siguiente paso ser&#xE1; decidir si queremos permitir crear usuarios nuevos, o solamente logearnos con alguno existente. En nuestra aplicaci&#xF3;n vamos a hacer las dos cosas, e incluso nos logearemos como an&#xF3;nimos. El c&#xF3;digo aparece a continuaci&#xF3;n, y un enlace con toda la informaci&#xF3;n <a href="https://firebase.google.com/docs/auth/android/password-auth">https://firebase.google.com/docs/auth/android/password-auth</a></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token comment">////// Crear usuario nueveo y iniciar sesi&#xF3;n</span>
        btCrear<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
               FirebaseAuth<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createUserWithEmailAndPassword</span><span class="token punctuation">(</span>
                    user<span class="token punctuation">.</span>editText<span class="token operator">!!</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pasword<span class="token punctuation">.</span>editText<span class="token operator">!!</span>
                        <span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Usuario creado&quot;</span><span class="token punctuation">,</span>
                                            Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span>
                                             <span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Problemas al crear usuario&quot;</span> <span class="token operator">+</span>task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> view

</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">/////Iniciar sesi&#xF3;n con usuario y contrase&#xF1;a</span>
        btIniciar<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
             FirebaseAuth<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signInWithEmailAndPassword</span><span class="token punctuation">(</span>
                user<span class="token punctuation">.</span>editText<span class="token operator">!!</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pasword<span class="token punctuation">.</span>editText<span class="token operator">!!</span>
                    <span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Authentication failed:&quot;</span> <span class="token operator">+</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>
                                             <span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token comment">//////// Iniciar sesi&#xF3;n con an&#xF3;nimo</span>
        btAnonimus<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
                 FirebaseAuth<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signInAnonymously</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span>
                <span class="token punctuation">(</span>
                    <span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Authentication failed:&quot;</span> <span class="token operator">+</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span><span class="token string">&quot;anonimous&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
</pre><p>Como podemos ver en el c&#xF3;digo, lo que se hace es usar cualquiera de los m&#xE9;todos que hayamos elegido (login, an&#xF3;nimo o a&#xF1;adir usuario) sobre la instancia de <strong><code>FirebaseAuth</code></strong>. Con estos pasos tendremos la autentificaci&#xF3;n controlada, y podremos seguir con nuestra aplicaci&#xF3;n.</p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Resuelve el ejercicio de los ejemplos hasta conseguir un correcto funcionamiento</span></p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>