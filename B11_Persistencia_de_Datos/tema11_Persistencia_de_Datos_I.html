<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 11. Persistencia de Datos I</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  background-color: #FFFF;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v8/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="apuntes">Apuntes</h1>

<p><a href="./tema11_Persistencia_de_Datos_I.pdf">Descargar estos apuntes</a></p>
<h1 class="mume-header undefined" id="tema-11-persistencia-de-datos-i">Tema 11. Persistencia de Datos I</h1>

<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>

<ol>
<li><a href="#acceso-a-bases-de-datos-locales-sqlite">Acceso a bases de datos locales. SQLite</a>
<ol>
<li><a href="#introducci%C3%B3n">Introducci&#xF3;n</a></li>
<li><a href="#creaci%C3%B3n-y-apertura-de-la-bd">Creaci&#xF3;n y apertura de la BD</a></li>
<li><a href="#acceso-y-modificaci%C3%B3n-de-los-datos-en-la-bd">Acceso y modificaci&#xF3;n de los datos en la BD</a>
<ol>
<li><a href="#acceso-a-la-bd-mediante-sentencias-sql">Acceso a la BD mediante sentencias sql</a></li>
<li><a href="#acceso-a-la-bd-mediante-sqlitedatabase">Acceso a la BD mediante SQLiteDataBase</a></li>
<li><a href="#recuperaci%C3%B3n-de-datos-con-rawquery">Recuperaci&#xF3;n de datos con rawQuery</a></li>
<li><a href="#recuperaci%C3%B3n-de-datos-con-query">Recuperaci&#xF3;n de datos con query</a></li>
</ol>
</li>
<li><a href="#uso-de-simplecursoradapter">Uso de SimpleCursorAdapter</a>
<ol>
<li><a href="#cursores-con-recyclerview">Cursores con RecyclerView</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#acceso-a-bases-de-datos-remotas">Acceso a bases de datos remotas</a>
<ol>
<li><a href="#introducci%C3%B3n-1">Introducci&#xF3;n</a></li>
<li><a href="#acceso-a-bases-de-datos-con-apirest-y-retrofit">Acceso a bases de datos con Apirest y Retrofit</a>
<ol>
<li><a href="#definici%C3%B3n-del-servicio-rest">Definici&#xF3;n del Servicio Rest</a></li>
<li><a href="#consumo-de-un-servicio-rest-desde-android">Consumo de un Servicio Rest desde Android</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#acceso-a-base-de-datos-con-firebase">Acceso a Base de Datos con FIREBASE</a>
<ol>
<li><a href="#creando-un-app-de-firebase">Creando un app de Firebase</a></li>
<li><a href="#firestore-database">Firestore DataBase</a>
<ol>
<li><a href="#firebaseui-y-recyclerview">FirebaseUI y RecyclerView</a></li>
<li><a href="#filtrado-y-ordenaci%C3%B3n">Filtrado y ordenaci&#xF3;n</a></li>
</ol>
</li>
<li><a href="#firebase-auth-autenticaci%C3%B3n">Firebase Auth. Autenticaci&#xF3;n</a></li>
</ol>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="acceso-a-bases-de-datos-locales-sqlite">Acceso a bases de datos locales. SQLite</h2>

<h3 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h3>

<p>La plataforma Android proporciona dos herramientas principales para el almacenamiento y consulta de datos estructurados: la base de datos <strong>SQLite</strong> y <strong>Content Providers</strong> (lo trabajaremos en temas posteriores).<br>
Vamos a centrarnos en <a href="https://developer.android.com/training/data-storage/sqlite?hl=es">SQLite</a>, aunque no entraremos ni en el dise&#xF1;o de BBDD relacionales ni en el uso avanzado de la BBDD. Para conocer toda la funcionalidad de SQLite se recomienda usar la documentaci&#xF3;n oficial.<br>
Para el acceso a las bases de datos tendremos tres clases que tenemos que conocer. La clase <strong><code>SQLiteOpenHelder</code></strong>, que encapsula todas las funciones de creaci&#xF3;n de la base de datos y versiones de la misma. La clase <strong><code>SQLiteDatabase</code></strong>, que incorpora la gesti&#xF3;n de tablas y datos. Y por &#xFA;ltimo la clase <strong><code>Cursor</code></strong>, que usaremos para movernos por el recordset que nos devuelve una consulta <em>SELECT</em>.</p>
<h3 class="mume-header" id="creaci%C3%B3n-y-apertura-de-la-bd">Creaci&#xF3;n y apertura de la BD</h3>

<p>El m&#xE9;todo recomendado para la creaci&#xF3;n de la base de datos es extender la clase <strong><code>SQLiteOpenHelder</code></strong> y sobrescribir los m&#xE9;todos <strong><code>onCreate</code></strong> y <strong><code>onUpgrade</code></strong>. El primer m&#xE9;todo se utiliza para crear la base de datos por primera vez y el segundo para actualizaciones de la misma. Si la base de datos ya existe y su versi&#xF3;n actual coincide con la solicitada, se realizar&#xE1; la conexi&#xF3;n a ella.</p>
<p>Para ejecutar la sentencia SQL utilizaremos el m&#xE9;todo <strong><code>execSQL</code></strong> proporcionado por la API para SQLite de Android.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">BDClientes</span><span class="token punctuation">(</span>
        context<span class="token operator">:</span> Context<span class="token operator">?</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
        factory<span class="token operator">:</span> CursorFactory<span class="token operator">?</span><span class="token punctuation">,</span>
        version<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">SQLiteOpenHelper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> version<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
     <span class="token keyword keyword-var">var</span> sentencia <span class="token operator">=</span>
            <span class="token string">&quot;create table if not exists clientes&quot;</span> <span class="token operator">+</span> 
            <span class="token string">&quot;(dni VARCHAR PRIMARY KEY NOT NULL, nombre TEXT, apellidos TEXT);&quot;</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>sqLiteDatabase<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sentencia<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>sqLiteDatabase<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">,</span> i<span class="token operator">:</span> Int<span class="token punctuation">,</span> i2<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; Si la base de datos existe pero su versi&#xF3;n actual es anterior a la solicitada, se llamar&#xE1; autom&#xE1;ticamente al m&#xE9;todo onUgrade(). Si la base de datos no existe se llama autom&#xE1;ticamente a onCreate().</p>
</blockquote>
<h3 class="mume-header" id="acceso-y-modificaci%C3%B3n-de-los-datos-en-la-bd">Acceso y modificaci&#xF3;n de los datos en la BD</h3>

<p>Una vez creada la clase, instanciaremos un objeto del tipo creado y usaremos uno de los dos siguientes m&#xE9;todos para tener acceso a la gesti&#xF3;n de datos: <strong><code>getWritableDatabase()</code></strong> para acceso de escritura y <strong><code>getReadableDatabase()</code></strong> para acceso de solo lectura. En ambos casos se devolver&#xE1; un objeto de la clase <strong><code>SQLiteDatabase</code></strong> para el acceso a los datos.<br>
Para realizar una codificaci&#xF3;n limpia y reutilizable, lo mejor es crear una clase con todos los m&#xE9;todos que necesitemos para trabajar con la Base de Datos, adem&#xE1;s es &#xFA;til tener la clase derivada de SQLiteOpenHelper interna a esta.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">BDAdapter</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token operator">?</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token keyword keyword-private">private</span>  <span class="token keyword keyword-var">var</span> clientes<span class="token operator">:</span> BDClientes
    
  <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
        clientes <span class="token operator">=</span> <span class="token function">BDClientes</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;BDClientes&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
     
  <span class="token operator">..</span><span class="token punctuation">.</span> 

  <span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">BDClientes</span><span class="token punctuation">(</span>
        context<span class="token operator">:</span> Context<span class="token operator">?</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
        factory<span class="token operator">:</span> CursorFactory<span class="token operator">?</span><span class="token punctuation">,</span>
        version<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">SQLiteOpenHelper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> version<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> sentencia <span class="token operator">=</span>
            <span class="token string">&quot;create table if not exists clientes&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;(dni VARCHAR PRIMARY KEY NOT NULL, nombre TEXT, apellidos TEXT);&quot;</span>
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>sqLiteDatabase<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sentencia<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>sqLiteDatabase<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">,</span> i<span class="token operator">:</span> Int<span class="token punctuation">,</span> i2<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; Como podemos ver en el c&#xF3;digo, creamos un objeto del tipo de BDClientes con el que vamos a trabajar llamando al constructor BDClientes(), a este m&#xE9;todo le pasamos el contexto, el nombre de la BBDD, un objeto cursor (con valor null) y la versi&#xF3;n de la BD que necesitamos.</p>
</blockquote>
<p>Para poder usar los m&#xE9;todos creados en la clase, tan solo instanciaremos un objeto de esta pas&#xE1;ndole el contexto (de tipo activity). Con esta instancia podremos llamar a cualquiera de los m&#xE9;todos que crearemos en la clase de utilidad.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-var">var</span> bdAdapter <span class="token operator">=</span> <span class="token function">BDAdapter</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span>
bdAdapter<span class="token punctuation">.</span><span class="token function">insertarDatos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><h4 class="mume-header" id="acceso-a-la-bd-mediante-sentencias-sql">Acceso a la BD mediante sentencias sql</h4>

<p>El acceso a la BBDD se hace en dos fases, primero se consigue un objeto del tipo <strong><code>SQLiteDatabase</code></strong> y posteriormente usamos sus funciones para gestionar los datos. Si hemos abierto correctamente la base de datos entonces podremos empezar con las inserciones, actualizaciones, borrado, etc. No deberemos olvidar cerrar el acceso a la BD, siempre y cuando no se est&#xE9; usando un cursor.</p>
<p><em>Por ejemplo, vamos a insertar 10 registros en nuestra tabla clientes. Para ello podremos crear un m&#xE9;todo en el <strong>BDAdapter</strong> parecido al siguiente:</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">insertarDatos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> dbClientes <span class="token operator">=</span>clientes<span class="token punctuation">.</span>writableDatabase
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dbClientes <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>i <span class="token keyword keyword-in">in</span> <span class="token number">0</span><span class="token operator">..</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> sentencia <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO Clientes (dni, nombre, apellidos) VALUES&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot; (&apos;&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;&apos;,&apos;nombre&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;&apos;,&apos;apellido&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;&apos;);&quot;</span>
                dbClientes<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sentencia<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            dbClientes<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x270B; Vale, &#xBF;y ahora qu&#xE9;? &#xBF;D&#xF3;nde est&#xE1; la base de datos que acabamos de crear? &#xBF;C&#xF3;mo podemos comprobar que todo ha ido bien y que los registros se han insertado correctamente?, en primer lugar veamos d&#xF3;nde se ha creado nuestra base de datos. Todas las bases de datos SQLite creadas por aplicaciones Android se almacenan en la memoria del tel&#xE9;fono en un fichero con el mismo nombre de la base de datos situado en una ruta que sigue el siguiente patr&#xF3;n: <strong>/data/data/paquete.java.de.la.aplicacion/databases/nombre_base_datos</strong><br>
En el caso de nuestro ejemplo, la base de datos se almacenar&#xED;a por tanto en la ruta siguiente: <strong>/data/data/ejemplo.basedatos/databases/DBClientes</strong><br>
Para comprobar que los datos se han grabado podemos acceder de forma remota al emulador a trav&#xE9;s de su consola de comandos (shell). Pero es mas sencillo abrir el archivo creado con un bloc de notas y echar un vistazo a su contenido.</p>
</blockquote>
<h4 class="mume-header" id="acceso-a-la-bd-mediante-sqlitedatabase">Acceso a la BD mediante SQLiteDataBase</h4>

<p>La API de Android nos ofrece dos m&#xE9;todos para acceder a los datos. El primero de ellos ya lo hemos visto, se trata de ejecutar sentencias SQL a trav&#xE9;s de <strong>execSql</strong>. Este m&#xE9;todo tiene como par&#xE1;metro una cadena con cualquier instrucci&#xF3;n SQL v&#xE1;lida. La otra forma es utilizar los m&#xE9;todos espec&#xED;ficos <strong>insert(), update() y delete()</strong> de la clase <strong>SQLiteDatabase</strong>.<br>
Veamos a continuaci&#xF3;n cada uno de estos m&#xE9;todos.</p>
<ul>
<li><strong><code>insert()</code></strong>: recibe tres par&#xE1;metros <em><code>insert(table, nullColumnHack, values)</code></em>, el primero es el nombre de la tabla, el segundo se utiliza en caso de que necesitemos insertar valores nulos en la tabla &quot;nullColumnHack&quot; en este caso lo dejaremos pasar ya que no lo vamos a usar y por lo tanto lo ponemos a null y el tercero son los valores del registro a insertar. Los valores a insertar los pasaremos a su vez como elementos de una colecci&#xF3;n de tipo <strong><code>ContentValues</code></strong>.  Estos elementos se almacenan como parejas <strong>clave-valor</strong>, donde la clave ser&#xE1; el nombre de cada campo y el valor ser&#xE1; el dato que se va a insertar.</li>
<li><strong><code>update()</code></strong>: Pr&#xE1;cticamente es igual que el anterior m&#xE9;todo pero con la excepci&#xF3;n de que aqu&#xED; estamos usando el m&#xE9;todo <em><code>update(table, values, whereClause, whereArgs)</code></em> para actualizar/modificar registros de nuestra tabla. Este m&#xE9;todo nos pide el nombre de la tabla &quot;table&quot;, los valores a modificar/actualizar &quot;values&quot; (ContentValues), una condici&#xF3;n WHERE &quot;whereClause&quot; que nos sirve para indicarle que valor queremos que actualice y como &#xFA;ltimo par&#xE1;metro &quot;whereArgs&quot; podemos pasarle los valores nuevos a insertar, en este caso no lo vamos a necesitar por lo tanto lo ponemos a null.</li>
<li><strong><code>delete()</code></strong>: el m&#xE9;todo <em><code>delete(table, whereClause, whereArgs)</code></em> nos pide el nombre de la tabla &quot;table&quot;, el registro a borrar &quot;whereClause&quot; que tomaremos como referencia su id y como &#xFA;ltimo par&#xE1;metro &quot;whereArgs&quot; los valores a borrar.</li>
</ul>
<div style="page-break-after:always;"></div>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td align="center">
<div align="left">
    Insertando con ContentValues
</div>
</td>
<td style="border:hidden;">
<div>
<img height="160" src="./imagenes/imagen8.png">
</div>
</td>
</tr>
<tr style="border:hidden;">
<td style="border:hidden;">
<div>
<img height="130" src="./imagenes/imagen9.png">
</div>
</td>
<td style="border:hidden;">
<div align="left">
    Modificando con ContentValues
</div>
</td>
</tr>
<tr style="border:hidden;">
<td align="center">
<div align="left">
    Borrando con ContentValues
</div>
</td>
<td style="border:hidden;">
<div>
<img height="70" src="./imagenes/imagen10.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<p>Los valores que hemos dejado anteriormente como null son realmente argumentos que podemos utilizar en la sentencia SQL. Ve&#xE1;moslo con un ejemplo:</p>
<div align="center">
    <img height="130" src="./imagenes/imagen11.png">
</div>
<p>Donde las <code>?</code> indican los emplazamientos de los argumentos.</p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Crea un ejercicio EjercicioResueltoBD en el que pruebes el c&#xF3;digo visto anteriormente: Creaci&#xF3;n de la BD, insertar elementos con SQL y modificar, eliminar e insertar mediante ContentValue.</span></p>
<h4 class="mume-header" id="recuperaci%C3%B3n-de-datos-con-rawquery">Recuperaci&#xF3;n de datos con rawQuery</h4>

<p>Existen dos formas de recuperar informaci&#xF3;n (SELECT de la base de datos), aunque ambas se apoyan en el concepto de <strong>cursor</strong>, que es en definitiva el objeto que recoge los resultados de la consulta.Vamos a completar el ejercicio anterior, para que nos permita ir insertando registros en la BD y visualiz&#xE1;ndolos en un listView.</p>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td style="border:hidden;">
<div align="left">
    La primera forma de obtener datos es utilizar el m&#xE9;todo rawQuery() de la clase SQLiteDatabase. Este m&#xE9;todo recibe como par&#xE1;metro la sentencia SQL, donde se indican los campos a recuperar y los criterios de selecci&#xF3;n.
</div>
</td>
<td style="border:hidden;">
<div align="center">
    <img width="600" src="./imagenes/imagen12.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">seleccionarDatosSelect</span><span class="token punctuation">(</span>sentencia<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> listaCliente<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span><span class="token operator">?</span>
        <span class="token keyword keyword-val">val</span> dbClientes <span class="token operator">=</span> clientes<span class="token punctuation">.</span>readableDatabase
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dbClientes <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> cursor<span class="token operator">:</span> Cursor <span class="token operator">=</span> dbClientes<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>sentencia<span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>
            listaCliente <span class="token operator">=</span> <span class="token function">getClientes</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>
            dbClientes<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>listaCliente <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token boolean">false</span> <span class="token keyword keyword-else">else</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</pre><p>Evidentemente, ahora tendremos que recorrer el cursor y visualizar los datos devueltos. Para ello se dispone de los m&#xE9;todos <strong><code>moveToFirst()</code></strong>, <strong><code>moveToNext()</code></strong>, <strong><code>moveToLast()</code></strong>, <strong><code>moveToPrevius()</code></strong>, <strong><code>isFirst()</code></strong> y <strong><code>isLast()</code></strong>.<br>
Existen m&#xE9;todos espec&#xED;ficos para la recuperaci&#xF3;n de datos getXXX(indice), donde XXX indica el tipo de dato (String, Blob, Float,&#x2026;) y el par&#xE1;metro &#xED;ndice permite recuperar la columna indicada en el mismo, teniendo en cuenta que comienza en 0.</p>
<p>El m&#xE9;todo getClientes (implementado por nosotros) es el que nos permite leer los datos existentes en la BD y llevarlos al arrayList:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">getClientes</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> Cursor<span class="token punctuation">)</span><span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> clientes<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span>
    <span class="token keyword keyword-var">var</span> cliente<span class="token operator">:</span> Clientes
    cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cursor<span class="token punctuation">.</span><span class="token function">isAfterLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clientes <span class="token operator">=</span> <span class="token function">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cursor<span class="token punctuation">.</span><span class="token function">isAfterLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cliente <span class="token operator">=</span>
              <span class="token function">Clientes</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cursor<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            clientes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cliente<span class="token punctuation">)</span>
            cursor<span class="token punctuation">.</span><span class="token function">moveToNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> clientes
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="recuperaci%C3%B3n-de-datos-con-query">Recuperaci&#xF3;n de datos con query</h4>

<p>La segunda forma de recuperar informaci&#xF3;n de la BD es utilizar el m&#xE9;todo <strong><code>query()</code></strong>. Recibe como par&#xE1;metros el nombre de la tabla, un string con los campos a recuperar, un string donde especificar las condiciones del WHERE, otro para los argumentos si los hubiera, otro para el GROUP BY, otro para HAVING y finalmente otro para ORDER BY.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">seleccionarDatosCodigo</span><span class="token punctuation">(</span>
        columnas<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">?</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-where">where</span><span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
        valores<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">?</span><span class="token punctuation">,</span>
        orderBy<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span><span class="token operator">?</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> listaCliente<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token function">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> dbClientes <span class="token operator">=</span> clientes<span class="token punctuation">.</span>readableDatabase
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dbClientes <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword keyword-val">val</span> cursor<span class="token operator">:</span> Cursor <span class="token operator">=</span> 
             dbClientes<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;clientes&quot;</span><span class="token punctuation">,</span> columnas<span class="token punctuation">,</span> <span class="token keyword keyword-where">where</span><span class="token punctuation">,</span> valores<span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> orderBy<span class="token punctuation">)</span>
            listaCliente <span class="token operator">=</span> <span class="token function">getClientes</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>
            dbClientes<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> listaCliente
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span>
    <span class="token punctuation">}</span>
</pre><p>Donde la llamada al m&#xE9;todo podr&#xED;a ser la siguiente:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">  <span class="token keyword keyword-val">val</span> listaCliente <span class="token operator">=</span> bdAdapter<span class="token punctuation">.</span><span class="token function">seleccionarDatosCodigo</span><span class="token punctuation">(</span>
                    <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
                    <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
</pre><div style="page-break-after:always;"></div>
<blockquote>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Crea un ejercicio ejemploBD en el que pruebes el c&#xF3;digo visto anteriormente: Recuperaci&#xF3;n de los datos con rawQuery y con query. Para ello crea la aplicaci&#xF3;n como en la imagen, de forma que con un bot&#xF3;n se guarde la informaci&#xF3;n en la BD y con el otro se extraiga y se muestre en una lista o en un recycler. Si vais a utilizar una lista como se muestra en la imagen, debereis crear una clase adaptador como la de la siguiente imagen y asociarla a la lista con el setAdapter:</span></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> binding<span class="token punctuation">.</span>listView<span class="token punctuation">.</span><span class="token function">setAdapter</span><span class="token punctuation">(</span>
                   <span class="token function">AdaptadorClientes</span><span class="token punctuation">(</span>
                       <span class="token keyword keyword-this">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span>
                       R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>list_layout<span class="token punctuation">,</span>
                       listaCliente<span class="token operator">!!</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p>Clase Adaptador para un ListView:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">AdaptadorClientes</span><span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> activitycontext<span class="token operator">:</span> Activity<span class="token punctuation">,</span> 
                           resource<span class="token operator">:</span> Int<span class="token punctuation">,</span> 
                           objects<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span>
                           <span class="token punctuation">)</span> <span class="token operator">:</span>
   ArrayAdapter<span class="token operator">&lt;</span>Any<span class="token operator">&gt;</span><span class="token punctuation">(</span>activitycontext<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> objects <span class="token keyword keyword-as">as</span> List<span class="token operator">&lt;</span>Any<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword keyword-var">var</span> objects<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>Clientes<span class="token operator">&gt;</span>
   <span class="token keyword keyword-override">override</span>  <span class="token keyword keyword-fun">fun</span> <span class="token function">getView</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Int<span class="token punctuation">,</span> 
                         convertView<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> 
                         parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">)</span><span class="token operator">:</span> View <span class="token punctuation">{</span>
       <span class="token keyword keyword-var">var</span> vista<span class="token operator">:</span> View<span class="token operator">?</span><span class="token operator">=</span> convertView
       <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>vista <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword keyword-val">val</span> inflater <span class="token operator">=</span> activitycontext<span class="token punctuation">.</span>layoutInflater
           vista <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>list_layout<span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>
           <span class="token punctuation">(</span>vista<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>apellidolist<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> TextView<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">.</span>apellidos<span class="token punctuation">)</span>
           <span class="token punctuation">(</span>vista<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>nombrelist<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> TextView<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">.</span>nombre<span class="token punctuation">)</span>
           <span class="token punctuation">(</span>vista<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>dnilist<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> TextView<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>objects<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">.</span>dni<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       <span class="token keyword keyword-return">return</span> vista
   <span class="token punctuation">}</span>

   <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
       <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>objects <span class="token operator">=</span> objects
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></blockquote>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Ejercicio Propuesto Recorrer BD</span></p>
<h3 class="mume-header" id="uso-de-simplecursoradapter">Uso de SimpleCursorAdapter</h3>

<p>Se utiliza para mapear las columnas de un cursor abierto en una base de datos a los diferentes elementos visuales contenidos en el control de selecci&#xF3;n. As&#xED; se evita el volcado de todos los elementos descargados de la BD a una colecci&#xF3;n, con el ahorro de memoria que conlleva.<br>
Nos encontramos con dos casos: cuando usamos <strong><code>Spinner</code></strong> o <strong><code>ListView</code></strong> sencillos el adaptador que gestiona este volcado ya est&#xE1; creado, si usamos <strong><code>RecyclerView</code></strong> tendremos que crear y gestionar el adaptador.<br>
Vamos a programar un ejemplo para practicar este concepto, ser&#xE1; una sencilla actividad con un <strong><code>Spinner</code></strong> que mostrar&#xE1; los ciclos inform&#xE1;ticos con la categor&#xED;a a la que pertenecen:</p>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td>
<div align="center">
    <img height src="./imagenes/imagen13.png">
</div>
</td>
<td>
<div align="center">
    <img height src="./imagenes/imagen14.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<p>Para ello nos creamos la base de datos e insertamos elementos como ya hemos visto hasta el momento:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">DBAdapter</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span>  <span class="token keyword keyword-var">var</span> ohCategoria<span class="token operator">:</span> OHCategoria
    <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
        ohCategoria <span class="token operator">=</span> <span class="token function">OHCategoria</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;BBDCategorias&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">insertarDatosCodigo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword keyword-val">val</span> sqLiteDatabase <span class="token operator">=</span> ohCategoria<span class="token punctuation">.</span>writableDatabase
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>sqLiteDatabase <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> valores <span class="token operator">=</span> <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nombre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ASIR&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Superior&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;idcategoria&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;categoria&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> valores<span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nombre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;DAM&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Superior&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;idcategoria&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;categoria&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> valores<span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nombre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SMR&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Medio&quot;</span><span class="token punctuation">)</span>
            valores<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;idcategoria&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;categoria&quot;</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span> valores<span class="token punctuation">)</span>
            sqLiteDatabase<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">leerDatos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Cursor<span class="token operator">?</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> sqLiteDatabase <span class="token operator">=</span> ohCategoria<span class="token punctuation">.</span>readableDatabase
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>sqLiteDatabase <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> sqLiteDatabase<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>
                <span class="token string">&quot;select  idcategoria as _id, nombre, cate from categoria&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword keyword-null">null</span> <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">OHCategoria</span><span class="token punctuation">(</span>
         context<span class="token operator">:</span> Context<span class="token operator">?</span><span class="token punctuation">,</span> name<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
         factory<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">.</span>CursorFactory<span class="token operator">?</span><span class="token punctuation">,</span> 
         version<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">QLiteOpenHelper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> version<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> cadena <span class="token operator">=</span>
            &quot;create table <span class="token keyword keyword-if">if</span> not exists <span class="token function">categoria</span><span class="token punctuation">(</span>idcategoria
             INTEGER PRIMARY KEY NOT NULL<span class="token punctuation">,</span> nombre TEXT<span class="token punctuation">,</span> cate TEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>&quot;
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>db<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            db<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>cadena<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>db<span class="token operator">:</span> SQLiteDatabase<span class="token punctuation">,</span> 
                               oldVersion<span class="token operator">:</span> Int<span class="token punctuation">,</span> newVersion<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Posteriormente pasamos a crear el cursorAdapter, pero para ello vamos a usar un Spinner para mostrar la informaci&#xF3;n, lo incluimos en el layout principal.</p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[9,10]}" class="language-kotlin" data-line="9,10"> <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> from <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;nombre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cate&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> <span class="token keyword keyword-to">to</span> <span class="token operator">=</span> <span class="token function">intArrayOf</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>ciclo<span class="token punctuation">,</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>cate<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_my<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> dbAdapter<span class="token operator">=</span><span class="token function">DBAdapter</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span>
        dbAdapter<span class="token punctuation">.</span><span class="token function">insertarDatosCodigo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> desplegable <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>Spinner<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>spinner<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> cursor<span class="token operator">=</span>dbAdapter<span class="token punctuation">.</span><span class="token function">leerDatos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> mAdapter <span class="token operator">=</span> <span class="token function">SimpleCursorAdapter</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>spinner_layout<span class="token punctuation">,</span> 
                                           cursor<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token keyword keyword-to">to</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span>
        desplegable<span class="token punctuation">.</span><span class="token function">setAdapter</span><span class="token punctuation">(</span>mAdapter<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<div class="line-highlight-wrapper">







<div aria-hidden="true" class="line-highlight" data-range="9" data-start="9">
</div></div><div class="line-highlight-wrapper">








<div aria-hidden="true" class="line-highlight" data-range="10" data-start="10">
</div></div></pre><blockquote>
<p>&#x1F4CC; en la <strong>L&#xED;nea 9</strong> se devuelve el cursor con la selecci&#xF3;n de los datos de la BD (cuidado!! no se deber&#xE1; cerrar el cursor). <strong>L&#xED;nea 19</strong> para el funcionamiento del <strong><code>SimpleCursorAdapter</code></strong>, es necesario indicar en su definici&#xF3;n los siguientes elementos: el contexto, el layout sobre el que se va a definir la vista, el cursor que va a ser origen de los datos, lista con el nombre de las columnas que se quiere enlazar, una lista con los id de las vistas donde se van a mostrar los campos (el orden es importante) y un flag (0 por defecto)</p>
</blockquote>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Prueba la aplicaci&#xF3;n del ejemplo anterior</span></p>
<div style="page-break-after:always;"></div>
<h4 class="mume-header" id="cursores-con-recyclerview">Cursores con RecyclerView</h4>

<p>Como era de esperar, no se puede aplicar directamente un adaptador de tipo <strong><code>SimpleCursorAdapter</code></strong> a un tipo <strong><code>RecyclerView</code></strong>. Si queremos aprovechar los beneficios de los cursores en los recyclers, tendremos que fabricarlos a medida. Los pasos son los siguientes:</p>
<ol>
<li>
<p>Crear una clase <strong>Abstracta</strong> base que derive de <strong>RecyclerView.Adapter</strong> y en la que implementaremos los m&#xE9;todos sobrescritos derivados de RecyclerView.Adapter:</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[8,10,12,16]}" class="language-kotlin" data-line="8,10,12,16"> <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> <span class="token function">CursorRecyclerAdapter</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> Cursor<span class="token punctuation">)</span> <span class="token operator">:</span>
 RecyclerView<span class="token punctuation">.</span>Adapter<span class="token operator">&lt;</span>RecyclerView<span class="token punctuation">.</span>ViewHolder<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword keyword-var">var</span> mCursor<span class="token operator">:</span> Cursor
 <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span>ViewHolder<span class="token punctuation">,</span> 
                               position<span class="token operator">:</span> Int<span class="token punctuation">)</span> 
 <span class="token punctuation">{</span>
     <span class="token function">checkNotNull</span><span class="token punctuation">(</span>mCursor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">&quot;ERROR, cursos vacio&quot;</span> <span class="token punctuation">}</span>
     <span class="token function">check</span><span class="token punctuation">(</span>mCursor<span class="token punctuation">.</span><span class="token function">moveToPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">&quot;ERROR, no se puede&quot;</span> <span class="token operator">+</span>
             <span class="token string">&quot; encontrar la posicion:  <span class="token interpolation variable">$position</span>&quot;</span> <span class="token punctuation">}</span>
     <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> mCursor<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span>ViewHolder<span class="token punctuation">,</span> 
                               cursor<span class="token operator">:</span> Cursor<span class="token punctuation">)</span>
 <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int
 <span class="token punctuation">{</span>
     <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>mCursor <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>    mCursor<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-else">else</span> <span class="token number">0</span>
 <span class="token punctuation">}</span>
 <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
     mCursor <span class="token operator">=</span> cursor
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div><div class="line-highlight-wrapper">








<div aria-hidden="true" class="line-highlight" data-range="10" data-start="10">
</div></div><div class="line-highlight-wrapper">










<div aria-hidden="true" class="line-highlight" data-range="12" data-start="12">
</div></div><div class="line-highlight-wrapper">














<div aria-hidden="true" class="line-highlight" data-range="16" data-start="16">
</div></div></pre><blockquote>
<p>&#x1F4CC; Al heredar de <strong><code>RecyclerView.Adapter</code></strong> habr&#xE1; que implementar los m&#xE9;todos <strong><code>onBindViewHolder()</code></strong> al que le llega la posici&#xF3;n de la l&#xED;nea del recycler que est&#xE1; activa en ese momento y <strong><code>getItemCount()</code></strong> que tendr&#xE1; que devolver los elementos que tiene el cursor <strong>L&#xED;nea 16</strong>, le llega en el constructor. En el m&#xE9;todo onBindViewHolder se comprobar&#xE1; que el cursor no est&#xE1; vacio y que se puede acceder a la posici&#xF3;n que llega como par&#xE1;metro <strong>L&#xED;nea 8</strong>, y en ese caso se llamar&#xE1; al m&#xE9;todo <strong><code>onBindViewHolder(holder: RecyclerView.ViewHolder, cursor: Cursor)</code></strong> abstracto que debemos crear en esta clase <strong>L&#xED;nea 12</strong>, pero esta vez con un <strong><code>Cursor</code></strong> como par&#xE1;metro.</p>
</blockquote>
</li>
<li>
<p>Ahora tendremos que crear nuestra clase RecyclerView derivada de la anterior.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[12]}" class="language-kotlin" data-line="12"><span class="token keyword keyword-class">class</span> <span class="token function">RecyclerAdapter</span><span class="token punctuation">(</span>c<span class="token operator">:</span> Cursor<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">CursorRecyclerAdapter</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">,</span> 
                                 viewType<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span> 
 <span class="token punctuation">{</span>
     <span class="token keyword keyword-val">val</span> v<span class="token operator">:</span> View <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>recycler_layout<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
     <span class="token keyword keyword-return">return</span> <span class="token function">SimpleViewHolder</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword keyword-override">override</span>  <span class="token keyword keyword-fun">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span>ViewHolder<span class="token punctuation">,</span>
                                cursor<span class="token operator">:</span> Cursor<span class="token punctuation">)</span> 
 <span class="token punctuation">{</span>
     <span class="token punctuation">(</span>holder <span class="token keyword keyword-as">as</span> SimpleViewHolder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">SimpleViewHolder</span><span class="token punctuation">(</span>itemView<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token operator">:</span>
                   RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span><span class="token punctuation">(</span>itemView<span class="token punctuation">)</span> 
 <span class="token punctuation">{</span>
     <span class="token keyword keyword-var">var</span> nombre<span class="token operator">:</span> TextView
     <span class="token keyword keyword-var">var</span> cate<span class="token operator">:</span> TextView
     <span class="token keyword keyword-var">var</span> imagen<span class="token operator">:</span> ImageView
     <span class="token keyword keyword-fun">fun</span> <span class="token function">bind</span><span class="token punctuation">(</span>dato<span class="token operator">:</span> Cursor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         nombre<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>dato<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         cate<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>dato<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token keyword keyword-val">val</span> theImage<span class="token operator">:</span> Bitmap <span class="token operator">=</span> MainActivity<span class="token punctuation">.</span>
                          <span class="token function">convertirStringBitmap</span><span class="token punctuation">(</span>dato<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         imagen<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>theImage<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
     <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
         nombre <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>ciclo<span class="token punctuation">)</span>
         cate <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>cate<span class="token punctuation">)</span>
         imagen <span class="token operator">=</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>imagen<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> ImageView
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">










<div aria-hidden="true" class="line-highlight" data-range="12" data-start="12">
</div></div></pre><blockquote>
<p>&#x1F4CC; A esta clase le llegar&#xE1; el cursor por el constructor que a su vez ser&#xE1; pasado a la clase padre. Al heredar de la clase abstracta, tendremos que implementar su m&#xE9;todo abstracto y ser&#xE1; ah&#xED; donde aprovecharemos que el cursos se ha posicionado en el elemento correcto de la BD, para llamar al m&#xE9;todo <strong><code>bind(cursor)</code></strong>  <strong>L&#xED;nea 12</strong> del <strong><code>Holder</code></strong>, con ese estado del cursor.  En el <strong><code>Holder</code></strong> trataremos los elementos que sacamos del cursos de forma correcta.</p>
</blockquote>
</li>
</ol>
<div style="page-break-after:always;"></div>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td>
3. Como esta App es un poco diferente a la anterior, se han incluido im&#xE1;genes para dar m&#xE1;s funcionalidad, hay dos m&#xE9;todos que nos permiten pasar im&#xE1;genes de Bitmap a String y viceversa para poderlas guardar en la BD a trav&#xE9;s del cursor (En la BD se guardar&#xE1;n como Blob). Est&#xE1;n localizados en MyActivity y son est&#xE1;ticos para poder acceder a ellos sin necesidad de objeto.
</td>
<td style="border:hidden;">
<div align="center">
    <img width="1000" src="./imagenes/imagen15.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> 
<span class="token punctuation">{</span>
  <span class="token keyword keyword-fun">fun</span> <span class="token function">convertirStringBitmap</span><span class="token punctuation">(</span>imagen<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Bitmap <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> decodedString<span class="token operator">:</span> ByteArray <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>imagen<span class="token punctuation">,</span> Base64<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeByteArray</span><span class="token punctuation">(</span>decodedString<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> decodedString<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-fun">fun</span> <span class="token function">ConvertirImagenString</span><span class="token punctuation">(</span>bitmap<span class="token operator">:</span> Bitmap<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> stream <span class="token operator">=</span> <span class="token function">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    bitmap<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span>CompressFormat<span class="token punctuation">.</span>PNG<span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> byte_arr<span class="token operator">:</span> ByteArray <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> Base64<span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>byte_arr<span class="token punctuation">,</span> Base64<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Prueba la aplicaci&#xF3;n del ejemplo anterior<br>
</span></p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F; Ejercicio propuesto cursor con recycler</span></p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="acceso-a-bases-de-datos-remotas">Acceso a bases de datos remotas</h2>

<h3 class="mume-header" id="introducci%C3%B3n-1">Introducci&#xF3;n</h3>

<p>Para obtener y guardar informaci&#xF3;n de una base de datos remota, es necesario conectarse a un servidor donde se encontrar&#xE1; la BBDD. El esquema de funcionamiento lo podemos ver en la siguiente imagen:</p>
<div align="center">
    <img height="280" src="./imagenes/imagen1.png">
</div>
<p>En el servidor funcionan en realidad tres componentes b&#xE1;sicos:</p>
<ul>
<li>
<p>Una base de datos, que almacena toda la informaci&#xF3;n de los usuarios. Para la BBDD se puede utilizar MySQL, que es de licencia gratuita.</p>
<div align="center">
  <img height="180" src="./imagenes/imagen2.png">
</div></li>
</ul>

<ul>
<li>Un servlet , que atiende la petici&#xF3;n recibida, la procesa y env&#xED;a la respuesta correspondiente. Un servlet no es m&#xE1;s que un componente Java, generalmente peque&#xF1;o e independiente de la<br>
plataforma.</li>
<li>Un servidor web , donde reside y se ejecuta el servlet , y que permanece a la espera de conexiones HTTP entrantes.</li>
</ul>
<p>Los formatos m&#xE1;s utilizados para compartir informaci&#xF3;n mediante estos servicios web son XML (y otros derivados) y JSON .</p>
<h5 class="mume-header" id="qu%C3%A9-es-json">&#xBF;Qu&#xE9; es JSON?</h5>

<p>JSON ( Javascript Objec t Notation ) es un formato ligero de intercambio de datos entre clientes y servidores, basado en la sintaxis de Javascript para representar estructuras en forma organizada. Es un formato en texto plano independiente de todo lenguaje de programaci&#xF3;n, es m&#xE1;s, soporta el intercambio de datos en gran variedad de lenguajes de programaci&#xF3;n como PHP Python C++ C# Java y Ruby.<br>
XML tambi&#xE9;n puede usarse para el intercambio, pero debido a que su definici&#xF3;n genera un DOM , el parseo se vuelve extenso y pesado. Adem&#xE1;s de ello XML debe usar Xpath para especificar rutas de elementos y atributos, por lo que demora la reconstrucci&#xF3;n de la petici&#xF3;n. En cambio JSON no requiere restricciones adicionales, simplemente se obtiene el texto plano y el engine de Javascript en los navegadores hace el trabajo de parsing sin ninguna complicaci&#xF3;n.</p>
<h5 class="mume-header" id="tipos-de-datos-en-json">Tipos de datos en JSON</h5>

<p>Similar a la estructuraci&#xF3;n de datos primitivos y complejos en los lenguajes de programaci&#xF3;n, JSON establece varios tipos de datos: cadenas, n&#xFA;meros, booleanos, arrays, objetos y valores null. El prop&#xF3;sito es crear objetos que contengan varios atributos compuestos como pares clave valor. Donde la clave es un nombre que identifique el uso del valor que lo acompa&#xF1;a. Veamos un ejemplo:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
   <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
   <span class="token property">&quot;Nombre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Carlos&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;EstaActivo&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">&quot;Notas&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</pre><p>La anterior estructura es un objeto JSON compuesto por los datos de un estudiante. Los objetos JSON contienen sus atributos entre llaves <strong><code>{}</code></strong>, al igual que un bloque de c&#xF3;digo en Javascript, donde cada atributo debe ir separado por coma <strong><code>,</code></strong> para diferenciar cada par.<br>
La sintaxis de los pares debe contener dos puntos <strong><code>:</code></strong> para dividir la clave del valor. El nombre del par debe tratarse como cadena y a&#xF1;adirle comillas dobles.<br>
Si notas, este ejemplo trae un ejemplo de cada tipo de dato:</p>
<ul>
<li>El <em>Id</em> es de tipo entero, ya que contiene un n&#xFA;mero que representa el c&#xF3;digo del estudiante.</li>
<li>El <em>Nombre</em> es un string. Usa comillas dobles para identificarlas.</li>
<li><em>EstaActivo</em> es un tipo booleano que representa si el estudiante se encuentra en la instituci&#xF3;n educativa o no. Usa las palabras reservadas true y false para declarar el valor.</li>
<li><em>Notas</em> es un arreglo de n&#xFA;meros reales. El conjunto de sus elementos debes incluirlos dentro de corchetes <strong><code>[ ]</code></strong> y separarlos por coma.</li>
</ul>
<p>La idea es crear un mecanismo que permita recibir la informaci&#xF3;n que contiene la base de datos externa en formato JSON hacia la aplicaci&#xF3;n. Con ello se parsear&#xE1; cada elemento y ser&#xE1; interpretado en forma de objeto Java para integrar correctamente el aspecto en la interfaz de usuario.<br>
La clase <strong>JsonObject</strong> de la librer&#xED;a <strong>org.json.JSONObject</strong>, puede interpretar datos con formato JSON y parsearlos a objetos Java o a la inversa.<br>
Veamos una ilustraci&#xF3;n que muestra el proceso de parseo que ser&#xE1; estudiado:</p>
<div align="center">
    <img height="300" src="./imagenes/imagen3.png">
</div>
<ul>
<li>Como puedes observar el origen de los datos es un servidor externo o hosting que hayas contratado como proveedor para tus servicios web. La aplicaci&#xF3;n web que realiza la gesti&#xF3;n de encriptaci&#xF3;n de los datos a formato <code>JSON</code> puede ser <code>PHP</code>, <code>JavaScript</code>, <code>ASP.NET</code>, etc..</li>
<li>Tu aplicaci&#xF3;n Android a trav&#xE9;s de un cliente realiza una petici&#xF3;n a la direcci&#xF3;n URL del recurso con el fin de obtener los datos. Ese flujo entrante debe interpretarse con ayuda de un parser personalizado que implementaran las clases que se utilizan para trabajar con <code>JSON</code>.</li>
<li>El resultado final es un conjunto de datos adaptable al <code>API</code> de Android. Dependiendo de tus necesidades, puedes convertirlos en una lista de objetos estructurados que alimenten un adaptador que pueble un ListView o simplemente actualizar la base de datos local de tu aplicaci&#xF3;n en <code>SQLite</code>.</li>
</ul>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="acceso-a-bases-de-datos-con-apirest-y-retrofit">Acceso a bases de datos con Apirest y Retrofit</h3>

<p>Retrofit es un cliente <em>REST</em> para Android y Java, desarrollado por Square, muy simple y f&#xE1;cil de aprender. Permite hacer peticiones <strong><code>GET</code></strong>, <strong><code>POST</code></strong>, <strong><code>PUT</code></strong>, <strong><code>PATCH</code></strong>, <strong><code>DELETE</code></strong> y <strong><code>HEAD</code></strong>; gestionar diferentes tipos de par&#xE1;metros y parsear autom&#xE1;ticamente la respuesta a un POJO (Plain Old Java Object). Vamos a utilizar esta librer&#xED;a por su facilidad de manejo. P</p>
<h4 class="mume-header" id="definici%C3%B3n-del-servicio-rest">Definici&#xF3;n del Servicio Rest</h4>

<p>Como es de suponer, para poder acceder a un servicio Rest desde una de nuestras aplicaciones, este debe de haber sido creado con anterioridad y alojado en un Hosting adecuado.<br>
La parte de creaci&#xF3;n ya sea con PHP, Java, o cualquiera de los otros lenguajes que lo permiten no corresponde a nuestra asignatura, por lo que la pasaremos por alto y usaremos un ApiRest general que se ha proporcionado en el m&#xF3;dulo de Acceso a Datos y que con unas peque&#xF1;as modificaciones es valido para la mayor&#xED;a de casos. La carpeta con el ApiRest est&#xE1; compuesta de los siguientes archivos:</p>
<div align="center">
    <img height="200" src="./imagenes/imagen4.png">
</div>
<p>La configuraci&#xF3;n de nuestro API consta de dos archivos:<br>
1. <strong><code>.htaccess</code></strong> En este archivo se configuran las reglas de acceso, sobre una ruta que le indiquemos en RewriteBase (aqu&#xED; es donde tendremos que a&#xF1;adir la carpeta en la que habremos alojado nuestra API, comenzando y acabando con <em><code>/</code></em>).<br>
2. <strong><code>apirest_variables.php</code></strong>, en este archivo se definen los  datos de conexi&#xF3;n a la base de datos. se indican las tablas que tiene esta y el nombre del identificador de cada una de ellas.</p>
<div style="page-break-after:always;"></div>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td align="center">
<font face="small fonts">
 .htaccess
</font>
<div align="center">
    <img height="
    " src="./imagenes/imagen5.png">
</div>
</td>
<td>
<div align="center">
<font face="small fonts">
 apirest_variables.php
</font>
    <img height="
    " src="./imagenes/imagen6.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<p>El resto de archivos del ApiREst no tendr&#xE1;n que modificarse, ya que est&#xE1; construida de forma gen&#xE9;rica con las necesidades m&#xE1;s comunes para estos casos. Tendremos que crear la BD y alojar el ApiRest de forma local o en la nube, usando los conocimientos que se tienen del m&#xF3;dulo de Acceso a Datos.</p>
<p><em>Vamos a suponer un ejemplo muy sencillo de una base de datos Usuarios en el que tendremos solamente una tabla Usuarios con dos campos de tipo String (nick y nombre). La BD la habremos construido en el servidor con antelaci&#xF3;n (en este caso con tabla usarios de tres campos, nick y nombre de tipo cadena y _id de tipo num&#xE9;rico autoincrementable como clave). Tambi&#xE9;n crearemos una aplicaci&#xF3;n con dos campos de texto que nos permita insertar los datos del usuario y un bot&#xF3;n flotante de a&#xF1;adir, como se ve en la imagen siguiente:</em></p>
<div align="center">
    <img height="250" src="./imagenes/imagen7.png">
</div>
<h4 class="mume-header" id="consumo-de-un-servicio-rest-desde-android">Consumo de un Servicio Rest desde Android</h4>

<p>Existen diferentes librer&#xED;as que nos permitir&#xED;an consumir los servicios desde la App de Android, pero dada su facilidad vamos a utilizar las librer&#xED;as: <strong>Retrofit2</strong> y <strong>Gson</strong>.<br>
Retrofit la utilizaremos para hacer peticiones y procesar las respuestas del APIRest, mientras que con Gson transformaremos los datos de JSON a los propios que utilice la aplicaci&#xF3;n.<br>
Para ello a&#xF1;adiremos las siguientes l&#xED;neas en el build.gradle de la app, y no olvides incluir permisos de internet:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">            implementation <span class="token string">&quot;com.squareup.retrofit2:converter-gson:2.9.0&quot;</span>
            implementation &apos;com.squareup.retrofit2<span class="token operator">:</span>retrofit<span class="token operator">:</span><span class="token number">2.9</span>.<span class="token number">0</span>&apos;
</pre><p>Podemos decir que los pasos a seguir ser&#xE1;n los siguientes:</p>
<ol>
<li>Creaci&#xF3;n de un builder de Retrofit. Para poder utilizar Retrofit necesitas crear un builder que te servir&#xE1; para comunicarte con la API elegida. En la imagen se ha utilizado un m&#xE9;todo para encapsular el c&#xF3;digo, aunque no es necesario.</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">crearRetrofit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ProveedorSersvicio <span class="token punctuation">{</span>
    <span class="token comment">//val url = &quot;http://10.0.2.2/usuarios/&quot; //para el AVD de android</span>
    <span class="token keyword keyword-val">val</span> url<span class="token operator">=</span><span class="token string">&quot;http://xusa.iesdoctorbalmis.info/usuarios/&quot;</span> <span class="token comment">//para servidor del instituto</span>
    <span class="token keyword keyword-val">val</span> retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ProveedorSersvicio<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Si te fijas en la segunda l&#xED;nea ver&#xE1;s que hay que escribir la url base de la API a la que har&#xE1;s las peticiones. La obtienes de la documentaci&#xF3;n proporcionada por el creador de la API.<br>
En la siguiente l&#xED;nea hay que indicar la forma de convertir los objetos de la API a los de tu aplicaci&#xF3;n y viceversa, aqu&#xED; es donde espec&#xED;ficas que vas a utilizar Gson.</p>
<p>Este builder lo necesitar&#xE1;s para hacer las llamadas a la API, as&#xED; que procura que sea accesible.</p>
<ol start="2">
<li>
<p>Creaci&#xF3;n de las clases Pojo que le servir&#xE1; al Gson para parsear los resultados. Pero primero necesitas conocer la estructura del Json que va a devolverte la API, ya que no hay un patr&#xF3;n establecido. Para conocer la estructura previamente, se puede utilizar PostMan y realizar las diferentes peticiones (GET, POST, PUT, etc) desde este.<br>
Existen aplicaciones o webs que facilitan la creaci&#xF3;n de la clase Pojo a partir de un JSon, como por ejemplo: [<a href="http://www.jsonschema2pojo.org/">http://www.jsonschema2pojo.org/</a>]</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> RespuestaJSon <span class="token punctuation">{</span>
    <span class="token keyword keyword-var">var</span> respuesta <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-var">var</span> metodo<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-var">var</span> tabla<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-var">var</span> mensaje<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-var">var</span> sqlQuery<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-var">var</span> sqlError<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
<span class="token punctuation">}</span>
</pre><p>Despu&#xE9;s tienes que crear la estructura de clases para almacenar la informaci&#xF3;n que te resulte &#xFA;til. Clase Usuario en este ejemplo.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">Usuarios</span><span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> nick<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword keyword-var">var</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword keyword-var">var</span> _id<span class="token operator">:</span> Int <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</pre></li>
<li>
<p>Otro elemento imprescindible, es la gesti&#xF3;n de los servicios que se quieran utilizar. Para cada uno de ellos se tendr&#xE1; que hacer una petici&#xF3;n a la API. Necesitaremos crear una interfaz con todos los servicios que quieras utilizar. Aqu&#xED; tienes unos ejemplos:</p>
</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ProveedorSersvicio <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;usuarios&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">usuarios</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Usuarios<span class="token operator">&gt;</span><span class="token operator">&gt;</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">mensajes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Mensaje<span class="token operator">&gt;</span><span class="token operator">&gt;</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes/{nick}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getUsuario</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;nick&quot;</span><span class="token punctuation">)</span> nick<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Usuarios<span class="token operator">&gt;</span><span class="token operator">&gt;</span>

    <span class="token annotation builtin">@POST</span><span class="token punctuation">(</span><span class="token string">&quot;usuarios&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insertarUsuario</span><span class="token punctuation">(</span><span class="token annotation builtin">@Body</span> usuarios<span class="token operator">:</span> Usuarios<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaJSon<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@POST</span><span class="token punctuation">(</span><span class="token string">&quot;mensajes&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insertarMensaje</span><span class="token punctuation">(</span><span class="token annotation builtin">@Body</span> mensaje<span class="token operator">:</span> Mensaje<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaJSon<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><p>En el c&#xF3;digo de arriba hay dos servicios dos son de tipo <strong><code>GET</code></strong> sin palabra clave y que servir&#xE1;n para obtener todos los usuarios y todos los mensajes. Luego se tiene otro servicio <strong><code>GET</code></strong> con palabra clave (Nick) que servir&#xE1; para seleccionar los mensajes de un determinado Nick. Y luego dos <strong><code>POST</code></strong> a los que se les pasa en el Body los datos a a&#xF1;adir.<br>
Usando <strong><code>Corrutinas</code></strong> se realizar&#xE1; la llamada a la API, por lo que los m&#xE9;todos de la interfaz deben ser de tipo <strong>suspend</strong>. En cada m&#xE9;todo se indica el tipo de dato que espera obtener, en estos ejemplos la respuesta puede ser o una lista del tipo de objeto de la petici&#xF3;n o un tipo RespuestaJSon, que tendr&#xE1; todos los posibles miembros que nos podr&#xED;a dar alguna de las llamadas invocadas.<br>
Las palabras seguidas del s&#xED;mbolo <strong><code>@</code></strong> dan funcionalidad a los servicios, haci&#xE9;ndolos din&#xE1;micos y reutilizables, para m&#xE1;s informaci&#xF3;n [<a href="http://square.github.io/retrofit/">http://square.github.io/retrofit/</a>]</p>
<blockquote>
<p>&#x1F4A1; Las que gestiona <strong>Retrofit</strong> para invocar la url de la petici&#xF3;n son <strong><code>@GET, @POST, @PUT y @DELETE</code></strong>. El par&#xE1;metro corresponder&#xE1; con la url de la petici&#xF3;n.<br>
En el builder de Retrofit se incluye la url base del api terminada con <strong><code>/</code></strong>, que unida con el par&#xE1;metro del servicio crear&#xE1;n la url completa de la petici&#xF3;n:<br>
<strong><code>@GET -&gt; http://&gt;10.0.2.2/usuarios/usuario</code></strong></p>
<ul>
<li><strong><code>@Header y @Headers</code></strong>. Se usan para especificar los valores que vayan en la secci&#xF3;n <em>header</em> de la petici&#xF3;n, como por ejemplo en que formato van a ser enviados y recibidos los datos.</li>
<li><strong><code>@Path</code></strong>. Sirve para incluir un identificador en la url de la petici&#xF3;n, para obtener informaci&#xF3;n sobre algo espec&#xED;fico. El atributo en el m&#xE9;todo de llamada que sea precedido por <em>@Path</em> sustituir&#xE1; al identificador entre llaves de la ruta, que tenga el mismo nombre.</li>
<li><strong><code>@Fields</code></strong>. Nos permite pasar variables b&#xE1;sicas en las peticiones <em>Post y Put</em>.</li>
<li><strong><code>@Body</code></strong>. Es equivalente a Fields pero para variables objeto.</li>
<li><strong><code>@Query</code></strong>. Se usa cuando la petici&#xF3;n va a necesitar par&#xE1;metros (los valores que van despu&#xE9;s del <strong><code>?</code></strong> en una url).</li>
</ul>
</blockquote>
<ol start="4">
<li>Pedir datos a la Api ser&#xED;a el &#xFA;ltimo paso a realizar. Retrofit nos da la opci&#xF3;n de realizarlo de manera s&#xED;ncrona o as&#xED;ncrona. Vamos a aprovechar nuestros conocimientos de corrutinas para lanzar la petici&#xF3;n en segundo plano de forma sencilla.</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin{highlight=[4,[5-19], 8]}" class="language-kotlin" data-line="4,5-19,8"> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">anyadirUsuario</span><span class="token punctuation">(</span>usuarios<span class="token operator">:</span> Usuarios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> context<span class="token operator">=</span><span class="token keyword keyword-this">this</span>
        <span class="token keyword keyword-var">var</span> salida<span class="token operator">:</span>String<span class="token operator">?</span>
        <span class="token keyword keyword-val">val</span> proveedorServicios<span class="token operator">:</span> ProveedorSersvicio <span class="token operator">=</span> <span class="token function">crearRetrofit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> proveedorServicios<span class="token punctuation">.</span><span class="token function">insertarUsuario</span><span class="token punctuation">(</span>usuarios<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> usuariosResponse <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>usuariosResponse <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> salida<span class="token operator">=</span>usuariosResponse<span class="token punctuation">.</span>mensaje
                <span class="token keyword keyword-else">else</span> salida<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                salida<span class="token operator">=</span>response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> salida<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>espera <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> espera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">limpiaControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5-19" data-start="5" data-end="19">














</div></div><div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div></pre><blockquote>
<p>&#x1F4CC; <strong>L&#xED;nea 4</strong> llamamos al m&#xE9;todo crearRetrofit, que es el que nos devuelve un proveedor de servicios del tipo de interface que hemos creado y nos enlazar&#xE1; con la url del servidor y con el GSon. L&#xED;nea 5 - 13 se lanza la corrutina con la petici&#xF3;n deseada, cuando se obtenga respuesta se filtra para ver si ha sido correcta y recuperar los datos necesarios, <strong><code>response.body()</code></strong>, en caso contrario se lanza mensaje de error.</p>
</blockquote>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;EjercicioPropuestoBDExternas</span></p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;EjercicioPropuestoAgenda</span></p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="acceso-a-base-de-datos-con-firebase">Acceso a Base de Datos con FIREBASE</h2>

<p><a href="https://firebase.google.com/">Firebase</a> es una plataforma de backend para construir aplicaciones m&#xF3;viles y web, se encarga del manejo de la infraestructura permitiendo que el desarrollador se enfoque en otros aspectos de la aplicaci&#xF3;n. Entre sus caracter&#xED;sticas se incluye base de datos de tiempo real, autenticaci&#xF3;n de usuarios y almacenamiento (hosting) est&#xE1;tico. La idea de usar Firebase es no tener que escribir c&#xF3;digo del lado del servidor y aprovechar al m&#xE1;ximo las caracter&#xED;sticas que nos provee la plataforma. Para utilizar Firebase con Android disponemos de un SDK, lo que nos permitir&#xE1; integrarlo f&#xE1;cilmente a nuestra aplicaci&#xF3;n. Para este ejemplo vamos a construir un listado de cosas por hacer usando la base de datos de tiempo real de Firebase como backend y autenticaci&#xF3;n con email/password.</p>
<h3 class="mume-header" id="creando-un-app-de-firebase">Creando un app de Firebase</h3>

<p>El primer paso es asociar nuestra cuenta de Firebase a una de nuestras cuentas de correo electr&#xF3;nico:</p>
<div align="center">
    <img height="250" src="./imagenes/imagen16.png">
</div>
<p>Una vez est&#xE1; lista veremos la pantalla donde es posible visualizar nuestros proyectos o crear nuevos.</p>
<div align="center">
    <img height="250" src="./imagenes/imagen17.png">
</div>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td style="border: 0;">
Para crear un nuevo proyecto solamente tendremos que introducir un nombre y la organizaci&#xF3;n o carpeta principal del proyecto. Google nos pedir&#xE1; si queremos habilitar Google Analytics en el proyecto, lo dejaremos habilitado.
</td>
<td style="border: 0;">
<div align="center">
    <img width="1000" src="./imagenes/imagen18.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<div align="left">
    <img height="50" src="./imagenes/imagen19.png">
</div>
<p>Y lo asociaremos a la cuenta por defecto. Una vez realizados estos pasos, se crear&#xE1; el proyecto de firebase.</p>
<p>Posteriormente nos aparecer&#xE1; la pantalla que nos permitir&#xE1; a&#xF1;adir la aplicaci&#xF3;n a nuestro proyecto Cada proyecto estar&#xE1; asociado a una o m&#xE1;s aplicaciones, por lo que antes de crear el proyecto necesitaremos crear la aplicaci&#xF3;n o decidir el espacio de nombres de esta.</p>
<p><em>Vamos a crear una aplicaci&#xF3;n sencilla con el siguiente aspecto, que nos permita entender el funcionamiento de acceso a Firebase para enviar y recibir datos sin autentificaci&#xF3;n.</em></p>
<div align="center">
    <img height="200" src="./imagenes/imagen32.png">
</div>
<p>Cuando el usuario meta la informaci&#xF3;n en los TextView y pulse el bot&#xF3;n a&#xF1;adir, la informaci&#xF3;n se guarda en Firebase y cuando se modifique esta desde Firebase, se mostrar&#xE1; un mensaje con el texto modificado en el Txt de la aplicaci&#xF3;n.</p>
<div align="center">
    <img height="150" src="./imagenes/imagen20.png">
</div>
<p>Una vez tengamos el espacio de nombre, podremos seguir con los pasos que nos pide Firebase para crear la aplicaci&#xF3;n. En nuestro caso no ser&#xE1; necesario introducir la firma de certificaci&#xF3;n.</p>
<div align="center">
    <img height="350" src="./imagenes/imagen21.png">
</div>
<p>Justo en el momento que termina de crearse la aplicaci&#xF3;n, se descargara un archivo JSON que deberemos copiar en nuestro proyecto Android. Solo tendremos que seguir las instrucciones que proporciona muy claramente la p&#xE1;gina Web de Firebase (copiar el archivo y a&#xF1;adir las l&#xED;neas que indican que vamos a usar servicios de google en los build.gradle de la app y del proyecto).</p>
<ol>
<li>
<p>En el proyecto</p>
<pre data-role="codeBlock" data-info="json" class="language-json">  dependencies <span class="token punctuation">{</span>
     classpath <span class="token string">&quot;com.android.tools.build:gradle:7.0.3&quot;</span>
     classpath <span class="token string">&quot;com.google.gms:google-services:4.3.10&quot;</span> <span class="token comment">//a&#xF1;adir esta l&#xED;nea</span>
     ...
  <span class="token punctuation">}</span>
</pre></li>
<li>
<p>En la APP</p>
<pre data-role="codeBlock" data-info="json" class="language-json">plugins <span class="token punctuation">{</span>
   id &apos;com.android.application&apos;
   id &apos;kotlin-android&apos;
   id &apos;com.google.gms.google-services&apos;  <span class="token comment">// Google Services plugin</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    ...
    implementation &apos;androidx.appcompat<span class="token operator">:</span>appcompat<span class="token operator">:</span><span class="token number">1.3</span>.<span class="token number">1</span>&apos;
    <span class="token comment">//a&#xF1;adir las siguientes dos l&#xED;neas</span>
    implementation platform(&apos;com.google.firebase<span class="token operator">:</span>firebase-bom<span class="token operator">:</span><span class="token number">28.4</span>.<span class="token number">1</span>&apos;)
    implementation &apos;com.google.firebase<span class="token operator">:</span>firebase-analytics&apos;
    ...
<span class="token punctuation">}</span>
</pre></li>
</ol>
<p>La dependencia de firebase bom permitir&#xE1; evitar a&#xF1;adir la versi&#xF3;n al resto de dependencias de Firebase que incluyamos en nuestro proyecto, facilitando mucho el trabajo.<br>
Muy importante no olvidar a&#xF1;adir en el SDK, el servicio de Google Play</p>
<div align="center">
    <img height src="./imagenes/imagen22.png">
</div>
<p>En el modo consola podremos acceder a todos nuestros proyectos, y podemos comprobar la aplicaci&#xF3;n o aplicaciones a&#xF1;adidas sobre un proyecto (podemos a&#xF1;adir m&#xE1;s de una).</p>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td align="center" rowspan="2">
<div align="left">
    <img width="400" src="./imagenes/imagen24.png">
</div>
</td>
<td style="border:hidden;">
<div align="center">
    <img height="150" src="./imagenes/imagen23.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;">
Accediendo a la configuraci&#xF3;n de la aplicaci&#xF3;n o del proyecto, podremos ver informaci&#xF3;n sobre las claves, ID de aplicaci&#xF3;n y dem&#xE1;s. Tambi&#xE9;n podremos descargar de nuevo el .json de configuraci&#xF3;n de los servicios.
</td>
</tr>

</tbody></table>
</span>
<p>Todas las aplicaciones por defecto se encuentran en modo desarrollo y bajo el plan gratis que soporta hasta 100 conexiones concurrentes, 1GB de almacenamiento y 10GB de transferencia en el backend. Luego de creada el app nos dirigimos a ver sus detalles, podemos entrar en diversas pesta&#xF1;as que nos permitir&#xE1;n trabajar con la APP, pero a nosotros nos interesa la BD. Firebase ofrece dos soluciones de bases de datos en la nube y accesibles para los clientes que admiten sincronizaci&#xF3;n en tiempo real:</p>
<ul>
<li><strong><code>Firestore DataBase</code></strong> en ocasiones tambi&#xE9;n nombrada Cloud Firestores, es la base de datos m&#xE1;s reciente de Firebase. Aprovecha lo mejor de Realtime Database con un modelo de datos nuevo, permite consultas m&#xE1;s ricas y r&#xE1;pidas, y el escalamiento se ajusta a un nivel m&#xE1;s alto que Realtime Database.</li>
<li><strong><code>Realtime Database</code></strong> es la base de datos original de Firebase. Es una soluci&#xF3;n eficiente y de baja latencia destinada a las apps para dispositivos m&#xF3;viles que necesitan estados sincronizados entre los clientes en tiempo real. Es similar a la anterior en su uso, por lo que no la explicaremos.</li>
</ul>
<div align="center">
    <img height="250" src="./imagenes/imagen25.png">
</div>
<h3 class="mume-header" id="firestore-database">Firestore DataBase</h3>

<p>Base de datos NoSQL flexible, escalable y en la nube a fin de almacenar y sincronizar datos para la programaci&#xF3;n en el lado del cliente y del servidor. Al igual que <a href="https://firebase.google.com/docs/database">Firebase Realtime Database</a> mantiene los datos sincronizados entre apps cliente a trav&#xE9;s de agentes de escucha en tiempo real. El modelo de datos de <a href="https://firebase.google.com/docs/firestore">Firebase Firestore DataBase</a> admite estructuras de datos flexibles y jer&#xE1;rquicas. Almacena los datos en documentos organizados en colecciones, los documentos pueden contener objetos anidados complejos, adem&#xE1;s de subcolecciones. Est&#xE1; optimizada para almacenar grandes colecciones de documentos peque&#xF1;os. El modelo de datos est&#xE1; formado por documentos, cada documento contiene un conjunto de pares clave-valor. Todos los documentos se deben almacenar en colecciones, los documentos pueden contener subcolecciones y objetos anidados, y ambos pueden incluir campos primitivos como strings o tipos de objetos complejos como listas. Las colecciones y los documentos se crean de manera impl&#xED;cita en <strong><code>Firestore DataBase</code></strong>. Solo debes asignar datos a un documento dentro de una colecci&#xF3;n. Si la colecci&#xF3;n o el documento no existen,  <strong><code>Firestore DataBase</code></strong> los crea. Cada documento est&#xE1; identificado por una clave &#xFA;nica, que puede generarse autom&#xE1;ticamente o que se puede a&#xF1;adir a la vez que el documento:</p>
<div align="center">
    <img width src="./imagenes/imagen26.png">
</div>
<p>Son muy similares a JSON, de hecho, b&#xE1;sicamente son JSON. Existen algunas diferencias, por ejemplo: los documentos admiten <strong>tipos de datos adicionales</strong> y su tama&#xF1;o se limita a 1 MB, pero en general, puedes tratar los documentos como registros JSON livianos. Los documentos viven en colecciones, que simplemente son contenedores de documentos. Por ejemplo, podr&#xED;as tener una colecci&#xF3;n llamada users con los distintos usuarios de tu app, en la que haya un documento que represente a cada uno:</p>
<div align="center">
    <img height="250" src="./imagenes/imagen27.png">
</div>
<p><em>Usando el ejercicio del que hemos creado el layout de inicio, vamos a a&#xF1;adir el c&#xF3;digo necesario para que nos permita interactuar con Firebase. La aplicaci&#xF3;n  guardar&#xE1; usuarios con contrase&#xF1;a en la base de datos con <strong><code>Firebase Cloud Firestone</code></strong> y adem&#xE1;s permitir&#xE1; la autenticaci&#xF3;n con <strong><code>Firebase Auth</code></strong>.</em></p>
<p><em>En el proyecto de Firebase que acabamos de crear, a&#xF1;adiremos una base de datos <strong>Firestore DataBase</strong>.</em></p>
<div align="center">
    <img height="200" src="./imagenes/imagen28.png">
</div>
<p><em>Deberemos seleccionar la ubicaci&#xF3;n de nuestra Base de Datos, podemos seleccionar Z&#xDA;RICH(europe-west6)</em>. Un elemento importante y que todav&#xED;a no hemos mencionado, son la Reglas. La Firebase Cloud Firestore proporciona un lenguaje de reglas flexibles basadas en expresiones y sintaxis similar a la de JavaScript <a href="https://firebase.google.com/docs/firestore/security/get-started?authuser=0">https://firebase.google.com/docs/firestore/security/get-started?authuser=0</a>, que permite definir f&#xE1;cilmente la manera en que tus datos deben estructurarse e indexarse, y el momento en que pueden someterse a lectura y escritura. Estas reglas las podremos configurar desde la pesta&#xF1;a RULES de nuestra BD,</p>
<div align="center">
    <img height="150" src="./imagenes/imagen29.png">
</div>
<p>Por defecto vendr&#xED;an configuradas para modo producci&#xF3;n, aunque para iniciarse podemos seleccionar modo de prueba (dura 30 d&#xED;as).</p>
<div align="center">
    <img height="220" src="./imagenes/imagen30.png">
</div>
<div align="center">
    <img height="150" src="./imagenes/imagen31.png">
</div>
<p>Si nos hubi&#xE9;semos confundido o quisi&#xE9;ramos cambiar las reglas, habr&#xED;a que cambiar su valor y sobre todo <strong>No olvidar Publicar</strong>.</p>
<p>Antes de comenzar con el c&#xF3;digo de acceso a la BD, tendremos que a&#xF1;adir la dependencia que nos permitir&#xE1; hacerlo:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">   implementation &apos;com.google.firebase<span class="token operator">:</span>firebase-firestore&apos;
</pre><p>Para referenciar a nuestra base de datos solamente tendremos que crear un objeto de tipo <strong><code>FirebaseFirestore</code></strong>. El archivo que descargamos al enlazar la app con el proyecto, es el que se encarga de todo el trabajo interno para la conexi&#xF3;n:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-val">val</span> firebaseFirestore <span class="token operator">=</span> FirebaseFirestore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Para hacer referencia a una colecci&#xF3;n existente o a&#xF1;adirla en caso de no existir, utilizaremos el m&#xE9;todo <strong><code>collection</code></strong> con el nombre de la colecci&#xF3;n como argumento.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
</pre><p>Este m&#xE9;todo devuelve una referencia a la colecci&#xF3;n seleccionada, y con &#xE9;l podremos a&#xF1;adir nuevos elementos a ella (la colecci&#xF3;n se crear&#xE1; al a&#xF1;adir el primer documento, en caso de haber sido creada anteriormente har&#xE1; la referencia solamente).</p>
<p>Para a&#xF1;adir un objeto (documento) a la colecci&#xF3;n lo podremos hacer de dos maneras:</p>
<ol>
<li>Dejando que la plataforma genere una clave aleat&#xF3;ria, para eso utilizaremos el m&#xE9;todo add.</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">   firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Usuario</span><span class="token punctuation">(</span><span class="token string">&quot;Pepe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;correo@gmail.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div align="center">
    <img height="95" src="./imagenes/imagen33.png">
</div>
<ol>
<li>A&#xF1;adiendo nosotros la clave, esta debe ser &#xFA;nica para que el usuario se a&#xF1;ada.</li>
</ol>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">   firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
</pre> <div align="center">
    <img height="95" src="./imagenes/imagen34.png">
</div>
<p><em>Para insertar el valor del nuevo hijo hemos utilizado un objeto de la clase Pojo Usuario, que nos habremos creado con anterioridad</em>, Firestore convierte autom&#xE1;ticamente los atributos con sus valores para poder guardarlos correctamente. <strong>Cuidado deberemos tener los atributos p&#xFA;blicos o usar getter y setter.</strong></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> Usuario <span class="token operator">:</span> Serializable <span class="token punctuation">{</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> usuario<span class="token operator">:</span> String
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> correo<span class="token operator">:</span> String

    <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> String<span class="token punctuation">,</span> correo<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>usuario <span class="token operator">=</span> usuario
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>correo <span class="token operator">=</span> correo
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p><em>El c&#xF3;digo completo para crear la aplicaci&#xF3;n que nos a&#xF1;adir&#xE1; un usuario cada vez que pulsemos el bot&#xF3;n a&#xF1;adir, de forma que el id del usuario sea el correo, ser&#xE1; el siguiente:</em></p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[19,25]}" class="language-kotlin" data-line="19,25"><span class="token keyword keyword-class">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> firebaseFirestore<span class="token operator">:</span> FirebaseFirestore
    <span class="token keyword keyword-var">var</span> listenerRegistration<span class="token operator">:</span> ListenerRegistration<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        firebaseFirestore <span class="token operator">=</span> FirebaseFirestore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> usuarioET <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextInputLayout<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> correoET <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextInputLayout<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> a&#xF1;adir <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>anyadir<span class="token punctuation">)</span>

        <span class="token keyword keyword-val">val</span> salida <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>TextView<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>salida<span class="token punctuation">)</span>
        a&#xF1;adir<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> usuario <span class="token operator">=</span> <span class="token function">Usuario</span><span class="token punctuation">(</span>usuarioET<span class="token punctuation">.</span>editText<span class="token operator">?</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  correoET<span class="token punctuation">.</span>editText<span class="token operator">?</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">addOnSuccessListener</span> <span class="token punctuation">{</span>
                              Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                              <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                              <span class="token string">&quot;Usuario A&#xF1;adido&quot;</span><span class="token punctuation">,</span>
                              Toast<span class="token punctuation">.</span>LENGTH_SHORT
                              <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
                             <span class="token punctuation">.</span><span class="token function">addOnFailureListener</span> <span class="token punctuation">{</span> e <span class="token operator">-&gt;</span>
                             Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                             <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                             <span class="token string">&quot;Error&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                             Toast<span class="token punctuation">.</span>LENGTH_SHORT
                             <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<div class="line-highlight-wrapper">

















<div aria-hidden="true" class="line-highlight" data-range="19" data-start="19">
</div></div><div class="line-highlight-wrapper">























<div aria-hidden="true" class="line-highlight" data-range="25" data-start="25">
</div></div></pre><blockquote>
<p>&#x1F4CC; como se puede ven en el c&#xF3;digo del OnClick, a&#xF1;adimos el usuario recogido de los EditText creando como clave el correo, como se ha explicado anteriormente en el tema.Adem&#xE1;s a los m&#xE9;todos de a&#xF1;adir objeto (set o add) se le pueden asignar&#xE1;n distintos escuchadores para comprobar el estado del proceso. <strong>L&#xED;nea 19 y 25</strong>.</p>
</blockquote>
<p>Para <a href="https://cloud.google.com/firestore/docs/query-data/queries?hl=es">buscar un documento en Cloud Firestore</a>, existen distintas posibilidades  basadas en la clausula <strong>Where</strong>. <em>Por ejemplo, si quisieramos comprobar si el id del usuario no est&#xE1; repetido y solo en ese caso a&#xF1;adirlo, podr&#xED;amos modificar el anterior c&#xF3;digo de la siguiente manera:</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token keyword keyword-fun">fun</span> <span class="token function">compruebaSiExisteyAnayade</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span>FieldPath<span class="token punctuation">.</span><span class="token function">documentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span>OnCompleteListener<span class="token operator">&lt;</span>QuerySnapshot<span class="token operator">?</span><span class="token operator">&gt;</span>
             <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">anyadeUsuario</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span> 
                    <span class="token keyword keyword-else">else</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                        <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;El correo ya existe, introduce uno nuevo&quot;</span><span class="token punctuation">,</span>
                        Toast<span class="token punctuation">.</span>LENGTH_LONG
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                    Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">anyadeUsuario</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>usuario<span class="token punctuation">.</span>correo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>usuario<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnSuccessListener</span> <span class="token punctuation">{</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Usuario A&#xF1;adido&quot;</span><span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">addOnFailureListener</span> <span class="token punctuation">{</span> e <span class="token operator">-&gt;</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Error&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p><em>Si quisieramos dar funcionalidad al bot&#xF3;n <strong>Eliminar</strong>, podemos hacer algo parecido a lo siguiente. En este caso se est&#xE1; eliminando por nombre de usuario, as&#xED; que en el caso de existir m&#xE1;s de un documento con el mismo nombre, se eliminar&#xE1;n todos.</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">Elimina</span><span class="token punctuation">(</span>usuario<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;usuario&quot;</span><span class="token punctuation">,</span> usuario<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span> 
               <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>documento <span class="token keyword keyword-in">in</span> task<span class="token punctuation">.</span>result<span class="token operator">!!</span><span class="token punctuation">)</span> documento<span class="token punctuation">.</span>reference<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                                   <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p>Si lo que queremos es controlar los cambios que ocurren en la BD, sea a trav&#xE9;s de una aplicaci&#xF3;n o directamente desde la consola de Firebase, tendremos que registrar un listener del tipo ListenerRegistration, que se inicializar&#xE1; sobre la consulta que deseemos con <strong><code>addSnapshotListener</code></strong>. <em>En el siguiente ejemplo ponemos a escuchar todos los documentos de la colecci&#xF3;n Usuarios, mostrando en el TextView (que est&#xE1; bajo los botones) el resultado de cualquier modificaci&#xF3;n en cualquier documento de la colecci&#xF3;n.</em></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">listarUsuarios</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> query <span class="token operator">=</span> firebaseFirestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;Usuarios&quot;</span><span class="token punctuation">)</span>
        listenerRegistration <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">addSnapshotListener</span> <span class="token punctuation">{</span>value<span class="token punctuation">,</span> error<span class="token operator">-&gt;</span>
           <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>dc <span class="token keyword keyword-in">in</span> value<span class="token operator">!!</span><span class="token punctuation">.</span>documentChanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-when">when</span> <span class="token punctuation">(</span>dc<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>ADDED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\nSe ha a&#xF1;adido:&quot;</span><span class="token operator">+</span>
                             <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>MODIFIED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\n Se ha modificado:&quot;</span><span class="token operator">+</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        DocumentChange<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>REMOVED <span class="token operator">-&gt;</span> salida<span class="token punctuation">.</span>text <span class="token operator">=</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>salida<span class="token punctuation">.</span>text<span class="token delimiter variable">}</span></span>\nSe ha eliminado:&quot;</span><span class="token operator">+</span>
                            <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter variable">${</span>dc<span class="token punctuation">.</span>document<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>\n&quot;</span><span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>  Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> <span class="token string">&quot;No se puede listar&quot;</span><span class="token operator">+</span>error<span class="token punctuation">,</span> 
                                  Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre><p>Se puede realizar la consulta sobre cualquier elemento de la colecci&#xF3;n despu&#xE9;s de haber sido seleccionado, de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">   query<span class="token punctuation">.</span><span class="token function">whereEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;correo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;manuel@gamil.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSnapshotListener</span><span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x26A0;&#xFE0F; Otro tema importante a tener en cuenta, es que la suscripci&#xF3;n a una referencia de una base de datos de Firebase, es decir, el hecho de asignar un listener a una ubicaci&#xF3;n del &#xE1;rbol para estar al tanto de sus cambios <strong>no es algo gratuito</strong> desde el punto de vista de consumo de recursos. Por tanto, es recomendable eliminar esa suscripci&#xF3;n cuando ya no la necesitamos. Para hacer esto basta con llamar al m&#xE9;todo <strong><code>remove()</code></strong> del listener registrado, cuando no deseemos seguir escuchando.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       listenerRegistration<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
</pre></blockquote>
<h4 class="mume-header" id="firebaseui-y-recyclerview">FirebaseUI y RecyclerView</h4>

<p><a href="https://github.com/firebase/FirebaseUI-Android">FirebaseUI</a> nos permite asociar f&#xE1;cilmente a un control <strong><code>ListView</code></strong> o <strong><code>RecyclerView</code></strong>, una referencia a una lista de elementos de una base de datos Firebase. De esta forma, el control se actualizar&#xE1; autom&#xE1;ticamente cada vez que se produzca cualquier cambio en la lista, sin tener que gestionar manualmente por nuestra parte los eventos de la lista, ni tener que almacenar en una estructura paralela la informaci&#xF3;n, ni tener que construir gran parte de los adaptadores necesarios&#x2026; en resumen, ahorrando muchas l&#xED;neas de c&#xF3;digo y evitando muchos posibles errores. Para utilizar <strong><code>FirebaseUI</code></strong> lo primero que tendremos que hacer ser&#xE1; a&#xF1;adir la referencia a la librer&#xED;a en el fichero build.gradle de nuestro m&#xF3;dulo principal. Hay que tener en cuenta que cada versi&#xF3;n de <strong><code>FirebaseUI</code></strong> es compatible &#xFA;nicamente con una versi&#xF3;n concreta de Firebase, por lo que debemos asegurar que las versiones utilizadas de ambas librer&#xED;as son coherentes. En la p&#xE1;gina de <strong><code>FirebaseUI</code></strong> ten&#xE9;is disponible la tabla de compatibilidades entre versiones. En el momento de actualizaci&#xF3;n de estos apuntes:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">implementation &apos;com.firebaseui<span class="token operator">:</span>firebase-ui-firestore<span class="token operator">:</span><span class="token number">8.0</span>.<span class="token number">0</span>&apos;
</pre><p>Esta librer&#xED;a nos provee de una Adaptador derivado de <strong><code>RecyclerView.ViewAdapter</code></strong> que gestionar&#xE1; autom&#xE1;ticamente la carga de los datos que le pasemos como referencia en la vista asignada por el <strong><code>Holder</code></strong>, para ello lo primero que deberemos crear es el ViewHolder personalizado que gestione los datos de nuestras aplicaci&#xF3;n (retomamos el ejemplo e implementamos el bot&#xF3;n listar, podemos crear un fragment o activity para mostrar).</p>
<pre data-role="codeBlock" data-info="kotlin{highlight=[[22-28],2]}" class="language-kotlin" data-line="22-28,2"><span class="token keyword keyword-class">class</span> <span class="token function">Adaptador</span><span class="token punctuation">(</span>options<span class="token operator">:</span> FirestoreRecyclerOptions<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    FirestoreRecyclerAdapter<span class="token operator">&lt;</span>Usuario<span class="token punctuation">,</span> Adaptador<span class="token punctuation">.</span>Holder<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    View<span class="token punctuation">.</span><span class="token function">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> listener<span class="token operator">:</span> View<span class="token punctuation">.</span>OnClickListener<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-override">override</span>  <span class="token keyword keyword-fun">fun</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> Holder<span class="token punctuation">,</span> position<span class="token operator">:</span> Int<span class="token punctuation">,</span> 
                                   model<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        holder<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> ViewGroup<span class="token punctuation">,</span> viewType<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> 
                                    Holder <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> view<span class="token operator">:</span> View <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>linea_recycler<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        view<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token function">Holder</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onClickListener</span><span class="token punctuation">(</span>listener<span class="token operator">:</span> View<span class="token punctuation">.</span>OnClickListener<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> listener
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onClick</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
   <span class="token keyword keyword-inner">inner</span> <span class="token keyword keyword-class">class</span> <span class="token function">Holder</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token operator">:</span> RecyclerView<span class="token punctuation">.</span><span class="token function">ViewHolder</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> usuario<span class="token operator">:</span> TextView
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> correo<span class="token operator">:</span> TextView
        <span class="token keyword keyword-fun">fun</span> <span class="token function">bind</span><span class="token punctuation">(</span>item<span class="token operator">:</span> Usuario<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            usuario<span class="token punctuation">.</span>text <span class="token operator">=</span> item<span class="token punctuation">.</span>usuario
            correo<span class="token punctuation">.</span>text <span class="token operator">=</span> item<span class="token punctuation">.</span>correo
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>
            usuario <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>usuario<span class="token punctuation">)</span>
            correo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>correo<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">




















<div aria-hidden="true" class="line-highlight" data-range="22-28" data-start="22" data-end="28">






</div></div><div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div></pre><blockquote>
<p>&#x1F4CC; Definimos un adaptador como ya hemos hecho anteriormente, con el Holder para controlar las vistas de las l&#xED;neas del recycler <strong>L&#xED;nea 22 a 28</strong>, en donde sobrescribir&#xED;amos, obligatoriamente, los dos m&#xE9;todos y el constructor. He implementar&#xED;amos los listener necesarios para el funcionamiento de los eventos. La principal diferencia es que el Adaptador hereda de la clase <strong><code>FirestoreRecyclerAdapter</code></strong>. FirebaseUI nos facilita el listado de los elementos extraidos de la BD proporcionando esta libreria. A esta clase le tenemos que indicar  que los elementos usados son: el ViewHolder personalizado que acabamos de crear y la clase java que utilicemos para encapsular la informaci&#xF3;n de cada elemento de la lista <strong><code>FirestoreRecyclerAdapter&lt;Usuario, Adaptador.Holder&gt;</code></strong>.<br>
Al crear un objeto de esta clase, debemos pasarle un objeto de la misma librer&#xED;a, de tipo <strong><code>FirestoreRecyclerOptions</code></strong>.</p>
</blockquote>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token keyword keyword-val">val</span> firestoreRecyclerOptions <span class="token operator">=</span> FirestoreRecyclerOptions<span class="token punctuation">.</span>Builder<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Usuario<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Al que debemos pasarle la siguiente informaci&#xF3;n:</p>
<ul>
<li>El objeto clase de nuestro Item (Usuario.class),</li>
<li>La referencia al nodo de la base de datos que contiene la lista de elementos que queremos mostrar en el control.</li>
</ul>
<p>Ahora solo quedar&#xED;a crear un objeto del tipo adaptador que nos hemos creado, pas&#xE1;ndole el elemento <strong><code>firebaseRecyclerOption</code></strong> y ya tendr&#xED;amos casi todo hecho.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">cargarRecycler</span><span class="token punctuation">(</span>query<span class="token operator">:</span> Query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> firestoreRecyclerOptions <span class="token operator">=</span> FirestoreRecyclerOptions<span class="token punctuation">.</span>
                                       Builder<span class="token operator">&lt;</span>Usuario<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Usuario<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        recyclerView <span class="token operator">=</span> vista<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>recycler<span class="token punctuation">)</span>
        adapter <span class="token operator">=</span> <span class="token function">Adaptador</span><span class="token punctuation">(</span>firestoreRecyclerOptions<span class="token punctuation">)</span>
        <span class="token comment">//Click para eliminar elementos</span>
        adapter<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">onClickListener</span><span class="token punctuation">{</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                    <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Elemento eliminado&quot;</span> <span class="token operator">+</span> recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>
                                           <span class="token function">getChildAdapterPosition</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Toast<span class="token punctuation">.</span>LENGTH_SHORT
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                adapter<span class="token operator">!!</span><span class="token punctuation">.</span>snapshots<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>
                                            <span class="token function">getChildAdapterPosition</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                            reference<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>adapter <span class="token operator">=</span> adapter
        recyclerView<span class="token operator">!!</span><span class="token punctuation">.</span>layoutManager <span class="token operator">=</span> <span class="token function">LinearLayoutManager</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre><p>No deberemos olvidar iniciar el escuchador del adaptador al comenzar la aplicaci&#xF3;n y cerrarlo al acabar.</p>
<span style="align: center;">
<table align="center">
<tbody><tr style="border:hidden;">
<td>
<div align="center">
    <img height src="./imagenes/imagen36.png">
</div></td>
<td style="border:hidden;">
<div align="center">
    <img height src="./imagenes/imagen35.png">
</div>
</td>
</tr>
</tbody></table>
</span>
<h4 class="mume-header" id="filtrado-y-ordenaci%C3%B3n">Filtrado y ordenaci&#xF3;n</h4>

<p>Lo primero que debemos tener en cuenta es que en las BD de Firebase no vamos a tener todas las facilidades de ordenaci&#xF3;n y filtrado que suelen encontrarse en bases de datos SQL tradicionales. Para las consultas podemos encontrar la informaci&#xF3;n que necesitamos en el siguiente enlace <a href="https://firebase.google.com/docs/firestore/query-data/queries">https://firebase.google.com/docs/firestore/query-data/queries</a>.<br>
Para realizar consultas se utiliza cualquiera de los m&#xE9;todos <strong><code>where</code></strong> que indican que tipo de consulta necesitamos:</p>
<div align="center">
    <img height="110" src=".\imagenes/imagen37.png">
</div>
<p>Usando la colecci&#xF3;n del ejemplo que nos encontramos en el enlace de la p&#xE1;gina de documentaci&#xF3;n de firestore, <em>con la expresi&#xF3;n siguiente recuperar&#xED;amos todos los documentos que tienen una poblaci&#xF3;n menor a 100000 habitantes.</em></p>
<div align="center">
    <img height="20" src=".\imagenes/imagen38.png">
</div>
<p>Se pueden enlazar b&#xFA;squedas con <strong><code>where</code></strong>, de la siguiente manera:</p>
<div align="center">
    <img height="20" src=".\imagenes/imagen39.png">
</div>
<p><em>En este caso se buscar&#xE1;n todos los documentos de estado igual a CA y del resultado de esa b&#xFA;squeda se extraer&#xE1;n solo aquellos que tengan una poblaci&#xF3;n menor a 100000.</em><br>
Tambi&#xE9;n est&#xE1; la opci&#xF3;n de buscar dentro de una colecci&#xF3;n directamente. Si algunos de nuestros documentos tienen un miembro que es una colecci&#xF3;n, podremos realizar la consulta sobre este elemento usando alguna de las sobrecargas de <strong><code>whereArrayContains</code></strong></p>
<div align="center">
    <img height="30" src=".\imagenes/imagen40.png">
</div>
<p><em>En los datos &#x2018;regions&#x2019; se refiere a un array con los nombres de las regiones a las que pertenece cada ciudad, por lo que con la consulta anterior se extraer&#xE1;n todas las ciudades que en ese array tengan la entrada &#x2018;west_coast&#x2019;, si la tienen repetida solo aparecer&#xE1;n una vez en los resultados.</em><br>
Si lo que queremos hacer es ordenar los datos obtenidos, tenemos toda la informaci&#xF3;n en la url <a href="https://firebase.google.com/docs/firestore/query-data/orderlimitdata?hl=es">https://firebase.google.com/docs/firestore/query-data/orderlimitdata?hl=es</a>  Se utilizar&#xE1; cualquiera de las sobrecargas del m&#xE9;todo <strong><code>orderBy</code></strong></p>
<div align="center">
    <img height="100" src=".\imagenes/imagen41.png">
</div>
<p>Por ejemplo, se pueden combinar m&#xE1;s de un <strong><code>orderBy</code></strong> para realizar la consulta que necesitemos. En este caso se ordena por el nombre del estado y a partir de ah&#xED; por n&#xFA;mero de poblaci&#xF3;n y en orden descendiente.</p>
<div align="center">
    <img height="30" src=".\imagenes/imagen42.png">
</div>
<p>Una cl&#xE1;usula <strong><code>orderBy</code></strong> tambi&#xE9;n filtra en busca de la existencia del campo dado. El conjunto de resultados no incluir&#xE1; documentos que no contengan el campo correspondiente.  Como es de esperar, tambi&#xE9;n se pueden ordenar los datos despu&#xE9;s de realizar una consulta <strong><code>where</code></strong>,  pero con la condici&#xF3;n que debe ser sobre el mismo campo por el que se ha hecho la b&#xFA;squeda.</p>
<div align="center">
    <img height="33" src=".\imagenes/imagen43.png">
</div>
<p>Si con orderBy se puede especificar el orden de clasificaci&#xF3;n de los datos, con limit puedes limitar la cantidad de documentos recuperados.</p>
<p><em>Devuelve los nombres de las tres primeras ciudades</em></p>
<div align="center">
    <img height="25" src=".\imagenes/imagen44.png">
</div>
<p><em>Devuelve los nombres de las tres &#xFA;ltimas ciudades</em></p>
<div align="center">
    <img height="25" src=".\imagenes/imagen45.png">
</div>
<p>Otros cursores de consultas que est&#xE1;n disponibles son:</p>
<span style="align: center;">
<table align="center">
<tbody><tr>
<td style="border:hidden;">
<ul>
<li><strong><code>startAt</code></strong> -&gt; La consulta s&#xF3;lo devolver&#xE1; los elementos cuyo<br>
valor sea igual o superior al dato pasado como par&#xE1;metro.<br>
<em>Ciudades con n&#xFA;mero de habitantes 100000 y ordenados por n&#xFA;mero de poblaci&#xF3;n</em></li>
</ul>
</td>
<td style="border:hidden;">
<div align="center">
    <img height src=".\imagenes/imagen46.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;" colspan="2">
<ul>
<li><strong><code>startAfter</code></strong> -&gt; Id&#xE9;ntico al anterior pero para valores superiores, no incluye los documentos con valor igual.</li>
</ul>
</td>
</tr>
<tr>
<td style="border:hidden;">
<ul>
<li><strong><code>endAt</code></strong> -&gt; La consulta s&#xF3;lo devolver&#xE1; los elementos cuyo valor sea igual o inferior al dato pasado como par&#xE1;metro.<br>
<em>Ciudades con n&#xFA;mero de habitantes &lt;= 100000 y ordenados por n&#xFA;mero de poblaci&#xF3;n</em></li>
</ul>

</td>
<td style="border:hidden;">
<div align="center">
    <img width="400" src=".\imagenes/imagen47.png">
</div>
</td>
</tr>
<tr>
<td style="border:hidden;" colspan="2">
<ul>
<li><strong><code>endBefore</code></strong> -&gt; Id&#xE9;ntico al anterior pero para valores inferiores, no incluye los documentos con valor igual.</li></ul></td>


</tr>
</tbody></table>
</span>
<p>Tambi&#xE9;n podremos utilizar varios criterios de filtrado en la misma consulta, es decir podremos combinar varios de los m&#xE9;todos anteriores para obtener s&#xF3;lo el rango de elementos necesario.</p>
<div align="center">
    <img width="300" src=".\imagenes/imagen48.png">
</div>
<h3 class="mume-header" id="firebase-auth-autenticaci%C3%B3n">Firebase Auth. Autenticaci&#xF3;n</h3>

<p><a href="https://firebase.google.com/docs/auth">Firebase Authentication</a> proporciona servicios de backend, SDK f&#xE1;ciles de usar y bibliotecas de IU ya elaboradas para autenticar a los usuarios en la app. <em>Vamos a iniciarnos en su uso modificando el proyecto anterior, para ello crearemos otro Fragment que ser&#xE1; el primero que se inicie en la aplicaci&#xF3;n. Nos permitir&#xE1; crear una cuenta o autenticarnos con una ya existente, si la autenticaci&#xF3;n es correcta se cargar&#xE1; el fragment con el que se iniciaba nuestro proyecto anteriormente.</em><br>
Si queremos autentificarnos como usuarios, tenemos varias opciones:<strong><code>email/password, google, tel&#xE9;fono, Facebook, twitter, github, anonymous</code></strong>.* Nosotros vamos a ver el ejemplo de email/password y el de anonymous, en el resto de autentificaciones pod&#xE9;is seguir la documentaci&#xF3;n de FireBase.*</p>
<p>El primer paso ser&#xED;a a&#xF1;adir la dependencia de autenticaci&#xF3;n, que como tenemos incluido la de firebase-bom, no necesitar&#xE1; n&#xFA;mero de versi&#xF3;n:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"> implementation &apos;com.google.firebase<span class="token operator">:</span>firebase-auth&apos;
</pre><p><em>Tendremos que codificar un layout que permita introducir el usuario y la contrase&#xF1;a para poder logearnos.</em></p>
<div align="center">
    <img width="200" src=".\imagenes/imagen49.png">
</div>
<p>Lo siguiente ser&#xE1; activar los proveedores con los que queremos iniciar sesi&#xF3;n. Nos vamos a la opci&#xF3;n Authentication y dentro de este a la pesta&#xF1;a M&#xE9;todos de inicio de sesi&#xF3;n. Tendremos que seleccionar ambos casos y habilitar el estado.</p>
<div align="center">
    <img width="500" src=".\imagenes/imagen50.png">
</div>
<p>Una vez a&#xF1;adido los proveedores, tendremos dos formas de crear los usuarios: <strong>a trav&#xE9;s de la consola y desde la aplicaci&#xF3;n</strong>. Desde la consola nos tendremos que ir a la pesta&#xF1;a usuarios, aqu&#xED; podremos crear los usuarios que necesitemos. Los usuarios an&#xF3;nimos aparecer&#xE1;n solamente con el id &#xFA;nico que asigna Firebase a cada usuario creado.<br>
El otro caso ser&#xE1; al codificar la aplicaci&#xF3;n. Para todos los casos de autentificaci&#xF3;n necesitamos a&#xF1;adir un escuchador a una variable de tipo <strong><code>FirebaseAuth.AuthStateListener</code></strong>. Este escuchador ser&#xE1; asignado en el m&#xE9;todo onStart y eliminado en onStop, y su funci&#xF3;n es la de controlar cualquier cambio que ocurra con el usuario.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> FragmentLogearse <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> mAuthListener<span class="token operator">:</span> AuthStateListener
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> mAuth<span class="token operator">:</span> FirebaseAuth
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> user<span class="token operator">:</span> TextInputLayout
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> pasword<span class="token operator">:</span> TextInputLayout
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> interfaceFragments<span class="token operator">:</span> InterfaceFragments
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mAuth<span class="token punctuation">.</span><span class="token function">addAuthStateListener</span><span class="token punctuation">(</span>mAuthListener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            mAuth<span class="token punctuation">.</span><span class="token function">removeAuthStateListener</span><span class="token punctuation">(</span>mAuthListener<span class="token punctuation">)</span>
            mAuth<span class="token punctuation">.</span><span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onAttach</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onAttach</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        interfaceFragments <span class="token operator">=</span> context <span class="token keyword keyword-as">as</span> InterfaceFragments
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">////Escuchador de cambios en los usuarios</span>
mAuthListener <span class="token operator">=</span> AuthStateListener 
<span class="token punctuation">{</span> 
    firebaseAuth <span class="token operator">-&gt;</span>
        <span class="token keyword keyword-val">val</span> user <span class="token operator">=</span> firebaseAuth<span class="token punctuation">.</span>currentUser
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>email <span class="token operator">+</span> <span class="token string">&quot; LOGEADO&quot;</span><span class="token punctuation">,</span> 
                               Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                mAuth <span class="token operator">=</span> firebaseAuth
            <span class="token punctuation">}</span> 
        <span class="token keyword keyword-else">else</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Usuario NULO&quot;</span><span class="token punctuation">,</span>
                             Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x26A0;&#xFE0F; El escuchador AuthStateListener deber&#xE1; ser incluido en el m&#xE9;todo onCreate de la aplicaci&#xF3;n.</p>
</blockquote>
<p>El siguiente paso ser&#xE1; decidir si queremos permitir crear usuarios nuevos, o solamente logearnos con alguno existente. En nuestra aplicaci&#xF3;n vamos a hacer las dos cosas, e incluso nos logearemos como an&#xF3;nimos. El c&#xF3;digo aparece a continuaci&#xF3;n, y un enlace con toda la informaci&#xF3;n <a href="https://firebase.google.com/docs/auth/android/password-auth">https://firebase.google.com/docs/auth/android/password-auth</a></p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token comment">////// Crear usuario nueveo y iniciar sesi&#xF3;n</span>
        btCrear<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
                mAuth<span class="token punctuation">.</span><span class="token function">createUserWithEmailAndPassword</span><span class="token punctuation">(</span>
                    user<span class="token punctuation">.</span>editText<span class="token operator">!!</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pasword<span class="token punctuation">.</span>editText<span class="token operator">!!</span>
                        <span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Usuario creado&quot;</span><span class="token punctuation">,</span>
                                            Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span>
                                             <span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Problemas al crear usuario&quot;</span> <span class="token operator">+</span>task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> view

</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">/////Iniciar sesi&#xF3;n con usuario y contrase&#xF1;a</span>
        btIniciar<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
            mAuth<span class="token punctuation">.</span><span class="token function">signInWithEmailAndPassword</span><span class="token punctuation">(</span>
                user<span class="token punctuation">.</span>editText<span class="token operator">!!</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pasword<span class="token punctuation">.</span>editText<span class="token operator">!!</span>
                    <span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span><span class="token punctuation">(</span><span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Authentication failed:&quot;</span> <span class="token operator">+</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>
                                             <span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"> <span class="token comment">//////// Iniciar sesi&#xF3;n con an&#xF3;nimo</span>
        btAnonimus<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">{</span>
                mAuth<span class="token punctuation">.</span><span class="token function">signInAnonymously</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOnCompleteListener</span>
                <span class="token punctuation">(</span>
                    <span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    OnCompleteListener<span class="token operator">&lt;</span>AuthResult<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> task <span class="token operator">-&gt;</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Authentication failed:&quot;</span> <span class="token operator">+</span> task<span class="token punctuation">.</span>exception<span class="token punctuation">,</span>
                                Toast<span class="token punctuation">.</span>LENGTH_SHORT
                            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token function">iniciarFragmen</span><span class="token punctuation">(</span><span class="token string">&quot;anonimous&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
</pre><p>Como podemos ver en el c&#xF3;digo, lo que se hace es a&#xF1;adir el mismo escuchador a cualquiera de los m&#xE9;todos que hayamos elegido (login, an&#xF3;nimo o a&#xF1;adir usuario) sobre un objeto <strong><code>FirebaseAuth</code></strong>. Con estos pasos tendremos la autentificaci&#xF3;n controlada, y podremos seguir con nuestra aplicaci&#xF3;n.</p>
<p><span style="color: DarkRed; font-weight: bold;">&#x2712;&#xFE0F;Resuelve el ejercicio de los ejemplos hasta conseguir un correcto funcionamiento</span></p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>