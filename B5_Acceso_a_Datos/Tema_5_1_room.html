<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 5.1 - Room</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  background-color: #FFFF;
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="tema-51-room">Tema 5.1 - Room</h1>

<p>Descargar estos apuntes <a href="./Tema_5_1_room.pdf">pdf</a> o <a href="./Tema_5_1_room.html">html</a></p>
<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>

<ol>
<li><a href="#introducci%C3%B3n">Introducci&#xF3;n</a></li>
<li><a href="#dependencias">Dependencias</a></li>
<li><a href="#componentes-de-room">Componentes de Room</a></li>
<li><a href="#a%C3%B1adiendo-paquete-room-al-proyecto">A&#xF1;adiendo paquete room al proyecto</a></li>
<li><a href="#crear-las-entidades-que-definen-nuestro-modelo">Crear las entidades que definen nuestro modelo</a>
<ol>
<li><a href="#definiendo-relaciones-entre-objetos">Definiendo relaciones entre Objetos</a>
<ol>
<li><a href="#relaciones-uno-a-muchos-entre-objetos">Relaciones Uno a Muchos entre objetos</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#crear-los-objetos-de-acceso-a-la-base-de-datos">Crear los Objetos de Acceso a la Base de Datos</a>
<ol>
<li><a href="#m%C3%A9todos-de-conveniencia">M&#xE9;todos de conveniencia</a></li>
<li><a href="#m%C3%A9todos-de-b%C3%BAsqueda">M&#xE9;todos de b&#xFA;squeda</a>
<ol>
<li><a href="#selecci%C3%B3n-de-un-subconjunto-de-columnas">Selecci&#xF3;n de un subconjunto de columnas</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#crear-la-base-de-datos-room-y-consumirla">Crear la Base de Datos Room y consumirla</a></li>
<li><a href="#instanciar-la-roomdatabase-para-su-posterior-funcionamiento">Instanciar la RoomDatabase para su posterior funcionamiento</a>
<ol>
<li><a href="#preparando-la-base-de-datos-y-los-daos-con-hilt">Preparando la Base de Datos y los DAOs con Hilt</a></li>
<li><a href="#inyectando-los-doss-en-los-repositorios">Inyectando los DOSs en los repositorios</a></li>
<li><a href="#cargando-datos-de-prueba-en-la-bd">Cargando datos de prueba en la BD</a></li>
</ol>
</li>
<li><a href="#ubicaci%C3%B3n-de-la-base-de-datos-en-el-dispositivo">Ubicaci&#xF3;n de la Base de Datos en el dispositivo</a></li>
<li><a href="#inspeccionando-y-depurando-la-bd-con-database-inspector">Inspeccionando y depurando la BD con Database Inspector</a></li>
</ol>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h2>

<ul>
<li>
<p><strong>Persistencia local con Room</strong></p>
<ul>
<li>Documentaci&#xF3;n oficial: <strong><a href="https://developer.android.com/training/data-storage/room">Save data in a local database using Room</a></strong></li>
<li>Documentaci&#xF3;n oficial versiones librer&#xED;a: <strong><a href="https://developer.android.com/jetpack/androidx/releases/room">Room</a></strong></li>
<li>Video Tutorial (Ingl&#xE9;s): <strong><a href="https://www.youtube.com/watch?v=bOd3wO0uFr8">Philipp Lackner</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=TKZRiq4GDuc">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=lYBb4QedYH8">AristiDevs</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=Yu-Ty8T28ag">Gibr&#xE1;n Garc&#xED;a</a></strong></li>
</ul>
</li>
</ul>
<p>La plataforma Android proporciona <strong>dos herramientas</strong> principales para el almacenamiento y consulta de datos estructurados: la base de datos <strong>SQLite</strong> y <strong>Content Providers</strong>.</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Existen otras opciones de terceros como <strong><a href="https://www.mongodb.com/docs/realm/sdk/kotlin/">Realm</a></strong> (<strong>MongoDB</strong>) pero no est&#xE1;n tan integradas con Android y Android Studio como Room.<br>
Incluso si nos decidimos por usar <strong><a href="https://firebase.google.com/docs/firestore/quickstart?hl=es-419#android">Firestore</a></strong>, existe la posibilidad de <strong><a href="https://cloud.google.com/firestore/docs/manage-data/enable-offline?hl=es-419#kotlin+ktxandroid">usarlo de forma offline</a></strong></p>
</blockquote>
<p>Nosotros vamos a centrarnos en <strong><a href="https://developer.android.com/training/data-storage/sqlite?hl=es">SQLite</a></strong>, aunque no entraremos ni en el dise&#xF1;o de BBDD relacionales ni en el uso avanzado de la BBDD. Para conocer toda la funcionalidad de SQLite se recomienda usar la documentaci&#xF3;n oficial. <strong>El problema de trabajar directamente con esta API es que es un trabajo a bajo nivel que puede llevar a errores en tiempo de ejecuci&#xF3;n</strong>.</p>
<p>Por este motivo Android Jetpack ha proporcionado ORM a modo de capa de abstracci&#xF3;n que facilita enormemente el proceso de codificaci&#xF3;n La biblioteca que nos va a permitir esta abstracci&#xF3;n y se distribuye como <strong><a href="https://developer.android.com/training/data-storage/room">Room</a></strong>.</p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="dependencias">Dependencias</h2>

<p>Para poder usar la funcionalidad de Room y las anotaciones, deberemos a&#xF1;adir una serie de dependencias y plugins.</p>
<p>Al igual que suced&#xED;a con <strong>Hilt</strong>, en <strong>Room</strong> vamos a necesitar alg&#xFA;n tipo de procesador de anotaciones. Las primeras versiones usaban<br>
<strong>KAPT</strong>, pero como con Hilt, <strong>Room</strong> ya est&#xE1; migrado a <strong>KSP</strong>. Por tanto, si ya estamos usando <strong>Hilt</strong> no necesitaremos a&#xF1;adir el plugin de <strong>KSP</strong>. No obstante vamos a recordar los pasos...</p>
<p>En el <strong><code>build.gradle.kts</code></strong> ra&#xED;z del proyecto a&#xF1;adiremos el siguiente plugin:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">plugins <span class="token punctuation">{</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;com.google.devtools.ksp&quot;</span><span class="token punctuation">)</span> version <span class="token string">&quot;1.9.0-1.0.12&quot;</span> apply <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</pre><p>En el <strong><code>build.gradle.kts</code></strong> del <strong>m&#xF3;dulo de la aplicaci&#xF3;n</strong> (app) a&#xF1;adiremos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">plugins <span class="token punctuation">{</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;com.google.devtools.ksp&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
android <span class="token punctuation">{</span>
    compileOptions <span class="token punctuation">{</span>
        sourceCompatibility <span class="token operator">=</span> JavaVersion<span class="token punctuation">.</span>VERSION_17
        targetCompatibility <span class="token operator">=</span> JavaVersion<span class="token punctuation">.</span>VERSION_17
    <span class="token punctuation">}</span>
    kotlinOptions <span class="token punctuation">{</span>
        jvmTarget <span class="token operator">=</span> <span class="token string">&quot;17&quot;</span>
    <span class="token punctuation">}</span>
    composeOptions <span class="token punctuation">{</span>
        kotlinCompilerExtensionVersion <span class="token operator">=</span> <span class="token string">&quot;1.5.0&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
dependencies <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> roomVersion <span class="token operator">=</span> <span class="token string">&quot;2.6.1&quot;</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-runtime:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-compiler:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">ksp</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-compiler:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-ktx:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-paging:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: La versi&#xF3;n de la librer&#xED;a puede cambiar, pero puedes ver los &#xFA;ltimos releases de la misma en el siguiente enlace: <strong><a href="https://developer.android.com/jetpack/androidx/releases/room">Room</a></strong></p>
</blockquote>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="componentes-de-room">Componentes de Room</h2>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 70%">
<p>Para trabajar con Room debemos familiarizarnos con su arquitectura que est&#xE1; compuesta por tres partes principales:</p>
<ul>
<li><strong>Entity</strong> (Entities), ser&#xE1;n las clases que definir&#xE1;n las entidades de nuestra Base de datos, que corresponden con cada tabla que la forman.</li>
<li><strong>DAOs</strong> (Data Access Objects), en este caso ser&#xE1;n las clases abstractas o interfaces donde estar&#xE1;n definidos los m&#xE9;todos que nos permitir&#xE1;n la operatividad (inserci&#xF3;n, consulta, etc) con cada una de las tablas de la Base de Datos.</li>
<li><strong>RoomDatabase</strong> (Room Database), contiene la Base de Datos y el acceso a esta, a la vez que une los dos anteriores conceptos.</li>
</ul>
</div>
<div style="width: auto">
    <img height="300px" src="assets/imagenes/tema_5_1/imagen1_room.png">
</div>
</div>
<p>Una vez que se creen estos tres elementos, la app podr&#xE1; acceder a los DAOs a trav&#xE9;s de las instancias de Room Database que creemos, de forma m&#xE1;s estable que con el acceso directo a la API de SQLite.</p>
<p>El uso de Room se hace a trav&#xE9;s de <strong>Anotaciones</strong> a&#xF1;adidas a las clases e interfaces, las principales son:</p>
<ul>
<li><strong><code>@Entity</code></strong>, indica que la clase a la que se atribuye debe ser tratada como una entidad.</li>
<li><strong><code>@Dao</code></strong>, debe de a&#xF1;adirse a las interfaces que queremos que sean nuestras Daos. Dentro de estas interfaces se utilizan otras anotaciones que veremos m&#xE1;s adelante.</li>
<li><strong><code>@Database</code></strong>, se a&#xF1;adir&#xE1; a las Room Database he indicar&#xE1; que es una Database, estas clases deben ser abstractas y heredar de RoomDatabase.</li>
</ul>
<h2 class="mume-header" id="a%C3%B1adiendo-paquete-room-al-proyecto">A&#xF1;adiendo paquete room al proyecto</h2>

<p>Recuerda que en la distribuci&#xF3;n de paquetes que se propuso a principio de curso. Dentro del paquete <strong><code>.data</code></strong> vamos a crear un paquete por cada una de las fuentes de datos que tengamos. En este caso, como vamos a usar Room, crearemos un paquete denominado <strong><code>.data.room</code></strong> y dentro del &#xE9;l vamos a crear los componentes que hemos mencionado y que concretaremos a continuaci&#xF3;n.</p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="crear-las-entidades-que-definen-nuestro-modelo">Crear las entidades que definen nuestro modelo</h2>

<p>Para definir la persistencia con Room, utilizaremos lo que denominaremos <em>&apos;Code First&apos;</em>, <em>&apos;Model First&apos;</em> o <em>&apos;Entity First&apos;</em>, es decir, primero definiremos las entidades que queremos persistir y sus relaciones. Posteriormente, a partir de estas definiciones, se crear&#xE1; la base de datos.</p>
<p>Para ello pues, el primer paso a realizar ser&#xE1; el de crear las distintas tablas que tendr&#xE1; nuestra base de datos. Cada tabla corresponder&#xE1; con una clase <strong><a href="https://developer.android.com/training/data-storage/room/defining-data">Entity</a></strong> etiquetada como <strong><code>@Entity</code></strong> en la que a&#xF1;adiremos los campos correspondiente a la tabla. Vamos a usar un ejemplo sencillo para entender el funcionamiento:</p>
<ol>
<li>
<p>Por ejemplo, si queremos crear una tabla de <strong><code>clientes</code></strong> con los campos <strong><code>dni</code></strong>, <strong><code>nombre</code></strong> y <strong><code>apellidos</code></strong>. Crearemos una <strong><code>data class</code></strong> denominada <strong><code>ClienteEntity</code></strong> dentro del paquete <strong><code>.data.room.ClienteEntity.kt</code></strong>.</p>
<p>A esta, le a&#xF1;adiremos a la anotaci&#xF3;n <strong><code>@Entity</code></strong> la propiedad <strong><code>tableName</code></strong> con el nombre de la tabla: <strong><code>@Entity(tableName = &quot;idTabla&quot;)</code></strong>. Si no lo hici&#xE9;ramos, la tabla tomar&#xED;a el nombre de nuestra entidad.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=1}" class="language-kotlin" data-line="1"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
<div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="1" data-start="1">
</div></div></pre></li>
<li>
<p>Deberemos decidir cual ser&#xE1; nuestra <strong>clave primaria</strong> para a&#xF1;adir la anotaci&#xF3;n <strong><code>@PrimaryKey</code></strong> a la propiedad que decidamos.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=3}" class="language-kotlin" data-line="3"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span> <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
<div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3" data-start="3">
</div></div></pre><p>Si necesit&#xE1;ramos una clave primaria compuesta por m&#xE1;s de un campo, tendr&#xED;amos que indicarlo con la propiedad <strong><a href="https://developer.android.com/training/data-storage/room/defining-data#composite-key">primaryKeys</a></strong> de la anotaci&#xF3;n <strong><code>@Entity</code></strong>. De igual manera lo har&#xED;amos en el caso de necesitar una <strong>clave ajena</strong>, pero en este caso con la propiedad <strong><a href="https://developer.android.com/reference/kotlin/androidx/room/ForeignKey">foreignKeys</a></strong>.</p>
<p>Por ejemplo, si tuvi&#xE9;ramos otra tabla <strong><code>pedidos</code></strong> en la que relacion&#xE1;ramos el <strong><code>dni</code></strong> de la tabla <strong><code>clientes</code></strong> con el <strong><code>dni</code></strong> ajeno de los registros de esta tabla, <strong><code>parentColumns</code></strong> se referir&#xED;a al <strong><code>dni</code></strong> de <strong><code>clientes</code></strong> mientras que <strong><code>dni_cliente</code></strong> en <strong><code>childColumns</code></strong> ser&#xED;a al de <strong><code>pedidos</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[7,8]}" class="language-kotlin" data-line="7,8"><span class="token comment">// Expresar&#xED;amos que un pedidos define una clave ajena dni en clientes.</span>
<span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;pedidos&quot;</span><span class="token punctuation">,</span>
        foreignKeys <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
            <span class="token function">ForeignKey</span><span class="token punctuation">(</span>
                entity <span class="token operator">=</span> ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span>
                parentColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// Nombre de la columna en la tabla pedidos</span>
                childColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                onDelete <span class="token operator">=</span> CASCADE<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">PedidoEntity</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7" data-start="7">
</div></div><div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div></pre><p>No obstante, m&#xE1;s adelante veremos como definir relaciones entre objetos en lugar de tablas. Adem&#xE1;s, ten en cuenta que la definici&#xF3;n correcta de &#xED;ndices nos va a proporcionar mucha velocidad.</p>
</li>
<li>
<p>Es muy <strong>buena pr&#xE1;ctica</strong> usar la etiqueta <strong><code>@ColumnInfo</code></strong> <strong>para que futuras modificaciones en la BD no afecten a mis entidades</strong>. Esta propiedad sirve para personalizar la columna de la base de datos del atributo asociado. Podemos indicar, entre otras cosas, un nombre para la columna diferente al del atributo. Esto nos permite hacer m&#xE1;s independiente la app de la BD. Adem&#xE1;s nos permite pasar del <em><strong>camelCasing</strong></em> que el como tendremos los nombres de propiedades compuestos en Kotlin a <em><strong>snake_casing</strong></em> que es el convenio est&#xE1;ndar en las bases de datos. Por ejemplo, la clave ajena anterior de pedidos ser&#xED;a ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dniCliente<span class="token operator">:</span> String<span class="token punctuation">,</span>
</pre><p>En nuestro ejemplo, al final la <strong><code>Entity</code></strong> quedar&#xED;a de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
</pre></li>
<li>
<p>Es posible que, a veces, quieras expresar una entidad o un objeto de datos como un solo elemento integral en la l&#xF3;gica de la base de datos, incluso si el objeto contiene varios campos. En esas situaciones, puedes usar la anotaci&#xF3;n <strong><code>@Embedded</code></strong> para representar <strong>un objeto cuyos subcampos quieras desglosar en una tabla</strong>. Luego, puedes buscar los campos integrados tal como lo har&#xED;as con otras columnas individuales. A este tipo de objetos, los denominaremos &apos;<em><strong>objetos incorporados</strong></em>&apos;</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Podemos hacer una analog&#xED;a entre los &apos;<em><strong>objetos incorporados</strong></em>&apos; con los que definimos en las BDOR (Bases de Datos Bbjeto-Relacionales de Oracle o PostgreSQL)</p>
</blockquote>
<p>Por ejemplo, la clase <strong><code>ClienteEntity</code></strong> puede incluir un campo de tipo <strong><code>Direccion</code></strong>, que representa una composici&#xF3;n de propiedades llamadas <strong><code>calle</code></strong>, <strong><code>ciudad</code></strong>, <strong><code>pais</code></strong> y <strong><code>codigoPostal</code></strong>. Para almacenar las <strong>columnas compuestas por separado</strong> en la tabla, incluye un campo <strong><code>Direccion</code></strong> en la clase <strong><code>ClienteEntity</code></strong> con anotaciones <strong><code>@Embedded</code></strong>, como se muestra en el siguiente fragmento de c&#xF3;digo:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Direccion</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> calle<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> ciudad<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> pais<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;codigo_postal&quot;</span><span class="token punctuation">)</span> 
    <span class="token keyword keyword-val">val</span> codigoPostal<span class="token operator">:</span> String<span class="token operator">?</span>
<span class="token punctuation">)</span>

<span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token comment">// Marcamos como embebe @Embedded el campo a descomponer en la tabla</span>
    <span class="token annotation builtin">@Embedded</span> <span class="token keyword keyword-val">val</span> direccion<span class="token operator">:</span> Direccion<span class="token operator">?</span>
<span class="token punctuation">)</span> 
</pre><p>Del c&#xF3;digo anterior, la tabla que representa un objeto <strong><code>ClienteEntity</code></strong> contendr&#xE1; columnas con los siguientes nombres:</p>
<table>
<thead>
<tr>
<th>dni</th>
<th>nombre</th>
<th>apellidos</th>
<th>calle</th>
<th>ciudad</th>
<th>pais</th>
<th>codigo_postal</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>A veces, necesitas que la app almacene un tipo de datos personalizado en una sola columna de base de datos. Para admitir tipos personalizados, debes proporcionar convertidores de tipo, que son m&#xE9;todos que indican a Room c&#xF3;mo convertir tipos personalizados en tipos conocidos que Room pueda tratar. Para identificar los conversores de tipo, puedes usar la anotaci&#xF3;n <strong><code>@TypeConverter</code></strong>.</p>
<p>Supongamos que necesitas conservar instancias del tipo <strong><code>LocalDate</code></strong> de Kotlin (Java) para saber la <strong>fecha</strong> en que se hizo un pedido. Pero la base de datos para guardar fechas lo hace mediante un <strong><code>Long</code></strong> que representa el <strong>TIMESTAMP</strong>.</p>
<p>Definiremos primero una clase denominada <strong><code>RoomConverters</code></strong> dentro del paquete <strong><code>.data.room</code></strong> con todos los m&#xE9;todos convertidores. Ojo, no importa el nombre del m&#xE9;todo, <strong>sino su signatura</strong> (par&#xE1;metro de entrada y de salida). Por ejemplo para fecha podr&#xED;a ser:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// Estamos presuponiendo que nuestras fechas nunca son nulas.</span>
<span class="token keyword keyword-class">class</span> RoomConverters <span class="token punctuation">{</span>
    <span class="token annotation builtin">@TypeConverter</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">fromTimestamp</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> LocalDate <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> value<span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> LocalDate<span class="token punctuation">.</span><span class="token function">ofEpochDay</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@TypeConverter</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">dateToTimestamp</span><span class="token punctuation">(</span>date<span class="token operator">:</span> LocalDate<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> date<span class="token punctuation">.</span><span class="token function">toEpochDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x270B; <strong>Importante:</strong> Cuando definamos la BD ya veremos como indicarle que aplique todas las conversiones definidas.</p>
</blockquote>
<p>Ahora ya podemos definir nuestra clase <strong><code>PedidoEntity</code></strong> dentro del paquete <strong><code>.data.room</code></strong> ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[6, 16]}" class="language-kotlin" data-line="6,16"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;pedidos&quot;</span><span class="token punctuation">,</span>
        foreignKeys <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>
            <span class="token function">ForeignKey</span><span class="token punctuation">(</span>
                entity <span class="token operator">=</span> ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span>
                parentColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                childColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                onDelete <span class="token operator">=</span> CASCADE<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">PedidoEntity</span><span class="token punctuation">(</span>
    <span class="token comment">// El id ser&#xE1; autogenerado insertando un 0.        </span>
    <span class="token annotation builtin">@PrimaryKey</span> <span class="token punctuation">(</span>autoGenerate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>         
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dniCliente<span class="token operator">:</span> Int<span class="token punctuation">,</span>

    <span class="token comment">// Indicamos que siempre debe tener una fecha.</span>
    <span class="token comment">// Esta en la DB se guardar&#xE1; como un Long.</span>
    <span class="token annotation builtin">@NonNull</span>                 
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;fecha&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> fecha<span class="token operator">:</span> LocalDate
<span class="token punctuation">)</span>
<div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div><div class="line-highlight-wrapper">














<div aria-hidden="true" class="line-highlight" data-range="16" data-start="16">
</div></div></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="definiendo-relaciones-entre-objetos">Definiendo relaciones entre Objetos</h3>

<p>Usando los &apos;<em><strong>objetos incorporados</strong></em>&apos; podremos hacerlo de forma sencilla.</p>
<h4 class="mume-header" id="relaciones-uno-a-muchos-entre-objetos">Relaciones Uno a Muchos entre objetos</h4>

<p>Supongamos que queremos definir un nuevo objeto a recuparar que no es una entidad en la BD, pero <strong>quiero que contenga un cliente con todos sus pedidos</strong>. De forma an&#xE1;loga a los que tenemos en las entidades de <strong>JPA</strong>.</p>
<p>Deberemos definir la clase que exprese la relaci&#xF3;n y que se completar&#xE1; <em>&apos;mapear&#xE1;&apos;</em> autom&#xE1;ticamente cuando la usemos en nuestro <strong>DAO</strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteConPedidos</span><span class="token punctuation">(</span>
    <span class="token comment">// Sabe recuperar el objeto embebido.</span>
    <span class="token annotation builtin">@Embedded</span> <span class="token keyword keyword-val">val</span> cliente<span class="token operator">:</span> ClienteEntity<span class="token punctuation">,</span>
    <span class="token annotation builtin">@Relation</span><span class="token punctuation">(</span>
          parentColumn <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">,</span>
          <span class="token comment">// Nombre de la columna en la parte del muchos</span>
          entityColumn <span class="token operator">=</span> <span class="token string">&quot;dni_cliente&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> pedidos<span class="token operator">:</span> List<span class="token operator">&lt;</span>PedidoEntity<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</pre><p>M&#xE1;s adelante, veremos su utilidad y que hay formas m&#xE1;s &apos;<em>simples</em>&apos; de hacerlo.</p>
<blockquote>
<p>&#x270B; <strong>Importante:</strong> Puedes saber m&#xE1;s sobre como definir otros tipos de <strong>relaciones entre objetos</strong> con room en el siguiente <strong><a href="https://developer.android.com/training/data-storage/room/relationships">enlace</a></strong></p>
</blockquote>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="crear-los-objetos-de-acceso-a-la-base-de-datos">Crear los Objetos de Acceso a la Base de Datos</h2>

<p>Los <strong><a href="https://developer.android.com/training/data-storage/room/accessing-data">DAO</a></strong> ser&#xE1;n elementos de tipo <strong>Interfaz</strong>, en los cuales incluiremos los m&#xE9;todos necesarios de acceso y gesti&#xF3;n a las entidades de la Base de Datos. En tiempo de compilaci&#xF3;n, Room generar&#xE1; autom&#xE1;ticamente la implementaciones de DAOs que hayamos definido.</p>
<p>Es buena pr&#xE1;ctica, <strong>definir un DAO por cada entidad que tengamos</strong>, y en este definir las funcionalidades asociadas a esta entidad.</p>
<p>Para que una interfaz sea gestionada como DAO, habr&#xE1; que a&#xF1;adir la anotaci&#xF3;n <strong><code>@Dao</code></strong>, siguiendo nuestro ejemplo tendr&#xED;amos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao 
<span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</pre><p>Para poder operar con la funcionalidad de Room, se necesitar&#xE1; hacer las llamadas fuera del hilo principal ya que las instancias de <strong><code>RoomDatabase</code></strong> son costosas en cuanto a tiempo, por lo que ser&#xE1; necesario lanzar estas llamadas mediante corrutinas. <strong>La manera recomendada es la de crear los m&#xE9;todos de la interfaces DAO como m&#xE9;todos de suspensi&#xF3;n</strong>.</p>
<p>Dentro de un DAO podemos crear dos tipos distintos de m&#xE9;todos, de conveniencia y de b&#xFA;squeda.</p>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="m%C3%A9todos-de-conveniencia">M&#xE9;todos de conveniencia</h3>

<p>Estos m&#xE9;todos nos permiten realizar las operaciones b&#xE1;sicas de <strong>inserci&#xF3;n</strong>, <strong>modificaci&#xF3;n</strong> y <strong>eliminaci&#xF3;n</strong> de registros en la BD sin tener que escribir ning&#xFA;n tipo de c&#xF3;digo SQL. A estos m&#xE9;todos se le pasa la entidad sobre la que se quiera trabajar y es la propia librer&#xED;a Room la encargada de crear la sentencia SQL usando la clave primaria para la identificaci&#xF3;n del registro sobre el que se quiere operar. Deber&#xE1;n ir precedidos por las anotaciones <strong>@Insert, @Delete o @Update</strong> dependiendo de la necesidad. Por ejemplo, en nuestro caso, para la entidad <strong><code>ClienteEntity</code></strong> crearemos <strong><code>ClienteDao</code></strong> en su mismo paquete de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao <span class="token punctuation">{</span>
    <span class="token annotation builtin">@Insert</span><span class="token punctuation">(</span>onConflict <span class="token operator">=</span> OnConflictStrategy<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token annotation builtin">@Delete</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token annotation builtin">@Update</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token comment">// Si no pasamos la entidad y lo que tenemos </span>
    <span class="token comment">// es la PK deberemos hacer una consulta con @Query</span>
    <span class="token comment">// pasando la PK como par&#xE1;metro.</span>
    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;DELETE FROM clientes WHERE dni = :dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">deleteByDni</span><span class="token punctuation">(</span>dni<span class="token operator">:</span> String<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Como se puede ver en el anterior c&#xF3;digo, es una manera muy sencilla de realizar las operaciones b&#xE1;sicas usando las anotaciones correspondientes y pasando como par&#xE1;metro al m&#xE9;todo la Entidad sobre la que queremos operar. En el caso de la inserci&#xF3;n podemos ver que se puede utilizar la propiedad <strong><code>onConflict</code></strong> para indicar si queremos reemplazar el elemento existente por el nuevo en caso de que coincida la clave primaria (en este caso el dni).</p>
</blockquote>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="m%C3%A9todos-de-b%C3%BAsqueda">M&#xE9;todos de b&#xFA;squeda</h3>

<p>Estos m&#xE9;todos ser&#xE1;n los que crearemos para realizar consultas sobre la BD y tendr&#xE1;n que ir precedidos por la anotaci&#xF3;n <strong>@Query</strong>. Esta anotaci&#xF3;n permite que se a&#xF1;ada como par&#xE1;metro una cadena con la sentencia SQL para la consulta. Por ejemplo, podemos completar nuestro DAO de la siguiente manera....</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao <span class="token punctuation">{</span>
    <span class="token comment">// ... aqu&#xED; van los m&#xE9;todos de conveniencia CRUD</span>

    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ClienteEntity<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes WHERE dni IN (:dni)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getFromDni</span><span class="token punctuation">(</span>dni <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> ClienteEntity

    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) FROM clientes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int
<span class="token punctuation">}</span>
</pre><p>Los dos primeros m&#xE9;todos de nuestro DAO, son dos m&#xE9;todos de consulta, el primero devuelve una <strong>lista de Clientes</strong> mientras que el segundo devuelve <strong>un solo cliente</strong>. Como ya hemos visto, Room permite pasar un par&#xE1;metro o una lista de par&#xE1;metros dentro de la propia consulta siempre que lo precedamos con <strong><code>:</code></strong> y que coincida en nombre con el par&#xE1;metro que le llega al m&#xE9;todo.</p>
<h4 class="mume-header" id="selecci%C3%B3n-de-un-subconjunto-de-columnas">Selecci&#xF3;n de un subconjunto de columnas</h4>

<p>En muchas ocasiones no ser&#xE1; necesaria toda la informaci&#xF3;n de la tabla, sino que solo necesitaremos recuperar algunas de las columnas a modo de <strong>DTO</strong>. Aunque se puede recuperar toda la informaci&#xF3; y posteriormente realizar un filtrado de esta, para ahorrar recursos es interesante consultar solamente los campos que se necesitan. Para ello, necesitaremos crear un objeto del tipo de columnas que queramos devolver, esto se podr&#xE1; hacer usando una <strong><code>data class</code></strong> nueva para esos datos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">NombreApellidosDTO</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String
<span class="token punctuation">)</span>
</pre><p>Y solamente se tendr&#xE1; que indicar en el Dao que el m&#xE9;todo correspondiente devolver&#xE1; los datos de este tipo:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT nombre, apellidos FROM clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getNombreApellido</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>NombreApellidosDTO<span class="token operator">&gt;</span>
</pre><p>Por ejemplo, si quisi&#xE9;ramos recuperar el mapeo de la clase <strong><code>ClienteConPedidos</code></strong> que definimos en la relaci&#xF3;n uno a muchos entre objetos. Deber&#xED;amos marcar el m&#xE9;todo con anotaci&#xF3;n <strong><code>@Transaction</code></strong>, pues en su interior hay una anotaci&#xF3;n <strong><code>@Relation</code></strong> que se deber&#xE1; completar antes de devolver la instancia del objetos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Transaction</span>
<span class="token comment">// F&#xED;jate que no indicamos la relaci&#xF3;n en la consulta ya est&#xE1; definida</span>
<span class="token comment">// en el objeto a recuperar.</span>
<span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// F&#xED;jate que devuelve una lista de objetos ClienteConPedidos</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getPedidos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ClienteConPedidos<span class="token operator">&gt;</span> 
</pre><p>Sin embargo si la relaci&#xF3;n ya la definimos al definir las entidades podemos hacerlo mediante un <strong><code>JOIN</code></strong> sin necesidad de definir el objeto <strong><code>ClienteConPedidos</code></strong> ni ning&#xFA;n tipo de DTO de la siguiente manera.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes JOIN pedidos ON clientes.dni = pedidos.dni_cliente&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">obtenerClientesConPedidos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>ClienteEntity<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>PedidoEntity<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</pre><p>F&#xED;jate que en este caso, el m&#xE9;todo devuelve un <strong><code>Map</code></strong> en el que la clave es un <strong><code>ClienteEntity</code></strong> y el valor todos los <strong><code>PedidoEntity</code></strong> asociados a este.</p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="crear-la-base-de-datos-room-y-consumirla">Crear la Base de Datos Room y consumirla</h2>

<p>El &#xFA;ltimo elemento que quedar&#xED;a por crear ser&#xED;a la <a href="https://developer.android.com/training/data-storage/room#database">RoomDatabase</a>. Este elemento es el que <strong>se encargar&#xE1; de crear la base de datos a partir de las entidades definidas</strong> y las operaciones que se realizar&#xE1;n sobre estas a partir de los DAOs de nuestra app. Por tanto, es el elemento que enlaza a los dos anteriores. Para ello crearemos una clase abstracta que deber&#xE1; de heredar de <strong><code>RoomDatabase</code></strong> y a la que etiquetaremos con la anotaci&#xF3;n <strong><code>@Database</code></strong> con las propiedades versi&#xF3;n y entities. La primera propiedad especificar&#xE1; la versi&#xF3;n de la BD, mientras que en entities indicaremos la entidad o entidades asociadas a esta.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[2, 7, 14,15]}" class="language-kotlin" data-line="2,7,14,15"><span class="token annotation builtin">@Database</span><span class="token punctuation">(</span>
    entities <span class="token operator">=</span> <span class="token punctuation">[</span>ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> PedidoEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    version <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token comment">// Indicaremos las conversiones de tipos que hemos definido para </span>
<span class="token comment">// nuestra base de datos si las hay. Ej. LocalDate &#x2194; Long o Bitmap &#x2194; byte[]</span>
<span class="token annotation builtin">@TypeConverters</span><span class="token punctuation">(</span>RoomConverters<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span>
<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> TiendaDB<span class="token operator">:</span> <span class="token function">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Cada RoomDatabase definir&#xE1; m&#xE9;todos abstractos que devolver&#xE1; </span>
    <span class="token comment">// los tipos de **`DAO`** definidos y cuando instanciemos </span>
    <span class="token comment">// la base de datos, obtendremos una instancia de </span>
    <span class="token comment">// estos DAOs a trav&#xE9;s de ellos.</span>
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">clienteDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ClienteDao
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">pedidoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> PedidoDao
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div><div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7" data-start="7">
</div></div><div class="line-highlight-wrapper">












<div aria-hidden="true" class="line-highlight" data-range="14" data-start="14">
</div></div><div class="line-highlight-wrapper">













<div aria-hidden="true" class="line-highlight" data-range="15" data-start="15">
</div></div></pre><h2 class="mume-header" id="instanciar-la-roomdatabase-para-su-posterior-funcionamiento">Instanciar la RoomDatabase para su posterior funcionamiento</h2>

<p>Una vez creados todos los componentes necesarios para el funcionamiento de Room Database, deberemos poder crear una instancias de la misma. Para ello, podemos definir un m&#xE9;todo de clase denominado <strong><code>fun getDatabase(context: Context)</code></strong> que usaremos posteriormente para que <strong>Hilt</strong> sepa crear una instancia del mismo e inyectarlo al obtener el DAO como veremos m&#xE1;s adelante.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=14}" class="language-kotlin" data-line="14"><span class="token annotation builtin">@Database</span><span class="token punctuation">(</span>
    entities <span class="token operator">=</span> <span class="token punctuation">[</span>ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> PedidoEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    version <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token annotation builtin">@TypeConverters</span><span class="token punctuation">(</span>RoomConverters<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span>
<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> TiendaDB<span class="token operator">:</span> <span class="token function">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">clienteDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ClienteDao
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">pedidoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> PedidoDao

    <span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">getDatabase</span><span class="token punctuation">(</span>
            context<span class="token operator">:</span> Context
        <span class="token punctuation">)</span> <span class="token operator">=</span> Room<span class="token punctuation">.</span><span class="token function">databaseBuilder</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            TiendaDB<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span> <span class="token string">&quot;tienda&quot;</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">allowMainThreadQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fallbackToDestructiveMigration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">












<div aria-hidden="true" class="line-highlight" data-range="14" data-start="14">
</div></div></pre><p>Si te fijas <strong><code>Room.databaseBuilder</code></strong> precisa del <strong>contexto</strong> de la aplicaci&#xF3;n para poder crear el fichero <strong><code>tienda</code></strong> que contendr&#xE1; la BD.</p>
<h3 class="mume-header" id="preparando-la-base-de-datos-y-los-daos-con-hilt">Preparando la Base de Datos y los DAOs con Hilt</h3>

<p>En el fichero <strong><code>AppModule.kt</code></strong> dentro del paquete <strong><code>.di</code></strong> prepararemos la inyecci&#xF3;n de dependencias de la siguiente manera:</p>
<ol>
<li>
<p>Para inyectar la BD definimos <strong><code>provideTiendaDatabase</code></strong> que llama al m&#xE9;todo est&#xE1;tico <strong><code>TiendaDB.getDatabase(context)</code></strong> para instanciarla. F&#xED;jate que el contexto de la aplicaci&#xF3;n se inyecta usando la anotaci&#xF3;n <strong><code>@ApplicationContext</code></strong> de Hilt.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=4}" class="language-kotlin" data-line="4"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideTiendaDatabase</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@ApplicationContext</span> context<span class="token operator">:</span> Context
<span class="token punctuation">)</span><span class="token operator">:</span> TiendaDB <span class="token operator">=</span> TiendaDB<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre></li>
<li>
<p>Para inyectar los DAOs, definimos <strong><code>provideClienteDao</code></strong> y <strong><code>providePedidoDao</code></strong> que inyectan los DAOs de la BD. F&#xED;jate que se inyecta la BD y se llama a los m&#xE9;todos abstractos que devuelven los DAOs.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4, 10]}" class="language-kotlin" data-line="4,10"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideClienteDao</span><span class="token punctuation">(</span>
    tiendaDB<span class="token operator">:</span> TiendaDB
<span class="token punctuation">)</span><span class="token operator">:</span> ClienteDao <span class="token operator">=</span> tiendaDB<span class="token punctuation">.</span><span class="token function">clienteDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">providePedidoDao</span><span class="token punctuation">(</span>
    tiendaDB<span class="token operator">:</span> TiendaDB
<span class="token punctuation">)</span><span class="token operator">:</span> PedidoDao <span class="token operator">=</span> tiendaDB<span class="token punctuation">.</span><span class="token function">pedidoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">








<div aria-hidden="true" class="line-highlight" data-range="10" data-start="10">
</div></div></pre></li>
</ol>
<h3 class="mume-header" id="inyectando-los-doss-en-los-repositorios">Inyectando los DOSs en los repositorios</h3>

<p>Para inyectar los DAOs en los repositorios, deberemos a&#xF1;adirlos como propiedades privadas en los constructores de estos. Por ejemplo, en el caso del repositorio de <strong><code>ClienteRepository</code></strong> deberemos a&#xF1;adir el DAO de <strong><code>ClienteDao</code></strong> como par&#xE1;metro del constructor.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=3}" class="language-kotlin" data-line="3"><span class="token keyword keyword-class">class</span> ClienteRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> clienteDao<span class="token operator">:</span> ClienteDao
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3" data-start="3">
</div></div></pre><blockquote>
<p>&#x270B; <strong>Importante</strong>: Recuerda que, tal y como hicimos a principio de curso con las clases de prueba. Deberemos definir los m&#xE9;todos de extensi&#xF3;n que transformen un <strong><code>ClienteEntity</code></strong> en un objeto <strong><code>Cliente</code></strong> del modelo para su uso en el ViewModel y viceversa.</p>
</blockquote>
<h3 class="mume-header" id="cargando-datos-de-prueba-en-la-bd">Cargando datos de prueba en la BD</h3>

<p>Este proceso se puede realizar de diferentes maneras, pero una forma de hacerlo de manera centralizada es en el momento de carga de la aplicaci&#xF3;n, por ejemplo invalidando el m&#xE9;todo <strong><code>onCreate</code></strong> de la clase <strong><code>TiendaAplication</code></strong> que recordemos hereda de <strong><code>Application</code></strong>.</p>
<p>F&#xED;jate que a trav&#xE9;s de la anotaci&#xF3;n <strong><code>@Inject</code></strong> <strong>Hilt</strong> ser&#xE1; capaz de crear una instancia de <strong><code>ClienteDao</code></strong> y por ende de <strong><code>TiendaDB</code></strong> en la propiedad <strong><code>daoClientes</code></strong> la primera vez que se use al ejecutar el m&#xE9;todo <strong><code>onCreate</code></strong> para cargar los datos de prueba.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,5]}" class="language-kotlin" data-line="4,5"><span class="token annotation builtin">@HiltAndroidApp</span>
<span class="token keyword keyword-class">class</span> TiendaAplication<span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Inject</span>
    <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> daoClientes<span class="token operator">:</span> ClienteDao

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        runBlocking <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>daoClientes<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                daoClientes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                    <span class="token function">ClienteEntity</span><span class="token punctuation">(</span><span class="token string">&quot;12345678A&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Juan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;P&#xE9;rez&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                daoClientes<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                    <span class="token function">ClienteEntity</span><span class="token punctuation">(</span><span class="token string">&quot;87654321B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mar&#xED;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Garc&#xED;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5" data-start="5">
</div></div></pre><h2 class="mume-header" id="ubicaci%C3%B3n-de-la-base-de-datos-en-el-dispositivo">Ubicaci&#xF3;n de la Base de Datos en el dispositivo</h2>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 70%">
<p>Si abrimos el <strong>Device Explorer</strong> de Android Studio, podremos ver que se ha creado un fichero <strong><code>tienda</code></strong> en la ruta <strong><code>data/data/&lt;nombre_paquete&gt;/databases</code></strong>. Este fichero es la base de datos que hemos creado y que se ha guardado en el dispositivo. Podremos ver su contenido si la copiamos con cualquier herramienta de gesti&#xF3;n de bases de datos SQLite como <strong>DBeaver</strong>.</p>
</div>
<div style="width: auto">
<p align="center"><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentscripttype="application/ecmascript" contentstyletype="text/css" height="138px" preserveAspectRatio="none" style="width:159px;height:138px;background:#FFFFFF;" version="1.1" viewBox="0 0 159 138" width="159px" zoomAndPan="magnify"><defs/><g><rect fill="#EEEEEE" height="18.0938" style="stroke:#000000;stroke-width:1.0;" width="79" x="6" y="6"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="43" x="8" y="20.457">Pixel 3a</text><line style="stroke:#000000;stroke-width:1.0;" x1="74" x2="74" y1="6" y2="24.0938"/><polygon fill="#000000" points="77,12,83,12,80,19.0938" style="stroke:#000000;stroke-width:1.0;"/><path d="M17,31.1875 L17,32.1875 L25,32.1875 L25,31.1875 L17,31.1875 M17,33.1875 L17,39.0975 C17,39.1475 17.04,39.1875 17.09,39.1875 L24.9,39.1875 C24.95,39.1875 24.99,39.1475 24.99,39.0975 L24.99,33.1875 L22.02,33.1875 L22.02,34.2175 L19.99,34.2175 L19.99,33.1875 L16.99,33.1875 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="30" x="26" y="39.5508">[data]</text><path d="M27,46.2813 L27,47.2813 L35,47.2813 L35,46.2813 L27,46.2813 M27,48.2813 L27,54.1913 C27,54.2413 27.04,54.2813 27.09,54.2813 L34.9,54.2813 C34.95,54.2813 34.99,54.2413 34.99,54.1913 L34.99,48.2813 L32.02,48.2813 L32.02,49.3113 L29.99,49.3113 L29.99,48.2813 L26.99,48.2813 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="30" x="36" y="54.6445">[data]</text><path d="M37,61.375 L37,62.375 L45,62.375 L45,61.375 L37,61.375 M37,63.375 L37,69.285 C37,69.335 37.04,69.375 37.09,69.375 L44.9,69.375 C44.95,69.375 44.99,69.335 44.99,69.285 L44.99,63.375 L42.02,63.375 L42.02,64.405 L39.99,64.405 L39.99,63.375 L36.99,63.375 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="106" x="46" y="69.7383">[com.pmdm.tienda]</text><path d="M47,76.4688 L47,77.4688 L55,77.4688 L55,76.4688 L47,76.4688 M47,78.4688 L47,84.3788 C47,84.4288 47.04,84.4688 47.09,84.4688 L54.9,84.4688 C54.95,84.4688 54.99,84.4288 54.99,84.3788 L54.99,78.4688 L52.02,78.4688 L52.02,79.4988 L49.99,79.4988 L49.99,78.4688 L46.99,78.4688 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="65" x="56" y="84.832">[databases]</text><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="35" x="56" y="99.9258">tienda</text><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="64" x="56" y="115.0195">tienda-shm</text><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="59" x="56" y="130.1133">tienda-wal</text><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="9" y="33.6406"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="19" y="48.7344"/><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="10" y1="36.6406" y2="49.7344"/><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="18" y1="49.7344" y2="49.7344"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="29" y="63.8281"/><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="20" y1="51.7344" y2="64.8281"/><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="28" y1="64.8281" y2="64.8281"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="39" y="78.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="30" y1="66.8281" y2="79.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="38" y1="79.9219" y2="79.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="95.0156"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="95.0156" y2="95.0156"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="110.1094"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="110.1094" y2="110.1094"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="125.2031"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="125.2031" y2="125.2031"/><!--MD5=[0dbcc16c8be6b51fa08a50175d2219ee]
@startsalt
{

^Pixel 3a^

{T
+ <&box>[data]
++ <&box>[data]
+++ <&box>[com.pmdm.tienda]
++++ <&box>[databases]
+++++ <color:blue>**tienda**
+++++ <color:blue>**tienda-shm**
+++++ <color:blue>**tienda-wal**
}
}
@endsalt

PlantUML version 1.2021.12(Tue Oct 05 18:01:58 CEST 2021)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: es
Country: ES
--></g></svg></p></div>
</div>
<p>Aunque hay formas de mantener versiones de la BD y <strong><a href="https://developer.android.com/training/data-storage/room/migrating-db-versions">migrar de una a otra</a></strong>. La opci&#xF3;n m&#xE1;s sencilla es ante un cambio en alguna de las entidades ser&#xED;a eliminar la BD y volver a crearla. Para ello, podemos usar la propiedad <strong><code>fallbackToDestructiveMigration()</code></strong> en el m&#xE9;todo <strong><code>databaseBuilder</code></strong> que hemos usado para crear la BD o s&#xED;mplmente borrarla usando el <strong>Device Explorer</strong> y volver a ejecutar la app.</p>
<h2 class="mume-header" id="inspeccionando-y-depurando-la-bd-con-database-inspector">Inspeccionando y depurando la BD con Database Inspector</h2>

<p>Existe la posibilidad de probar las consultas e inspeccionar la base de datos en tiempo de ejecuci&#xF3;n. Para ello, la herramienta de Android Studio <strong><a href="https://developer.android.com/studio/inspect/database">Database Inspector</a></strong>.</p>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>