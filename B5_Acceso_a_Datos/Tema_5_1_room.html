<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 5.1 - Room</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p,html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  300px/2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="tema-51---room">Tema 5.1 - Room</h1>

<p>Descargar estos apuntes <a href="./Tema_5_1_room.pdf">pdf</a> o <a href="./Tema_5_1_room.html">html</a></p>
<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>


<div class="md-toc">
<div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:18px">
          <a href="#introducci&#xF3;n" class="md-toc-link">
            <p>Introducci&#xF3;n</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:18px">
          <a href="#dependencias" class="md-toc-link">
            <p>Dependencias</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:18px">
          <a href="#componentes-de-room" class="md-toc-link">
            <p>Componentes de Room</p>

          </a></div><details style="padding:0;;padding-left:0px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#crear-las-entidades-que-definen-nuestro-modelo" class="md-toc-link"><p>Crear las entidades que definen nuestro modelo</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#crear-los-objetos-de-acceso-a-la-base-de-datos" class="md-toc-link"><p>Crear los Objetos de Acceso a la Base de Datos</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#m&#xE9;todos-de-conveniencia" class="md-toc-link">
            <p>M&#xE9;todos de conveniencia</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#m&#xE9;todos-de-b&#xFA;squeda" class="md-toc-link">
            <p>M&#xE9;todos de b&#xFA;squeda</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#crear-la-base-de-datos-room-y-consumirla" class="md-toc-link">
            <p>Crear la Base de Datos Room y consumirla</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#instanciar-la-roomdatabase-para-su-posterior-funcionamiento" class="md-toc-link">
            <p>Instanciar la RoomDatabase para su posterior funcionamiento</p>

          </a></div>
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h2>

<ul>
<li>
<p><strong>Persistencia local con Room</strong></p>
<ul>
<li>Documentaci&#xF3;n oficial: <strong><a href="https://developer.android.com/training/data-storage/room">Save data in a local database using Room</a></strong></li>
<li>Documentaci&#xF3;n oficial versiones librer&#xED;a: <strong><a href="https://developer.android.com/jetpack/androidx/releases/room">Room</a></strong></li>
<li>Video Tutorial (Ingl&#xE9;s): <strong><a href="https://www.youtube.com/watch?v=bOd3wO0uFr8">Philipp Lackner</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=TKZRiq4GDuc">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=lYBb4QedYH8">AristiDevs</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=Yu-Ty8T28ag">Gibr&#xE1;n Garc&#xED;a</a></strong></li>
</ul>
</li>
</ul>
<p>La plataforma Android proporciona <strong>dos herramientas</strong> principales para el almacenamiento y consulta de datos estructurados: la base de datos <strong>SQLite</strong> y <strong>Content Providers</strong>.</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Existen otras opciones de terceros como <strong><a href="https://www.mongodb.com/docs/realm/sdk/kotlin/">Realm</a></strong> (<strong>MongoDB</strong>) pero no est&#xE1;n tan integradas con Android y Android Studio como Room.<br>
Incluso si nos decidimos por usar <strong><a href="https://firebase.google.com/docs/firestore/quickstart?hl=es-419#android">Firestore</a></strong>, existe la posibilidad de <strong><a href="https://cloud.google.com/firestore/docs/manage-data/enable-offline?hl=es-419#kotlin+ktxandroid">usarlo de forma offline</a></strong></p>
</blockquote>
<p>Nosotros vamos a centrarnos en <strong><a href="https://developer.android.com/training/data-storage/sqlite?hl=es">SQLite</a></strong>, aunque no entraremos ni en el dise&#xF1;o de BBDD relacionales ni en el uso avanzado de la BBDD. Para conocer toda la funcionalidad de SQLite se recomienda usar la documentaci&#xF3;n oficial. <strong>El problema de trabajar directamente con esta API es que es un trabajo a bajo nivel que puede llevar a errores en tiempo de ejecuci&#xF3;n</strong>.</p>
<p>Por este motivo Android Jetpack ha proporcionado ORM a modo de capa de abstracci&#xF3;n que facilita enormemente el proceso de codificaci&#xF3;n La biblioteca que nos va a permitir esta abstracci&#xF3;n y se distribuye como <strong><a href="https://developer.android.com/training/data-storage/room">Room</a></strong>.</p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="dependencias">Dependencias</h2>

<p>Para poder usar la funcionalidad de Room y las anotaciones, deberemos a&#xF1;adir una serie de dependencias y plugins.</p>
<p>Al igual que suced&#xED;a con <strong>Hilt</strong>, en <strong>Room</strong> vamos a necesitar alg&#xFA;n tipo de procesador de anotaciones. Las primeras versiones usaban<br>
<strong>KAPT</strong>, pero como con Hilt, <strong>Room</strong> ya est&#xE1; migrado a <strong>KSP</strong>. Por tanto, si ya estamos usando <strong>Hilt</strong> no necesitaremos a&#xF1;adir el plugin de <strong>KSP</strong>. No obstante vamos a recordar los pasos...</p>
<p>En el <strong><code>build.gradle.kts</code></strong> ra&#xED;z del proyecto a&#xF1;adiremos el siguiente plugin:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">plugins <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Plugin para que Gradle use Ksp</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;com.google.devtools.ksp&quot;</span><span class="token punctuation">)</span> version <span class="token string">&quot;1.9.0-1.0.12&quot;</span> apply <span class="token boolean">false</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<p>En el <strong><code>build.gradle.kts</code></strong> del <strong>m&#xF3;dulo de la aplicaci&#xF3;n</strong> (app) a&#xF1;adiremos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin">plugins <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Plugin para que Gradle use Ksp</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;com.google.devtools.ksp&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

android <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Debemos usar el SDK de la versi&#xF3;n 17 o superior</span>
    compileOptions <span class="token punctuation">{</span>
        sourceCompatibility <span class="token operator">=</span> JavaVersion<span class="token punctuation">.</span>VERSION_17
        targetCompatibility <span class="token operator">=</span> JavaVersion<span class="token punctuation">.</span>VERSION_17
    <span class="token punctuation">}</span>
    kotlinOptions <span class="token punctuation">{</span>
        jvmTarget <span class="token operator">=</span> <span class="token string">&quot;17&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// M&#xED;nimo el compilador de compose 1.5.0</span>
    composeOptions <span class="token punctuation">{</span>
        kotlinCompilerExtensionVersion <span class="token operator">=</span> <span class="token string">&quot;1.5.0&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// Room</span>
    <span class="token keyword keyword-val">val</span> roomVersion <span class="token operator">=</span> <span class="token string">&quot;2.6.1&quot;</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-runtime:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-compiler:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">ksp</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-compiler:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-ktx:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// optional - Paging 3 Integration</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;androidx.room:room-paging:<span class="token interpolation variable">$roomVersion</span>&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: La versi&#xF3;n de la librer&#xED;a puede cambiar, pero puedes ver los &#xFA;ltimos releases de la misma en el siguiente enlace: <strong><a href="https://developer.android.com/jetpack/androidx/releases/room">Room</a></strong></p>
</blockquote>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="componentes-de-room">Componentes de Room</h2>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 70%">
<p>Para trabajar con Room debemos familiarizarnos con su arquitectura que est&#xE1; compuesta por tres partes principales:</p>
<ul>
<li><strong>Entity</strong> (Entities), ser&#xE1;n las clases que definir&#xE1;n las entidades de nuestra Base de datos, que corresponden con cada tabla que la forman.</li>
<li><strong>DAOs</strong> (Data Access Objects), en este caso ser&#xE1;n las clases abstractas o interfaces donde estar&#xE1;n definidos los m&#xE9;todos que nos permitir&#xE1;n la operatividad (inserci&#xF3;n, consulta, etc) con cada una de las tablas de la Base de Datos.</li>
<li><strong>RoomDatabase</strong> (Room Database), contiene la Base de Datos y el acceso a esta, a la vez que une los dos anteriores conceptos.</li>
</ul>
</div>
<div style="width: auto">
    <img height="300px" src="assets/imagenes/tema_5_1/imagen1_room.png">
</div>
</div>
<p>Una vez que se creen estos tres elementos, la app podr&#xE1; acceder a los DAOs a trav&#xE9;s de las instancias de Room Database que creemos, de forma m&#xE1;s estable que con el acceso directo a la API de SQLite.</p>
<p>El uso de Room se hace a trav&#xE9;s de <strong>Anotaciones</strong> a&#xF1;adidas a las clases e interfaces, las principales son:</p>
<ul>
<li><strong><code>@Entity</code></strong>, indica que la clase a la que se atribuye debe ser tratada como una entidad.</li>
<li><strong><code>@Dao</code></strong>, debe de a&#xF1;adirse a las interfaces que queremos que sean nuestras Daos. Dentro de estas interfaces se utilizan otras anotaciones que veremos m&#xE1;s adelante.</li>
<li><strong><code>@Database</code></strong>, se a&#xF1;adir&#xE1; a las Room Database he indicar&#xE1; que es una Database, estas clases deben ser abstractas y heredar de RoomDatabase.</li>
</ul>
<div style="page-break-after:always;"></div>
<p><strong><mark>HABLAR AQUII DE LOS PAQUETES</mark></strong></p>
<h2 class="mume-header" id="crear-las-entidades-que-definen-nuestro-modelo">Crear las entidades que definen nuestro modelo</h2>

<p>El primer paso a realizar ser&#xE1; el de crear las distintas tablas que tendr&#xE1; nuestra base de datos. Cada tabla corresponder&#xE1; con una clase <strong><a href="https://developer.android.com/training/data-storage/room/defining-data">Entity</a></strong> etiquetada como <strong><code>@Entity</code></strong> en la que a&#xF1;adiremos los campos correspondiente a la tabla. Vamos a usar un ejemplo sencillo para entender el funcionamiento:</p>
<ol>
<li>
<p>Crearemos una clase en Kotlin que etiquetaremos como <strong>data class</strong>.</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Recuerda que los objetos de este tipo de clases son inmutables y por tanto sus propiedades son de solo lectura o <strong><code>val</code></strong>. Adem&#xE1;s, generan autom&#xE1;ticamente los m&#xE9;todos <strong><code>copy</code></strong>, <strong><code>equals</code></strong> y <strong><code>toString</code></strong>.</p>
</blockquote>
<p>A&#xF1;adiremos a la anotaci&#xF3;n <strong><code>@Entity</code></strong> la propiedad <strong><code>tableName</code></strong> con el nombre de la tabla: <strong><code>@Entity(tableName = &quot;idTabla&quot;)</code></strong>. Si no lo hicieramos, la tabla tomar&#xED;a el nombre de nuestra entidad.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
</pre></li>
<li>
<p>Deberemos decidir cual ser&#xE1; nuestra <strong>clave primaria</strong> para a&#xF1;adir la anotaci&#xF3;n <strong><code>@PrimaryKey</code></strong> a la propiedad que decidamos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span> <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token comment">// Clava primaria</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
</pre><p>Si necesitaramos una clave primaria compuesta por m&#xE1;s de un campo, tendr&#xED;amos que indicarlo con la propiedad <strong><a href="https://developer.android.com/training/data-storage/room/defining-data#composite-key">primaryKeys</a></strong> de la etiqueta <strong><code>@Entity</code></strong>.</p>
<p>De igual manera lo hariamos en el caso de necesitar una <strong>clave ajena</strong>, pero en este caso con la propiedad <a href="https://developer.android.com/reference/kotlin/androidx/room/ForeignKey">foreignKeys</a>. Por ejemplo, si tuvieramos otra tabla <strong><code>pedidos</code></strong> en la que relacionaramos el <strong><code>dni</code></strong> de la tabla <strong><code>clientes</code></strong> con el <strong><code>dni</code></strong> ajeno de los registros de esta tabla, <strong><code>parentColumns</code></strong> se referir&#xED;a al <strong><code>dni</code></strong> de <strong><code>clientes</code></strong> mientras que <strong><code>dni_cliente</code></strong> en <strong><code>childColumns</code></strong> ser&#xED;a al de <strong><code>pedidos</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// Expresariamos que un pedidos define una clave ajena dni en clientes.</span>
<span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;pedidos&quot;</span><span class="token punctuation">,</span>
        foreignKeys <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token function">ForeignKey</span><span class="token punctuation">(</span>entity <span class="token operator">=</span> ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span>
                parentColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// Nombre de la columna en la tabla</span>
                childColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                onDelete <span class="token operator">=</span> CASCADE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">PedidoEntity</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</pre><p>No obstante m&#xE1;s adelante veremos como definir relaciones entre objetos en lugar de tablas. No obstante recuerda que la definici&#xF3;n correcta de &#xED;ndices nos va a proporcionar mucha velocidad.</p>
</li>
<li>
<p>Es muy <strong>buena pr&#xE1;ctica</strong> usar la etiqueta <strong><code>@ColumnInfo</code></strong> para que futuras modificaciones en la BD no afecten a mis entidades. Esta propiedad sirve para personalizar la columna de la base de datos del atributo asociado. Podemos indicar, entre otras cosas, un nombre para la columna diferente al del atributo. Esto nos permite hacer m&#xE1;s independiente la app de la BD. En nuestro ejemplo, al final la <strong><code>Entity</code></strong> quedar&#xED;a de la siguiente manera:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">)</span>
</pre></li>
<li>
<p>Es posible que, a veces, quieras expresar una entidad o un objeto de datos como un solo elemento integral en la l&#xF3;gica de la base de datos, incluso si el objeto contiene varios campos. En esas situaciones, puedes usar la anotaci&#xF3;n <strong><code>@Embedded</code></strong> para representar <strong>un objeto cuyos subcampos quieras desglosar en una tabla</strong>. Luego, puedes buscar los campos integrados tal como lo har&#xED;as con otras columnas individuales. A este tipo de objetos, los denominaremos &apos;<em><strong>objetos incorporados</strong></em>&apos;</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Podemos hacer una analog&#xED;a entre los &apos;<em><strong>objetos incorporados</strong></em>&apos; con los que definimos en las BDOR (Bases de datos objetos relacionales)</p>
</blockquote>
<p>Por ejemplo, la clase <strong><code>ClienteEntity</code></strong> puede incluir un campo de tipo <strong><code>Direccion</code></strong>, que representa una composici&#xF3;n de propiedades llamadas <strong><code>calle</code></strong>, <strong><code>ciudad</code></strong>, <strong><code>pais</code></strong> y <strong><code>codigoPostal</code></strong>. Para almacenar las <strong>columnas compuestas por separado</strong> en la tabla, incluye un campo <strong><code>Direccion</code></strong> en la clase <strong><code>ClienteEntity</code></strong> con anotaciones <strong><code>@Embedded</code></strong>, como se muestra en el siguiente fragmento de c&#xF3;digo:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Direccion</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> calle<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> ciudad<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> pais<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;codigo_postal&quot;</span><span class="token punctuation">)</span> 
    <span class="token keyword keyword-val">val</span> codigoPostal<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span>

<span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dni<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token comment">// Marcamos como embebe @Embedded el campo a descomponer</span>
    <span class="token annotation builtin">@Embedded</span> <span class="token keyword keyword-val">val</span> direccion<span class="token operator">:</span> Direccion<span class="token operator">?</span><span class="token punctuation">)</span> 
</pre><p>La tabla que representa un objeto <strong><code>ClienteEntity</code></strong> contiene columnas con los siguientes nombres: <strong><code>dni</code></strong>, <strong><code>nombre</code></strong>, <strong><code>apellidos</code></strong>, <strong><code>calle</code></strong>, <strong><code>ciudad</code></strong>, <strong><code>pais</code></strong> y <strong><code>codigo_postal</code></strong>.</p>
</li>
<li>
<p>A veces, necesitas que la app almacene un tipo de datos personalizados en una sola columna de base de datos. Para admitir tipos personalizados, debes proporcionar convertidores de tipo, que son m&#xE9;todos que indican a Room c&#xF3;mo convertir tipos personalizados en tipos conocidos y a partir de ellos que Room puede conservar. Para identificar los conversores de tipo, puedes usar la anotaci&#xF3;n <strong><code>@TypeConverter</code></strong>.</p>
<p>Supongamos que necesitas conservar instancias del tipo <strong><code>Date</code></strong> de Kotlin para saber la <strong>fecha</strong> en que se hizo un pedido. Pero la base de datos para guardar fechas lo hace mediante un <strong><code>Long</code></strong> que representa el TIMESTAMP.</p>
<p>Definiremos primero una clase con todos los m&#xE9;todos convertidores. Ojo, no importa el id del m&#xE9;todo si no su signatura (par&#xE1;metro de entrada y de salida) Por ejemplo para fecha podr&#xED;a ser:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// Estamos presuponiendo que nuestras fechas nunca son nulas.</span>
<span class="token keyword keyword-class">class</span> Converters <span class="token punctuation">{</span>
    <span class="token annotation builtin">@TypeConverter</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">fromTimestamp</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Date <span class="token punctuation">{</span>  <span class="token comment">// Convierte de Long a Date</span>
        <span class="token keyword keyword-return">return</span> value<span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">Date</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@TypeConverter</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">dateToTimestamp</span><span class="token punctuation">(</span>date<span class="token operator">:</span> Date<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>  <span class="token comment">// Convierte de Date a Long</span>
        <span class="token keyword keyword-return">return</span> date<span class="token punctuation">.</span>time
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Ahora ya podemos definir nuestra clase <strong><code>PedidoEntity</code></strong> ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Entity</span><span class="token punctuation">(</span>tableName <span class="token operator">=</span> <span class="token string">&quot;pedidos&quot;</span><span class="token punctuation">,</span>
        foreignKeys <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token function">ForeignKey</span><span class="token punctuation">(</span>entity <span class="token operator">=</span> ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span>
                parentColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// Nombre de la columna en la tabla</span>
                childColumns <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                onDelete <span class="token operator">=</span> CASCADE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">PedidoEntity</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@PrimaryKey</span> <span class="token punctuation">(</span>autoGenerate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// El id ser&#xE1; autogenerado.</span>
    
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;dni_cliente&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> dniCliente<span class="token operator">:</span> Int<span class="token punctuation">,</span>

    <span class="token comment">// Indicamos que siempre debe tener una fecha.</span>
    <span class="token annotation builtin">@NonNull</span>                 
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;fecha&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> fecha<span class="token operator">:</span> Date<span class="token punctuation">)</span>

</pre><blockquote>
<p>&#x270B; <strong>Importante:</strong> Cuando definamos la BD ya veremos como indicarle que aplique todas las conversiones definidas.</p>
</blockquote>
</li>
</ol>
<div style="page-break-after:always;"></div>
<h4 class="mume-header" id="definiendo-relaciones-entre-objetos">Definiendo relaciones entre Objetos</h4>

<p>Usando los &apos;<em><strong>objetos incorporados</strong></em>&apos; podremos hacerlo de forma sencilla.</p>
<h5 class="mume-header" id="relaciones-uno-a-muchos-entre-objetos">Relaciones Uno a Muchos entre objetos</h5>

<p>Supongamos que queremos definir un nuevo objeto a recuparar que no es una entidad en la BD, pero quiero que contenga un cliente con todos sus pedidos. De forma an&#xE1;loga a los que tenemos en las entidades de JPA.</p>
<p>Deberemos definir la clase que exprese la relaci&#xF3;n y que se completar&#xE1; <em>&apos;mapear&#xE1;&apos;</em> autom&#xE1;ticamente cuando la usemos en nuestro <strong>DAO</strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ClienteConPedidos</span><span class="token punctuation">(</span>
    <span class="token comment">// Sabe recuperar el objeto embebido.</span>
    <span class="token annotation builtin">@Embedded</span> <span class="token keyword keyword-val">val</span> cliente<span class="token operator">:</span> ClienteEntity<span class="token punctuation">,</span>
    <span class="token annotation builtin">@Relation</span><span class="token punctuation">(</span>
          parentColumn <span class="token operator">=</span> <span class="token string">&quot;dni&quot;</span><span class="token punctuation">,</span>
          <span class="token comment">// Nombre de la columna en la tabla</span>
          entityColumn <span class="token operator">=</span> <span class="token string">&quot;dni_cliente&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> pedidos<span class="token operator">:</span> List<span class="token operator">&lt;</span>PedidoEntity<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</pre><blockquote>
<p>&#x270B; <strong>Importante:</strong> Puedes saber m&#xE1;s sobre como definir otros tipos de <strong>relaciones entre objetos</strong> con room en el siguiente <strong><a href="https://developer.android.com/training/data-storage/room/relationships">enlace</a></strong></p>
</blockquote>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="crear-los-objetos-de-acceso-a-la-base-de-datos">Crear los Objetos de Acceso a la Base de Datos</h3>

<p>Los <strong><a href="https://developer.android.com/training/data-storage/room/accessing-data">DAO</a></strong> ser&#xE1;n elementos de tipo Interfaz mayoritariament, en los cuales incluiremos los m&#xE9;todos necesarios de acceso y gesti&#xF3;n a las entidades de la Base de Datos.  En tiempo de compilaci&#xF3;n, Room generar&#xE1; autom&#xE1;ticamente la implementaciones de DAOs que hayamos definido.</p>
<p>Es buena pr&#xE1;ctica, <strong>definir un DAO por cada entidad que tengamos</strong>, y en este definir las funcionalidades asociadas a esta entidad.</p>
<p>Para que una interfaz sea gestionada como DAO, habr&#xE1; que etiquetarla de esta manera, siguiendo nuestro ejemplo tendr&#xED;amos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao 
<span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</pre><p>Para poder operar con la funcionalidad de Room, se necesitar&#xE1; hacer las llamadas fuera del hilo principal ya que las instancias de <strong><code>RoomDatabase</code></strong> son costosas en cuanto a tiempo, por lo que ser&#xE1; necesario lanzar estas llamadas mediante corrutinas. <strong>La manera recomendada es la de crear los m&#xE9;todos de la interfaces DAO como m&#xE9;todos de suspensi&#xF3;n</strong>.</p>
<p>Dentro de un DAO podemos crear dos tipos distintos de m&#xE9;todos, de conveniencia y de b&#xFA;squeda.</p>
<h4 class="mume-header" id="m%C3%A9todos-de-conveniencia">M&#xE9;todos de conveniencia</h4>

<p>Estos m&#xE9;todos nos permiten realizar las operaciones b&#xE1;sicas de inserci&#xF3;n, modificaci&#xF3;n y eliminaci&#xF3;n de registros en la BD sin tener que escribir ning&#xFA;n tipo de c&#xF3;digo SQL. A estos m&#xE9;todos se le pasa la entidad sobre la que se quiera trabajar y es la propia librer&#xED;a Room la encargada de crear la sentencia SQL usando la clave primaria para la identificaci&#xF3;n del registro sobre el que se quiere operar. Deber&#xE1;n ir precedidos por las anotaciones <strong>@Insert, @Delete o @Update</strong> dependiendo de la necesidad.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao <span class="token punctuation">{</span>
    <span class="token annotation builtin">@Insert</span><span class="token punctuation">(</span>onConflict <span class="token operator">=</span> OnConflictStrategy<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token annotation builtin">@Delete</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token annotation builtin">@Update</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>cliente <span class="token operator">:</span> ClienteEntity<span class="token punctuation">)</span>

    <span class="token comment">// Si no pasamos la entidad y lo que tenemos </span>
    <span class="token comment">// es la PK deberemos hacer una consulta con @Query</span>
    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;DELETE FROM clientes WHERE dni = :dni&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">deleteByDni</span><span class="token punctuation">(</span>dni<span class="token operator">:</span> String<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x1F4CC; <strong>Nota:</strong> Como se puede ver en el anterior c&#xF3;digo, es una manera muy sencilla de realizar las operaciones b&#xE1;sicas usando las anotaciones correspondientes y pasando como par&#xE1;metro al m&#xE9;todo la Entidad sobre la que queremos operar.<br>
En el caso de la inserci&#xF3;n podemos ver que se puede utilizar la propiedad <strong><code>onConflict</code></strong> para indicar si queremos reemplazar el elemento existente por el nuevo en caso de que coincida la clave primaria (en este caso el dni).</p>
</blockquote>
<h4 class="mume-header" id="m%C3%A9todos-de-b%C3%BAsqueda">M&#xE9;todos de b&#xFA;squeda</h4>

<p>Estos m&#xE9;todos ser&#xE1;n los que crearemos para realizar consultas sobre la BD y tendr&#xE1;n que ir precedidos por la anotaci&#xF3;n <strong>@Query</strong>. Esta anotaci&#xF3;n permite que se a&#xF1;ada como par&#xE1;metro una cadena con la sentencia SQL para la consulta.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Dao</span>
<span class="token keyword keyword-interface">interface</span> ClienteDao <span class="token punctuation">{</span>

    <span class="token comment">// ... aqu&#xED; van los m&#xE9;todos de conveniencia CRUD</span>

    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ClienteEntity<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes WHERE dni IN (:dni)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getFromDni</span><span class="token punctuation">(</span>dni <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> ClienteEntity
<span class="token punctuation">}</span>
</pre><p>Los dos primeros m&#xE9;todos de nuestro DAO, son dos m&#xE9;todos de consulta, el primero devuelve una lista de Clientes mientras que el segundo devuelve un solo cliente. Como se puede ver en el c&#xF3;digo, Room permite pasar un par&#xE1;metro o una lista de par&#xE1;metros dentro de la propia consulta siempre que lo precedamos con <strong><code>:</code></strong> y que coincida en nombre con el par&#xE1;metro que le llega al m&#xE9;todo.</p>
<h5 class="mume-header" id="selecci%C3%B3n-de-un-subconjunto-de-columnas">Selecci&#xF3;n de un subconjunto de columnas</h5>

<p>En muchas ocasiones no ser&#xE1; necesaria toda la informaci&#xF3;n de la tabla, sino que solo necesitaremos recuperar algunas de las columnas. Aunque se puede recuperar toda la informaci&#xF3; y posteriormente realizar un filtrado de esta, para ahorrar recursos es interesante consultar solamente los campos que se necesitan. Para ello necesitaremos crear un objeto del tipo de columnas que queramos devolver, esto se podr&#xE1; hacer usando una data class nueva para esos datos:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">TuplaNombreApellido</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@ColumnInfo</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;apellidos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String
<span class="token punctuation">)</span>
</pre><p>Y solamente se tendr&#xE1; que indicar en el Dao que el m&#xE9;todo correspondiente devolver&#xE1; los datos de este tipo:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT nombre, apellidos FROM clientes&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getNombreApellido</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>TuplaNombreApellido<span class="token operator">&gt;</span>
</pre><p>Por ejemplo, si quisieramos recuperar el mapeo de la clase <strong><code>ClienteConPedidos</code></strong> que definimos en la relaci&#xF3;n uno a muchos entre objetos. Deber&#xED;amos marcar el m&#xE9;todo con anotaci&#xF3;n <strong><code>@Transaction</code></strong>, pues en su interior hay una anotaci&#xF3;n <strong><code>@Relation</code></strong> que se deber&#xE1; completar antes de devolver la instancia del objetos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Transaction</span>
<span class="token comment">// F&#xED;jate que no indicamos la relaci&#xF3;n en la consulta ya est&#xE1; definida</span>
<span class="token comment">// en el objeto a recuperar.</span>
<span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM clientes&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// F&#xED;jate que devuelve una lista de objetos ClienteConPedidos</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">getPedidos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ClienteConPedidos<span class="token operator">&gt;</span> 
</pre><div style="page-break-after:always;"></div>
<h3 class="mume-header" id="crear-la-base-de-datos-room-y-consumirla">Crear la Base de Datos Room y consumirla</h3>

<p>El &#xFA;ltimo elemento que quedar&#xED;a por crear ser&#xED;a la <a href="https://developer.android.com/training/data-storage/room#database">RoomDatabase</a>. Este elemento es el que se encargar&#xE1; de crear la base de datos a partir de las Entities definidas y las operaciones que se realizar&#xE1;n sobre estas a partir de los Daos de nuestra app. Por tanto es el elemento que enlaza a los dos anteriores. Para ello crearemos una clase abstracta que deber&#xE1; de heredar de <strong><code>RoomDatabase</code></strong> y a la que etiquetaremos con la anotaci&#xF3;n <strong>@Database</strong> con las propiedades versi&#xF3;n y entities. La primera propiedad especificar&#xE1; la versi&#xF3;n de la BD, mientras que en entities indicaremos la entidad o entidades asociadas a esta.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Database</span><span class="token punctuation">(</span>
    entities <span class="token operator">=</span> <span class="token punctuation">[</span>ClienteEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> PedidoEntity<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    version <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token comment">// Indicaremos las conversiones de tipos que hemos definido para </span>
<span class="token comment">// nuestra base de datos si las hay. Ej. Date &#x2194; Long o Bitmap &#x2194; byte[]</span>
<span class="token annotation builtin">@TypeConverters</span><span class="token punctuation">(</span>Converters<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span>
<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> TiendaDB<span class="token operator">:</span> <span class="token function">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">clienteDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ClienteDao
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">pedidoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> PedidoDao
<span class="token punctuation">}</span>
</pre><blockquote>
<p>&#x270B; <strong>Importante:</strong>  Cada Database tendr&#xE1; un m&#xE9;todo abstracto  que devolver&#xE1; su tipo <strong><code>DAO</code></strong> correspondiente para posteriormente acceder a los m&#xE9;todos de este.</p>
</blockquote>
<h3 class="mume-header" id="instanciar-la-roomdatabase-para-su-posterior-funcionamiento">Instanciar la RoomDatabase para su posterior funcionamiento</h3>

<p>Una vez creados todos los componentes necesarios para el funcionamiento de Room Database, podremos crear instancias en el lugar donde las necesitemos para la gesti&#xF3;n de la base de datos, para ello crearemos primero un m&#xE9;todo est&#xE1;tico <strong><code>fun getDatabase(context: Context): AgendaDb</code></strong> que me devolver&#xE1; una &#xFA;nica instancia de la BD de forma s&#xED;ncrona (como se ve de la l&#xED;nea 5 a la 19).</p>
<pre data-role="codeBlock" data-info="kotlin {class=&quot;line-numbers&quot;}" class="language-kotlin line-numbers"><span class="token annotation builtin">@TypeConverters</span><span class="token punctuation">(</span>Converters<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span>
<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> AgendaDb<span class="token operator">:</span> <span class="token function">RoomDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ContactoDao

    <span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> <span class="token punctuation">{</span>
        <span class="token annotation builtin">@Volatile</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> db<span class="token operator">:</span> AgendaDb<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>

        <span class="token keyword keyword-fun">fun</span> <span class="token function">getDatabase</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> AgendaDb <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> db <span class="token operator">?:</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> instance <span class="token operator">=</span> Room<span class="token punctuation">.</span><span class="token function">databaseBuilder</span><span class="token punctuation">(</span>
                        context<span class="token punctuation">,</span>
                        AgendaDb<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span> <span class="token string">&quot;agenda&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                db <span class="token operator">=</span> instance
                instance
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>Como necesitamos el contexto podemos definir un objeto <strong><code>TiendaApp</code></strong> que herede de <strong><code>Application()</code></strong> para crear la instancia de forma global y accesible desde el <strong><code>MainActivity</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> TiendaApp <span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> database<span class="token operator">:</span> AgendaDb <span class="token keyword keyword-by">by</span> lazy <span class="token punctuation">{</span> AgendaDb<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Para que se cree una instancia del objeto <strong><code>TiendaApp</code></strong> deberemos modificar nuestro <strong><code>AndroidManifest.xml</code></strong> para indicarle que est&#xE1; asociado a nuestra App a&#xF1;adiendo el siguiente atributo a la etiqueta <strong><code>&lt;application&gt;</code></strong></p>
<pre data-role="codeBlock" data-info="xml" class="language-xml">...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>paquete_donde_este_definido.TiendaApp<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>

...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
</pre><p>Para obtener una instancia del DAO en alg&#xFA;n punto de nuestra aplicaci&#xF3;n podemos hacer.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// Suponiendo que estamos definiendo un ViewModel</span>

<span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> dao <span class="token operator">=</span> <span class="token punctuation">(</span>applicationInstance <span class="token keyword keyword-as">as</span> TiendaApp<span class="token punctuation">)</span><span class="token punctuation">.</span>database<span class="token punctuation">.</span><span class="token function">contactoDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Un posible uso de este objeto para realizar una </span>
<span class="token comment">// consulta con paso de par&#xE1;metro ser&#xED;a de la siguiente manera...</span>

viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>    
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dao<span class="token punctuation">.</span><span class="token function">getFromDni</span><span class="token punctuation">(</span>cliente<span class="token punctuation">.</span>dni<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>dni <span class="token operator">!=</span> cliente<span class="token punctuation">.</span>dni<span class="token punctuation">)</span>
        dao<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cliente<span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span>
        <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>
                            <span class="token keyword keyword-this">this</span><span class="token label symbol">@MainActivity</span><span class="token punctuation">,</span>
                            <span class="token string">&quot;El registro ya existe&quot;</span><span class="token punctuation">,</span>
                            Toast<span class="token punctuation">.</span>LENGTH_LONG
                        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>