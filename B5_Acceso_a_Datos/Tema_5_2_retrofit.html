<!DOCTYPE html><html><head>
      <title>PMDM 2º DAM  Tema 5.2 - retrofit</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css">
      
      
      
      
      
      <style>
      @import url(https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css);
code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face{font-family:"Material Icons";font-style:normal;font-weight:400;src:local("Material Icons"),local("MaterialIcons-Regular"),url("data:application/x-font-woff;charset=utf-8;base64,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") format("woff")}.admonition{box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);position:relative;margin:1.5625em 0;padding:0 1.2rem;border-left:.4rem solid rgba(68,138,255,.8);border-radius:.2rem;background-color:rgba(255,255,255,.05);overflow:auto}.admonition>p{margin-top:.8rem}.admonition>.admonition-title{margin:0 -1.2rem;padding:.8rem 1.2rem .8rem 3.6rem;border-bottom:1px solid rgba(68,138,255,.2);background-color:rgba(68,138,255,.1);font-weight:700}.admonition>.admonition-title:before{position:absolute;left:1.2rem;font-size:1.5rem;color:rgba(68,138,255,.8);content:"\E3C9"}.admonition>.admonition-title:before{font-family:Material Icons;font-style:normal;font-variant:normal;font-weight:400;line-height:2rem;text-transform:none;white-space:nowrap;speak:none;word-wrap:normal;direction:ltr}.admonition.abstract,.admonition.summary,.admonition.tldr{border-left-color:rgba(0,176,255,.8)}.admonition.abstract>.admonition-title,.admonition.summary>.admonition-title,.admonition.tldr>.admonition-title{background-color:rgba(0,176,255,.1);border-bottom-color:rgba(0,176,255,.2)}.admonition.abstract>.admonition-title:before,.admonition.summary>.admonition-title:before,.admonition.tldr>.admonition-title:before{color:#00b0ff;content:"\E8D2"}.admonition.hint,.admonition.tip{border-left-color:rgba(0,191,165,.8)}.admonition.hint>.admonition-title,.admonition.tip>.admonition-title{background-color:rgba(0,191,165,.1);border-bottom-color:rgba(0,191,165,.2)}.admonition.hint>.admonition-title:before,.admonition.tip>.admonition-title:before{color:#00bfa5;content:"\E80E"}.admonition.info,.admonition.todo{border-left-color:rgba(0,184,212,.8)}.admonition.info>.admonition-title,.admonition.todo>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.info>.admonition-title:before,.admonition.todo>.admonition-title:before{color:#00b8d4;content:"\E88E"}.admonition.check,.admonition.done,.admonition.success{border-left-color:rgba(0,200,83,.8)}.admonition.check>.admonition-title,.admonition.done>.admonition-title,.admonition.success>.admonition-title{background-color:rgba(0,200,83,.1);border-bottom-color:rgba(0,200,83,.2)}.admonition.check>.admonition-title:before,.admonition.done>.admonition-title:before,.admonition.success>.admonition-title:before{color:#00c853;content:"\E876"}.admonition.faq,.admonition.help,.admonition.question{border-left-color:rgba(100,221,23,.8)}.admonition.faq>.admonition-title,.admonition.help>.admonition-title,.admonition.question>.admonition-title{background-color:rgba(100,221,23,.1);border-bottom-color:rgba(100,221,23,.2)}.admonition.faq>.admonition-title:before,.admonition.help>.admonition-title:before,.admonition.question>.admonition-title:before{color:#64dd17;content:"\E887"}.admonition.attention,.admonition.caution,.admonition.warning{border-left-color:rgba(255,145,0,.8)}.admonition.attention>.admonition-title,.admonition.caution>.admonition-title,.admonition.warning>.admonition-title{background-color:rgba(255,145,0,.1);border-bottom-color:rgba(255,145,0,.2)}.admonition.attention>.admonition-title:before{color:#ff9100;content:"\E417"}.admonition.caution>.admonition-title:before,.admonition.warning>.admonition-title:before{color:#ff9100;content:"\E002"}.admonition.fail,.admonition.failure,.admonition.missing{border-left-color:rgba(255,82,82,.8)}.admonition.fail>.admonition-title,.admonition.failure>.admonition-title,.admonition.missing>.admonition-title{background-color:rgba(255,82,82,.1);border-bottom-color:rgba(255,82,82,.2)}.admonition.fail>.admonition-title:before,.admonition.failure>.admonition-title:before,.admonition.missing>.admonition-title:before{color:#ff5252;content:"\E14C"}.admonition.bug,.admonition.danger,.admonition.error{border-left-color:rgba(255,23,68,.8)}.admonition.bug>.admonition-title,.admonition.danger>.admonition-title,.admonition.error>.admonition-title{background-color:rgba(255,23,68,.1);border-bottom-color:rgba(255,23,68,.2)}.admonition.danger>.admonition-title:before{color:#ff1744;content:"\E3E7"}.admonition.error>.admonition-title:before{color:#ff1744;content:"\E14C"}.admonition.bug>.admonition-title:before{color:#ff1744;content:"\E868"}.admonition.example,.admonition.snippet{border-left-color:rgba(0,184,212,.8)}.admonition.example>.admonition-title,.admonition.snippet>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.example>.admonition-title:before,.admonition.snippet>.admonition-title:before{color:#00b8d4;content:"\E242"}.admonition.cite,.admonition.quote{border-left-color:rgba(158,158,158,.8)}.admonition.cite>.admonition-title,.admonition.quote>.admonition-title{background-color:rgba(158,158,158,.1);border-bottom-color:rgba(158,158,158,.2)}.admonition.cite>.admonition-title:before,.admonition.quote>.admonition-title:before{color:#9e9e9e;content:"\E244"}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v28/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.markdown-preview.markdown-preview .caso_estudio {
  background-color: #f5f5f5;
  border: 2px solid #969696;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
@page a4landscape {
  size: A4 landscape;
  margin: 1cm;
}
@page a4portrait {
  size: A4 portrait;
  margin: 1cm 1cm 2.5cm 1cm;
}
.markdown-preview.markdown-preview .landscape {
  page: a4landscape;
}
.markdown-preview.markdown-preview .portrait {
  page: a4portrait;
}
.markdown-preview.markdown-preview .ejercicio {
  background-color: #f5faf5;
  border: 2px solid #969b96;
  padding-left: 15px;
  padding-right: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.markdown-preview.markdown-preview .fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.markdown-preview.markdown-preview .cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.markdown-preview.markdown-preview .abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.markdown-preview.markdown-preview .cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.markdown-preview.markdown-preview .autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
.markdown-preview.markdown-preview .flotante {
  display: flex;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: center;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: space-between;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: row;
  }
}
.markdown-preview.markdown-preview .flotante_izq {
  margin-right: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: auto;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: auto;
  }
}
.markdown-preview.markdown-preview .galeria_imagenes {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: row;
  }
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="tema-52---retrofit">Tema 5.2 - Retrofit </h1>
<p>Descargar estos apuntes <a href="./Tema_5_2_retrofit.pdf">pdf</a> o <a href="./Tema_5_2_retrofit.html">html</a></p>
<h2 id="índice">Índice </h2>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#introducción" class="md-toc-link"><p>Introducción</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#qué-es-json" class="md-toc-link"><p>¿Qué es JSON?</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#tipos-de-datos-en-json" class="md-toc-link">
            <p>Tipos de datos en JSON</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#definición-de-un-servidor-rest-rápido-para-pruebas" class="md-toc-link"><p>Definición de un Servidor Rest rápido para pruebas</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#creando-la-base-de-datos-con-phpmyadmin" class="md-toc-link">
            <p>Creando la Base de Datos con phpMyAdmin</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#consumo-de-un-servicio-rest-desde-android" class="md-toc-link"><p>Consumo de un Servicio Rest desde Android</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#configuración-del-proyecto" class="md-toc-link">
            <p>Configuración del proyecto</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#crear-los-servicios-con-retrofit" class="md-toc-link"><p>Crear los servicios con Retrofit</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-los-tipos-a-serializar-a-json" class="md-toc-link">
            <p>Definiendo los tipos a serializar a JSON</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-las-peticiones-para-consumo-del-endpoint" class="md-toc-link">
            <p>Definiendo las peticiones para consumo del '<em>endpoint</em>'</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#preparando-los-objetos-de-retrofit-con-hilt" class="md-toc-link">
            <p>Preparando los objetos de Retrofit con Hilt</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#implementaciones-de-la-gestión-del-consumo-de-nuestro-endpoint" class="md-toc-link">
            <p>Implementaciones de la gestión del '<em>consumo</em>' de nuestro endpoint</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#usando-nuestra-implementación-del-servicio-en-el-patrón-repository" class="md-toc-link"><p>Usando nuestra implementación del servicio en el patrón Repository</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#acceder-a-la-api-iniciando-una-sesión-en-el-servidor" class="md-toc-link">
            <p>Acceder a la API iniciando una sesión en el servidor</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 id="introducción">Introducción </h2>
<ul>
<li>
<p><strong>Persistencia remota consumiendo un API Rest con Retrofit2</strong></p>
<ul>
<li>Página oficial librería: <strong><a href="https://square.github.io/retrofit/">Retrofit</a></strong></li>
<li>Guía usuario: <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">Gson</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=MRzcCnkZQlA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial <strong>Interceptores</strong> (Castellano): <strong><a href="https://www.youtube.com/watch?v=MQdhmAaVmeA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=2_DnhfQrwXQ">DevExperto</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=L3pM5YuxYp4">AristiDevs</a></strong></li>
</ul>
</li>
</ul>
<p>En la gran mayoría de aplicaciones móviles, se necesita acceder a datos que no están en el dispositivo, sino que están en un servidor remoto. Para ello se utilizan que permiten el acceso a los datos a través de internet. Estos servicios pueden ser <strong>API Rest</strong>, <strong>GraphQL</strong>, <strong>WebSockets</strong>, <strong>gRPC</strong>, etc. En este tema nos centraremos en los servicios API Rest, que son los más utilizados.</p>
<p>Los Servicios web REST, utilizan el protocolo HTTP para intercambiar información entre el cliente y el servidor. Nosotros en el curso vamos a utilizar una arquitectura similar a la siguiente:</p>
<p></p><p align="center" class="puml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="776px" preserveAspectRatio="none" style="width:950px;height:776px;background:#000000;" version="1.1" viewBox="0 0 950 776" width="950px" zoomAndPan="magnify"><defs></defs><g><rect fill="#1B260D" height="1" style="stroke:#1B260D;stroke-width:1;" width="1" x="0" y="0"></rect><rect fill="#FFFFFF" height="73" style="stroke:#FFFFFF;stroke-width:1;" width="948.1777" x="0" y="0"></rect><image height="53" width="450" x="1" xlink:href="data:image/png;base64,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" y="10"></image><image height="62" width="62" x="450" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAA+CAYAAABzwahEAAACp0lEQVR4Xu3SQapbQQxEUe9/08nk9+SQi9S2AyH2hRqoqqR+Bj9+fSgPjU/h+8M/je8P/zTyhz8ej6dU+7e4572tikw8sFXt3+Ke97YqMpkW5bZ/WH/okMvUz2RalNv+4Z//4X5g5TXrTxJ9+5UXmbjoA5XXrD9J9O1XXmTiog9U7jz5qjB3r/IiExd9oHLnyVeFuXuVF5m46AOVO5emnujbr7zIxEUfqNy5NPVE337lRSbTolS/fLE3zRNTP5NpUapfvtib5ompn8lZvJX7755vVWTiga3cf/d8q6KTN1EfUP5hyl/l713+oX5A+Ycpf5W87F9Gib7z1i+JuT1nycSDSvSdt35JzO05Sya1WA+ZPzs/6x+m/JCNOnD8KX92ftY/TPlhbvzgwdtZv/KD+TTfst70odtZv/KD+TTfMm76wLMfrl+asHe7fxibHtw+VLn7asLe7f4hmx6cDpvXnr652FNTr8jEA+Oh4UPKNxd7auoVnUAd0vdhte1tVYy5RlGH9P0wte1tVYy5hnigZjVhz3nC/vX7GuKhmtWEPecJ+9fvaxw8sD1cefkH729VjLnGwcVXHyz/4P2tijHXmKiHJ38767+qopOgDk/+dtZ/VUUnL+LDftBWhfk0Sycv4sP+oK0K82mWTPyArQpzZzHfzqrIxANbFebOYr6dVZHJtCjVX3/IHz5605fyJRvbA4fq3/4QVVRevmTDA35Q5bL1a96q9opMXPRg5bL1a96q9opMXPRg5c7lF+bTnUlFJi56sHLn8gvz6c6kIhMXPVh5zVvffPKd9YtseMDDlde89c0n31m/yMb2wMH+di5VT7/miWxeHxo+pOZS9fRrnsimD27l/kTtF/YnFZl4YCv3J2q/sD+p6OQ/5/vDP43vD/80PvaH/waCbp3NtVew5gAAAABJRU5ErkJggg==" y="5.5"></image><rect fill="#000000" height="629.2656" style="stroke:#000000;stroke-width:1;" width="948.1777" x="0" y="73"></rect><text fill="#33FF02" font-family="sans-serif" font-size="12" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="105.375" x="5" y="90">PlantUML 1.2025.4</text><text fill="#33FF02" font-family="sans-serif" font-size="12" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="3.334" x="5" y="105.0938">&nbsp;</text><text fill="#33FF02" font-family="sans-serif" font-size="12" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="320.7246" x="5" y="120.1875">This version of PlantUML is 212 days old, so you should</text><text fill="#33FF02" font-family="sans-serif" font-size="12" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="322.6641" x="5" y="135.2813">consider upgrading from https://plantuml.com/download</text><rect fill="#33FF02" height="22.6094" style="stroke:#33FF02;stroke-width:1;" width="938.1777" x="5" y="146.375"></rect><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="140" x="6" y="161.375">[From string (line 4) ]</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="3.8896" x="5" y="182.9844">&nbsp;</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="68.8857" x="5" y="200.5938">@startuml</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="665.0479" x="16.6689" y="218.2031">!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="720.2344" x="5" y="235.8125">' convert it with additional command line argument -DRELATIVE_INCLUDE="relative/absolute" to use locally</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="291.792" x="5" y="253.4219">!if %variable_exists("RELATIVE_INCLUDE")</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="180.4619" x="12.7793" y="271.0313">!include ./C4_Context.puml</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="11.6689" x="5" y="288.6406">...</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="168.834" x="5" y="306.25">... ( skipping 13482 lines )</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="11.6689" x="5" y="323.8594">...</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="379.8867" x="5" y="341.4688">00008FFFFFD0000000000000000000000000000014000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="376.8242" x="5" y="359.0781">0000122F621000100000010011000001000010006C000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="397.6055" x="5" y="376.6875">0000000F40009FFC20ACFFC8FFA006FFF16FFF54FFF80000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="393.8457" x="5" y="394.2969">0000000F4006E21BB0AE22FC13F23F51302309C08C100000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="393.8525" x="5" y="411.9063">0000000F400B9004F0AA00D700F47D0000168BE08C000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="395.4043" x="5" y="429.5156">0000000F400C8004F0A900D700F48C0000EC7AE08C000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="389.9697" x="5" y="447.125">0000000F4009C008D0A900D700F45F1004F109E08C000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="406.2393" x="5" y="464.7344">0000000F4001EDBF50A900D700F40CEBE2FCCEE04FB60000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="373.7344" x="5" y="482.3438">000000061000166200430052006100574026515004720000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="373.7344" x="5" y="499.9531">000000000000000000000000000000000000000000000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="373.7344" x="5" y="517.5625">000000000000000000000000000000000000000000000000</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5.4482" x="5" y="535.1719">}</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="3.8896" x="5" y="552.7813">&nbsp;</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="3.8896" x="5" y="570.3906">&nbsp;</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="938.1777" x="5" y="588">!define DEV2_TOMCAT_LINE_WORDMARK(_alias) ENTITY(rectangle,black,tomcat_line_wordmark,_alias,DEV2 TOMCAT_LINE_WORDMARK)</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="910.2324" x="5" y="605.6094">!define DEV2_TOMCAT_LINE_WORDMARK(_alias, _label) ENTITY(rectangle,black,tomcat_line_wordmark,_label, _alias,DEV2 TOMCAT ...</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="900.9355" x="5" y="623.2188">!define DEV2_TOMCAT_LINE_WORDMARK(_alias, _label, _shape) ENTITY(_shape,black,tomcat_line_wordmark,_label, _alias,DEV2 T ...</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="888.4668" x="5" y="640.8281">!define DEV2_TOMCAT_LINE_WORDMARK(_alias, _label, _shape, _color) ENTITY(_shape,_color,tomcat_line_wordmark,_label, _ali ...</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="539.8545" x="5" y="658.4375">skinparam folderBackgroundColor&lt;&lt;DEV2 TOMCAT_LINE_WORDMARK&gt;&gt; White</text><text fill="#33FF02" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" text-decoration="wavy underline" textLength="241.9648" x="16.6689" y="676.0469">!include &lt;tupadr3/devicons2/mysql&gt;</text><text fill="#FF0000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="336.0889" x="8.8896" y="693.6563">cannot include java.io.IOException: Stream closed</text><rect fill="#FFFFFF" height="73" style="stroke:#FFFFFF;stroke-width:1;" width="948.1777" x="0" y="702.2656"></rect><image height="53" width="450" x="1" xlink:href="data:image/png;base64,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" y="712.2656"></image><image height="62" width="62" x="450" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAA+CAYAAABzwahEAAACp0lEQVR4Xu3SQapbQQxEUe9/08nk9+SQi9S2AyH2hRqoqqR+Bj9+fSgPjU/h+8M/je8P/zTyhz8ej6dU+7e4572tikw8sFXt3+Ke97YqMpkW5bZ/WH/okMvUz2RalNv+4Z//4X5g5TXrTxJ9+5UXmbjoA5XXrD9J9O1XXmTiog9U7jz5qjB3r/IiExd9oHLnyVeFuXuVF5m46AOVO5emnujbr7zIxEUfqNy5NPVE337lRSbTolS/fLE3zRNTP5NpUapfvtib5ompn8lZvJX7755vVWTiga3cf/d8q6KTN1EfUP5hyl/l713+oX5A+Ycpf5W87F9Gib7z1i+JuT1nycSDSvSdt35JzO05Sya1WA+ZPzs/6x+m/JCNOnD8KX92ftY/TPlhbvzgwdtZv/KD+TTfst70odtZv/KD+TTfMm76wLMfrl+asHe7fxibHtw+VLn7asLe7f4hmx6cDpvXnr652FNTr8jEA+Oh4UPKNxd7auoVnUAd0vdhte1tVYy5RlGH9P0wte1tVYy5hnigZjVhz3nC/vX7GuKhmtWEPecJ+9fvaxw8sD1cefkH729VjLnGwcVXHyz/4P2tijHXmKiHJ38767+qopOgDk/+dtZ/VUUnL+LDftBWhfk0Sycv4sP+oK0K82mWTPyArQpzZzHfzqrIxANbFebOYr6dVZHJtCjVX3/IHz5605fyJRvbA4fq3/4QVVRevmTDA35Q5bL1a96q9opMXPRg5bL1a96q9opMXPRg5c7lF+bTnUlFJi56sHLn8gvz6c6kIhMXPVh5zVvffPKd9YtseMDDlde89c0n31m/yMb2wMH+di5VT7/miWxeHxo+pOZS9fRrnsimD27l/kTtF/YnFZl4YCv3J2q/sD+p6OQ/5/vDP43vD/80PvaH/waCbp3NtVew5gAAAABJRU5ErkJggg==" y="707.7656"></image><!--SRC=[xLtXRwCu5l_ENy5fxyFCXzt1O8ofHYE1WRkRQszNq-xCXzEfeWdRYIPDkeJCj7VQ__ri0y5W1qZI5hI3AqKjyS_- -VczvuTvffilYzLzdCPt-ZpvBTukiwla8VEMYzlLNRBAz1dzI59Ds-ogVKlZ-q-BUVPPDmr3k7uNFrmacqrycrmk_flem3P4r7bocwpcqNgLaVLodUe_HBn8DVnuzkKsNMzNyxnUbiQh3Qr0QSXrr-ayIULwGiKqcMNnwdQPl7sxv1WlJU9tx_J_QJejDxlEPb8Z_7lUWVpT7yekYaOlgRoITVPudx3Hvh8mwv1vdCKtyUO0nE_RP7j0TVgPBMQB-vZEO6zGdARhRqNrOf8GB_oAC7MDgse6IRfPhmxeV9RHfjkgisyssIELS_mjsQpl4jQ0Ugfls9J6wUDkeXKj8iKNHAa5kPfTygxdyUPpCcyAU_Q5QlrJTCKXlAFxPRnOvTstM0IJm0iKHgEth0L5WRnqZg8IiWAd4hviIKFpuFOvD8dSvePcmIsvbOJKqJE9etA2Gyjaar05MSsIc_N3u4gIUokHHfTdwh3xBdZfFzgy28yoxjF59haUYqCP3QN2juo6J-bcHaEey3Zz-0pXV4OZgPeV6ez2bIv9oUWextHKIxqyrUPnaoLte_5Iew1JUAXHS2czqoZ859wfcyiGNcaK4gfvf74eKEcD93P7UQA3M-dbXMOKIcyGatGqZcWiZ0fVD1OwfJiQ2v_28_MYCuHJ6ekSQdvfDCfKkYOLeQEyqp4D7L-K578BsRDLLzyiRWXSkDeK-0y6XgRZoy8s7Cj7EUP3NZsbezSDVYLOnBVhLRpSNLIxka4OAtpSu3nAvpOuaSAhzU4XjAg-Uf90H5Ssk5HgFcmWDlljFdcW5AYnNJyFCuJPZymCU-pdD0SmB7NLtj1e2EqsXqR3gDmTEeIGqBpwwaaYgcqDZKPEzRsXWMdjTnlv_THJ4m80OJ-G2Ld4YOXnchSOXF7UxPa1UTItPWOaKjkMQUSXjAg-Uf90vEsO0QMYs8fvSJOzmeNdOURoyipXmY3KsyA5mGb9uSBWZ9hXGXz2GlFggoU9I1ak32udTRWm4AtEB9MNsLdkuI6cXplJmvtfuSxt_71dB8amJ-sifdoPALzcofVvpl9b-EqQnMM9_jSYvVlV43z0_0QW_r3P60UMfm50roV4SyoU01H6HV6j7W108g4udG0GHhM2km0aQXJK3d0YgO0s093hHsuR02a0KHl0Lm5W2o1K0PmMWAf-Gx8d0W8L0BK0l4C7hH9hs3hJOTSGJbKDnTJPNUeTjCsQqkByjlQL9chlEl50JoTWEPxlkmWydvlf3p1j1sF1jzWO8mZs0fnYj86Be6L1fvIN3vK0gBIU0W9aW1ErbS1i0b3KNa9G1rXHL_7h0ByJK6g9rhC3EWmHuFO0HAO02Fe0a03eKx-mLMsV3vQBToZ07nz068CHzW4u0W3rg5-eNw5Bk5iphBfw0sYt5ki5lSOVpN3Ax8wdfcXdYdQcQ6UATdf5EpmIQSOYpMX4ao8HEHQfHIDQZqYa5ereVI8HCHevRZcm3btI_5w0V1QrtXqKqOZMDn8fen6jRoHI6glMDn8fRKdhkugNSXePm3joq8UBTJTnUm8Ct9mugoSWa9Il0s1BwjqEy6K3QWNKuocd4r0tqS89j02QJY1tCti12ZSZEB9cQJWo8PvArpVhR0oxKnDWK82jzl6Xgru1rO5E3h6KIsQVEsKHqEEMiGQ0hG0Y0-m-Dyhz0U5f0EIwi0GGQ5RYglwW0DV5XIF5FCgoA_aXiLcd_BK8zhJyXg84UE8T08_wJH5WSq0W0FogJe6ssW4yvjtfYBLpu_i1aOU5rMVtHmjWhrZ_N01nuYBiD0gH0Q9gH5BewyggKLC-1pKAaPNl1UpXE9jktqfn502xbmyGFHya- -gBlh9njwqiqmhqfm0qewcEpQbcRDP5m5Dl7Uu5a3PBKG1KTwSXF7IFmsi1u4EtNPuRGAMk1DGcGwirZ_V4xNW272tMCQh6Im1KAmXHMXpCNGJ44eBWyZiHGAglfKBgta3hzrYW6eosnxdiNPgr_XrKEn0JO08yEQ1hSsh4W9t5TG28PDCT02nvZNO0aVoIis-l2Kb-wS1mQZeNFvsBdyx5Vw_dugU3yTF1-EbW_7Gm_j23yOU-OcVtbf-dfWij70JsynoR7ufqsyl41gGYlKXiG2xDbuYrKn4QLbyzIIpAbuSDA1lrYyDUd52FyEBPoFaM-v79UOZzF564CHJxjY1Z39oaE6CCf9gXHazEGW_ggoS9IXbjZ45Qwe1ZE6QTXrPVxFs8JtrcTNffwVJIqkcbfT_bIqlB1zdP-cuMPzTBsjxrDpgIkpZzybnPWgHvj06vhG0h4CzlyRCOGIi0EL54W9YiJdW6-Lw02zqYBuedQVXHPBjM6y2pM0Oy2TcZz208sEDmlW7U0Z20WqoMueBPMHig0coh4ki5G7aceVmDetec2tOn2gF0ASUGFv95nYwvljQ37M3RWaAggiEQSu5HFBa4Lj560K2-aEdFvMqNvqLo07PePQzA4B9sIGScX3bban1h1y20jrPDd2UVku7iW8c9CNkQwHBs6DaXmccqPcqlS8a3U1Pi-M70wZc7MSjH04x0UeIUC0H6EpIhH68HWEdaSj7oR3kFKI8UrpxXw9TVwHp1m6LoWYvsc1njR3Bv8zTnNI2DmIJOPvNfL9YsxK6JDy5cn8AURLS0DvzDXqcIYzMasWCXCmZRDY1bQFhqxqfA9k74S5WNhuiQvbRDj6SRPe1eiqOjGscNSGpzXas3m2gK4jSESX2xUDmDvBEJ1HjIJuBoNJusAHyK15wXbir9nm4YdkncQDUUemGObg_8H_0G8vLdmX0F8xDnUgkPyU2uTAwmvUN6O4B72uXJITYnCQe18A7J2ShqktnymAOA2wi-R0400hCq8ATsv0YwWSl9KMtQWJK-QSIiCdf26rb2Rc_fOhtTKpdRArHVECuc31hWW5kIKPo6qzXCrMONEKxZS1qAk4tx3bDNZGd0CpiM1Gu1qARpheM-xuTMvpfY1znyaAl9ENHx8OIMyCWbgtStjUUlGMj583uT1QOP8HDKtXuKwqvnWG-Nr0s8vzTINQ9pxX6Mxi4pi5WEC60VDgm_uSq1A3I1xnjUI3iam8fCAxAfcpSjmoK69a3gWPaZzS4URPejAn5q-B3Owmf32f0f4Pm3t1AGLmg9uwa1j6DgmWB0PiO1wOUh1e0my2DR01Waz4Cw7hhuKfoFQcw62nNnTPPgbctcbsowL9d81bITeME-N9QW4BVzjbxIwB0HMxvz6uGVJVtgvmlYNLsV_-DVuVMddpy45zw7Vz8WzTDd6fcnqF8lYzLikPqd-jjiUn_FK-lDFFcweE7VndnpzxZvVVbEqtvPqX3yrujp_IkzQLciLphuYQqiFy5Nbt6clz-kT1Fhm3ept3FJrabuUQMpxrzhh_xsoxc-MM_J6GrR5viiNTniCzh0Q-rz_3NMFsnNsU8kETFPNw-kBbxhbs5vKGzNNnVfcl-7LEtznukyalxtTNPvlyvuPGH_z1UPVfcab9V-yK8Byl-kIg6pzNonkZtJVxsAViJQEGrgjpG-FjEJZKQeXBBqyKmFB_yF]--></g></svg></p><p></p>
<p>Donde tenemos una aplicación Android que se comunica con un servidor web que tiene un API Rest, que a su vez se comunica con una base de datos MySQL. En este tema nos centraremos en consumo de dicho API Rest desde la aplicación Android utilizando una librería llamada <strong>Retrofit2</strong>.</p>
<div class="admonition info">
<p class="admonition-title">Información</p>
<p>Uno de los inconvenientes de <strong>Retrofit2</strong> es que al funcionar sobre la librería de Java <strong><a href="https://square.github.io/okhttp/">OkHttp</a></strong>, no es compatible con la programación multiplataforma. Disponemos de una alternativa muy potente y extendida denominada <strong><a href="https://ktor.io/docs/client-create-multiplatform-application.html">Ktor Client</a></strong> que además es una muy buena documentación dispone de una montón de <strong><a href="https://www.youtube.com/watch?v=n_NzI6vUR-k">vídeos de la comunidad explicando su uso en Android</a></strong>.<br>
Existen incluso librerías como <strong><a href="https://foso.github.io/Ktorfit/">Kotrfit</a></strong> que imitan el funcionamiento de Retrofit2 pero utilizando Ktor Client por debajo y así facilitar la migración.</p>
</div>
<p>El formato de los datos que se intercambian entre el cliente y el servidor es muy importante. En este tema nos centraremos en el formato <strong>JSON</strong>.</p>
<h3 id="qué-es-json">¿Qué es JSON? </h3>
<p>Aunque seguramente ya lo has visto en el módulo de Acceso a Datos. Vamos ha realizar un resumen rápido sobre dicho formato a modo de recordatorio.</p>
<p><strong>JSON</strong> (Javascript Object Notation) es un formato ligero de intercambio de datos entre clientes y servidores, basado en la sintaxis de Javascript para representar estructuras en forma organizada. Es un formato en texto plano independiente de todo lenguaje de programación, es más, soporta el intercambio de datos en gran variedad de lenguajes</p>
<h4 id="tipos-de-datos-en-json">Tipos de datos en JSON </h4>
<p>Similar a la estructuración de datos primitivos y complejos en los lenguajes de programación, JSON establece varios tipos de datos: <strong><code>cadenas</code></strong>, <strong><code>números</code></strong>, <strong><code>booleanos</code></strong>, <strong><code>arrays</code></strong> y <strong><code>objetos</code></strong>. El propósito es crear objetos que contengan varios atributos compuestos como pares clave valor. Donde la clave es un nombre que identifique el uso del valor que lo acompaña. Veamos un ejemplo:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
   <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
   <span class="token property">"nombre"</span><span class="token operator">:</span> <span class="token string">"Carlos"</span><span class="token punctuation">,</span>
   <span class="token property">"estaActivo"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">"notas"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p>La anterior estructura es un objeto JSON compuesto por los datos de un estudiante. Los objetos JSON contienen sus atributos entre llaves <strong><code>{}</code></strong>, al igual que un bloque de código en Javascript, donde cada atributo debe ir separado por coma <strong><code>,</code></strong> para diferenciar cada par.</p>
<p>La sintaxis de los pares debe contener dos puntos <strong><code>:</code></strong> para dividir la clave del valor. El nombre del par debe tratarse como cadena y añadirle comillas dobles.</p>
<p>Si te fijas en nuestro ejemplo, este trae un ejemplo de cada tipo de dato:</p>
<ul>
<li>
<p><strong><code>id</code></strong> es de tipo entero, ya que contiene un número que representa el código del estudiante.</p>
</li>
<li>
<p><strong><code>nombre</code></strong> es un string. Usa comillas dobles para definirlas.</p>
</li>
<li>
<p><strong><code>estaActivo</code></strong> es un tipo booleano que representa si el estudiante se encuentra en la institución educativa o no. Usa las palabras reservadas <strong><code>true</code></strong> y <strong><code>false</code></strong> para declarar el valor.</p>
</li>
<li>
<p><strong><code>notas</code></strong> es un arreglo de números reales. El conjunto de sus elementos debes incluirlos dentro de corchetes <strong><code>[ ]</code></strong> y separarlos por coma.</p>
</li>
</ul>
<p>La idea es crear un mecanismo que permita recibir la información que contiene la base de datos externa en formato JSON hacia la aplicación. Con ello se parseará cada elemento y será interpretado en forma de objeto Kotlin para integrar correctamente el aspecto en la interfaz de usuario.</p>
<p>Para realizar este proceso podemos utilizar diferentes librerías para la serialización y deserialización de objetos JSON. En este tema nos centraremos en la librería de Google <strong>Gson</strong>, aunque <strong>Retrofit2</strong> es agnóstico a la forma de serializar y también nos permite utilizar otras librerías como <strong>Jackson</strong>, <strong>Moshi</strong>, etc.</p>
<div style="page-break-after:always;"></div>
<h2 id="definición-de-un-servidor-rest-rápido-para-pruebas">Definición de un Servidor Rest rápido para pruebas </h2>
<div class="admonition info">
<p class="admonition-title">Código de los ejemplos</p>
<p>Si te surge alguna duda o tienes dificultades para completar este tema. Puedes descargar el proyecto con el código de mismo del siguiente enlace: <strong><a href="0_AgendaRetrofit_recurso.zip">Proyecto ejemplos</a></strong></p>
</div>
<p>Una forma rápida de <strong>definir una API Rest rápido</strong> para probar desde Android, es mediante la librería de PHP proporcionada en el módulo de Acceso a datos <strong><a href="apiRest-PHP-Session_recurso.zip">apiRest-PHP-Session.zip</a></strong>.</p>
<div class="flotante" ,="" style="align-items: center;">
<div class="flotante_izq">
<p>Por si no la has visto en el módulo de Acceso a Datos, vamos a realizar un resumen rápido sobre el uso dicha librería...</p>
<p>Debes instalar un servidor web Apache con PHP y MySQL. En el módulo de Acceso a Datos se ha utilizado <strong>xampp</strong>. En la carpeta <strong><code>xampp\htdocs</code></strong>, o en la carpeta pública de tu servidor web, debes descomprimir el fichero <strong>apiRest-PHP-Session.zip</strong> y renombrar su contenido por ejemplo por la BD que quieras utilizar. Supongamos que queremos crear el servicio de API Rest para la Agenda que hemos ido creando durante el curso. En este caso renombraremos la carpeta <strong><code>apiRest-PHP-Session</code></strong> por agenda como se aprecia a la derecha <strong><code>agenda</code></strong>.</p>
</div>
<div class="flotante_der">
<p align="center" class="puml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SALT" height="153px" preserveAspectRatio="none" style="width:177px;height:153px;background:#FFFFFF;" version="1.1" viewBox="0 0 177 153" width="177px" zoomAndPan="magnify"><defs></defs><g><rect fill="#EEEEEE" height="18.0938" style="stroke:#000000;stroke-width:1;" width="63" x="6" y="6"></rect><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="12.6621" x="8" y="20.457">C:</text><line style="stroke:#000000;stroke-width:1;" x1="58" x2="58" y1="6" y2="24.0938"></line><polygon fill="#000000" points="61,12,67,12,64,19.0938" style="stroke:#000000;stroke-width:1;"></polygon><path d="M17,31.1875 L17,32.1875 L25,32.1875 L25,31.1875 L17,31.1875 M17,33.1875 L17,39.0975 C17,39.1475 17.04,39.1875 17.09,39.1875 L24.9,39.1875 C24.95,39.1875 24.99,39.1475 24.99,39.0975 L24.99,33.1875 L22.02,33.1875 L22.02,34.2175 L19.99,34.2175 L19.99,33.1875 L16.99,33.1875" fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="85.3535" x="26" y="39.5508">[SERVIDORES]</text><path d="M27,46.2813 L27,47.2813 L35,47.2813 L35,46.2813 L27,46.2813 M27,48.2813 L27,54.1913 C27,54.2413 27.04,54.2813 27.09,54.2813 L34.9,54.2813 C34.95,54.2813 34.99,54.2413 34.99,54.1913 L34.99,48.2813 L32.02,48.2813 L32.02,49.3113 L29.99,49.3113 L29.99,48.2813 L26.99,48.2813" fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="42.6855" x="36" y="54.6445">[xampp]</text><path d="M37,61.375 L37,62.375 L45,62.375 L45,61.375 L37,61.375 M37,63.375 L37,69.285 C37,69.335 37.04,69.375 37.09,69.375 L44.9,69.375 C44.95,69.375 44.99,69.335 44.99,69.285 L44.99,63.375 L42.02,63.375 L42.02,64.405 L39.99,64.405 L39.99,63.375 L36.99,63.375" fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="42.0234" x="46" y="69.7383">[htdocs]</text><path d="M47,76.4688 L47,77.4688 L55,77.4688 L55,76.4688 L47,76.4688 M47,78.4688 L47,84.3788 C47,84.4288 47.04,84.4688 47.09,84.4688 L54.9,84.4688 C54.95,84.4688 54.99,84.4288 54.99,84.3788 L54.99,78.4688 L52.02,78.4688 L52.02,79.4988 L49.99,79.4988 L49.99,78.4688 L46.99,78.4688" fill="#0000FF"></path><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="50.0039" x="56" y="84.832">[agenda]</text><path d="M57,91.5625 L57,92.5625 L65,92.5625 L65,91.5625 L57,91.5625 M57,93.5625 L57,99.4725 C57,99.5225 57.04,99.5625 57.09,99.5625 L64.9,99.5625 C64.95,99.5625 64.99,99.5225 64.99,99.4725 L64.99,93.5625 L62.02,93.5625 L62.02,94.5925 L59.99,94.5925 L59.99,93.5625 L56.99,93.5625" fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="22.0078" x="66" y="99.9258">[inc]</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="50.6895" x="56" y="115.0195">.htaccess</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="114.0703" x="56" y="130.1133">apirest_variables.php</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="52.043" x="56" y="145.207">index.php</text><rect fill="none" height="2" style="stroke:#888888;stroke-width:1;" width="2" x="9" y="33.6406"></rect><rect fill="none" height="2" style="stroke:#888888;stroke-width:1;" width="2" x="19" y="48.7344"></rect><line style="stroke:#888888;stroke-width:1;" x1="10" x2="10" y1="36.6406" y2="49.7344"></line><line style="stroke:#888888;stroke-width:1;" x1="10" x2="18" y1="49.7344" y2="49.7344"></line><rect fill="none" height="2" style="stroke:#888888;stroke-width:1;" width="2" x="29" y="63.8281"></rect><line style="stroke:#888888;stroke-width:1;" x1="20" x2="20" y1="51.7344" y2="64.8281"></line><line style="stroke:#888888;stroke-width:1;" x1="20" x2="28" y1="64.8281" y2="64.8281"></line><rect fill="none" height="2" style="stroke:#888888;stroke-width:1;" width="2" x="39" y="78.9219"></rect><line style="stroke:#888888;stroke-width:1;" x1="30" x2="30" y1="66.8281" y2="79.9219"></line><line style="stroke:#888888;stroke-width:1;" x1="30" x2="38" y1="79.9219" y2="79.9219"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="40" y1="81.9219" y2="95.0156"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="48" y1="95.0156" y2="95.0156"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="40" y1="81.9219" y2="110.1094"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="48" y1="110.1094" y2="110.1094"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="40" y1="81.9219" y2="125.2031"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="48" y1="125.2031" y2="125.2031"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="40" y1="81.9219" y2="140.2969"></line><line style="stroke:#888888;stroke-width:1;" x1="40" x2="48" y1="140.2969" y2="140.2969"></line><!--SRC=[FP1VQy8m5CNVyodkqz0CYtOwN1WYq-wFM2Qc-Y8wqZRJG4rASYiEsNTVh4xkq_cTS-zDxj2XiEX4WUH4DfIE6AKRGau9kOVdkzGS1oiUpPSVuyzvnDVa_aQFOb-MPt0ZEynDvchaMMOAOrbQL79myIbTYQtKkLXJMcTkZKfdwoi9TYYoJ3ftrQ9KLZhyEWYhH5f85vIxykefdSjZhNzz3Vte-XjaLWYDYtWA1scTCXewGTWEUq6tmGN2fD8Gzg7pmDfFBEp1AE89dFqcQRpDfk1CPJC9kN9eLLgX7z0a4t4GCAyqghraS5QD96u2Z_uXHFgWhD5xgP5Cbl4b1Ey6UMcm3ZzsMoyAWKlhtmNBc8pbjwWAzAsPoPNUCbWahwq-cGgzhVof64X7HiOli3yC8lu7]--></g></svg></p></div>
</div>
<p>La configuración de nuestro API consta de dos archivos:</p>
<ol>
<li>
<p><strong><code>.htaccess</code></strong> En este archivo se configuran las reglas de acceso, y solo deberemos modificar la línea <strong><code>RewriteBase</code></strong> para indicar la ruta de acceso a la carpeta de nuestro API. En nuestro caso cambiaremosel valos de la cadena <strong><code>"/apirest-session/"</code></strong> por <strong><code>"/agenda/"</code></strong>.</p>
<pre data-role="codeBlock" data-info="bash { highlight=[2,6] }" class="language-bash bash" data-line="2,6"><code>RewriteEngine On
RewriteBase <span class="token string">"/apirest-session/"</span>
<span class="token punctuation">..</span>.

RewriteEngine On
RewriteBase <span class="token string">"/agenda/"</span>
<span class="token punctuation">..</span>.
</code><div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="2">
<li>
<p><strong><code>apirest_variables.php</code></strong>, en este archivo se definen los  datos de conexión a la base de datos. se indican las tablas que tiene esta y el nombre del identificador de cada una de ellas.</p>
<pre data-role="codeBlock" data-info="php" class="language-php php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

    <span class="token comment">// CONFIGURACIÓN BASE DE DATOS MYSQL</span>
    <span class="token variable">$servername</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"root"</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    
    <span class="token comment">// BASE DE DATOS</span>
    <span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"agenda"</span><span class="token punctuation">;</span>

    <span class="token comment">// ACCESO USUARIOS (si está vacío funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// $usuarios["juanjo"]="_IesBalmis1";</span>
    <span class="token comment">// $usuarios["xusa"]="_IesBalmis2";</span>
    <span class="token comment">// $usuarios["pepe"]="_IesBalmis3";</span>
    
    <span class="token comment">// TABLAS Y SU CLAVE</span>
    <span class="token variable">$tablas</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tablas</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"contactos"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">;</span>
</span></code></pre></li>
</ol>
<p>El resto de archivos del ApiREst <strong>no tendrán que modificars</strong>e, ya que está construida de forma genérica con las necesidades más comunes para estos casos.</p>
<div style="page-break-after:always;"></div>
<h3 id="creando-la-base-de-datos-con-phpmyadmin">Creando la Base de Datos con phpMyAdmin </h3>
<p>Para crear la base de datos con <strong><code>phpMyAdmin</code></strong>, deberemos crear una base de datos y para ello pudes bajarte el siguiente <strong><a href="agenda_mysql_recurso.zip">recurso</a></strong> en él encontrará el archivo <strong><code>agenda_mysql_datos.sql</code></strong> que contiene el script de creación de la base de datos, incluyendo las imágenes de ejemplo en formato <strong><code>blob</code></strong> (base64).</p>
<div class="galeria_imagenes">
    <img height="" src="assets/imagenes/tema_5_2/agenda.png">
</div>
<p>Para acceder a <strong><code>phpMyAdmin</code></strong> debes ir a la url <strong><code>http://localhost/phpmyadmin/</code></strong> y ejercutar <strong><code>agenda_mysql_datos.sql</code></strong> en la pestaña SQL. Tras hacerlo, te debe aparecer la base de datos <strong><code>agenda</code></strong> con la tabla <strong><code>contactos</code></strong> como se muestra en la imagen de ejemplo.</p>
<p>Puedes probar que el API está funcionando correctamente, abriendo un navegador y accediendo a la url <strong><code>http://localhost/agenda/</code></strong>. Si todo ha ido bien, deberías ver una página como la siguiente:</p>
<div class="galeria_imagenes">
    <img height="" src="assets/imagenes/tema_5_2/agenda_api.png">
</div>
<div style="page-break-after:always;"></div>
<h2 id="consumo-de-un-servicio-rest-desde-android">Consumo de un Servicio Rest desde Android </h2>
<p>Como ya hemos comentado, existen diferentes librerías que nos permitirían consumir los servicios desde la App de Android, pero dada su facilidad vamos a utilizar las librerías: <strong>Retrofit2</strong> y <strong>Gson</strong>.</p>
<p><strong>Retrofit</strong> la utilizaremos para hacer peticiones http y procesar las respuestas del API Rest, mientras que con <strong>Gson</strong> transformaremos los datos de JSON a los propios que utilice la aplicación.</p>
<h3 id="configuración-del-proyecto">Configuración del proyecto </h3>
<p>Para poder utilizar Retrofit y Gson en nuestro proyecto, deberemos añadir:</p>
<p>En el catálogo de versiones <strong><code>lib.versions.toml</code></strong> deberemos comprobar que hemos definido tener:</p>
<pre data-role="codeBlock" data-info="toml" class="language-toml toml"><code><span class="token punctuation">[</span><span class="token table class-name">versions</span><span class="token punctuation">]</span>
<span class="token key property">retorfit</span> <span class="token punctuation">=</span> <span class="token string">"2.11.0"</span>
<span class="token key property">okhttp3</span> <span class="token punctuation">=</span> <span class="token string">"4.12.0"</span>

<span class="token punctuation">[</span><span class="token table class-name">libraries</span><span class="token punctuation">]</span>
<span class="token key property">com-squareup-retrofit2-converter-gson</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.retrofit2"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"converter-gson"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"retorfit"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-retrofit2-retrofit</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.retrofit2"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"retrofit"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"retorfit"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-okhttp-bom</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"okhttp-bom"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"okhttp3"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-okhttp</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"okhttp"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-logging-interceptor</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"logging-interceptor"</span> 
<span class="token punctuation">}</span>
</code></pre><p>Acuérdate de escribir en una sola línea la definición de las librerías.</p>
<p>En el fichero <strong><code>build.gradle.kts</code></strong> del módulo de la aplicación:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>dependencies <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>retrofit2<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>gson<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>retrofit2<span class="token punctuation">.</span>retrofit<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">platform</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>bom<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>okhttp<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>interceptor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>En el archivo <strong><code>AndroidManifest.xml</code></strong> deberemos añadir el permiso de acceso a internet para que el servicio pueda acceder al API.</p>
<pre data-role="codeBlock" data-info="xml {highlight=[3-5,9]}" class="language-xml xml" data-line="3-5,9"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_NETWORK_STATE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_WIFI_STATE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Permitir tráfico http en lugar de https --&gt;</span>
        android:usesCleartextTraffic="true"
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code><div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3-5" data-start="3" data-end="5">


</div></div><div class="line-highlight-wrapper">







<div aria-hidden="true" class="line-highlight" data-range="9" data-start="9">
</div></div></pre><div style="page-break-after:always;"></div>
<h3 id="crear-los-servicios-con-retrofit">Crear los servicios con Retrofit </h3>
<p>En la paquete <strong><code>data</code></strong> crearemos un nuevo paquete llamado <strong><code>data.services</code></strong> donde definiremos los API de cara uno de nuestro '<em>endpoint</em>'.</p>
<h4 id="definiendo-los-tipos-a-serializar-a-json">Definiendo los tipos a serializar a JSON </h4>
<p>Para cada una de las clases que se van a transferir en las peticiones crearemos un fichero <strong><code>&lt;Tipo&gt;Api.kt</code></strong>.</p>
<ol>
<li>
<p>Definiremos la clase <strong><code>ContactoApi</code></strong> que será la que se utilizará para transferir los datos de los contactos entre el servidor y la aplicación. Fíjate que los atributos de la clase tienen que tener el mismo nombre que los campos que se devuelven en el JSON del API Rest. Si quisiéramos cambiar el nombre de alguna propiedad, deberemos utilizar la anotación <strong><code>@SerializedName</code></strong> justo antes de la propiedad para indicar el nombre que tiene en el JSON. Puedes obtener más información sobre trasformaciones de en la <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">documentación de la librería</a></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4]}" class="language-kotlin kotlin" data-line="4"><code><span class="token comment">// ContactoApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"nombre"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> telefono<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> email<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> foto<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> categorias<span class="token operator">:</span> String
<span class="token punctuation">)</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre></li>
<li>
<p>La librería de PHP que estamos usando, en la peticiones de tipo <strong>POST</strong>, <strong>PUT</strong> y <strong>DELETE</strong>, nos devuelve una respuesta en JSON con campos de información sobre la petición, por tanto, deberemos definir un objetos para su deserialización.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token comment">// RespuestaApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaApi</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> respuesta <span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> metodo<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> mensaje<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlQuery<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlError<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
<span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Por último, las petición <strong><a href="http://localhost/agenda/contactos/count">http://localhost/agenda/contactos/count</a></strong> devuelve un número de contactos en un JSON especial, por lo que deberemos definir un objeto para su deserialización.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token comment">// TotalRegistrosApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">TotalRegistrosApi</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tabla"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"total_registros"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> totalRegistros<span class="token operator">:</span> Int
<span class="token punctuation">)</span>
</code></pre></li>
</ol>
<h4 id="definiendo-las-peticiones-para-consumo-del-endpoint">Definiendo las peticiones para consumo del '<em>endpoint</em>' </h4>
<p>Para cada una de las peticiones que se vayan a realizar al API Rest, crearemos una interfaz con el nombre de la clase del API, en nuestro caso <strong><code>ContactoApi</code></strong> y le añadiremos el sufijo <strong><code>Service</code></strong>. Pot tanto, vamos a definir un interface llamado <strong><code>ContactoService</code></strong>.</p>
<p>Definiremos pues la signatura de cada uno delos métodos que se van a utilizar para realizar las peticiones Para ello utilizaremos diferentes anotaciones para indicar el tipo de petición, la url del API Rest, el tipo de datos que se envía y el tipo de datos que se recibe.</p>
<p>Por ejemplo, para la petición <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos, deberemos añadir...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><ol>
<li>La anotación  <strong><code>@GET</code></strong> con la url <strong><code>contactos</code></strong> que completaría la URL base al definir el objeto de Retrofit que será <strong><code>http://localhost/agenda/</code></strong>.</li>
<li>La anotación <strong><code>@Headers</code></strong> que incluirá en la cabecera de la petición HTTP los valores <strong><code>Accept</code></strong> y <strong><code>Content-Type</code></strong> para indicar que se envía y se espera recibir JSON en el <strong>body</strong>.</li>
<li>Por último, definiremos la signatura del método que será de suspensión <strong><code>suspend</code></strong> y devolverá un objeto de tipo <strong><code>Response</code></strong> que contendrá una lista de objetos de tipo <strong><code>ContactoApi</code></strong> ya deserializados si la respuesta es correcta.</li>
</ol>
<p>En el caso de que la respuesta en el body no sea un objeto del tipo <strong><code>ContactoApi</code></strong> como el caso de la petición <strong><code>http://localhost/agenda/contactos/count</code></strong> que devuelve un objeto del tipo <strong><code>TotalRegistrosApi</code></strong>, <strong><code>Response</code></strong> irá parametrizado con este tipo para la correcta deserialización.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/count"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>TotalRegistrosApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>Podremos poner también el valor de un parámetro en la URL con la anotación <strong><code>@Path</code></strong>, así como serializar en el '<em>body</em>' de la petición un objeto con <strong><code>@Body</code></strong>. Por ejemplo, para la petición <strong><code>@PUT</code></strong> a nuestro Api con PHP tenemos que indicar el <strong>id</strong> del contacto a actualizar <strong><code>http://localhost/agenda/contactos/1</code></strong> y en el cuerpo de la petición el objeto <strong><code>ContactoApi</code></strong> con los datos a actualizar. Fíjate además que la respuesta que parametrizamos en el objeto <strong><code>Response</code></strong> es del tipo <strong><code>RespuestaApi</code></strong> que definimos anteriormente. Nuestro prototipo de método <strong><code>update</code></strong> quedaría de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@PUT</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>También podemos establecer parámetros en el <strong>QUERYSTRING</strong> de la URL con la anotación <strong><code>@Query</code></strong>. Por ejemplo, para la petición <strong><code>http://localhost/agenda/contactos/id/?desde=3&amp;hasta=5</code></strong> que devuelve un <strong>listado de contactos con id entre 3 y 5</strong>. Nuestro prototipo de método <strong><code>contactosDesdeHasta</code></strong> quedaría de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/id/"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactosDesdeHasta</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"desde"</span></span><span class="token punctuation">)</span> desde<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"hasta"</span></span><span class="token punctuation">)</span> hasta<span class="token operator">:</span> Int
    <span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</code></pre><p>Con lo visto ya podemos definir el resto de métodos HTTP que necesitemos para nuestro API Rest. En nuestro caso, nos quedan por definir los siguientes los siguientes ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contacto</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@POST</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@DELETE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h3 id="preparando-los-objetos-de-retrofit-con-hilt">Preparando los objetos de Retrofit con Hilt </h3>
<p>En el fichero <strong><code>.di/AppModule.kt</code></strong> deberemos definir como crear los objetos a inyectar de Retrofit.</p>
<ol>
<li>
<p>Primero definimos como crear el objeto <strong><code>OkHttpClient</code></strong>, para ello usaremos <strong><code>OkHttpClient.Builder()</code></strong>. En este caso le añadiremos un <strong>interceptor</strong> o ('<em>hook</em>') para poder depurar, a través de Logcat de Android Studio, el contenido de las peticiones y respuestas HTTP que se realizan. Fíjate que el nivel de log que le hemos indicado es <strong><code>HEADERS</code></strong>, esto es porque no queremos que se muestre la cabecera sin el cuerpo de la petición. Además, le hemos indicado un tiempo de espera ('<em>TIMEOUT</em>') de <strong>10 segundos</strong> para las peticiones después de los cuales se cancelará la petición y se producirá una excepción de tipo <strong><code>SocketTimeoutException</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div style="page-break-after:always;"></div>
</li>
<li>
<p>Ahora definiremos el objeto <strong><code>Retrofit</code></strong>  que es el que usaremos realmente para realizar las peticiones HTTP y procesar las respuestas del API Rest. Al mismo le pasaremos:</p>
<ul>
<li>El objeto <strong><code>OkHttpClient</code></strong> que hemos creado anteriormente y que le llega a través de la inyección.</li>
<li>La url base del API Rest, en nuestro caso <strong><code>http://10.0.2.2/agenda/</code></strong>. Fíjate que la dirección no es <strong><code>localhost</code></strong> o <strong><code>127.0.0.1</code></strong> ya que, cómo estamos accediendo desde el dispositivo emulador para él el <strong><code>localhost</code></strong> es el propio dispositivo Android emulado y no el equipo donde está el servidor web. AVD (Android Virtual Device) proporciona una dirección IP especial <strong><code>10.0.2.2</code></strong> que nos permite acceder al equipo donde está el servidor web.</li>
</ul>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideRetrofit</span><span class="token punctuation">(</span>
    okHttpClient<span class="token operator">:</span> OkHttpClient
<span class="token punctuation">)</span> <span class="token operator">:</span> Retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>okHttpClient<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"http://10.0.2.2/agenda/"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Por último, <strong>indicaremos a Hilt como instanciar el o los objetos de <code>&lt;enpoint&gt;Service</code></strong> que es el que realmente utilizaremos para realizar las peticiones al API Rest. Para ello le pasaremos el objeto <strong><code>Retrofit</code></strong> que hemos creado anteriormente y que le llega a través de la inyección. En nuestro caso solo vamos a definir como instanciar un objeto que implemente la interfaz <strong><code>ContactoService</code></strong> que utilizaremos para realizar las peticiones al API Rest de la Agenda que esl único '<em>endpoint</em>' definido.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideContactoService</span><span class="token punctuation">(</span>
    retrofit<span class="token operator">:</span> Retrofit
<span class="token punctuation">)</span> <span class="token operator">:</span> ContactoService <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ContactoService<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<h3 id="implementaciones-de-la-gestión-del-consumo-de-nuestro-endpoint">Implementaciones de la gestión del '<em>consumo</em>' de nuestro endpoint </h3>
<p>Aunque <strong>este paso intermedio no es de todo necesario</strong> y no lo vamos a ver en muchos ejemplos de uso de Retrofit. Si que <strong>es recomendable para gestionar correctamente los errores y los logs de depuración que se puedan producir</strong> al consumir nuestro API Rest y simplificar el código de uso de uso de Retrofit en nuestro patrón Repository.</p>
<p>Primero definiremos la clase <strong><code>ApiServicesException</code></strong> que será la que utilizaremos para lanzar las excepciones que se produzcan al consumir el API Rest.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensaje<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Exception</span><span class="token punctuation">(</span>mensaje<span class="token punctuation">)</span>
</code></pre><p>Posteriormente, definiremos para ello una clase denominada <strong><code>ContactoServiceImplementation</code></strong> a la que le inyectaremos una instancia de <strong><code>ContactoService</code></strong> que es la que realmente utilizaremos para realizar las peticiones al API Rest.</p>
<p>Veamos la anatomía de uso de Retrofit para <strong>obtener la lista de contactos</strong> del API Rest en esta clase comentado paso por paso...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[5,6,11,15-20,24-27,33-36]}" class="language-kotlin kotlin" data-line="5,6,11,15-20,24-27,33-36"><code><span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-class">class</span> ContactoServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Propiedad privada cte. donde definimos el tag para los logs</span>
    <span class="token comment">// de depuración de las peticiones.</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se han podido obtener los contactos"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Obtenemos la respuesta HTTP Response&lt;List&lt;ContactoApi&gt;&gt;</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// Si la respuesta tiene un estatus 2xx (200, 201, 202, etc.)</span>
                <span class="token comment">// Obtenemos con response.body los datos List&lt;ContactoApi&gt; </span>
                <span class="token comment">// ya deserializados de JSON contenidos en el cuerpo de la misma.</span>
                <span class="token comment">// Si no hay datos porque el resultado de la serialización </span>
                <span class="token comment">// es null o el cuerpo estaba vacío. Entonces, lanzamos un </span>
                <span class="token comment">// error indicando que no hay datos.</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// sino entonces la respuesta HTTP tiene un estatus de error y por</span>
                <span class="token comment">// tanto obtendré el mensaje de error del body de la respuesta</span>
                <span class="token comment">// y lanzaremos un error genérico, enviando al al mismo tiempo el</span>
                <span class="token comment">// mensaje generado al Log.</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Si ha habido algún error al deserializar el JSON</span>
            <span class="token comment">// o también si ha habido algún error al realizar la petición por</span>
            <span class="token comment">// ejemplo por falta de conexión a internet, o se ha </span>
            <span class="token comment">// producido un TIMEOUT, etc.</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... resto de la implementación de las llamadas al Servicio Rest</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5" data-start="5">
</div></div><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div><div class="line-highlight-wrapper">









<div aria-hidden="true" class="line-highlight" data-range="11" data-start="11">
</div></div><div class="line-highlight-wrapper">













<div aria-hidden="true" class="line-highlight" data-range="15-20" data-start="15" data-end="20">





</div></div><div class="line-highlight-wrapper">






















<div aria-hidden="true" class="line-highlight" data-range="24-27" data-start="24" data-end="27">



</div></div><div class="line-highlight-wrapper">































<div aria-hidden="true" class="line-highlight" data-range="33-36" data-start="33" data-end="36">



</div></div></pre><p>Siguiendo el esquema anterior, <strong>obtener un contacto por ID</strong> quedaría...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,8]}" class="language-kotlin kotlin" data-line="4,8"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> ContactoApi <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se han podido obtener el contacto con id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">id</span></span><span class="token string">"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contacto</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div></pre><p>Para <strong>insertar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,7-9]}" class="language-kotlin kotlin" data-line="4,7-9"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"No se ha podido añadir el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// Aquí response.body() es un objeto de tipo RespuestaApi </span>
            <span class="token comment">// que simplemente logeamos si no es null.</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7-9" data-start="7" data-end="9">


</div></div></pre><p>Para <strong>actualizar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4-6]}" class="language-kotlin kotlin" data-line="4-6"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se ha podido actualizar el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// En este método el API de PHP espera recibir el id del contacto</span>
        <span class="token comment">// que también lo podemos obtener del objeto contacto que le pasamos</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span>id<span class="token punctuation">,</span> contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4-6" data-start="4" data-end="6">


</div></div></pre><p>Para <strong>borrar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se ha podido borrar el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h3 id="usando-nuestra-implementación-del-servicio-en-el-patrón-repository">Usando nuestra implementación del servicio en el patrón Repository </h3>
<p>Al igual que sucedía con las anteriores fuentes como los objetos Mock de prueba o las entidades de room. Deberemos definir en <strong><code>RepositoryConverters.kt</code></strong> las funciones de extensión para convertir los objetos de tipo <strong><code>ContactoApi</code></strong> en objetos de tipo <strong><code>Contacto</code></strong> y viceversa.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-fun">fun</span> Contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword keyword-fun">fun</span> ContactoApi<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Contacto</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre><p>Por último, en el fichero <strong><code>ContactoRepository.kt</code></strong> deberemos inyectar la implementación de nuestro servicio <strong><code>ContactoServiceImplementation</code></strong> y utilizarlo en las funciones de nuestro patrón Repository.</p>
<div class="admonition tip">
<p class="admonition-title">Impoatante</p>
<p>Cualquier error que se produzca ya lo resolveremos en el <strong>ViewModel</strong> como sucedía con <strong>room</strong>.</p>
</div>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> ContactoRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Contacto<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Contacto <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h4 id="acceder-a-la-api-iniciando-una-sesión-en-el-servidor">Acceder a la API iniciando una sesión en el servidor </h4>
<p>Si queremos incrementar la seguridad del acceso a nuestra APIRest, podemos <strong>iniciar una sesión en el servidor</strong> con determinadas credenciales. Tran enviar la petición de '<em>login</em>', capturaremos la '<em>cookie</em>' que nos devuelve con el id de la sesión y usaremos esta misma cookie para poder acceder al resto de funcionalidades del APIRest. Para habilitar la autenticación a traves del uso de sesiones en nuestro APIRest con PHP, volveremos a editar el archivo <strong><code>apirest_variables.php</code></strong> y descomentaremos las siguientes líneas donde definimos los usuarios y sus contraseñas.</p>
<pre data-role="codeBlock" data-info="php {highlight=6-8}" class="language-php php" data-line="6-8"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token operator">...</span>

    <span class="token comment">// ACCESO USUARIOS (si está vacío funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"juanjo"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis1"</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xusa"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis2"</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pepe"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis3"</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>    
</span></code><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div></pre><p>Tras ello, entremos donde entremos a nuestro API en <strong><code>http://localhost/agenda/</code></strong> nos pedirá que iniciemos sesión con un usuario y contraseña indicándonos como debemos hacerlo con la siguiente pantalla...</p>
<div class="galeria_imagenes">
    <img height="350" src="assets/imagenes/tema_5_2/agenda_api_sesion.png">
</div>
<div style="page-break-after:always;"></div>
<p>Si nos fijamos en la ayuda para autenticarnos necesitamos enviar una petición <strong><code>GET</code></strong> a la url <strong><code>http://localhost/agenda/?usu=&lt;usuario&gt;&amp;pass=&lt;password&gt;</code></strong>. Por tanto, deberemos definir un nuevo servicio en nuestro APIRest llamado <strong><code>AutenticacionService</code></strong> en el paquete <strong><code>.data.services.autenticacion</code></strong> que nos permita realizar esta petición y la de cerrar la sesión como mínimo.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> AutenticacionService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"."</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"usu"</span></span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"pass"</span></span><span class="token punctuation">)</span> password <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"."</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"logout"</span></span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>En ambos casos la respuesta del APIRest será un objeto del tipo <strong><code>RespuestaAutenticacionApi</code></strong> que definiremos como...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaAutenticacionApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> mensaje <span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> usuario <span class="token operator">:</span> String
<span class="token punctuation">)</span>
</code></pre><p>y que nos devolverá un mensaje de error o de éxito y el usuario que ha iniciado la sesión o null si no se ha podido iniciar la sesión.</p>
<p>A la hora de realizar la implementación de este servicio de <strong>login</strong>...</p>
<pre data-role="codeBlock" data-info="txt  {highlight=1}" class="language-txt txt" data-line="1"><code>--&gt; GET http://10.0.2.2/agenda/?usu=juanjo&amp;pass=_IesBalmis1
Accept: application/json
Content-Type: application/json
--&gt; END GET
</code><div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="1" data-start="1">
</div></div></pre><p>deberemos tener en cuenta que en la cabecera de la respuesta del APIRest <strong>se nos devuelve una cookie con el id de la sesión que deberemos almacenar</strong> del algún modo para poder acceder al resto de funcionalidades del APIRest. En nuestro caso el valor de esa cookie se encuentra en la cabecera <strong><code>Set-Cookie</code></strong> y es <strong><code>PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o</code></strong>. Sin tener en cuenta que podrían llegar otras cookies en en esta misma cabecera.</p>
<pre data-role="codeBlock" data-info="txt {highlight=[5-6]}" class="language-txt txt" data-line="5-6"><code>&lt;-- 200 OK http://10.0.2.2/agenda/?usu=juanjo&amp;pass=_IesBalmis1 (18ms)
Date: ...
Server: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.2.4
X-Powered-By: PHP/8.2.4
Set-Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
Expires: Fecha de expiración de la Cookie
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 59
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/json; charset=utf-8
&lt;-- END HTTP
</code><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5-6" data-start="5" data-end="6">

</div></div></pre><p>Para ello, podemos definir <strong>una propiedad estática pública</strong> en la clase <strong><code>AutenticacionServiceImplementation</code></strong> que almacenará la cookie de la sesión.</p>
<pre data-role="codeBlock" data-info="kotlin { highlight=[6-8, 22] }" class="language-kotlin kotlin" data-line="6-8,22"><code><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>

    <span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> cookie<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al loguear a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">userName</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                cookie <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div><div class="line-highlight-wrapper">




















<div aria-hidden="true" class="line-highlight" data-range="22" data-start="22">
</div></div></pre><div style="page-break-after:always;"></div>
<p>Esta cookie la utilizaremos en el resto de peticiones que realicemos al APIRest. Para ello, deberemos añadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la petición <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos la petición HTTP debería ser...</p>
<pre data-role="codeBlock" data-info="txt {highlight=4}" class="language-txt txt" data-line="4"><code>--&gt; GET http://10.0.2.2/agenda/contactos
Accept: application/json
Content-Type: application/json
Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
--&gt; END GET
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre><p>Para ello, deberíamos modificar la interfaz <strong><code>ContactoService</code></strong> y añadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la petición GET a esa ruta será ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token annotation builtin">@Header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Cookie"</span></span><span class="token punctuation">)</span> cookie <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</code></pre><p>Fíjate que hemos añadido la anotación <strong><code>@Header</code></strong> para indicar que el valor de la cabecera <strong><code>Cookie</code></strong> se obtendrá del parámetro <strong><code>cookie</code></strong> que le pasamos al método y por tanto deberemos añadirlo en la llamada al método que hacíamos desde el <strong><code>ContactoServiceImplementation</code></strong>.</p>
<p>El problema de esto es que, como hemos mencionado, <strong>deberemos hacer lo mismo en todas las peticiones de todos servicios a '<em>endpoints</em>' que hayamos definido</strong> y pasarlo en todas las llamadas a los métodos de los servicios en las implementaciones de los mismos.</p>
<p>Para evitar hacer esto, podemos definir un <strong>interceptor</strong> o ('<em><strong>hook</strong></em>') que se ejecutará antes de realizar la petición y que añadirá la cabecera <strong><code>Cookie</code></strong> a la petición. Para ello, podemos seguir los siguientes pasos:</p>
<ol>
<li>
<p>En el paquete <strong><code>services</code></strong> vamos a crear un nuevo paquete llamado <strong><code>services.interceptors</code></strong> donde definiremos el interceptor que se encargará de guardar la cookie de la sesión y el de añadirla a las peticiones que se realicen al APIRest.</p>
</li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada AlmacenDeCookies guardará en un <strong><code>HashSet</code></strong> las cookies que se vayan recibiendo en las respuestas del APIRest. Hilts nos permitirá inyectar un objeto único esta clase en los interceptores que definamos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-class">class</span> AlmacenDeCookies <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span>  <span class="token operator">=</span> cookies
    <span class="token keyword keyword-fun">fun</span> <span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>cookies <span class="token operator">=</span> cookies
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>ReciveCookiesInterceptor</code></strong> que implementará el interfaz <strong><code>Interceptor</code></strong> y se encargará de <strong>preprocesar cualquier respuesta del servidor y guardar las cookies recibidas</strong> en la cabecera <strong><code>Set-Cookie</code></strong>, incluida la de la sesión, en el objeto <strong><code>AlmacenDeCookies</code></strong> invalidando el método <strong><code>intercept</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin kotlin" data-line=""><code><span class="token keyword keyword-class">class</span> <span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Procesamos la respuesta actual            </span>
        <span class="token keyword keyword-val">val</span> originalResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// Extraemos de ella las cookies de la cabecera Set-Cookie</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>header <span class="token keyword keyword-in">in</span> originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cookies<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            almacenDeCookies<span class="token punctuation">.</span><span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Devolvemos la respuesta original</span>
        <span class="token keyword keyword-return">return</span> originalResponse
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="4">
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>EnviaCookiesInterceptor</code></strong> que implementará el interfaz <strong><code>Interceptor</code></strong> y se encargará de <strong>preprocesar cualquier petición al servidor y añañdir las cookies guardadas</strong> en el objeto <strong><code>AlmacenDeCookies</code></strong> a la cabecera <strong><code>Cookie</code></strong> de la petición, incluida la de la sesión.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin kotlin" data-line=""><code><span class="token keyword keyword-class">class</span> <span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Builder con el contenido de la peticion original</span>
        <span class="token keyword keyword-val">val</span> builder <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> almacenDeCookies<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>cookie <span class="token keyword keyword-in">in</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Añadimos las cookies a la cabecera Cookie de la </span>
                <span class="token comment">// peticion en el builder</span>
                builder<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Cookie"</span></span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Procesamos la peticion con las cookies añadidas</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="5">
<li>
<p>Redefinimos <strong><code>provideOkHttpClient</code></strong> inyectando el objeto <strong><code>AlmacenDeCookies</code></strong> y añadiendo los interceptores que hemos definido en el builder de nuestro cliente.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4, 11-15]}" class="language-kotlin kotlin" data-line="4,11-15"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span>
    almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// El orden de los interceptores es importante si</span>
        <span class="token comment">// quiero ver la información de las cookies en el log.</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">









<div aria-hidden="true" class="line-highlight" data-range="11-15" data-start="11" data-end="15">




</div></div></pre></li>
</ol>
<p>Tras esto <strong><code>.data/services/autenticacion/AutenticacionService.kt</code></strong> quedará iguál que antes, pero su implementación en <strong><code>.data/services/autenticacion/AutenticacionServiceImplementation.kt</code></strong> ya no necesitará quedarse con la cookie de la sesión...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al loguear a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">userName</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al cerrar sesión"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (código </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Además, tras hacer login, ya podremos seguir usándo nuestro APIRest como lo hacíamos anteriormente  pero sin tener que añadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest.</p>
<p>Una posible implementación de <strong><code>./data/AutenticacionRepository.kt</code></strong> que use la implementación de nuestro servicio podría ser...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> AutenticacionRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
        password<span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
            userName <span class="token operator">=</span> userName<span class="token punctuation">,</span>
            password <span class="token operator">=</span> password
        <span class="token punctuation">)</span><span class="token punctuation">.</span>usuario<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="admonition info">
<p class="admonition-title">Código de los ejemplos</p>
<p>En el siguiente enlace puedes deacargar un proyecto ejemplo con la implementación que acabamos de describir del uso de APIRest en PHP para autenticarnos con la agenda. Para ello, le hemos añadido una pantalla más donde realizar dicha autenticación: <strong><a href="0_AgendaRetrofit_son_sesiones_recurso.zip">Proyecto ejemplo</a></strong></p>
</div>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>