<!DOCTYPE html><html><head>
      <title>PMDM 2&#xBA; DAM  Tema 5.2 - retrofit</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p,html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div{display:inline}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  300px/2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face {
  font-family: "Material Icons";
  font-style: normal;
  font-weight: 400;
  src: local("Material Icons"), local("MaterialIcons-Regular"), url("data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAfIAAsAAAAADDAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7kosY21hcAAAAYAAAADTAAACjtP6ytBnbHlmAAACVAAAAxgAAAQ4zRtvlGhlYWQAAAVsAAAALwAAADYRwZsnaGhlYQAABZwAAAAcAAAAJAeKAzxobXR4AAAFuAAAABIAAAA8OGQAAGxvY2EAAAXMAAAAIAAAACAG5AfwbWF4cAAABewAAAAfAAAAIAEfAERuYW1lAAAGDAAAAVcAAAKFkAhoC3Bvc3QAAAdkAAAAYgAAAK2vz7wkeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkPsQ4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVLy4xKzzX4chhrmK4QpQmBEkBwAZygyweJzFkr0NwjAQhZ+TEP6CRUfHBEwRUWaQTICyQbpMwRCskA5RUIONxG0RnnNpKAIV4qzPku/8c353ACYAYrIjCWCuMAh2ptf0/hiL3p/gyPUWa3osqlt0L1zu9r71z8dGrJRykFoauXQd932Lj5vhG+MjxGeYI8MKETObMpslf5EyP8tg+vHun5r539PvlvXzaVhRFVQDTPEWKVQR90KhnnC5Ek67vUKN4VuFasM/ldARj43CCkCsEjpJSoVVgRyU0GVSK6wUpFFCx8lFgX0BiXpRPQB4nE2TTWjcRhTH3xttpDhxN7uxPlp3u/FK7moRPixafRijNosxSw/LUsIwNcaEHPZggo/FmEKMCKWU4kNOOftQSlhE8alnH0Ix9BqWnHooPRrTQ0+mnu2bXTu2pPdGM9LM/6c3fwECTM4gBBMYQNqxzLrZAjqYSlqu2TAHZQA0/DQJH6FtzqGDnvbt4Ggwvzw/nL8EfH8kW0fsuRqhgWXZnY7M1picaUL7Du5BHeDzMIl83dAt016wH1qmvtSMo5R6YRJHTR//FXsff/nj/tc/5K9P5d+nP22+fFK5u7v3K39SW3y+OtDKO3L85vD09PD9z5X17a2N1g4tqk01RlqX7gyoEmnsWQtVr4rtZMmukEaFBZxzefkCn11cyKMLZgshRwgTYNoLNXCBz2ja7HvZG7hDpPSNfoo5vs0knK/9hb+rNpu+8kHPgk/Ao4kK3tWtTpSEtvkA9c+wE6UaUdwieNkaHg55tBEtRiEPw1s0+FtrtTcc9two2lhMknV7PZF/cs6+uUFTmpTGbEx7sQCPSLOttHS3GRltqp7SNzVSKzl6aWnZT/CX5k6/v9N3Hh8fHBwffJVjhrC6OgH5dkIt/tPsq+d/PD5Qz7G7efzq1THFjdZVPe/N6ulQ3JnDWSE5junsFsVIiFwL/htf1S5gJ3BfOcUxfHKLnzqpFpyfZ9cX+/5WB6a+Y0pHpzkNrYNVDwMsikK+y7WuLCRg/oFHkA8VT3rDg5ZnU6ktzzINymV0m74Xd5pfIGXyFeVEQSShkzqG7TBBa2OxVRKitLXv7h3uuftXnXq7lz2tZ/WnWa9dx9dCjDhHzmuVQATlmljr9dZErUydSo2Hbi/b1vXtrOeGCk2/8s3ZlO8+ueJT8BVlw5pGw2oYccdSiHHqx0RlabHqdNR9jAETl6PreJcPBnnfpTLnOQ8C3OV8AmQGzouV1iZdeb5SSIoVc8W8/kcDtksUH5FrU6/aqBqNWcMEzxG4DAQ14qRQhi9mWU0rzepKezbjfgCwQKxVYq5ajRgpRqy45CqwkJydcEkbTkvRz8P5/2ZpDTN4nGNgZGBgAOKb6v+/xvPbfGXgZmEAgeuB2kkI+v8bFgbmKiCXg4EJJAoAPyAKhQB4nGNgZGBg1vmvwxDDwgACQJKRARXwAwAzZQHQeJxjYQCCFAYGFgbSMQAcWACdAAAAAAAAAAwALgBgAIQAmADSAQgBIgE8AVABoAHeAfwCHHicY2BkYGDgZ7BgYGMAASYg5gJCBob/YD4DAA/hAWQAeJxlkbtuwkAURMc88gApQomUJoq0TdIQzEOpUDokKCNR0BuzBiO/tF6QSJcPyHflE9Klyyekz2CuG8cr7547M3d9JQO4xjccnJ57vid2cMHqxDWc40G4Tv1JuEF+Fm6ijRfhM+oz4Ra6eBVu4wZvvMFpXLIa40PYQQefwjVc4Uu4Tv1HuEH+FW7i1mkKn6Hj3Am3sHC6wm08Ou8tpSZGe1av1PKggjSxPd8zJtSGTuinyVGa6/Uu8kxZludCmzxMEzV0B6U004k25W35fj2yNlCBSWM1paujKFWZSbfat+7G2mzc7weiu34aczzFNYGBhgfLfcV6iQP3ACkSaj349AxXSN9IT0j16JepOb01doiKbNWt1ovippz6sVYYwsXgX2rGVFIkq7Pl2PNrI6qW6eOshj0xaSq9mpNEZIWs8LZUfOouNkVXxp/d5woqebeYIf4D2J1ywQB4nG3LOw6AIBAE0B384B+PAkgEa+QwNnYmHt+EpXSal5lkSBBnoP8oCFSo0aCFRIceA0ZMmLFAYSW88rmvtMUjG3RiQ9HvpfusM6zWNmtc5H/iPewha50tOt5PS/QBx2IeSwAA") format("woff");
}

.admonition {
  box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 1px 5px 0 rgba(0, 0, 0, .12), 0 3px 1px -2px rgba(0, 0, 0, .2);
  position: relative;
  margin: 1.5625em 0;
  padding: 0 1.2rem;
  border-left: .4rem solid rgba(68, 138, 255, .8);
  border-radius: .2rem;
  background-color: rgba(255, 255, 255, 0.05);
  overflow: auto;
}

.admonition>p {
  margin-top: .8rem;
}

.admonition>.admonition-title {
  margin: 0 -1.2rem;
  padding: .8rem 1.2rem .8rem 3.6rem;
  border-bottom: 1px solid rgba(68, 138, 255, .2);
  background-color: rgba(68, 138, 255, .1);
  font-weight: 700;
}

.admonition>.admonition-title:before {
  position: absolute;
  left: 1.2rem;
  font-size: 1.5rem;
  color: rgba(68, 138, 255, .8);
  content: "\E3C9";
}

.admonition>.admonition-title:before {
  font-family: Material Icons;
  font-style: normal;
  font-variant: normal;
  font-weight: 400;
  line-height: 2rem;
  text-transform: none;
  white-space: nowrap;
  speak: none;
  word-wrap: normal;
  direction: ltr;
}

.admonition.summary,
.admonition.abstract,
.admonition.tldr {
  border-left-color: rgba(0, 176, 255, .8);
}

.admonition.summary>.admonition-title,
.admonition.abstract>.admonition-title,
.admonition.tldr>.admonition-title {
  background-color: rgba(0, 176, 255, .1);
  border-bottom-color: rgba(0, 176, 255, .2);
}

.admonition.summary>.admonition-title:before,
.admonition.abstract>.admonition-title:before,
.admonition.tldr>.admonition-title:before {
  color: rgba(0, 176, 255, 1);
  ;
  content: "\E8D2";
}

.admonition.hint,
.admonition.tip {
  border-left-color: rgba(0, 191, 165, .8);
}

.admonition.hint>.admonition-title,
.admonition.tip>.admonition-title {
  background-color: rgba(0, 191, 165, .1);
  border-bottom-color: rgba(0, 191, 165, .2);
}

.admonition.hint>.admonition-title:before,
.admonition.tip>.admonition-title:before {
  color: rgba(0, 191, 165, 1);
  content: "\E80E";
}

.admonition.info,
.admonition.todo {
  border-left-color: rgba(0, 184, 212, .8);
}

.admonition.info>.admonition-title,
.admonition.todo>.admonition-title {
  background-color: rgba(0, 184, 212, .1);
  border-bottom-color: rgba(0, 184, 212, .2);
}

.admonition.info>.admonition-title:before,
.admonition.todo>.admonition-title:before {
  color: rgba(0, 184, 212, 1);
  ;
  content: "\E88E";
}

.admonition.success,
.admonition.check,
.admonition.done {
  border-left-color: rgba(0, 200, 83, .8);
}

.admonition.success>.admonition-title,
.admonition.check>.admonition-title,
.admonition.done>.admonition-title {
  background-color: rgba(0, 200, 83, .1);
  border-bottom-color: rgba(0, 200, 83, .2);
}

.admonition.success>.admonition-title:before,
.admonition.check>.admonition-title:before,
.admonition.done>.admonition-title:before {
  color: rgba(0, 200, 83, 1);
  ;
  content: "\E876";
}

.admonition.question,
.admonition.help,
.admonition.faq {
  border-left-color: rgba(100, 221, 23, .8);
}

.admonition.question>.admonition-title,
.admonition.help>.admonition-title,
.admonition.faq>.admonition-title {
  background-color: rgba(100, 221, 23, .1);
  border-bottom-color: rgba(100, 221, 23, .2);
}

.admonition.question>.admonition-title:before,
.admonition.help>.admonition-title:before,
.admonition.faq>.admonition-title:before {
  color: rgba(100, 221, 23, 1);
  ;
  content: "\E887";
}

.admonition.warning,
.admonition.attention,
.admonition.caution {
  border-left-color: rgba(255, 145, 0, .8);
}

.admonition.warning>.admonition-title,
.admonition.attention>.admonition-title,
.admonition.caution>.admonition-title {
  background-color: rgba(255, 145, 0, .1);
  border-bottom-color: rgba(255, 145, 0, .2);
}

.admonition.attention>.admonition-title:before {
  color: rgba(255, 145, 0, 1);
  content: "\E417";
}

.admonition.warning>.admonition-title:before,
.admonition.caution>.admonition-title:before {
  color: rgba(255, 145, 0, 1);
  content: "\E002";
}

.admonition.failure,
.admonition.fail,
.admonition.missing {
  border-left-color: rgba(255, 82, 82, .8);
}

.admonition.failure>.admonition-title,
.admonition.fail>.admonition-title,
.admonition.missing>.admonition-title {
  background-color: rgba(255, 82, 82, .1);
  border-bottom-color: rgba(255, 82, 82, .2);
}

.admonition.failure>.admonition-title:before,
.admonition.fail>.admonition-title:before,
.admonition.missing>.admonition-title:before {
  color: rgba(255, 82, 82, 1);
  ;
  content: "\E14C";
}

.admonition.danger,
.admonition.error,
.admonition.bug {
  border-left-color: rgba(255, 23, 68, .8);
}

.admonition.danger>.admonition-title,
.admonition.error>.admonition-title,
.admonition.bug>.admonition-title {
  background-color: rgba(255, 23, 68, .1);
  border-bottom-color: rgba(255, 23, 68, .2);
}

.admonition.danger>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E3E7";
}

.admonition.error>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E14C";
}

.admonition.bug>.admonition-title:before {
  color: rgba(255, 23, 68, 1);
  content: "\E868";
}

.admonition.example,
.admonition.snippet {
  border-left-color: rgba(0, 184, 212, .8);
}

.admonition.example>.admonition-title,
.admonition.snippet>.admonition-title {
  background-color: rgba(0, 184, 212, .1);
  border-bottom-color: rgba(0, 184, 212, .2);
}

.admonition.example>.admonition-title:before,
.admonition.snippet>.admonition-title:before {
  color: rgba(0, 184, 212, 1);
  ;
  content: "\E242";
}

.admonition.quote,
.admonition.cite {
  border-left-color: rgba(158, 158, 158, .8);
}

.admonition.quote>.admonition-title,
.admonition.cite>.admonition-title {
  background-color: rgba(158, 158, 158, .1);
  border-bottom-color: rgba(158, 158, 158, .2);
}

.admonition.quote>.admonition-title:before,
.admonition.cite>.admonition-title:before {
  color: rgba(158, 158, 158, 1);
  ;
  content: "\E244";
}

/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <style>/* 
Añade 

@import "../EstilosPersonalizadosMarkdownEnhanced.less"

justo después del front matter 
*/
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
</style>
<h1 class="mume-header undefined" id="tema-52---retrofit">Tema 5.2 - Retrofit</h1>

<p>Descargar estos apuntes <a href="./Tema_5_2_retrofit.pdf">pdf</a> o <a href="./Tema_5_2_retrofit.html">html</a></p>
<h2 class="mume-header undefined" id="%C3%ADndice">&#xCD;ndice</h2>


<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#introducci&#xF3;n" class="md-toc-link"><p>Introducci&#xF3;n</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#qu&#xE9;-es-json" class="md-toc-link"><p>&#xBF;Qu&#xE9; es JSON?</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#tipos-de-datos-en-json" class="md-toc-link">
            <p>Tipos de datos en JSON</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#definici&#xF3;n-de-un-servidor-rest-r&#xE1;pido-para-pruebas" class="md-toc-link"><p>Definici&#xF3;n de un Servidor Rest r&#xE1;pido para pruebas</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#creando-la-base-de-datos-con-phpmyadmin" class="md-toc-link">
            <p>Creando la Base de Datos con phpMyAdmin</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#consumo-de-un-servicio-rest-desde-android" class="md-toc-link"><p>Consumo de un Servicio Rest desde Android</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#configuraci&#xF3;n-del-proyecto" class="md-toc-link">
            <p>Configuraci&#xF3;n del proyecto</p>

          </a></div><details style="padding:0;;padding-left:24px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#crear-los-servicios-con-retrofit" class="md-toc-link"><p>Crear los servicios con Retrofit</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-los-tipos-a-serializar-a-json" class="md-toc-link">
            <p>Definiendo los tipos a serializar a JSON</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-las-peticiones-para-consumo-del-endpoint" class="md-toc-link">
            <p>Definiendo las peticiones para consumo del &apos;<em>endpoint</em>&apos;</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#preparando-los-objetos-de-retrofit-con-hilt" class="md-toc-link">
            <p>Preparando los objetos de Retrofit con Hilt</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#implementaciones-de-la-gesti&#xF3;n-del-consumo-de-nuestro-endpoint" class="md-toc-link">
            <p>Implementaciones de la gesti&#xF3;n del &apos;<em>consumo</em>&apos; de nuestro endpoint</p>

          </a></div><details style="padding:0;;padding-left:24px;" open>
        <summary class="md-toc-link-wrapper">
          <a href="#usando-nuestra-implementaci&#xF3;n-del-servicio-en-el-patr&#xF3;n-repository" class="md-toc-link"><p>Usando nuestra implementaci&#xF3;n del servicio en el patr&#xF3;n Repository</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#acceder-a-la-api-iniciando-una-sesi&#xF3;n-en-el-servidor" class="md-toc-link">
            <p>Acceder a la API iniciando una sesi&#xF3;n en el servidor</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="introducci%C3%B3n">Introducci&#xF3;n</h2>

<ul>
<li>
<p><strong>Persistencia remota consumiendo un API Rest con Retrofit2</strong></p>
<ul>
<li>P&#xE1;gina oficial librer&#xED;a: <strong><a href="https://square.github.io/retrofit/">Retrofit</a></strong></li>
<li>P&#xE1;gina oficial librer&#xED;a base: <strong><a href="https://square.github.io/okhttp/">OkHttp</a></strong></li>
<li>Gu&#xED;a usuario: <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">Gson</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=MRzcCnkZQlA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial <strong>Interceptores</strong> (Castellano): <strong><a href="https://www.youtube.com/watch?v=MQdhmAaVmeA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=2_DnhfQrwXQ">DevExperto</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=L3pM5YuxYp4">AristiDevs</a></strong></li>
</ul>
</li>
</ul>
<p>En la gran mayor&#xED;a de aplicaciones m&#xF3;viles, se necesita acceder a datos que no est&#xE1;n en el dispositivo, sino que est&#xE1;n en un servidor remoto. Para ello se utilizan que permiten el acceso a los datos a trav&#xE9;s de internet. Estos servicios pueden ser <strong>API Rest</strong>, <strong>GraphQL</strong>, <strong>WebSockets</strong>, <strong>gRPC</strong>, etc. En este tema nos centraremos en los servicios API Rest, que son los m&#xE1;s utilizados.</p>
<p>Los Servicios web REST, utilizan el protocolo HTTP para intercambiar informaci&#xF3;n entre el cliente y el servidor. Nosotros en el curso vamos a utilizar una arquitectura similar a la siguiente:</p>
<p align="center"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="227px" preserveAspectRatio="none" style="width:522px;height:227px;background:#FFFFFF;" version="1.1" viewBox="0 0 522 227" width="522px" zoomAndPan="magnify"><defs/><g><!--cluster azure--><g id="cluster_azure"><rect fill="none" height="214" rx="2.5" ry="2.5" style="stroke:#444444;stroke-width:1.0;stroke-dasharray:7.0,7.0;" width="313" x="203" y="7"/><text fill="#444444" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="45" x="337" y="25.6094">Azure</text><text fill="#444444" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="63" x="328" y="41.582">[Container]</text></g><!--entity api--><g id="elem_api"><rect fill="#1168BD" height="143.4688" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="90" x="219" y="61.5"/><image height="48" width="48" x="240" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAEnElEQVR4Xs2YP45cRRCH5wp9gzmCj7BH2CM4dLgiJtiIdIhJSIhxSoIskEgQYgMkExDYgROQEEJCBCTD5/48Rb3qNz2z7Fjrp9Lodb2q7l/97e7ZtGdff1C0GVn/m+5e/3nzxc8jf0LIf/7tm8y5GKCrT75/9dvf+/3+xcvftx99MwoUQgYDkEcr8y8GCFtvv/xl3x9WmmPiq+iRfP7Dr1n4YoDw/PWnP/IrphIIlsyr4kXFnn72E5J4Nz5dDBCGMm+YrvV//PUP5HDfoyM5RAXF3VevsSTmuTCg1p1B7Ijgk4+/8xPrsTwLO0QATqQ/fPwU89wP0CQzAtAq4ZVjXwGUa3MGCOBIE2N1dD5T44BR2BzKHLRiseyDQmd5CAkWVhTLWIn3SAVhRUQkwxRD8OnOiFQmPoXDiiUrgJiXKhiniGT0wWFFq1SWNAKCA/oAQayzbRUQwKmOwgxCk4mgMSH4hCJUPhVADHMiamcWqIDmuTkhSymG4DOHgOiL6RhDxXBVsb8CKnhPEjiIL1ouxgLZAcDKCVuGqhcXLgChYLM6STYbcGSPMntRX02geEeRRCzFsQCExDmAmDRacGkBMMsWkUPmzhVft31/LZMvACEx1lcmSskFkHTbihC7ke16BeVKtpmZUhEvS1LJaBDSuTlkETGpGSOTVaMhmR8QPoCfA6EZuUvZ25BUZQYIvGNXtRZyruRKdG13KCkfiVxSrYgvKsiEfF6rAtITMTSIJs357QCr5kfHY120jYBab0XaBDgi4tQ6wJdRZSQdMPLboVOMfGkFkN3zqh9JR6/k3JwTnh4lQXM3PU+uAGrdpVTQiKb1ZSbTFcITOTTm4lx9BZAeInBjW2vHy/AYMYlxL03oGK0AClejPx597guo9SK3MlYtLFQBASIKxMDlQ7GPtu764as0/gnheKY6iWkByNbZDh0PZTeTjEYPPennEOT5CsdtdTXn8uR27XlH+A+Q+d8OjTWnnrtEPGNWwkFLcOUEOErip7H6gt4BMpGx++rIAe32cAnkmZt43Tc1kZWAxo42Af0OUDRD0BxLC6YwnzQRWPMYIeNuv2qAW97IfwvIHbGtHWgKbQ8X8niOoc8qVv5ueXhtvUuNJr0FFBlzZhe+6dd46SSgrDXCApPJHsxNTvvnywvA+6ACa3u4xUZP35AQeIgxdK8t/SH0tN/7ytHsph8BNtv+v0TQqPz+SFh3/fIk4ZHaqR+dKqBHdJi0ALRbXuD3w/9tFyTTeeQvACFElUH73o55yU5adVgwVz1aOHnoBlXk2xgyCUAZfuxl0cdpENEh7/ptxPfoq54UfLZ9p4shuXzd790+Zf8/Deim/zOkt+wOApKpO22ttIx9792+2O7sIzJbt03H7Pq9cXTqaUD5GKplrQMKZ7xKf2GpeNtv2XlCnSQI/8fxPctIpwEZEd8zoEA5AhoXs/16fnoooHByOxyQ2ylABGufjk2a4RCthwLa9iMVq77ofy7HcXsCqHW/6hVTzTxzKCBRMmc5nKwDQqgUPBwbgZzrdJsGYvCzIvzbw193CPDJNI8DhdlWtvN1QI9IHxygfwE5xZPCLHXBawAAAABJRU5ErkJggg==" y="71.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="70" x="229" y="136.1094">Endpoint</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="26" x="231.5" y="156.2344">API</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="4" x="257.5" y="156.2344">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="35" x="261.5" y="156.2344">Rest</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="262" y="174.2832">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="230" y="191.8926">Jakarta</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="276" y="191.8926">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="280" y="191.8926">EE</text></g><!--entity db--><g id="elem_db"><path d="M432,77 C432,67 466,67 466,67 C466,67 500,67 500,77 L500,189.3438 C500,199.3438 466,199.3438 466,199.3438 C466,199.3438 432,199.3438 432,189.3438 L432,77 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"/><path d="M432,77 C432,87 466,87 466,87 C466,87 500,87 500,77 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"/><image height="48" width="48" x="442" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAC6ElEQVR4Xs2YMY7UQBBFfYW+AUfgCByBIxBuiIgJiEghJiEhhpQEIZBIEIIACQICNtgEJISQEAGJeevP9PZ0ldt2eXa8o7/SjGfc/fpXdXWtu3TyAl278wrp/bbq+Hv27ls/vH7+/vv49dmN+2/t746m7vaTz6DAlLH0cSvDOubGmPwZPj7KrZsP39sbLlvdvadfmP763Tfl1QfPT7NbkH39/odQ3nr00d5/cHWEhik/nP6qviCTgMC/l59+yDPBsQA7ygF1ntQsnclwxX6dBV9OMgy7vMQ/B0KYwUyTSYOdGYtb7A/W6z8QImpldktVbknYg0my6uCb8QKIaZijShEobXpJsoo1HDZ8F0CI/GXR5RUMYNaxKVXDeB1wA+4BaYJq+va20oboZ+TfTO0ByY/2drPKTGNGLtIeUBqiZlN7UrKWG91NsEg1EM7H/FfhGNsB81UDIfIan+z1SUETiHglB0j+B0wiXuuTyQFKuyIZSAgd1VXtWCQfCBSAYoFTEQ9XJh8oDSbFgFQFwtntA6kgtUtiQ2pXYpnkA2mV4YNT/R2Hnf1qUj4QRSXsedoZ3JtGdI58IGhWtjuqk4FBfKD1rWquSUvj7gPZjA6Yr4ZpaeGeBcR+CZy46viWmuQDMX25Mh1SHCn2l21RyazZbflADJQ3bV5o4EBQ77DIJB9IhUTv8/HUhw4EZRIez7zXByq7Im1gEBk6YBLeKOJa1WTcfaBUdEXKA9annTw5oivizpLmPDUYBZJJehTR72oubgW2WymGlWFjNXMUKBWPHMpjZH0RT7sekCDY8tYCSoPVVTKSEwzU8HymQJFV1VATQK70H/78ndyQrCrzMgIkLSp3VjiE/dhTPeeIA6UhQ+3FhjAVM3IVyK+yHKwCWiqZIQLeA2G7yqMC5Z6kUcyOCpSKByZjbcmxgVLB5D4a3AAoFUWoN83JNkASJVdNRFn6twSShJVTansgCZMUu6sClAarqLRXCEj6BxH3aRCkm5d/AAAAAElFTkSuQmCC" y="91"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="24" x="454" y="155.6094">BD</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="464" y="173.6582">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="443" y="191.2676">MySQL</text></g><!--entity android--><g id="elem_android"><rect fill="#1168BD" height="123.3438" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="100" x="7" y="71.5"/><image height="48" width="48" x="33" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAC4klEQVR4Xu2YPW4UQRCFfYW5AUfwETgCRyB0aBETEJFCTOLEMaQkCGGJBCEcINkBgR04AQmtkBAByfJ5nqktd233TLVArNCUnkYzNV2v31T/Tu8NB692CnvR9W/RI+jw+Pze0w/R70EBikX/JHoEgRfvP0dnqkANnYLuP/uoPB2dXJ1eflt9/wm44VG5oUCMmoNOQVS5blpfew19gl6ffS3r32YUi7GTSAuiXcqa60bhyNBGThBdxGq68+DNxZcftwVcG05eme4nLy8jTwMJQfsP31qtdOFHzz/ZY2G8ooA9EhjZakgIsvRkLZWkhKCtDTTHCIxsNSQElfVkLLLVMCGIWe7u43d23w3PEGvxaAmy+UbrgKbjPgzjYiK29vxUFURiNhlfrxnJ/jFrRbhlPaIqiNx6Cj/mO6wIbzTcImi0RVCwRdCULYKm7A8I2rmZenC7Va1lnjFrg1vL2vvalqBh/N2x9N6uImdigGry92hCkMfK7UqzFtlqSAia+fcTrb3fKJAQRMekH7AfLfayZE7OIoVyEkJgZKshIcjDV2x7eG68P0bNwSJoCv+jIP5T5Sz+ZWPUHHQK8kcONtdxY872dNxApyAWIw3y4qRM6wOvGqtVG52C/h52WBBdkoY37I9nKHQLJn4erefqUWBYaRbmxscenVzZ7CxaotTVoOWRBvXljXwjiAAaHl7eafQSqVEDOx7eakk6PD7Hr2JaLqibZVxOQSuGp9VRDq+0U0OQFfbkN4K0F7NuqBhdTXtRxrAaT64KpzRpz6lMyykG74zk14L4aJ0HCJJS0A1j3fFslS/j66mMlAjaFPDdOqktao20Rq423WTINmISpEmlLYjGkpPCKAAa9qfjJFTQqmm2ZsirvOlDamPoCGsLUqurW6zGw3JPPfyeHhUofZRU2gi3PiQS+wbKKHwzyiBSwonhSgxXv5XhLZ+iMoCb2HsEheseEZSkPnk8ufH4fe3OzUO/AIXzUJObSDsLAAAAAElFTkSuQmCC" y="81.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="80" x="17" y="146.1094">Aplicaci&#xF3;n</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="55" y="164.1582">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="28" y="181.7676">Retrofit</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="74" y="181.7676">&#xA0;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="8" x="78" y="181.7676">2</text></g><!--link android to api--><g id="link_android_api"><path d="M107.1,133 C138.31,133 178.68,133 210.52,133 " fill="none" id="android-to-api" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="218.84,133,210.84,130,210.84,136,218.84,133" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="19" x="138" y="114.457">API</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="3" x="157" y="114.457">&#xA0;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="26" x="160" y="114.457">Rest</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="37" x="143.5" y="129.5508">[HTTP]</text></g><!--link api to db--><g id="link_api_db"><path d="M309.39,133 C343.55,133 390.4,133 423.75,133 " fill="none" id="api-to-db" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="431.93,133,423.9354,129.9857,423.9247,135.9857,431.93,133" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="61" x="340" y="114.457">Eclipselink</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="38" x="351.5" y="129.5508">[JDBC]</text></g><!--SRC=[XP3VIiCm5CRlVOeOlDXWMs5w9IhiJtGR7TQkknW89MkY2qlJc9mwglXKFe8lPj8DDqNOJK9ElkztplaGGgT2PR9a7Aq0jBqC0aCtdMS1gt9PMcwoGW5NqCcAFD2IAYXpsRR0f5W6Wujsv4lpQHZar08thfGEd8CAnKr7E-q9EcXn1QMcp9m7ZByAHxRT08eyev1APqWtXM4vDUkROwQyiY_og8egPWh1VcD7uo59Pmc9oNsoY4YZwOjXRt4_JzAGt2PfFBuR9Tloh78xvOqTfuLmJqkHqKnyVIhidZ47Kpm9G5ttEhFQ2E3N-6zRNBFGJonfloWLewPgqBVIS8_rDswYToUhjUYWkHPEGHJJXL3mg7hH6CNS0cxX2LrJ0nGHSjZ-lq1t8-onmsM3BHstF_HxJAlPGtZ8gFFTcJxy6NEvZs4xqduGX4T94ctbjT3_rtYIIQ4jTxEilMmox0zmyni0]--></g></svg></p><p>Donde tenemos una aplicaci&#xF3;n Android que se comunica con un servidor web que tiene un API Rest, que a su vez se comunica con una base de datos MySQL. En este tema nos centraremos en consumo de dicho API Rest desde la aplicaci&#xF3;n Android utilizando una librer&#xED;a llamada <strong>Retrofit2</strong>.</p>
<p>El formato de los datos que se intercambian entre el cliente y el servidor es muy importante. En este tema nos centraremos en el formato <strong>JSON</strong>.</p>
<h3 class="mume-header" id="qu%C3%A9-es-json">&#xBF;Qu&#xE9; es JSON?</h3>

<p>Aunque seguramente ya lo has visto en el m&#xF3;dulo de Acceso a Datos. Vamos ha realizar un resumen r&#xE1;pido sobre dicho formato a modo de recordatorio.</p>
<p><strong>JSON</strong> (Javascript Object Notation) es un formato ligero de intercambio de datos entre clientes y servidores, basado en la sintaxis de Javascript para representar estructuras en forma organizada. Es un formato en texto plano independiente de todo lenguaje de programaci&#xF3;n, es m&#xE1;s, soporta el intercambio de datos en gran variedad de lenguajes</p>
<h4 class="mume-header" id="tipos-de-datos-en-json">Tipos de datos en JSON</h4>

<p>Similar a la estructuraci&#xF3;n de datos primitivos y complejos en los lenguajes de programaci&#xF3;n, JSON establece varios tipos de datos: <strong><code>cadenas</code></strong>, <strong><code>n&#xFA;meros</code></strong>, <strong><code>booleanos</code></strong>, <strong><code>arrays</code></strong> y <strong><code>objetos</code></strong>. El prop&#xF3;sito es crear objetos que contengan varios atributos compuestos como pares clave valor. Donde la clave es un nombre que identifique el uso del valor que lo acompa&#xF1;a. Veamos un ejemplo:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
   <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
   <span class="token property">&quot;nombre&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Carlos&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;estaActivo&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">&quot;notas&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</pre><p>La anterior estructura es un objeto JSON compuesto por los datos de un estudiante. Los objetos JSON contienen sus atributos entre llaves <strong><code>{}</code></strong>, al igual que un bloque de c&#xF3;digo en Javascript, donde cada atributo debe ir separado por coma <strong><code>,</code></strong> para diferenciar cada par.</p>
<p>La sintaxis de los pares debe contener dos puntos <strong><code>:</code></strong> para dividir la clave del valor. El nombre del par debe tratarse como cadena y a&#xF1;adirle comillas dobles.</p>
<p>Si te fijas en nuestro ejemplo, este trae un ejemplo de cada tipo de dato:</p>
<ul>
<li>
<p><strong><code>id</code></strong> es de tipo entero, ya que contiene un n&#xFA;mero que representa el c&#xF3;digo del estudiante.</p>
</li>
<li>
<p><strong><code>nombre</code></strong> es un string. Usa comillas dobles para definirlas.</p>
</li>
<li>
<p><strong><code>estaActivo</code></strong> es un tipo booleano que representa si el estudiante se encuentra en la instituci&#xF3;n educativa o no. Usa las palabras reservadas <strong><code>true</code></strong> y <strong><code>false</code></strong> para declarar el valor.</p>
</li>
<li>
<p><strong><code>notas</code></strong> es un arreglo de n&#xFA;meros reales. El conjunto de sus elementos debes incluirlos dentro de corchetes <strong><code>[ ]</code></strong> y separarlos por coma.</p>
</li>
</ul>
<p>La idea es crear un mecanismo que permita recibir la informaci&#xF3;n que contiene la base de datos externa en formato JSON hacia la aplicaci&#xF3;n. Con ello se parsear&#xE1; cada elemento y ser&#xE1; interpretado en forma de objeto Kotlin para integrar correctamente el aspecto en la interfaz de usuario.</p>
<p>Para realizar este proceso podemos utilizar diferentes librer&#xED;as para la serializaci&#xF3;n y deserializaci&#xF3;n de objetos JSON. En este tema nos centraremos en la librer&#xED;a de Google <strong>Gson</strong>, aunque <strong>Retrofit2</strong> es agn&#xF3;stico a la forma de serializar y tambi&#xE9;n nos permite utilizar otras librer&#xED;as como <strong>Jackson</strong>, <strong>Moshi</strong>, etc.</p>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="definici%C3%B3n-de-un-servidor-rest-r%C3%A1pido-para-pruebas">Definici&#xF3;n de un Servidor Rest r&#xE1;pido para pruebas</h2>

<div class="admonition info">
<p class="admonition-title">C&#xF3;digo de los ejemplos</p>
<p>Si te surge alguna duda o tienes dificultades para completar este tema. Puedes descargar el proyecto con el c&#xF3;digo de mismo del siguiente enlace: <strong><a href="0_AgendaRetrofit_recurso.zip">Proyecto ejemplos</a></strong></p>
</div>
<p>Una forma r&#xE1;pida de <strong>definir una API Rest r&#xE1;pido</strong> para probar desde Android, es mediante la librer&#xED;a de PHP proporcionada en el m&#xF3;dulo de Acceso a datos <strong><a href="apiRest-PHP-Session_recurso.zip">apiRest-PHP-Session.zip</a></strong>.</p>
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px">
<div style="width: 70%">
<p>Por si no la has visto en el m&#xF3;dulo de Acceso a Datos, vamos a realizar un resumen r&#xE1;pido sobre el uso dicha librer&#xED;a...</p>
<p>Debes instalar un servidor web Apache con PHP y MySQL. En el m&#xF3;dulo de Acceso a Datos se ha utilizado <strong>xampp</strong>. En la carpeta <strong><code>xampp\htdocs</code></strong>, o en la carpeta p&#xFA;blica de tu servidor web, debes descomprimir el fichero <strong>apiRest-PHP-Session.zip</strong> y renombrar su contenido por ejemplo por la BD que quieras utilizar. Supongamos que queremos crear el servicio de API Rest para la Agenda que hemos ido creando durante el curso. En este caso renombraremos la carpeta <strong><code>apiRest-PHP-Session</code></strong> por agenda como se aprecia a la derecha <strong><code>agenda</code></strong>.</p>
</div>
<div style="width: auto">
<p align="center"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="153px" preserveAspectRatio="none" style="width:182px;height:153px;background:#FFFFFF;" version="1.1" viewBox="0 0 182 153" width="182px" zoomAndPan="magnify"><defs/><g><rect fill="#EEEEEE" height="18.0938" style="stroke:#000000;stroke-width:1.0;" width="63" x="6" y="6"/><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="11" x="8" y="20.457">C:</text><line style="stroke:#000000;stroke-width:1.0;" x1="58" x2="58" y1="6" y2="24.0938"/><polygon fill="#000000" points="61,12,67,12,64,19.0938" style="stroke:#000000;stroke-width:1.0;"/><path d="M17,31.1875 L17,32.1875 L25,32.1875 L25,31.1875 L17,31.1875 M17,33.1875 L17,39.0975 C17,39.1475 17.04,39.1875 17.09,39.1875 L24.9,39.1875 C24.95,39.1875 24.99,39.1475 24.99,39.0975 L24.99,33.1875 L22.02,33.1875 L22.02,34.2175 L19.99,34.2175 L19.99,33.1875 L16.99,33.1875 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="26" y="39.5508">[SERVIDORES]</text><path d="M27,46.2813 L27,47.2813 L35,47.2813 L35,46.2813 L27,46.2813 M27,48.2813 L27,54.1913 C27,54.2413 27.04,54.2813 27.09,54.2813 L34.9,54.2813 C34.95,54.2813 34.99,54.2413 34.99,54.1913 L34.99,48.2813 L32.02,48.2813 L32.02,49.3113 L29.99,49.3113 L29.99,48.2813 L26.99,48.2813 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="43" x="36" y="54.6445">[xampp]</text><path d="M37,61.375 L37,62.375 L45,62.375 L45,61.375 L37,61.375 M37,63.375 L37,69.285 C37,69.335 37.04,69.375 37.09,69.375 L44.9,69.375 C44.95,69.375 44.99,69.335 44.99,69.285 L44.99,63.375 L42.02,63.375 L42.02,64.405 L39.99,64.405 L39.99,63.375 L36.99,63.375 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="43" x="46" y="69.7383">[htdocs]</text><path d="M47,76.4688 L47,77.4688 L55,77.4688 L55,76.4688 L47,76.4688 M47,78.4688 L47,84.3788 C47,84.4288 47.04,84.4688 47.09,84.4688 L54.9,84.4688 C54.95,84.4688 54.99,84.4288 54.99,84.3788 L54.99,78.4688 L52.02,78.4688 L52.02,79.4988 L49.99,79.4988 L49.99,78.4688 L46.99,78.4688 " fill="#0000FF" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="50" x="56" y="84.832">[agenda]</text><path d="M57,91.5625 L57,92.5625 L65,92.5625 L65,91.5625 L57,91.5625 M57,93.5625 L57,99.4725 C57,99.5225 57.04,99.5625 57.09,99.5625 L64.9,99.5625 C64.95,99.5625 64.99,99.5225 64.99,99.4725 L64.99,93.5625 L62.02,93.5625 L62.02,94.5925 L59.99,94.5925 L59.99,93.5625 L56.99,93.5625 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="22" x="66" y="99.9258">[inc]</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="56" y="115.0195">.htaccess</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="119" x="56" y="130.1133">apirest_variables.php</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="56" y="145.207">index.php</text><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="9" y="33.6406"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="19" y="48.7344"/><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="10" y1="36.6406" y2="49.7344"/><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="18" y1="49.7344" y2="49.7344"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="29" y="63.8281"/><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="20" y1="51.7344" y2="64.8281"/><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="28" y1="64.8281" y2="64.8281"/><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="39" y="78.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="30" y1="66.8281" y2="79.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="38" y1="79.9219" y2="79.9219"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="95.0156"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="95.0156" y2="95.0156"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="110.1094"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="110.1094" y2="110.1094"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="125.2031"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="125.2031" y2="125.2031"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="140.2969"/><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="140.2969" y2="140.2969"/><!--SRC=[HP3TQi9048NlzodcgkYAGLDhor94gh7KAefHRqJB9fdgGjmD-nCiqdVlcbhBNCrtpXbcfcyirzRmt98psL4wO9Jk23alIGEUxn9rwctYQB5-6yuMKRmbZHizyMDHNC2D76ocKbCXprALAysIt67lLwTqm_SeCxwbjFBSWaAcsoi93fQdAHfpxNaXD1hxKN8jU9AZ2Of3STM4pF1KzT- - -dvqTGQPvrpQrNG29MeZb8Hs4BR2-o2inKx221C8kz1kiV21THvX42tX8jT9xNK-0QESJX4oOQmMYRC-NoTZNd9OE6d54HdC2fJZuViVW4YMGYjvH6d9U3tzDtGxpHTX8KRjDu7rb0pnaxlS-aIgCY7t35RBKVE9JBZSE_yS1cZ8GFcv-ej15Fy0]--></g></svg></p></div>
</div>
<p>La configuraci&#xF3;n de nuestro API consta de dos archivos:</p>
<ol>
<li>
<p><strong><code>.htaccess</code></strong> En este archivo se configuran las reglas de acceso, y solo deberemos modificar la l&#xED;nea <strong><code>RewriteBase</code></strong> para indicar la ruta de acceso a la carpeta de nuestro API. En nuestro caso cambiaremosel valos de la cadena <strong><code>&quot;/apirest-session/&quot;</code></strong> por <strong><code>&quot;/agenda/&quot;</code></strong>.</p>
<pre data-role="codeBlock" data-info="bash { highlight=[2,6] }" class="language-bash" data-line="2,6">RewriteEngine On
RewriteBase <span class="token string">&quot;/apirest-session/&quot;</span>
<span class="token punctuation">..</span>.

RewriteEngine On
RewriteBase <span class="token string">&quot;/agenda/&quot;</span>
<span class="token punctuation">..</span>.
<div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="2">
<li>
<p><strong><code>apirest_variables.php</code></strong>, en este archivo se definen los  datos de conexi&#xF3;n a la base de datos. se indican las tablas que tiene esta y el nombre del identificador de cada una de ellas.</p>
<pre data-role="codeBlock" data-info="php" class="language-php"><span class="token delimiter important">&lt;?php</span>

    <span class="token comment">// CONFIGURACI&#xD3;N BASE DE DATOS MYSQL</span>
    <span class="token variable">$servername</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;root&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// BASE DE DATOS</span>
    <span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;agenda&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// ACCESO USUARIOS (si est&#xE1; vac&#xED;o funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// $usuarios[&quot;juanjo&quot;]=&quot;_IesBalmis1&quot;;</span>
    <span class="token comment">// $usuarios[&quot;xusa&quot;]=&quot;_IesBalmis2&quot;;</span>
    <span class="token comment">// $usuarios[&quot;pepe&quot;]=&quot;_IesBalmis3&quot;;</span>
    
    <span class="token comment">// TABLAS Y SU CLAVE</span>
    <span class="token variable">$tablas</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tablas</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;contactos&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;id&quot;</span><span class="token punctuation">;</span>
</pre></li>
</ol>
<p>El resto de archivos del ApiREst <strong>no tendr&#xE1;n que modificars</strong>e, ya que est&#xE1; construida de forma gen&#xE9;rica con las necesidades m&#xE1;s comunes para estos casos.</p>
<h3 class="mume-header" id="creando-la-base-de-datos-con-phpmyadmin">Creando la Base de Datos con phpMyAdmin</h3>

<p>Para crear la base de datos con <strong><code>phpMyAdmin</code></strong>, deberemos crear una base de datos y para ello pudes bajarte el siguiente <strong><a href="agenda_mysql_recurso.zip">recurso</a></strong> en &#xE9;l encontrar&#xE1; el archivo <strong><code>agenda_mysql_datos.sql</code></strong> que contiene el script de creaci&#xF3;n de la base de datos, incluyendo las im&#xE1;genes de ejemplo en formato <strong><code>blob</code></strong> (base64).</p>
<div style="display: flex; justify-content: center; align-items: center; margin-top: 15px; margin-bottom: 15px">
    <img height src="assets/imagenes/tema_5_2/agenda.png">
</div>
<p>Para acceder a <strong><code>phpMyAdmin</code></strong> debes ir a la url <strong><code>http://localhost/phpmyadmin/</code></strong> y ejercutar <strong><code>agenda_mysql_datos.sql</code></strong> en la pesta&#xF1;a SQL. Tras hacerlo, te debe aparecer la base de datos <strong><code>agenda</code></strong> con la tabla <strong><code>contactos</code></strong> como se muestra en la imagen de ejemplo.</p>
<p>Puedes probar que el API est&#xE1; funcionando correctamente, abriendo un navegador y accediendo a la url <strong><code>http://localhost/agenda/</code></strong>. Si todo ha ido bien, deber&#xED;as ver una p&#xE1;gina como la siguiente:</p>
<div style="display: flex; justify-content: center; align-items: center; margin-top: 15px; margin-bottom: 15px">
    <img height src="assets/imagenes/tema_5_2/agenda_api.png">
</div>
<div style="page-break-after:always;"></div>
<h2 class="mume-header" id="consumo-de-un-servicio-rest-desde-android">Consumo de un Servicio Rest desde Android</h2>

<p>Como ya hemos comentado, existen diferentes librer&#xED;as que nos permitir&#xED;an consumir los servicios desde la App de Android, pero dada su facilidad vamos a utilizar las librer&#xED;as: <strong>Retrofit2</strong> y <strong>Gson</strong>.</p>
<p><strong>Retrofit</strong> la utilizaremos para hacer peticiones http y procesar las respuestas del API Rest, mientras que con <strong>Gson</strong> transformaremos los datos de JSON a los propios que utilice la aplicaci&#xF3;n.</p>
<h3 class="mume-header" id="configuraci%C3%B3n-del-proyecto">Configuraci&#xF3;n del proyecto</h3>

<p>Para poder utilizar Retrofit y Gson en nuestro proyecto, deberemos a&#xF1;adir las siguientes dependencias en el fichero <strong><code>build.gradle.kts</code></strong> del m&#xF3;dulo de la aplicaci&#xF3;n:</p>
<pre data-role="codeBlock" data-info="groovy" class="language-groovy">dependencies <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;com.squareup.retrofit2:converter-gson:2.9.0&quot;</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;com.squareup.retrofit2:retrofit:2.9.0&quot;</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">&quot;com.squareup.okhttp3:logging-interceptor:4.2.2&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>En el archivo <strong><code>AndroidManifest.xml</code></strong> deberemos a&#xF1;adir el permiso de acceso a internet para que el servicio pueda acceder al API.</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.INTERNET<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_NETWORK_STATE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_WIFI_STATE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</pre><h3 class="mume-header" id="crear-los-servicios-con-retrofit">Crear los servicios con Retrofit</h3>

<p>En la paquete <strong><code>data</code></strong> crearemos un nuevo paquete llamado <strong><code>data.services</code></strong> donde definiremos los API de cara uno de nuestro &apos;<em>endpoint</em>&apos;.</p>
<h4 class="mume-header" id="definiendo-los-tipos-a-serializar-a-json">Definiendo los tipos a serializar a JSON</h4>

<p>Para cada una de las clases que se van a transferir en las peticiones crearemos un fichero <strong><code>&lt;Tipo&gt;Api.kt</code></strong>.</p>
<ol>
<li>
<p>Definiremos la clase <strong><code>ContactoApi</code></strong> que ser&#xE1; la que se utilizar&#xE1; para transferir los datos de los contactos entre el servidor y la aplicaci&#xF3;n. F&#xED;jate que los atributos de la clase tienen que tener el mismo nombre que los campos que se devuelven en el JSON del API Rest. Si quisi&#xE9;ramos cambiar el nombre de alguna propiedad, deberemos utilizar la anotaci&#xF3;n <strong><code>@SerializedName</code></strong> justo antes de la propiedad para indicar el nombre que tiene en el JSON. Puedes obtener m&#xE1;s informaci&#xF3;n sobre trasformaciones de en la <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">documentaci&#xF3;n de la librer&#xED;a</a></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4]}" class="language-kotlin" data-line="4"><span class="token comment">// ContactoApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;nombre&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> telefono<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> email<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> foto<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> categorias<span class="token operator">:</span> String
<span class="token punctuation">)</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre></li>
<li>
<p>La librer&#xED;a de PHP que estamos usando, en la peticiones de tipo <strong>POST</strong>, <strong>PUT</strong> y <strong>DELETE</strong>, nos devuelve una respuesta en JSON con campos de informaci&#xF3;n sobre la petici&#xF3;n, por tanto, deberemos definir un objetos para su deserializaci&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// RespuestaApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaApi</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> respuesta <span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> metodo<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> mensaje<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlQuery<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlError<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
<span class="token punctuation">)</span>
</pre></li>
<li>
<p>Por &#xFA;ltimo, las petici&#xF3;n <strong><a href="http://localhost/agenda/contactos/count">http://localhost/agenda/contactos/count</a></strong> devuelve un n&#xFA;mero de contactos en un JSON especial, por lo que deberemos definir un objeto para su deserializaci&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token comment">// TotalRegistrosApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">TotalRegistrosApi</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string">&quot;tabla&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string">&quot;total_registros&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> totalRegistros<span class="token operator">:</span> Int
<span class="token punctuation">)</span>
</pre></li>
</ol>
<h4 class="mume-header" id="definiendo-las-peticiones-para-consumo-del-endpoint">Definiendo las peticiones para consumo del &apos;<em>endpoint</em>&apos;</h4>

<p>Para cada una de las peticiones que se vayan a realizar al API Rest, crearemos una interfaz con el nombre de la clase del API, en nuestro caso <strong><code>ContactoApi</code></strong> y le a&#xF1;adiremos el sufijo <strong><code>Service</code></strong>. Pot tanto, vamos a definir un interface llamado <strong><code>ContactoService</code></strong>.</p>
<p>Definiremos pues la signatura de cada uno delos m&#xE9;todos que se van a utilizar para realizar las peticiones Para ello utilizaremos diferentes anotaciones para indicar el tipo de petici&#xF3;n, la url del API Rest, el tipo de datos que se env&#xED;a y el tipo de datos que se recibe.</p>
<p>Por ejemplo, para la petici&#xF3;n <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos, deberemos a&#xF1;adir...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;contactos&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><ol>
<li>La anotaci&#xF3;n  <strong><code>@GET</code></strong> con la url <strong><code>contactos</code></strong> que completar&#xED;a la URL base al definir el objeto de Retrofit que ser&#xE1; <strong><code>http://localhost/agenda/</code></strong>.</li>
<li>La anotaci&#xF3;n <strong><code>@Headers</code></strong> que incluir&#xE1; en la cabecera de la petici&#xF3;n HTTP los valores <strong><code>Accept</code></strong> y <strong><code>Content-Type</code></strong> para indicar que se env&#xED;a y se espera recibir JSON en el <strong>body</strong>.</li>
<li>Por &#xFA;ltimo, definiremos la signatura del m&#xE9;todo que ser&#xE1; de suspensi&#xF3;n <strong><code>suspend</code></strong> y devolver&#xE1; un objeto de tipo <strong><code>Response</code></strong> que contendr&#xE1; una lista de objetos de tipo <strong><code>ContactoApi</code></strong> ya deserializados si la respuesta es correcta.</li>
</ol>
<p>En el caso de que la respuesta en el body no sea un objeto del tipo <strong><code>ContactoApi</code></strong> como el caso de la petici&#xF3;n <strong><code>http://localhost/agenda/contactos/count</code></strong> que devuelve un objeto del tipo <strong><code>TotalRegistrosApi</code></strong>, <strong><code>Response</code></strong> ir&#xE1; parametrizado con este tipo para la correcta deserializaci&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;contactos/count&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>TotalRegistrosApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><p>Podremos poner tambi&#xE9;n el valor de un par&#xE1;metro en la URL con la anotaci&#xF3;n <strong><code>@Path</code></strong>, as&#xED; como serializar en el &apos;<em>body</em>&apos; de la petici&#xF3;n un objeto con <strong><code>@Body</code></strong>. Por ejemplo, para la petici&#xF3;n <strong><code>@PUT</code></strong> a nuestro Api con PHP tenemos que indicar el <strong>id</strong> del contacto a actualizar <strong><code>http://localhost/agenda/contactos/1</code></strong> y en el cuerpo de la petici&#xF3;n el objeto <strong><code>ContactoApi</code></strong> con los datos a actualizar. F&#xED;jate adem&#xE1;s que la respuesta que parametrizamos en el objeto <strong><code>Response</code></strong> es del tipo <strong><code>RespuestaApi</code></strong> que definimos anteriormente. Nuestro prototipo de m&#xE9;todo <strong><code>update</code></strong> quedar&#xED;a de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@PUT</span><span class="token punctuation">(</span><span class="token string">&quot;contactos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><p>Tambi&#xE9;n podemos establecer par&#xE1;metros en el <strong>QUERYSTRING</strong> de la URL con la anotaci&#xF3;n <strong><code>@Query</code></strong>. Por ejemplo, para la petici&#xF3;n <strong><code>http://localhost/agenda/contactos/id/?desde=3&amp;hasta=5</code></strong> que devuelve un <strong>listado de contactos con id entre 3 y 5</strong>. Nuestro prototipo de m&#xE9;todo <strong><code>contactosDesdeHasta</code></strong> quedar&#xED;a de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;contactos/id/&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactosDesdeHasta</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;desde&quot;</span><span class="token punctuation">)</span> desde<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;hasta&quot;</span><span class="token punctuation">)</span> hasta<span class="token operator">:</span> Int
    <span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</pre><p>Con lo visto ya podemos definir el resto de m&#xE9;todos HTTP que necesitemos para nuestro API Rest. En nuestro caso, nos quedan por definir los siguientes los siguientes ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;contactos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contacto</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@POST</span><span class="token punctuation">(</span><span class="token string">&quot;contactos&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@DELETE</span><span class="token punctuation">(</span><span class="token string">&quot;contactos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<h3 class="mume-header" id="preparando-los-objetos-de-retrofit-con-hilt">Preparando los objetos de Retrofit con Hilt</h3>

<p>En el fichero <strong><code>.di/AppModule.kt</code></strong> deberemos definir como crear los objetos a inyectar de Retrofit.</p>
<ol>
<li>
<p>Primero definimos como crear el objeto <strong><code>OkHttpClient</code></strong>, para ello usaremos <strong><code>OkHttpClient.Builder()</code></strong>. En este caso le a&#xF1;adiremos un <strong>interceptor</strong> o (&apos;<em>hook</em>&apos;) para poder depurar, a trav&#xE9;s de Logcat de Android Studio, el contenido de las peticiones y respuestas HTTP que se realizan. F&#xED;jate que el nivel de log que le hemos indicado es <strong><code>HEADERS</code></strong>, esto es porque no queremos que se muestre la cabecera sin el cuerpo de la petici&#xF3;n. Adem&#xE1;s, le hemos indicado un tiempo de espera (&apos;<em>TIMEOUT</em>&apos;) de <strong>10 segundos</strong> para las peticiones despu&#xE9;s de los cuales se cancelar&#xE1; la petici&#xF3;n y se producir&#xE1; una excepci&#xF3;n de tipo <strong><code>SocketTimeoutException</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre> <div style="page-break-after:always;"></div>
</li>
<li>
<p>Ahora definiremos el objeto <strong><code>Retrofit</code></strong>  que es el que usaremos realmente para realizar las peticiones HTTP y procesar las respuestas del API Rest. Al mismo le pasaremos:</p>
<ul>
<li>El objeto <strong><code>OkHttpClient</code></strong> que hemos creado anteriormente y que le llega a trav&#xE9;s de la inyecci&#xF3;n.</li>
<li>La url base del API Rest, en nuestro caso <strong><code>http://10.0.2.2/agenda/</code></strong>. F&#xED;jate que la direcci&#xF3;n no es <strong><code>localhost</code></strong> o <strong><code>127.0.0.1</code></strong> ya que, c&#xF3;mo estamos accediendo desde el dispositivo emulador para &#xE9;l el <strong><code>localhost</code></strong> es el propio dispositivo Android emulado y no el equipo donde est&#xE1; el servidor web. AVD (Android Virtual Device) proporciona una direcci&#xF3;n IP especial <strong><code>10.0.2.2</code></strong> que nos permite acceder al equipo donde est&#xE1; el servidor web.</li>
</ul>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideRetrofit</span><span class="token punctuation">(</span>
    okHttpClient<span class="token operator">:</span> OkHttpClient
<span class="token punctuation">)</span> <span class="token operator">:</span> Retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>okHttpClient<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://10.0.2.2/agenda/&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre></li>
<li>
<p>Por &#xFA;ltimo, <strong>indicaremos a Hilt como instanciar el o los objetos de <code>&lt;enpoint&gt;Service</code></strong> que es el que realmente utilizaremos para realizar las peticiones al API Rest. Para ello le pasaremos el objeto <strong><code>Retrofit</code></strong> que hemos creado anteriormente y que le llega a trav&#xE9;s de la inyecci&#xF3;n. En nuestro caso solo vamos a definir como instanciar un objeto que implemente la interfaz <strong><code>ContactoService</code></strong> que utilizaremos para realizar las peticiones al API Rest de la Agenda que esl &#xFA;nico &apos;<em>endpoint</em>&apos; definido.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideContactoService</span><span class="token punctuation">(</span>
    retrofit<span class="token operator">:</span> Retrofit
<span class="token punctuation">)</span> <span class="token operator">:</span> ContactoService <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ContactoService<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</pre></li>
</ol>
<div style="page-break-after:always;"></div>
<h3 class="mume-header" id="implementaciones-de-la-gesti%C3%B3n-del-consumo-de-nuestro-endpoint">Implementaciones de la gesti&#xF3;n del &apos;<em>consumo</em>&apos; de nuestro endpoint</h3>

<p>Aunque <strong>este paso intermedio no es de todo necesario</strong> y no lo vamos a ver en muchos ejemplos de uso de Retrofit. Si que <strong>es recomendable para gestionar correctamente los errores y los logs de depuraci&#xF3;n que se puedan producir</strong> al consumir nuestro API Rest y simplificar el c&#xF3;digo de uso de uso de Retrofit en nuestro patr&#xF3;n Repository.</p>
<p>Primero definiremos la clase <strong><code>ApiServicesException</code></strong> que ser&#xE1; la que utilizaremos para lanzar las excepciones que se produzcan al consumir el API Rest.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensaje<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Exception</span><span class="token punctuation">(</span>mensaje<span class="token punctuation">)</span>
</pre><p>Posteriormente, definiremos para ello una clase denominada <strong><code>ContactoServiceImplementation</code></strong> a la que le inyectaremos una instancia de <strong><code>ContactoService</code></strong> que es la que realmente utilizaremos para realizar las peticiones al API Rest.</p>
<p>Veamos la anatom&#xED;a de uso de Retrofit para <strong>obtener la lista de contactos</strong> del API Rest en esta clase comentado paso por paso...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,5,10,14-19,23-26,32-35]}" class="language-kotlin" data-line="4,5,10,14-19,23-26,32-35"><span class="token keyword keyword-class">class</span> ContactoServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Propiedad privada cte. donde definimos el tag para los logs</span>
    <span class="token comment">// de depuraci&#xF3;n de las peticiones.</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;OkHttp&quot;</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;No se han podido obtener los contactos&quot;</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Obtenemos la respuesta HTTP Response&lt;List&lt;ContactoApi&gt;&gt;</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// Si la respuesta tiene un estatus 2xx (200, 201, 202, etc.)</span>
                <span class="token comment">// Obtenemos con response.body los datos List&lt;ContactoApi&gt; </span>
                <span class="token comment">// ya deserializados de JSON contenidos en el cuerpo de la misma.</span>
                <span class="token comment">// Si no hay datos porque el resultado de la serializaci&#xF3;n </span>
                <span class="token comment">// es null o el cuerpo estaba vac&#xED;o. Entonces, lanzamos un </span>
                <span class="token comment">// error indicando que no hay datos.</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string">&quot;No hay datos&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// sino entonces la respuesta HTTP tiene un estatus de error y por</span>
                <span class="token comment">// tanto obtendr&#xE9; el mensaje de error del body de la respuesta</span>
                <span class="token comment">// y lanzaremos un error gen&#xE9;rico, enviando al al mismo tiempo el</span>
                <span class="token comment">// mensaje generado al Log.</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Si ha habido alg&#xFA;n error al deserializar el JSON</span>
            <span class="token comment">// o tambi&#xE9;n si ha habido alg&#xFA;n error al realizar la petici&#xF3;n por</span>
            <span class="token comment">// ejemplo por falta de conexi&#xF3;n a internet, o se ha </span>
            <span class="token comment">// producido un TIMEOUT, etc.</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... resto de la implementaci&#xF3;n de las llamadas al Servicio Rest</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5" data-start="5">
</div></div><div class="line-highlight-wrapper">








<div aria-hidden="true" class="line-highlight" data-range="10" data-start="10">
</div></div><div class="line-highlight-wrapper">












<div aria-hidden="true" class="line-highlight" data-range="14-19" data-start="14" data-end="19">





</div></div><div class="line-highlight-wrapper">





















<div aria-hidden="true" class="line-highlight" data-range="23-26" data-start="23" data-end="26">



</div></div><div class="line-highlight-wrapper">






























<div aria-hidden="true" class="line-highlight" data-range="32-35" data-start="32" data-end="35">



</div></div></pre><div style="page-break-after:always;"></div>
<p>Siguiendo el esquema anterior, <strong>obtener un contacto por ID</strong> quedar&#xED;a...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,8]}" class="language-kotlin" data-line="4,8"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> ContactoApi <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;No se han podido obtener el contacto con id = <span class="token interpolation variable">$id</span>&quot;</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contacto</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string">&quot;No hay datos&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div></pre><p>Para <strong>insertar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,7-9]}" class="language-kotlin" data-line="4,7-9"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span><span class="token string">&quot;No se ha podido a&#xF1;adir el contacto&quot;</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// Aqu&#xED; response.body() es un objeto de tipo RespuestaApi </span>
            <span class="token comment">// que simplemente logeamos si no es null.</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string">&quot;No hay respuesta&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7-9" data-start="7" data-end="9">


</div></div></pre><div style="page-break-after:always;"></div>
<p>Para <strong>actualizar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4-6]}" class="language-kotlin" data-line="4-6"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;No se ha podido actualizar el contacto&quot;</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// En este m&#xE9;todo el API de PHP espera recibir el id del contacto</span>
        <span class="token comment">// que tambi&#xE9;n lo podemos obtener del objeto contacto que le pasamos</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span>id<span class="token punctuation">,</span> contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string">&quot;No hay respuesta&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4-6" data-start="4" data-end="6">


</div></div></pre><p>Para <strong>borrar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;No se ha podido borrar el contacto&quot;</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string">&quot;No hay respuesta&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<h3 class="mume-header" id="usando-nuestra-implementaci%C3%B3n-del-servicio-en-el-patr%C3%B3n-repository">Usando nuestra implementaci&#xF3;n del servicio en el patr&#xF3;n Repository</h3>

<p>Al igual que suced&#xED;a con las anteriores fuentes como los objetos Mock de prueba o las entidades de room. Deberemos definir en <strong><code>RepositoryConverters.kt</code></strong> las funciones de extensi&#xF3;n para convertir los objetos de tipo <strong><code>ContactoApi</code></strong> en objetos de tipo <strong><code>Contacto</code></strong> y viceversa.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-fun">fun</span> Contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword keyword-fun">fun</span> ContactoApi<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Contacto</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</pre><p>Por &#xFA;ltimo, en el fichero <strong><code>ContactoRepository.kt</code></strong> deberemos inyectar la implementaci&#xF3;n de nuestro servicio <strong><code>ContactoServiceImplementation</code></strong> y utilizarlo en las funciones de nuestro patr&#xF3;n Repository.</p>
<blockquote>
<p>&#x1F4CC; <strong>Nota</strong>: Cualquier error que se produzca ya lo resolveremos en el <strong>ViewModel</strong> como suced&#xED;a con <strong>room</strong>.</p>
</blockquote>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> ContactoRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Contacto<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Contacto <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><div style="page-break-after:always;"></div>
<h4 class="mume-header" id="acceder-a-la-api-iniciando-una-sesi%C3%B3n-en-el-servidor">Acceder a la API iniciando una sesi&#xF3;n en el servidor</h4>

<p>Si queremos incrementar la seguridad del acceso a nuestra APIRest, podemos <strong>iniciar una sesi&#xF3;n en el servidor</strong> con determinadas credenciales. Tran enviar la petici&#xF3;n de &apos;<em>login</em>&apos;, capturaremos la &apos;<em>cookie</em>&apos; que nos devuelve con el id de la sesi&#xF3;n y usaremos esta misma cookie para poder acceder al resto de funcionalidades del APIRest. Para habilitar la autenticaci&#xF3;n a traves del uso de sesiones en nuestro APIRest con PHP, volveremos a editar el archivo <strong><code>apirest_variables.php</code></strong> y descomentaremos las siguientes l&#xED;neas donde definimos los usuarios y sus contrase&#xF1;as.</p>
<pre data-role="codeBlock" data-info="php {highlight=6-8}" class="language-php" data-line="6-8"><span class="token delimiter important">&lt;?php</span>
    <span class="token operator">...</span>

    <span class="token comment">// ACCESO USUARIOS (si est&#xE1; vac&#xED;o funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;juanjo&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;_IesBalmis1&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;xusa&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;_IesBalmis2&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;pepe&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;_IesBalmis3&quot;</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>    
<div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div></pre><p>Tras ello, entremos donde entremos a nuestro API en <strong><code>http://localhost/agenda/</code></strong> nos pedir&#xE1; que iniciemos sesi&#xF3;n con un usuario y contrase&#xF1;a indic&#xE1;ndonos como debemos hacerlo con la siguiente pantalla...</p>
<div style="display: flex; justify-content: center; align-items: center; margin-top: 15px; margin-bottom: 15px">
    <img height="400" src="assets/imagenes/tema_5_2/agenda_api_sesion.png">
</div>
<div style="page-break-after:always;"></div>
<p>Si nos fijamos en la ayuda para autenticarnos necesitamos enviar una petici&#xF3;n <strong><code>GET</code></strong> a la url <strong><code>http://localhost/agenda/?usu=&lt;usuario&gt;&amp;pass=&lt;password&gt;</code></strong>. Por tanto, deberemos definir un nuevo servicio en nuestro APIRest llamado <strong><code>AutenticacionService</code></strong> en el paquete <strong><code>.data.services.autenticacion</code></strong> que nos permita realizar esta petici&#xF3;n y la de cerrar la sesi&#xF3;n como m&#xED;nimo.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-interface">interface</span> AutenticacionService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;usu&quot;</span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;pass&quot;</span><span class="token punctuation">)</span> password <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;logout&quot;</span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</pre><p>En ambos casos la respuesta del APIRest ser&#xE1; un objeto del tipo <strong><code>RespuestaAutenticacionApi</code></strong> que definiremos como...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaAutenticacionApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> mensaje <span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> usuario <span class="token operator">:</span> String
<span class="token punctuation">)</span>
</pre><p>y que nos devolver&#xE1; un mensaje de error o de &#xE9;xito y el usuario que ha iniciado la sesi&#xF3;n o null si no se ha podido iniciar la sesi&#xF3;n.</p>
<p>A la hora de realizar la implementaci&#xF3;n de este servicio de <strong>login</strong>...</p>
<pre data-role="codeBlock" data-info="txt  {highlight=1}" class="language-txt" data-line="1">--&gt; GET http://10.0.2.2/agenda/?usu=juanjo&amp;pass=Mb14e92i_
Accept: application/json
Content-Type: application/json
--&gt; END GET
<div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="1" data-start="1">
</div></div></pre><p>deberemos tener en cuenta que en la cabecera de la respuesta del APIRest <strong>se nos devuelve una cookie con el id de la sesi&#xF3;n que deberemos almacenar</strong> del alg&#xFA;n modo para poder acceder al resto de funcionalidades del APIRest. En nuestro caso el valor de esa cookie se encuentra en la cabecera <strong><code>Set-Cookie</code></strong> y es <strong><code>PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o</code></strong>. Sin tener en cuenta que podr&#xED;an llegar otras cookies en en esta misma cabecera.</p>
<pre data-role="codeBlock" data-info="txt {highlight=[5-6]}" class="language-txt" data-line="5-6">&lt;-- 200 OK http://10.0.2.2/agenda/?usu=juanjo&amp;pass=Mb14e92i_ (18ms)
Date: ...
Server: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.2.4
X-Powered-By: PHP/8.2.4
Set-Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
Expires: Fecha de expiraci&#xF3;n de la Cookie
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 59
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/json; charset=utf-8
&lt;-- END HTTP
<div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5-6" data-start="5" data-end="6">

</div></div></pre><p>Para ello, podemos definir <strong>una propiedad est&#xE1;tica p&#xFA;blica</strong> en la clase <strong><code>AutenticacionServiceImplementation</code></strong> que almacenar&#xE1; la cookie de la sesi&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin { highlight=[6-8, 22] }" class="language-kotlin" data-line="6-8,22"><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;OkHttp&quot;</span>

    <span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> cookie<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;Error al loguear a <span class="token interpolation variable">$userName</span>&quot;</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                cookie <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string">&quot;No hay datos&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div><div class="line-highlight-wrapper">




















<div aria-hidden="true" class="line-highlight" data-range="22" data-start="22">
</div></div></pre><div style="page-break-after:always;"></div>
<p>Esta cookie la utilizaremos en el resto de peticiones que realicemos al APIRest. Para ello, deberemos a&#xF1;adir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la petici&#xF3;n <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos la petici&#xF3;n HTTP deber&#xED;a ser...</p>
<pre data-role="codeBlock" data-info="txt {highlight=4}" class="language-txt" data-line="4">--&gt; GET http://10.0.2.2/agenda/contactos
Accept: application/json
Content-Type: application/json
Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
--&gt; END GET
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre><p>Para ello, deber&#xED;amos modificar la interfaz <strong><code>ContactoService</code></strong> y a&#xF1;adir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la petici&#xF3;n GET a esa ruta ser&#xE1; ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;contactos&quot;</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">&quot;Accept: application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type: application/json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token annotation builtin">@Header</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">)</span> cookie <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</pre><p>F&#xED;jate que hemos a&#xF1;adido la anotaci&#xF3;n <strong><code>@Header</code></strong> para indicar que el valor de la cabecera <strong><code>Cookie</code></strong> se obtendr&#xE1; del par&#xE1;metro <strong><code>cookie</code></strong> que le pasamos al m&#xE9;todo y por tanto deberemos a&#xF1;adirlo en la llamada al m&#xE9;todo que hac&#xED;amos desde el <strong><code>ContactoServiceImplementation</code></strong>.</p>
<blockquote>
<p>&#x270B; <strong>Importante</strong>: El problema de esto es que, como hemos mencionado, deberemos hacer lo mismo en todas las peticiones de todos servicios a &apos;<em>endpoints</em>&apos; que hayamos definido y pasarlo en todas las llamadas a los m&#xE9;todos de los servicios en las implementaciones de los mismos.</p>
</blockquote>
<p>Para evitar hacer esto, podemos definir un <strong>interceptor</strong> o (&apos;<em><strong>hook</strong></em>&apos;) que se ejecutar&#xE1; antes de realizar la petici&#xF3;n y que a&#xF1;adir&#xE1; la cabecera <strong><code>Cookie</code></strong> a la petici&#xF3;n. Para ello, podemos seguir los siguientes pasos:</p>
<ol>
<li>
<p>En el paquete <strong><code>services</code></strong> vamos a crear un nuevo paquete llamado <strong><code>services.interceptors</code></strong> donde definiremos el interceptor que se encargar&#xE1; de guardar la cookie de la sesi&#xF3;n y el de a&#xF1;adirla a las peticiones que se realicen al APIRest.</p>
</li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada AlmacenDeCookies guardar&#xE1; en un <strong><code>HashSet</code></strong> las cookies que se vayan recibiendo en las respuestas del APIRest. Hilts nos permitir&#xE1; inyectar un objeto &#xFA;nico esta clase en los interceptores que definamos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-class">class</span> AlmacenDeCookies <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span>  <span class="token operator">=</span> cookies
    <span class="token keyword keyword-fun">fun</span> <span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>cookies <span class="token operator">=</span> cookies
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>ReciveCookiesInterceptor</code></strong> que implementar&#xE1; el interfaz <strong><code>Interceptor</code></strong> y se encargar&#xE1; de <strong>preprocesar cualquier respuesta del servidor y guardar las cookies recibidas</strong> en la cabecera <strong><code>Set-Cookie</code></strong>, incluida la de la sesi&#xF3;n, en el objeto <strong><code>AlmacenDeCookies</code></strong> invalidando el m&#xE9;todo <strong><code>intercept</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin" data-line><span class="token keyword keyword-class">class</span> <span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Procesamos la respuesta actual            </span>
        <span class="token keyword keyword-val">val</span> originalResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// Extraemos de ella las cookies de la cabecera Set-Cookie</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>header <span class="token keyword keyword-in">in</span> originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cookies<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            almacenDeCookies<span class="token punctuation">.</span><span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Devolvemos la respuesta original</span>
        <span class="token keyword keyword-return">return</span> originalResponse
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>EnviaCookiesInterceptor</code></strong> que implementar&#xE1; el interfaz <strong><code>Interceptor</code></strong> y se encargar&#xE1; de <strong>preprocesar cualquier petici&#xF3;n al servidor y a&#xF1;a&#xF1;dir las cookies guardadas</strong> en el objeto <strong><code>AlmacenDeCookies</code></strong> a la cabecera <strong><code>Cookie</code></strong> de la petici&#xF3;n, incluida la de la sesi&#xF3;n.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin" data-line><span class="token keyword keyword-class">class</span> <span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Builder con el contenido de la peticion original</span>
        <span class="token keyword keyword-val">val</span> builder <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> almacenDeCookies<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>cookie <span class="token keyword keyword-in">in</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// A&#xF1;adimos las cookies a la cabecera Cookie de la </span>
                <span class="token comment">// peticion en el builder</span>
                builder<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Procesamos la peticion con las cookies a&#xF1;adidas</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></li>
<li>
<p>Redefinimos <strong><code>provideOkHttpClient</code></strong> inyectando el objeto <strong><code>AlmacenDeCookies</code></strong> y a&#xF1;adiendo los interceptores que hemos definido en el builder de nuestro cliente.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4, 11-15]}" class="language-kotlin" data-line="4,11-15"><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span>
    almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// El orden de los interceptores es importante si</span>
        <span class="token comment">// quiero ver la informaci&#xF3;n de las cookies en el log.</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">









<div aria-hidden="true" class="line-highlight" data-range="11-15" data-start="11" data-end="15">




</div></div></pre></li>
</ol>
<p>Tras esto <strong><code>.data/services/autenticacion/AutenticacionService.kt</code></strong> quedar&#xE1; igu&#xE1;l que antes, pero su implementaci&#xF3;n en <strong><code>.data/services/autenticacion/AutenticacionServiceImplementation.kt</code></strong> ya no necesitar&#xE1; quedarse con la cookie de la sesi&#xF3;n...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;OkHttp&quot;</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;Error al loguear a <span class="token interpolation variable">$userName</span>&quot;</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string">&quot;No hay datos&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string">&quot;Error al cerrar sesi&#xF3;n&quot;</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string">&quot;No hay datos&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;<span class="token interpolation variable">$mensajeError</span> (c&#xF3;digo <span class="token interpolation"><span class="token delimiter variable">${</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter variable">}</span></span>): <span class="token interpolation variable">$this</span>\n<span class="token interpolation"><span class="token delimiter variable">${</span>body<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string">&quot;Error: <span class="token interpolation"><span class="token delimiter variable">${</span>e<span class="token punctuation">.</span>localizedMessage<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Adem&#xE1;s, tras hacer login, ya podremos seguir us&#xE1;ndo nuestro APIRest como lo hac&#xED;amos anteriormente  pero sin tener que a&#xF1;adir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest.</p>
<p>Una posible implementaci&#xF3;n de <strong><code>./data/AutenticacionRepository.kt</code></strong> que use la implementaci&#xF3;n de nuestro servicio podr&#xED;a ser...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin"><span class="token keyword keyword-class">class</span> AutenticacionRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
        password<span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
            userName <span class="token operator">=</span> userName<span class="token punctuation">,</span>
            password <span class="token operator">=</span> password
        <span class="token punctuation">)</span><span class="token punctuation">.</span>usuario<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><div class="admonition info">
<p class="admonition-title">C&#xF3;digo de los ejemplos</p>
<p>En el siguiente enlace puedes deacargar un proyecto ejemplo con la implementaci&#xF3;n que acabamos de describir del uso de APIRest en PHP para autenticarnos con la agenda. Para ello, le hemos a&#xF1;adido una pantalla m&#xE1;s donde realizar dicha autenticaci&#xF3;n: <strong><a href="0_AgendaRetrofit_son_sesiones_recurso.zip">Proyecto ejemplo</a></strong></p>
</div>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>