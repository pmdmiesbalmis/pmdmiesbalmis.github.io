<!DOCTYPE html><html><head>
      <title>PMDM 2ยบ DAM  Tema 5.2 - retrofit</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face{font-family:"Material Icons";font-style:normal;font-weight:400;src:local("Material Icons"),local("MaterialIcons-Regular"),url("data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAfIAAsAAAAADDAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7kosY21hcAAAAYAAAADTAAACjtP6ytBnbHlmAAACVAAAAxgAAAQ4zRtvlGhlYWQAAAVsAAAALwAAADYRwZsnaGhlYQAABZwAAAAcAAAAJAeKAzxobXR4AAAFuAAAABIAAAA8OGQAAGxvY2EAAAXMAAAAIAAAACAG5AfwbWF4cAAABewAAAAfAAAAIAEfAERuYW1lAAAGDAAAAVcAAAKFkAhoC3Bvc3QAAAdkAAAAYgAAAK2vz7wkeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkPsQ4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVLy4xKzzX4chhrmK4QpQmBEkBwAZygyweJzFkr0NwjAQhZ+TEP6CRUfHBEwRUWaQTICyQbpMwRCskA5RUIONxG0RnnNpKAIV4qzPku/8c353ACYAYrIjCWCuMAh2ptf0/hiL3p/gyPUWa3osqlt0L1zu9r71z8dGrJRykFoauXQd932Lj5vhG+MjxGeYI8MKETObMpslf5EyP8tg+vHun5r539PvlvXzaVhRFVQDTPEWKVQR90KhnnC5Ek67vUKN4VuFasM/ldARj43CCkCsEjpJSoVVgRyU0GVSK6wUpFFCx8lFgX0BiXpRPQB4nE2TTWjcRhTH3xttpDhxN7uxPlp3u/FK7moRPixafRijNosxSw/LUsIwNcaEHPZggo/FmEKMCKWU4kNOOftQSlhE8alnH0Ix9BqWnHooPRrTQ0+mnu2bXTu2pPdGM9LM/6c3fwECTM4gBBMYQNqxzLrZAjqYSlqu2TAHZQA0/DQJH6FtzqGDnvbt4Ggwvzw/nL8EfH8kW0fsuRqhgWXZnY7M1picaUL7Du5BHeDzMIl83dAt016wH1qmvtSMo5R6YRJHTR//FXsff/nj/tc/5K9P5d+nP22+fFK5u7v3K39SW3y+OtDKO3L85vD09PD9z5X17a2N1g4tqk01RlqX7gyoEmnsWQtVr4rtZMmukEaFBZxzefkCn11cyKMLZgshRwgTYNoLNXCBz2ja7HvZG7hDpPSNfoo5vs0knK/9hb+rNpu+8kHPgk/Ao4kK3tWtTpSEtvkA9c+wE6UaUdwieNkaHg55tBEtRiEPw1s0+FtrtTcc9two2lhMknV7PZF/cs6+uUFTmpTGbEx7sQCPSLOttHS3GRltqp7SNzVSKzl6aWnZT/CX5k6/v9N3Hh8fHBwffJVjhrC6OgH5dkIt/tPsq+d/PD5Qz7G7efzq1THFjdZVPe/N6ulQ3JnDWSE5junsFsVIiFwL/htf1S5gJ3BfOcUxfHKLnzqpFpyfZ9cX+/5WB6a+Y0pHpzkNrYNVDwMsikK+y7WuLCRg/oFHkA8VT3rDg5ZnU6ktzzINymV0m74Xd5pfIGXyFeVEQSShkzqG7TBBa2OxVRKitLXv7h3uuftXnXq7lz2tZ/WnWa9dx9dCjDhHzmuVQATlmljr9dZErUydSo2Hbi/b1vXtrOeGCk2/8s3ZlO8+ueJT8BVlw5pGw2oYccdSiHHqx0RlabHqdNR9jAETl6PreJcPBnnfpTLnOQ8C3OV8AmQGzouV1iZdeb5SSIoVc8W8/kcDtksUH5FrU6/aqBqNWcMEzxG4DAQ14qRQhi9mWU0rzepKezbjfgCwQKxVYq5ajRgpRqy45CqwkJydcEkbTkvRz8P5/2ZpDTN4nGNgZGBgAOKb6v+/xvPbfGXgZmEAgeuB2kkI+v8bFgbmKiCXg4EJJAoAPyAKhQB4nGNgZGBg1vmvwxDDwgACQJKRARXwAwAzZQHQeJxjYQCCFAYGFgbSMQAcWACdAAAAAAAAAAwALgBgAIQAmADSAQgBIgE8AVABoAHeAfwCHHicY2BkYGDgZ7BgYGMAASYg5gJCBob/YD4DAA/hAWQAeJxlkbtuwkAURMc88gApQomUJoq0TdIQzEOpUDokKCNR0BuzBiO/tF6QSJcPyHflE9Klyyekz2CuG8cr7547M3d9JQO4xjccnJ57vid2cMHqxDWc40G4Tv1JuEF+Fm6ijRfhM+oz4Ra6eBVu4wZvvMFpXLIa40PYQQefwjVc4Uu4Tv1HuEH+FW7i1mkKn6Hj3Am3sHC6wm08Ou8tpSZGe1av1PKggjSxPd8zJtSGTuinyVGa6/Uu8kxZludCmzxMEzV0B6U004k25W35fj2yNlCBSWM1paujKFWZSbfat+7G2mzc7weiu34aczzFNYGBhgfLfcV6iQP3ACkSaj349AxXSN9IT0j16JepOb01doiKbNWt1ovippz6sVYYwsXgX2rGVFIkq7Pl2PNrI6qW6eOshj0xaSq9mpNEZIWs8LZUfOouNkVXxp/d5woqebeYIf4D2J1ywQB4nG3LOw6AIBAE0B384B+PAkgEa+QwNnYmHt+EpXSal5lkSBBnoP8oCFSo0aCFRIceA0ZMmLFAYSW88rmvtMUjG3RiQ9HvpfusM6zWNmtc5H/iPewha50tOt5PS/QBx2IeSwAA") format("woff")}.admonition{box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);position:relative;margin:1.5625em 0;padding:0 1.2rem;border-left:.4rem solid rgba(68,138,255,.8);border-radius:.2rem;background-color:rgba(255,255,255,.05);overflow:auto}.admonition>p{margin-top:.8rem}.admonition>.admonition-title{margin:0 -1.2rem;padding:.8rem 1.2rem .8rem 3.6rem;border-bottom:1px solid rgba(68,138,255,.2);background-color:rgba(68,138,255,.1);font-weight:700}.admonition>.admonition-title:before{position:absolute;left:1.2rem;font-size:1.5rem;color:rgba(68,138,255,.8);content:"\E3C9"}.admonition>.admonition-title:before{font-family:Material Icons;font-style:normal;font-variant:normal;font-weight:400;line-height:2rem;text-transform:none;white-space:nowrap;speak:none;word-wrap:normal;direction:ltr}.admonition.abstract,.admonition.summary,.admonition.tldr{border-left-color:rgba(0,176,255,.8)}.admonition.abstract>.admonition-title,.admonition.summary>.admonition-title,.admonition.tldr>.admonition-title{background-color:rgba(0,176,255,.1);border-bottom-color:rgba(0,176,255,.2)}.admonition.abstract>.admonition-title:before,.admonition.summary>.admonition-title:before,.admonition.tldr>.admonition-title:before{color:#00b0ff;content:"\E8D2"}.admonition.hint,.admonition.tip{border-left-color:rgba(0,191,165,.8)}.admonition.hint>.admonition-title,.admonition.tip>.admonition-title{background-color:rgba(0,191,165,.1);border-bottom-color:rgba(0,191,165,.2)}.admonition.hint>.admonition-title:before,.admonition.tip>.admonition-title:before{color:#00bfa5;content:"\E80E"}.admonition.info,.admonition.todo{border-left-color:rgba(0,184,212,.8)}.admonition.info>.admonition-title,.admonition.todo>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.info>.admonition-title:before,.admonition.todo>.admonition-title:before{color:#00b8d4;content:"\E88E"}.admonition.check,.admonition.done,.admonition.success{border-left-color:rgba(0,200,83,.8)}.admonition.check>.admonition-title,.admonition.done>.admonition-title,.admonition.success>.admonition-title{background-color:rgba(0,200,83,.1);border-bottom-color:rgba(0,200,83,.2)}.admonition.check>.admonition-title:before,.admonition.done>.admonition-title:before,.admonition.success>.admonition-title:before{color:#00c853;content:"\E876"}.admonition.faq,.admonition.help,.admonition.question{border-left-color:rgba(100,221,23,.8)}.admonition.faq>.admonition-title,.admonition.help>.admonition-title,.admonition.question>.admonition-title{background-color:rgba(100,221,23,.1);border-bottom-color:rgba(100,221,23,.2)}.admonition.faq>.admonition-title:before,.admonition.help>.admonition-title:before,.admonition.question>.admonition-title:before{color:#64dd17;content:"\E887"}.admonition.attention,.admonition.caution,.admonition.warning{border-left-color:rgba(255,145,0,.8)}.admonition.attention>.admonition-title,.admonition.caution>.admonition-title,.admonition.warning>.admonition-title{background-color:rgba(255,145,0,.1);border-bottom-color:rgba(255,145,0,.2)}.admonition.attention>.admonition-title:before{color:#ff9100;content:"\E417"}.admonition.caution>.admonition-title:before,.admonition.warning>.admonition-title:before{color:#ff9100;content:"\E002"}.admonition.fail,.admonition.failure,.admonition.missing{border-left-color:rgba(255,82,82,.8)}.admonition.fail>.admonition-title,.admonition.failure>.admonition-title,.admonition.missing>.admonition-title{background-color:rgba(255,82,82,.1);border-bottom-color:rgba(255,82,82,.2)}.admonition.fail>.admonition-title:before,.admonition.failure>.admonition-title:before,.admonition.missing>.admonition-title:before{color:#ff5252;content:"\E14C"}.admonition.bug,.admonition.danger,.admonition.error{border-left-color:rgba(255,23,68,.8)}.admonition.bug>.admonition-title,.admonition.danger>.admonition-title,.admonition.error>.admonition-title{background-color:rgba(255,23,68,.1);border-bottom-color:rgba(255,23,68,.2)}.admonition.danger>.admonition-title:before{color:#ff1744;content:"\E3E7"}.admonition.error>.admonition-title:before{color:#ff1744;content:"\E14C"}.admonition.bug>.admonition-title:before{color:#ff1744;content:"\E868"}.admonition.example,.admonition.snippet{border-left-color:rgba(0,184,212,.8)}.admonition.example>.admonition-title,.admonition.snippet>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.example>.admonition-title:before,.admonition.snippet>.admonition-title:before{color:#00b8d4;content:"\E242"}.admonition.cite,.admonition.quote{border-left-color:rgba(158,158,158,.8)}.admonition.cite>.admonition-title,.admonition.quote>.admonition-title{background-color:rgba(158,158,158,.1);border-bottom-color:rgba(158,158,158,.2)}.admonition.cite>.admonition-title:before,.admonition.quote>.admonition-title:before{color:#9e9e9e;content:"\E244"}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v19/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.markdown-preview.markdown-preview .caso_estudio {
  background-color: #f5f5f5;
  border: 2px solid #969696;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .ejercicio {
  background-color: #f5faf5;
  border: 2px solid #969b96;
  padding-left: 15px;
  padding-right: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.markdown-preview.markdown-preview .fondo {
  background: url(https://programacioniesbalmis.github.io/Imagenes/BannersMoodle/banner.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.markdown-preview.markdown-preview .cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.markdown-preview.markdown-preview .abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.markdown-preview.markdown-preview .cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.markdown-preview.markdown-preview .autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
.markdown-preview.markdown-preview .flotante {
  display: flex;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: center;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: space-between;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: row;
  }
}
.markdown-preview.markdown-preview .flotante_izq {
  margin-right: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: auto;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: auto;
  }
}
.markdown-preview.markdown-preview .galeria_imagenes {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: row;
  }
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="tema-52---retrofit">Tema 5.2 - Retrofit </h1>
<p>Descargar estos apuntes <a href="./Tema_5_2_retrofit.pdf">pdf</a> o <a href="./Tema_5_2_retrofit.html">html</a></p>
<h2 id="รญndice">รndice </h2>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#introducciรณn" class="md-toc-link"><p>Introducciรณn</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#quรฉ-es-json" class="md-toc-link"><p>ยฟQuรฉ es JSON?</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#tipos-de-datos-en-json" class="md-toc-link">
            <p>Tipos de datos en JSON</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#definiciรณn-de-un-servidor-rest-rรกpido-para-pruebas" class="md-toc-link"><p>Definiciรณn de un Servidor Rest rรกpido para pruebas</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#creando-la-base-de-datos-con-phpmyadmin" class="md-toc-link">
            <p>Creando la Base de Datos con phpMyAdmin</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#consumo-de-un-servicio-rest-desde-android" class="md-toc-link"><p>Consumo de un Servicio Rest desde Android</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#configuraciรณn-del-proyecto" class="md-toc-link">
            <p>Configuraciรณn del proyecto</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#crear-los-servicios-con-retrofit" class="md-toc-link"><p>Crear los servicios con Retrofit</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-los-tipos-a-serializar-a-json" class="md-toc-link">
            <p>Definiendo los tipos a serializar a JSON</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#definiendo-las-peticiones-para-consumo-del-endpoint" class="md-toc-link">
            <p>Definiendo las peticiones para consumo del '<em>endpoint</em>'</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#preparando-los-objetos-de-retrofit-con-hilt" class="md-toc-link">
            <p>Preparando los objetos de Retrofit con Hilt</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#implementaciones-de-la-gestiรณn-del-consumo-de-nuestro-endpoint" class="md-toc-link">
            <p>Implementaciones de la gestiรณn del '<em>consumo</em>' de nuestro endpoint</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#usando-nuestra-implementaciรณn-del-servicio-en-el-patrรณn-repository" class="md-toc-link"><p>Usando nuestra implementaciรณn del servicio en el patrรณn Repository</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#acceder-a-la-api-iniciando-una-sesiรณn-en-el-servidor" class="md-toc-link">
            <p>Acceder a la API iniciando una sesiรณn en el servidor</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 id="introducciรณn">Introducciรณn </h2>
<ul>
<li>
<p><strong>Persistencia remota consumiendo un API Rest con Retrofit2</strong></p>
<ul>
<li>Pรกgina oficial librerรญa: <strong><a href="https://square.github.io/retrofit/">Retrofit</a></strong></li>
<li>Guรญa usuario: <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">Gson</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=MRzcCnkZQlA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial <strong>Interceptores</strong> (Castellano): <strong><a href="https://www.youtube.com/watch?v=MQdhmAaVmeA">Martin Kiperszmid</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=2_DnhfQrwXQ">DevExperto</a></strong></li>
<li>Video Tutorial (Castellano): <strong><a href="https://www.youtube.com/watch?v=L3pM5YuxYp4">AristiDevs</a></strong></li>
</ul>
</li>
</ul>
<p>En la gran mayorรญa de aplicaciones mรณviles, se necesita acceder a datos que no estรกn en el dispositivo, sino que estรกn en un servidor remoto. Para ello se utilizan que permiten el acceso a los datos a travรฉs de internet. Estos servicios pueden ser <strong>API Rest</strong>, <strong>GraphQL</strong>, <strong>WebSockets</strong>, <strong>gRPC</strong>, etc. En este tema nos centraremos en los servicios API Rest, que son los mรกs utilizados.</p>
<p>Los Servicios web REST, utilizan el protocolo HTTP para intercambiar informaciรณn entre el cliente y el servidor. Nosotros en el curso vamos a utilizar una arquitectura similar a la siguiente:</p>
<p align="center" class="puml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="227px" preserveAspectRatio="none" style="width:522px;height:227px;background:#FFFFFF;" version="1.1" viewBox="0 0 522 227" width="522px" zoomAndPan="magnify"><defs></defs><g><!--cluster azure--><g id="cluster_azure"><rect fill="none" height="214" rx="2.5" ry="2.5" style="stroke:#444444;stroke-width:1.0;stroke-dasharray:7.0,7.0;" width="313" x="203" y="7"></rect><text fill="#444444" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="45" x="337" y="25.6094">Azure</text><text fill="#444444" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="62" x="328.5" y="41.582">[container]</text></g><!--entity api--><g id="elem_api"><rect fill="#1168BD" height="143.4688" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="90" x="219" y="61.5"></rect><image height="48" width="48" x="240" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAEtUlEQVR4XtWYP4pUQRCHvYI38AgewcADeARDQzE2MBIzjU1MjDU1EVEwkUUDQQMDNzBREBHEwGTkG/iW2l/1m+nZnUW34bfzXnV1df3vfnvh4o3nF84zGuEs8O7w5+rm44+rpO8C1j969aXJaIz7xpW7bw4+f/u9Yrz48H116dbLq8mzCfDjAAZycr4t2Dfw3J0nn9YKMFBm1gj4NJ51Tw++trVt0b5B2K89eLsOv2OUCiiWyhExx/WH79friGjlaRvuG3iNTas3GXj0x68/a9QBj3AgA1n3nx2unVHltw33DQ3gGSNIJ9Lq8u3X9+RBKQYKSoMXei1+5olEld823AUZ8hGqAZuAx7fxYUB2s8Y0AlazmBxUiKFnY7yaa4Q1kHTkVIXSsyPsHAGYUdCFeAhleM8BX00LYcpUGkYZvZo2CXhqVEbOaIsEm9IFkq7gWmQOopK8SweQWDIAOsZXhUnHdFJbCLCaLpH0BMLYACzlLzzIAiOekQHQsr50WvK2DcFs4c3ADlNpGGUNYJjP1lmluYZojJzaNgQjS3cBSpN+yFEhFEivYkgW5YimzFG02uYI8ODYBfZ4lM4IsvlI5kihER1Z1FfmP2iLYR5ttglsWE/VUVtlLiNAlDKFvPNUPtaN0gc0AsxL3SdBh1EB1nnfqSnoPQgeDMtW6BljXdT0sYO5rrZf0ZQC22rAzsKG5rpzKFfPBHMa4FnmMxV0RJ4XnjusU8aUAVg6KiRgN8gcz66lkt5pRH4TqJhyavohA/66PvVpCrowc87UMt9T4VngnPT0ErYdgqARhGHjGYNICzfWqz7n2m3Qq0mvMFpJTzSC8OTD05tuill4syDCS+tQnvkZ5zRCBR5nLCkPZjcaAQ9nilhjszIbQRgBUikPloptHWsbkG16js6AbWgEUUOM0NHhBE5rACDCNohNzhqhEQAK105hKuX3q0PPsTm82ednQdTZYxcjGsFTj2cPJQR6xchhBFDaPg4fdC9xm2oo9/Zknm21x16sfp7NySwmrwt1JI+AjhwNymvEEozEUpeqOLbIKwAey4OsAk/VMestlMcIjRmlWr0TzRh89FAPLpQfCa9AsDWhtzBkNl3g9za6yQHen5IujoTZvmCebWVEDQVybDM+ZdhK+R2lI4YuOWb9p+b6SU5WPEhaiV0MSDlLhmCERV7n2j+L8P5JFdgXRobwS3YwV0/w9ZcSEYAITnPT3DfwtgWfEcEQ6GvLEinoX0NDcHQFzm7M5w2NADIi/2NURCNQOKOxj0vbSWDxJl00AgvoQgDFvZxlFPJ9aW5TBEf0pHmlST7RCBUYkNbXu1A9sWm/9VDjuUazHo7ebh0onTQKl73rGN1Sm9IVLKoGsIn/IWNTW68GOGf0PCBpy7x7z+LZA8mW7RzPOEmvo3Q9aBONUJEG5CegHuIZA6qXqZn6EaQsaKN6Mgoq7L/qfU9+0QgVaYBp4XsaUI1bMmBJIQ9UvyfOxIAaWuAljOdZA0gdRk0JHSENOWdiABsgGOVIJ0b9bp4xgGdTxN9aM9I0QOPYb3TtbkpXsCCLx1y1vUpno3qHwrA6n7KYx0CNghcei7veiK2d0SWzKX3e0AjnDX8B7RkSoeh+TNYAAAAASUVORK5CYII=" y="71.5"></image><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="70" x="229" y="136.1094">Endpoint</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="26" x="231.5" y="156.2344">API</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="4" x="257.5" y="156.2344">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="35" x="261.5" y="156.2344">Rest</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="262" y="174.2832">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="230" y="191.8926">Jakarta</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="276" y="191.8926">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="280" y="191.8926">EE</text></g><!--entity db--><g id="elem_db"><path d="M432,77 C432,67 466,67 466,67 C466,67 500,67 500,77 L500,189.3438 C500,199.3438 466,199.3438 466,199.3438 C466,199.3438 432,199.3438 432,189.3438 L432,77 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"></path><path d="M432,77 C432,87 466,87 466,87 C466,87 500,87 500,77 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"></path><image height="48" width="48" x="442" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAADD0lEQVR4XtWZsYoUQRCG9xV8Ax/BRzDwAXwEQ0MxNjASM41NTIw1NRFRMJHDCwQNDLzAREFEEAOTla/hP2qranZnemp3Zxu+u9ua2Znq+qureuZWV26/WsHVu29ugD6fCu3Hi7Pva41ff/6tn779tr7+4P2ZP3mJrO48+9wcZxJ2IrItXZUWfaJujUwKG4PfNx9/2Di+JFb3n39pjl679+6hP/jo5YUVpE3m64+/LcVuPfm4iEm1xYtj5xe/U4dYCziMUq8//bxURhMiAP47h6T9IJoMIu5PyGBSdr2gyrEW/eUfRJkxJd9Rz06Ea/hz9s3GB9LIL2iRrRFB9FFBahyycm18wBGcyPKayQ2tEyE1CMKhUioYWKhE0duJKs7tckx9hXGIShUMciBzNFMmQ0WBMWVN9RAMivTYijSEnUQWjCqCAVTvvX0qUpNrbSsCcwgGQPYq+VWedxWAXoJBsJBRwtt7wHnG3LTMCAYh+StUIH3axdb16yEYLGpsFfmrTWNWoucQDBYcZwJVqaRuXdkfgsGDClUTUGmtXNDBYFFPGNvAxqDteNVaCAaLIla5OdNDEvsmf6yHYLBQwyvlBqnKqCgOwWDB+X3s8dXcKq4dDJZ9PTLavjA3PYPBwg2yCVRIr2eHud05GCzZBKgeFRs9PTzNVSEYLDjqI6R9DVsNf/5U6C9ZkKYQDBZuYMudjVrFlkC7XkavCsFgUc3WZ7ufYVRsCbQWULbnesFg8c8FKn9MjBtXqEDklZYMrjklPYPBY58LlLNESqVwys22QXoSmKnvZIPBIxX0EpihMooiFRXJwz2lyq5mFwwZ9iWv31rsq1uDHqrIgqHeEwxDIHG2yMhhbjBG7h5wXGpk9whf6EHvSHtL4Rikhl9z4cQ5zGlIQ6AA6hP97AV0+MJcMpmngIpE2ZZWO3yZDRc4NoqynOUzDg89wQXDsbFbbZ/vGcGwBOwbbr+Z9ATDUrCT2PYvrGBYErYHMLIqF760RGig2gH7rh9OXjKaiF0X4aRTABWUTuHgqYAaNM1w4NT4D5unn4E/pEF9AAAAAElFTkSuQmCC" y="91"></image><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="24" x="454" y="155.6094">BD</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="464" y="173.6582">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="443" y="191.2676">MySQL</text></g><!--entity android--><g id="elem_android"><rect fill="#1168BD" height="123.3438" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="100" x="7" y="71.5"></rect><image height="48" width="48" x="33" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAADCElEQVR4Xu2ZPaoVQRCF3xbcgUtwCQYuwCUYGoqxgZGYaWxiYqypiYiCiTw0EDQw8AUmCiKCGJhc+S6eS91T3e/V9EwyMAWHO/d096mu7p7+m5NLN1+crBmJWBsSMYJbTz7trj98t3O+B/JSxvkRJGIUz06/lSs0Je9FSMQobjz6sG9VWvfx66+792e/dj9//92DZzi1PHm9/CgSMQoqVrWlhg9IxAhefvzhdbzQKOM6I0jEVDA8Ro2yrjcViZgCxnWszOXbr659+f4nVPHYSCNPDPrB87NZQSSiiit33twPddu/rHeffo5U08hD3mhouX4Viagitv5cm9MLiajivKEy1dBy/SoSUYVXYq65fhWJ6IFF6Oq9t6fx/5JwXfffQyJaiPO8tgFaZZcCmmjLqutEIhy0+kH1vzEVOjfXWpqxx3tIhIPudPMpdAlraVaGUiIcWwBFa2luAWwBTLCW5hbAFsAEa2kuEsDqV2IQT1DaCwU/ixiacS9UPW4mogeuQmKXBt+LmHTxMeXaJRFVsINc0ly/ikRUMXKV0rPq1rmFRFTBS8eY5TjYOl7SQ0pr9ZbS0EDL9atIxCi8gvGgzrOblx9FIkbhFdwCKCIRo/AKrj4AbuCU1rqx8/KjSMQo/JI3LkY8R6uushUkYhTsWzRdtr7AaJtAnsoep4pErA2JWBuO/vCyMT4j2KeTxjhmyYeLL6g4gRlHKyvPrsetdlx55RMdvTf4hGOoefno+ygABBifOCWTpj7ENIvgHJ582r/wvYt0ldHWgUqys1SaoO2D+9R1PXl0uCGAWNZ9HwLQoSW+XBLRb4y8lT8CJ95SgoLQSU89rDTpelrP956kFXXBKqjiLUeA/L2vjbQQLUqFaG1BO1haUl81W5Xr+Yy+NdxSQWVSAJrDXawXAENHaZSlskDTKOO451ND5Lwe8OAOCRqDOEKoGoDGpsYxvCrpcC0FRTn1DprxHZB2bATySzM5UFcjwi8i/PqenXy0hvIDnntjX5Cm/lNhylEp8e476vtxMzlYG/4BRm/xcYdSVVEAAAAASUVORK5CYII=" y="81.5"></image><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="80" x="17" y="146.1094">Aplicaciรณn</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="55" y="164.1582">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="28" y="181.7676">Retrofit</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="74" y="181.7676">&nbsp;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="8" x="78" y="181.7676">2</text></g><!--link android to api--><g id="link_android_api"><path d="M107.1,133 C141.1,133 177.97,133 210.84,133 " fill="none" id="android-to-api" style="stroke:#666666;stroke-width:1.0;"></path><polygon fill="#666666" points="218.84,133,210.84,130,210.84,136,218.84,133" style="stroke:#666666;stroke-width:1.0;"></polygon><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="19" x="138" y="114.457">API</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="3" x="157" y="114.457">&nbsp;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="26" x="160" y="114.457">Rest</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="37" x="143.5" y="129.5508">[HTTP]</text></g><!--link api to db--><g id="link_api_db"><path d="M309.39,133 C346.44,133 390.44,133 423.93,133 " fill="none" id="api-to-db" style="stroke:#666666;stroke-width:1.0;"></path><polygon fill="#666666" points="431.93,133,423.93,130,423.93,136,431.93,133" style="stroke:#666666;stroke-width:1.0;"></polygon><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="61" x="340" y="114.457">Eclipselink</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="38" x="351.5" y="129.5508">[JDBC]</text></g><!--SRC=[XP3VIiCm5CRlVOeOlDXWMs5w9IhiJtGR7TQkknW89MkY2qlJc9mwglXKFe8lPj8DDqNOJK9ElkztplaGGgT2PR9a7Aq0jBqC0aCtdMS1gt9PMcwoGW5NqCcAFD2IAYXpsRR0f5W6Wujsv4lpQHZar08thfGEd8CAnKr7E-q9EcXn1QMcp9m7ZByAHxRT08eyev1APqWtXM4vDUkROwQyiY_og8egPWh1VcD7uo59Pmc9oNsoY4YZwOjXRt4_JzAGt2PfFBuR9Tloh78xvOqTfuLmJqkHqKnyVIhidZ47Kpm9G5ttEhFQ2E3N-6zRNBFGJonfloWLewPgqBVIS8_rDswYToUhjUYWkHPEGHJJXL3mg7hH6CNS0cxX2LrJ0nGHSjZ-lq1t8-onmsM3BHstF_HxJAlPGtZ8gFFTcJxy6NEvZs4xqduGX4T94ctbjT3_rtYIIQ4jTxEilMmox0zmyni0]--></g></svg></p><p>Donde tenemos una aplicaciรณn Android que se comunica con un servidor web que tiene un API Rest, que a su vez se comunica con una base de datos MySQL. En este tema nos centraremos en consumo de dicho API Rest desde la aplicaciรณn Android utilizando una librerรญa llamada <strong>Retrofit2</strong>.</p>
<div class="admonition info">
<p class="admonition-title">Informaciรณn</p>
<p>Uno de los inconvenientes de <strong>Retrofit2</strong> es que al funcionar sobre la librerรญa de Java <strong><a href="https://square.github.io/okhttp/">OkHttp</a></strong>, no es compatible con la programaciรณn multiplataforma. Disponemos de una alternativa muy potente y extendida denominada <strong><a href="https://ktor.io/docs/client-create-multiplatform-application.html">Ktor Client</a></strong> que ademรกs es una muy buena documentaciรณn dispone de una montรณn de <strong><a href="https://www.youtube.com/watch?v=n_NzI6vUR-k">vรญdeos de la comunidad explicando su uso en Android</a></strong>.<br>
Existen incluso librerรญas como <strong><a href="https://foso.github.io/Ktorfit/">Kotrfit</a></strong> que imitan el funcionamiento de Retrofit2 pero utilizando Ktor Client por debajo y asรญ facilitar la migraciรณn.</p>
</div>
<p>El formato de los datos que se intercambian entre el cliente y el servidor es muy importante. En este tema nos centraremos en el formato <strong>JSON</strong>.</p>
<h3 id="quรฉ-es-json">ยฟQuรฉ es JSON? </h3>
<p>Aunque seguramente ya lo has visto en el mรณdulo de Acceso a Datos. Vamos ha realizar un resumen rรกpido sobre dicho formato a modo de recordatorio.</p>
<p><strong>JSON</strong> (Javascript Object Notation) es un formato ligero de intercambio de datos entre clientes y servidores, basado en la sintaxis de Javascript para representar estructuras en forma organizada. Es un formato en texto plano independiente de todo lenguaje de programaciรณn, es mรกs, soporta el intercambio de datos en gran variedad de lenguajes</p>
<h4 id="tipos-de-datos-en-json">Tipos de datos en JSON </h4>
<p>Similar a la estructuraciรณn de datos primitivos y complejos en los lenguajes de programaciรณn, JSON establece varios tipos de datos: <strong><code>cadenas</code></strong>, <strong><code>nรบmeros</code></strong>, <strong><code>booleanos</code></strong>, <strong><code>arrays</code></strong> y <strong><code>objetos</code></strong>. El propรณsito es crear objetos que contengan varios atributos compuestos como pares clave valor. Donde la clave es un nombre que identifique el uso del valor que lo acompaรฑa. Veamos un ejemplo:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
   <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
   <span class="token property">"nombre"</span><span class="token operator">:</span> <span class="token string">"Carlos"</span><span class="token punctuation">,</span>
   <span class="token property">"estaActivo"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">"notas"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p>La anterior estructura es un objeto JSON compuesto por los datos de un estudiante. Los objetos JSON contienen sus atributos entre llaves <strong><code>{}</code></strong>, al igual que un bloque de cรณdigo en Javascript, donde cada atributo debe ir separado por coma <strong><code>,</code></strong> para diferenciar cada par.</p>
<p>La sintaxis de los pares debe contener dos puntos <strong><code>:</code></strong> para dividir la clave del valor. El nombre del par debe tratarse como cadena y aรฑadirle comillas dobles.</p>
<p>Si te fijas en nuestro ejemplo, este trae un ejemplo de cada tipo de dato:</p>
<ul>
<li>
<p><strong><code>id</code></strong> es de tipo entero, ya que contiene un nรบmero que representa el cรณdigo del estudiante.</p>
</li>
<li>
<p><strong><code>nombre</code></strong> es un string. Usa comillas dobles para definirlas.</p>
</li>
<li>
<p><strong><code>estaActivo</code></strong> es un tipo booleano que representa si el estudiante se encuentra en la instituciรณn educativa o no. Usa las palabras reservadas <strong><code>true</code></strong> y <strong><code>false</code></strong> para declarar el valor.</p>
</li>
<li>
<p><strong><code>notas</code></strong> es un arreglo de nรบmeros reales. El conjunto de sus elementos debes incluirlos dentro de corchetes <strong><code>[ ]</code></strong> y separarlos por coma.</p>
</li>
</ul>
<p>La idea es crear un mecanismo que permita recibir la informaciรณn que contiene la base de datos externa en formato JSON hacia la aplicaciรณn. Con ello se parsearรก cada elemento y serรก interpretado en forma de objeto Kotlin para integrar correctamente el aspecto en la interfaz de usuario.</p>
<p>Para realizar este proceso podemos utilizar diferentes librerรญas para la serializaciรณn y deserializaciรณn de objetos JSON. En este tema nos centraremos en la librerรญa de Google <strong>Gson</strong>, aunque <strong>Retrofit2</strong> es agnรณstico a la forma de serializar y tambiรฉn nos permite utilizar otras librerรญas como <strong>Jackson</strong>, <strong>Moshi</strong>, etc.</p>
<div style="page-break-after:always;"></div>
<h2 id="definiciรณn-de-un-servidor-rest-rรกpido-para-pruebas">Definiciรณn de un Servidor Rest rรกpido para pruebas </h2>
<div class="admonition info">
<p class="admonition-title">Cรณdigo de los ejemplos</p>
<p>Si te surge alguna duda o tienes dificultades para completar este tema. Puedes descargar el proyecto con el cรณdigo de mismo del siguiente enlace: <strong><a href="0_AgendaRetrofit_recurso.zip">Proyecto ejemplos</a></strong></p>
</div>
<p>Una forma rรกpida de <strong>definir una API Rest rรกpido</strong> para probar desde Android, es mediante la librerรญa de PHP proporcionada en el mรณdulo de Acceso a datos <strong><a href="apiRest-PHP-Session_recurso.zip">apiRest-PHP-Session.zip</a></strong>.</p>
<div class="flotante" ,="" style="align-items: center;">
<div class="flotante_izq">
<p>Por si no la has visto en el mรณdulo de Acceso a Datos, vamos a realizar un resumen rรกpido sobre el uso dicha librerรญa...</p>
<p>Debes instalar un servidor web Apache con PHP y MySQL. En el mรณdulo de Acceso a Datos se ha utilizado <strong>xampp</strong>. En la carpeta <strong><code>xampp\htdocs</code></strong>, o en la carpeta pรบblica de tu servidor web, debes descomprimir el fichero <strong>apiRest-PHP-Session.zip</strong> y renombrar su contenido por ejemplo por la BD que quieras utilizar. Supongamos que queremos crear el servicio de API Rest para la Agenda que hemos ido creando durante el curso. En este caso renombraremos la carpeta <strong><code>apiRest-PHP-Session</code></strong> por agenda como se aprecia a la derecha <strong><code>agenda</code></strong>.</p>
</div>
<div class="flotante_der">
<p align="center" class="puml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="153px" preserveAspectRatio="none" style="width:182px;height:153px;background:#FFFFFF;" version="1.1" viewBox="0 0 182 153" width="182px" zoomAndPan="magnify"><defs></defs><g><rect fill="#EEEEEE" height="18.0938" style="stroke:#000000;stroke-width:1.0;" width="63" x="6" y="6"></rect><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="11" x="8" y="20.457">C:</text><line style="stroke:#000000;stroke-width:1.0;" x1="58" x2="58" y1="6" y2="24.0938"></line><polygon fill="#000000" points="61,12,67,12,64,19.0938" style="stroke:#000000;stroke-width:1.0;"></polygon><path d="M17,31.1875 L17,32.1875 L25,32.1875 L25,31.1875 L17,31.1875 M17,33.1875 L17,39.0975 C17,39.1475 17.04,39.1875 17.09,39.1875 L24.9,39.1875 C24.95,39.1875 24.99,39.1475 24.99,39.0975 L24.99,33.1875 L22.02,33.1875 L22.02,34.2175 L19.99,34.2175 L19.99,33.1875 L16.99,33.1875 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="26" y="39.5508">[SERVIDORES]</text><path d="M27,46.2813 L27,47.2813 L35,47.2813 L35,46.2813 L27,46.2813 M27,48.2813 L27,54.1913 C27,54.2413 27.04,54.2813 27.09,54.2813 L34.9,54.2813 C34.95,54.2813 34.99,54.2413 34.99,54.1913 L34.99,48.2813 L32.02,48.2813 L32.02,49.3113 L29.99,49.3113 L29.99,48.2813 L26.99,48.2813 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="43" x="36" y="54.6445">[xampp]</text><path d="M37,61.375 L37,62.375 L45,62.375 L45,61.375 L37,61.375 M37,63.375 L37,69.285 C37,69.335 37.04,69.375 37.09,69.375 L44.9,69.375 C44.95,69.375 44.99,69.335 44.99,69.285 L44.99,63.375 L42.02,63.375 L42.02,64.405 L39.99,64.405 L39.99,63.375 L36.99,63.375 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="43" x="46" y="69.7383">[htdocs]</text><path d="M47,76.4688 L47,77.4688 L55,77.4688 L55,76.4688 L47,76.4688 M47,78.4688 L47,84.3788 C47,84.4288 47.04,84.4688 47.09,84.4688 L54.9,84.4688 C54.95,84.4688 54.99,84.4288 54.99,84.3788 L54.99,78.4688 L52.02,78.4688 L52.02,79.4988 L49.99,79.4988 L49.99,78.4688 L46.99,78.4688 " fill="#0000FF" style="stroke:;stroke-width:0.0;stroke-dasharray:;"></path><text fill="#0000FF" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="50" x="56" y="84.832">[agenda]</text><path d="M57,91.5625 L57,92.5625 L65,92.5625 L65,91.5625 L57,91.5625 M57,93.5625 L57,99.4725 C57,99.5225 57.04,99.5625 57.09,99.5625 L64.9,99.5625 C64.95,99.5625 64.99,99.5225 64.99,99.4725 L64.99,93.5625 L62.02,93.5625 L62.02,94.5925 L59.99,94.5925 L59.99,93.5625 L56.99,93.5625 " fill="#000000" style="stroke:;stroke-width:0.0;stroke-dasharray:;"></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="22" x="66" y="99.9258">[inc]</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="56" y="115.0195">.htaccess</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="119" x="56" y="130.1133">apirest_variables.php</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="56" y="145.207">index.php</text><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="9" y="33.6406"></rect><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="19" y="48.7344"></rect><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="10" y1="36.6406" y2="49.7344"></line><line style="stroke:#888888;stroke-width:1.0;" x1="10" x2="18" y1="49.7344" y2="49.7344"></line><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="29" y="63.8281"></rect><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="20" y1="51.7344" y2="64.8281"></line><line style="stroke:#888888;stroke-width:1.0;" x1="20" x2="28" y1="64.8281" y2="64.8281"></line><rect fill="none" height="2" style="stroke:#888888;stroke-width:1.0;" width="2" x="39" y="78.9219"></rect><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="30" y1="66.8281" y2="79.9219"></line><line style="stroke:#888888;stroke-width:1.0;" x1="30" x2="38" y1="79.9219" y2="79.9219"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="95.0156"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="95.0156" y2="95.0156"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="110.1094"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="110.1094" y2="110.1094"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="125.2031"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="125.2031" y2="125.2031"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="40" y1="81.9219" y2="140.2969"></line><line style="stroke:#888888;stroke-width:1.0;" x1="40" x2="48" y1="140.2969" y2="140.2969"></line><!--SRC=[HP3HQy8m4CRVyrVSqz28fJeT8moHQHrpYcAhBw8ZRMysK9EIf4MH_U-BdNFSq_s-xplkRcWirzRmt98BsLCwOfJk2Rb4f0Kl3x4w3RPXiDgyZnUh8DoHrfsU-B4ehk1ECfkgnDJ8iKJbIhCuBt7mgrEwvGUKATzHMdlkGI6JtOrucUL9WiRSUbu8ZSP-LbmB7kTel28hRfgGAPxg_jlLq8skpo3Bd4kxdi-WGcs4aj3nkdwtvpqsego42SRGwKFNPpsV-NqO1H5SvIPfl2rdO5If4uHK6Aj5N5gNRv8fhpYiIcd54Hai2fJJySSVW41MGYjvH6d9T3F_Dpprsg_2GeZQRGAREHdZ5ozpwnA9IeKyC5X7a_OpcN5vADrp6A0X8-NcwZE38Fm1]--></g></svg></p></div>
</div>
<p>La configuraciรณn de nuestro API consta de dos archivos:</p>
<ol>
<li>
<p><strong><code>.htaccess</code></strong> En este archivo se configuran las reglas de acceso, y solo deberemos modificar la lรญnea <strong><code>RewriteBase</code></strong> para indicar la ruta de acceso a la carpeta de nuestro API. En nuestro caso cambiaremosel valos de la cadena <strong><code>"/apirest-session/"</code></strong> por <strong><code>"/agenda/"</code></strong>.</p>
<pre data-role="codeBlock" data-info="bash { highlight=[2,6] }" class="language-bash bash" data-line="2,6"><code>RewriteEngine On
RewriteBase <span class="token string">"/apirest-session/"</span>
<span class="token punctuation">..</span>.

RewriteEngine On
RewriteBase <span class="token string">"/agenda/"</span>
<span class="token punctuation">..</span>.
</code><div class="line-highlight-wrapper">
<div aria-hidden="true" class="line-highlight" data-range="2" data-start="2">
</div></div><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="2">
<li>
<p><strong><code>apirest_variables.php</code></strong>, en este archivo se definen los  datos de conexiรณn a la base de datos. se indican las tablas que tiene esta y el nombre del identificador de cada una de ellas.</p>
<pre data-role="codeBlock" data-info="php" class="language-php php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

    <span class="token comment">// CONFIGURACIรN BASE DE DATOS MYSQL</span>
    <span class="token variable">$servername</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"root"</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    
    <span class="token comment">// BASE DE DATOS</span>
    <span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"agenda"</span><span class="token punctuation">;</span>

    <span class="token comment">// ACCESO USUARIOS (si estรก vacรญo funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// $usuarios["juanjo"]="_IesBalmis1";</span>
    <span class="token comment">// $usuarios["xusa"]="_IesBalmis2";</span>
    <span class="token comment">// $usuarios["pepe"]="_IesBalmis3";</span>
    
    <span class="token comment">// TABLAS Y SU CLAVE</span>
    <span class="token variable">$tablas</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tablas</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"contactos"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">;</span>
</span></code></pre></li>
</ol>
<p>El resto de archivos del ApiREst <strong>no tendrรกn que modificars</strong>e, ya que estรก construida de forma genรฉrica con las necesidades mรกs comunes para estos casos.</p>
<div style="page-break-after:always;"></div>
<h3 id="creando-la-base-de-datos-con-phpmyadmin">Creando la Base de Datos con phpMyAdmin </h3>
<p>Para crear la base de datos con <strong><code>phpMyAdmin</code></strong>, deberemos crear una base de datos y para ello pudes bajarte el siguiente <strong><a href="agenda_mysql_recurso.zip">recurso</a></strong> en รฉl encontrarรก el archivo <strong><code>agenda_mysql_datos.sql</code></strong> que contiene el script de creaciรณn de la base de datos, incluyendo las imรกgenes de ejemplo en formato <strong><code>blob</code></strong> (base64).</p>
<div class="galeria_imagenes">
    <img height="" src="assets/imagenes/tema_5_2/agenda.png">
</div>
<p>Para acceder a <strong><code>phpMyAdmin</code></strong> debes ir a la url <strong><code>http://localhost/phpmyadmin/</code></strong> y ejercutar <strong><code>agenda_mysql_datos.sql</code></strong> en la pestaรฑa SQL. Tras hacerlo, te debe aparecer la base de datos <strong><code>agenda</code></strong> con la tabla <strong><code>contactos</code></strong> como se muestra en la imagen de ejemplo.</p>
<p>Puedes probar que el API estรก funcionando correctamente, abriendo un navegador y accediendo a la url <strong><code>http://localhost/agenda/</code></strong>. Si todo ha ido bien, deberรญas ver una pรกgina como la siguiente:</p>
<div class="galeria_imagenes">
    <img height="" src="assets/imagenes/tema_5_2/agenda_api.png">
</div>
<div style="page-break-after:always;"></div>
<h2 id="consumo-de-un-servicio-rest-desde-android">Consumo de un Servicio Rest desde Android </h2>
<p>Como ya hemos comentado, existen diferentes librerรญas que nos permitirรญan consumir los servicios desde la App de Android, pero dada su facilidad vamos a utilizar las librerรญas: <strong>Retrofit2</strong> y <strong>Gson</strong>.</p>
<p><strong>Retrofit</strong> la utilizaremos para hacer peticiones http y procesar las respuestas del API Rest, mientras que con <strong>Gson</strong> transformaremos los datos de JSON a los propios que utilice la aplicaciรณn.</p>
<h3 id="configuraciรณn-del-proyecto">Configuraciรณn del proyecto </h3>
<p>Para poder utilizar Retrofit y Gson en nuestro proyecto, deberemos aรฑadir:</p>
<p>En el catรกlogo de versiones <strong><code>lib.versions.toml</code></strong> deberemos comprobar que hemos definido tener:</p>
<pre data-role="codeBlock" data-info="toml" class="language-toml toml"><code><span class="token punctuation">[</span><span class="token table class-name">versions</span><span class="token punctuation">]</span>
<span class="token key property">retorfit</span> <span class="token punctuation">=</span> <span class="token string">"2.11.0"</span>
<span class="token key property">okhttp3</span> <span class="token punctuation">=</span> <span class="token string">"4.12.0"</span>

<span class="token punctuation">[</span><span class="token table class-name">libraries</span><span class="token punctuation">]</span>
<span class="token key property">com-squareup-retrofit2-converter-gson</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.retrofit2"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"converter-gson"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"retorfit"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-retrofit2-retrofit</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.retrofit2"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"retrofit"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"retorfit"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-okhttp-bom</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"okhttp-bom"</span><span class="token punctuation">,</span> <span class="token key property">version.ref</span> <span class="token punctuation">=</span> <span class="token string">"okhttp3"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-okhttp</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"okhttp"</span> 
<span class="token punctuation">}</span>
<span class="token key property">com-squareup-okhttp3-logging-interceptor</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> 
    <span class="token key property">group</span> <span class="token punctuation">=</span> <span class="token string">"com.squareup.okhttp3"</span><span class="token punctuation">,</span> <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"logging-interceptor"</span> 
<span class="token punctuation">}</span>
</code></pre><p>Acuรฉrdate de escribir en una sola lรญnea la definiciรณn de las librerรญas.</p>
<p>En el fichero <strong><code>build.gradle.kts</code></strong> del mรณdulo de la aplicaciรณn:</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code>dependencies <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>retrofit2<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>gson<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>retrofit2<span class="token punctuation">.</span>retrofit<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">platform</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>okhttp<span class="token punctuation">.</span>bom<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>okhttp<span class="token punctuation">)</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span>libs<span class="token punctuation">.</span>com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>interceptor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>En el archivo <strong><code>AndroidManifest.xml</code></strong> deberemos aรฑadir el permiso de acceso a internet para que el servicio pueda acceder al API.</p>
<pre data-role="codeBlock" data-info="xml {highlight=[3-5,9]}" class="language-xml xml" data-line="3-5,9"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_NETWORK_STATE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_WIFI_STATE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Permitir trรกfico http en lugar de https --&gt;</span>
        android:usesCleartextTraffic="true"
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code><div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3-5" data-start="3" data-end="5">


</div></div><div class="line-highlight-wrapper">







<div aria-hidden="true" class="line-highlight" data-range="9" data-start="9">
</div></div></pre><div style="page-break-after:always;"></div>
<h3 id="crear-los-servicios-con-retrofit">Crear los servicios con Retrofit </h3>
<p>En la paquete <strong><code>data</code></strong> crearemos un nuevo paquete llamado <strong><code>data.services</code></strong> donde definiremos los API de cara uno de nuestro '<em>endpoint</em>'.</p>
<h4 id="definiendo-los-tipos-a-serializar-a-json">Definiendo los tipos a serializar a JSON </h4>
<p>Para cada una de las clases que se van a transferir en las peticiones crearemos un fichero <strong><code>&lt;Tipo&gt;Api.kt</code></strong>.</p>
<ol>
<li>
<p>Definiremos la clase <strong><code>ContactoApi</code></strong> que serรก la que se utilizarรก para transferir los datos de los contactos entre el servidor y la aplicaciรณn. Fรญjate que los atributos de la clase tienen que tener el mismo nombre que los campos que se devuelven en el JSON del API Rest. Si quisiรฉramos cambiar el nombre de alguna propiedad, deberemos utilizar la anotaciรณn <strong><code>@SerializedName</code></strong> justo antes de la propiedad para indicar el nombre que tiene en el JSON. Puedes obtener mรกs informaciรณn sobre trasformaciones de en la <strong><a href="https://github.com/google/gson/blob/main/UserGuide.md">documentaciรณn de la librerรญa</a></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4]}" class="language-kotlin kotlin" data-line="4"><code><span class="token comment">// ContactoApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"nombre"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> nombre<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> apellidos<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> telefono<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> email<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> foto<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> categorias<span class="token operator">:</span> String
<span class="token punctuation">)</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre></li>
<li>
<p>La librerรญa de PHP que estamos usando, en la peticiones de tipo <strong>POST</strong>, <strong>PUT</strong> y <strong>DELETE</strong>, nos devuelve una respuesta en JSON con campos de informaciรณn sobre la peticiรณn, por tanto, deberemos definir un objetos para su deserializaciรณn.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token comment">// RespuestaApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaApi</span> <span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> respuesta <span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> metodo<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> mensaje<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlQuery<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> sqlError<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
<span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Por รบltimo, las peticiรณn <strong><a href="http://localhost/agenda/contactos/count">http://localhost/agenda/contactos/count</a></strong> devuelve un nรบmero de contactos en un JSON especial, por lo que deberemos definir un objeto para su deserializaciรณn.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token comment">// TotalRegistrosApi.kt</span>
<span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">TotalRegistrosApi</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tabla"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> tabla<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token annotation builtin">@SerializedName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"total_registros"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> totalRegistros<span class="token operator">:</span> Int
<span class="token punctuation">)</span>
</code></pre></li>
</ol>
<h4 id="definiendo-las-peticiones-para-consumo-del-endpoint">Definiendo las peticiones para consumo del '<em>endpoint</em>' </h4>
<p>Para cada una de las peticiones que se vayan a realizar al API Rest, crearemos una interfaz con el nombre de la clase del API, en nuestro caso <strong><code>ContactoApi</code></strong> y le aรฑadiremos el sufijo <strong><code>Service</code></strong>. Pot tanto, vamos a definir un interface llamado <strong><code>ContactoService</code></strong>.</p>
<p>Definiremos pues la signatura de cada uno delos mรฉtodos que se van a utilizar para realizar las peticiones Para ello utilizaremos diferentes anotaciones para indicar el tipo de peticiรณn, la url del API Rest, el tipo de datos que se envรญa y el tipo de datos que se recibe.</p>
<p>Por ejemplo, para la peticiรณn <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos, deberemos aรฑadir...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><ol>
<li>La anotaciรณn  <strong><code>@GET</code></strong> con la url <strong><code>contactos</code></strong> que completarรญa la URL base al definir el objeto de Retrofit que serรก <strong><code>http://localhost/agenda/</code></strong>.</li>
<li>La anotaciรณn <strong><code>@Headers</code></strong> que incluirรก en la cabecera de la peticiรณn HTTP los valores <strong><code>Accept</code></strong> y <strong><code>Content-Type</code></strong> para indicar que se envรญa y se espera recibir JSON en el <strong>body</strong>.</li>
<li>Por รบltimo, definiremos la signatura del mรฉtodo que serรก de suspensiรณn <strong><code>suspend</code></strong> y devolverรก un objeto de tipo <strong><code>Response</code></strong> que contendrรก una lista de objetos de tipo <strong><code>ContactoApi</code></strong> ya deserializados si la respuesta es correcta.</li>
</ol>
<p>En el caso de que la respuesta en el body no sea un objeto del tipo <strong><code>ContactoApi</code></strong> como el caso de la peticiรณn <strong><code>http://localhost/agenda/contactos/count</code></strong> que devuelve un objeto del tipo <strong><code>TotalRegistrosApi</code></strong>, <strong><code>Response</code></strong> irรก parametrizado con este tipo para la correcta deserializaciรณn.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/count"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>TotalRegistrosApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>Podremos poner tambiรฉn el valor de un parรกmetro en la URL con la anotaciรณn <strong><code>@Path</code></strong>, asรญ como serializar en el '<em>body</em>' de la peticiรณn un objeto con <strong><code>@Body</code></strong>. Por ejemplo, para la peticiรณn <strong><code>@PUT</code></strong> a nuestro Api con PHP tenemos que indicar el <strong>id</strong> del contacto a actualizar <strong><code>http://localhost/agenda/contactos/1</code></strong> y en el cuerpo de la peticiรณn el objeto <strong><code>ContactoApi</code></strong> con los datos a actualizar. Fรญjate ademรกs que la respuesta que parametrizamos en el objeto <strong><code>Response</code></strong> es del tipo <strong><code>RespuestaApi</code></strong> que definimos anteriormente. Nuestro prototipo de mรฉtodo <strong><code>update</code></strong> quedarรญa de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@PUT</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>Tambiรฉn podemos establecer parรกmetros en el <strong>QUERYSTRING</strong> de la URL con la anotaciรณn <strong><code>@Query</code></strong>. Por ejemplo, para la peticiรณn <strong><code>http://localhost/agenda/contactos/id/?desde=3&amp;hasta=5</code></strong> que devuelve un <strong>listado de contactos con id entre 3 y 5</strong>. Nuestro prototipo de mรฉtodo <strong><code>contactosDesdeHasta</code></strong> quedarรญa de la siguiente manera...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/id/"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactosDesdeHasta</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"desde"</span></span><span class="token punctuation">)</span> desde<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"hasta"</span></span><span class="token punctuation">)</span> hasta<span class="token operator">:</span> Int
    <span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</code></pre><p>Con lo visto ya podemos definir el resto de mรฉtodos HTTP que necesitemos para nuestro API Rest. En nuestro caso, nos quedan por definir los siguientes los siguientes ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> ContactoService <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contacto</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@POST</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token annotation builtin">@Body</span> c <span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@DELETE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos/{id}"</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h3 id="preparando-los-objetos-de-retrofit-con-hilt">Preparando los objetos de Retrofit con Hilt </h3>
<p>En el fichero <strong><code>.di/AppModule.kt</code></strong> deberemos definir como crear los objetos a inyectar de Retrofit.</p>
<ol>
<li>
<p>Primero definimos como crear el objeto <strong><code>OkHttpClient</code></strong>, para ello usaremos <strong><code>OkHttpClient.Builder()</code></strong>. En este caso le aรฑadiremos un <strong>interceptor</strong> o ('<em>hook</em>') para poder depurar, a travรฉs de Logcat de Android Studio, el contenido de las peticiones y respuestas HTTP que se realizan. Fรญjate que el nivel de log que le hemos indicado es <strong><code>HEADERS</code></strong>, esto es porque no queremos que se muestre la cabecera sin el cuerpo de la peticiรณn. Ademรกs, le hemos indicado un tiempo de espera ('<em>TIMEOUT</em>') de <strong>10 segundos</strong> para las peticiones despuรฉs de los cuales se cancelarรก la peticiรณn y se producirรก una excepciรณn de tipo <strong><code>SocketTimeoutException</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div style="page-break-after:always;"></div>
</li>
<li>
<p>Ahora definiremos el objeto <strong><code>Retrofit</code></strong>  que es el que usaremos realmente para realizar las peticiones HTTP y procesar las respuestas del API Rest. Al mismo le pasaremos:</p>
<ul>
<li>El objeto <strong><code>OkHttpClient</code></strong> que hemos creado anteriormente y que le llega a travรฉs de la inyecciรณn.</li>
<li>La url base del API Rest, en nuestro caso <strong><code>http://10.0.2.2/agenda/</code></strong>. Fรญjate que la direcciรณn no es <strong><code>localhost</code></strong> o <strong><code>127.0.0.1</code></strong> ya que, cรณmo estamos accediendo desde el dispositivo emulador para รฉl el <strong><code>localhost</code></strong> es el propio dispositivo Android emulado y no el equipo donde estรก el servidor web. AVD (Android Virtual Device) proporciona una direcciรณn IP especial <strong><code>10.0.2.2</code></strong> que nos permite acceder al equipo donde estรก el servidor web.</li>
</ul>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideRetrofit</span><span class="token punctuation">(</span>
    okHttpClient<span class="token operator">:</span> OkHttpClient
<span class="token punctuation">)</span> <span class="token operator">:</span> Retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>okHttpClient<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"http://10.0.2.2/agenda/"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p>Por รบltimo, <strong>indicaremos a Hilt como instanciar el o los objetos de <code>&lt;enpoint&gt;Service</code></strong> que es el que realmente utilizaremos para realizar las peticiones al API Rest. Para ello le pasaremos el objeto <strong><code>Retrofit</code></strong> que hemos creado anteriormente y que le llega a travรฉs de la inyecciรณn. En nuestro caso solo vamos a definir como instanciar un objeto que implemente la interfaz <strong><code>ContactoService</code></strong> que utilizaremos para realizar las peticiones al API Rest de la Agenda que esl รบnico '<em>endpoint</em>' definido.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideContactoService</span><span class="token punctuation">(</span>
    retrofit<span class="token operator">:</span> Retrofit
<span class="token punctuation">)</span> <span class="token operator">:</span> ContactoService <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ContactoService<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<h3 id="implementaciones-de-la-gestiรณn-del-consumo-de-nuestro-endpoint">Implementaciones de la gestiรณn del '<em>consumo</em>' de nuestro endpoint </h3>
<p>Aunque <strong>este paso intermedio no es de todo necesario</strong> y no lo vamos a ver en muchos ejemplos de uso de Retrofit. Si que <strong>es recomendable para gestionar correctamente los errores y los logs de depuraciรณn que se puedan producir</strong> al consumir nuestro API Rest y simplificar el cรณdigo de uso de uso de Retrofit en nuestro patrรณn Repository.</p>
<p>Primero definiremos la clase <strong><code>ApiServicesException</code></strong> que serรก la que utilizaremos para lanzar las excepciones que se produzcan al consumir el API Rest.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensaje<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Exception</span><span class="token punctuation">(</span>mensaje<span class="token punctuation">)</span>
</code></pre><p>Posteriormente, definiremos para ello una clase denominada <strong><code>ContactoServiceImplementation</code></strong> a la que le inyectaremos una instancia de <strong><code>ContactoService</code></strong> que es la que realmente utilizaremos para realizar las peticiones al API Rest.</p>
<p>Veamos la anatomรญa de uso de Retrofit para <strong>obtener la lista de contactos</strong> del API Rest en esta clase comentado paso por paso...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[5,6,11,15-20,24-27,33-36]}" class="language-kotlin kotlin" data-line="5,6,11,15-20,24-27,33-36"><code><span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-class">class</span> ContactoServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Propiedad privada cte. donde definimos el tag para los logs</span>
    <span class="token comment">// de depuraciรณn de las peticiones.</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se han podido obtener los contactos"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Obtenemos la respuesta HTTP Response&lt;List&lt;ContactoApi&gt;&gt;</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contactos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// Si la respuesta tiene un estatus 2xx (200, 201, 202, etc.)</span>
                <span class="token comment">// Obtenemos con response.body los datos List&lt;ContactoApi&gt; </span>
                <span class="token comment">// ya deserializados de JSON contenidos en el cuerpo de la misma.</span>
                <span class="token comment">// Si no hay datos porque el resultado de la serializaciรณn </span>
                <span class="token comment">// es null o el cuerpo estaba vacรญo. Entonces, lanzamos un </span>
                <span class="token comment">// error indicando que no hay datos.</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// sino entonces la respuesta HTTP tiene un estatus de error y por</span>
                <span class="token comment">// tanto obtendrรฉ el mensaje de error del body de la respuesta</span>
                <span class="token comment">// y lanzaremos un error genรฉrico, enviando al al mismo tiempo el</span>
                <span class="token comment">// mensaje generado al Log.</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Si ha habido algรบn error al deserializar el JSON</span>
            <span class="token comment">// o tambiรฉn si ha habido algรบn error al realizar la peticiรณn por</span>
            <span class="token comment">// ejemplo por falta de conexiรณn a internet, o se ha </span>
            <span class="token comment">// producido un TIMEOUT, etc.</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... resto de la implementaciรณn de las llamadas al Servicio Rest</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5" data-start="5">
</div></div><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div><div class="line-highlight-wrapper">









<div aria-hidden="true" class="line-highlight" data-range="11" data-start="11">
</div></div><div class="line-highlight-wrapper">













<div aria-hidden="true" class="line-highlight" data-range="15-20" data-start="15" data-end="20">





</div></div><div class="line-highlight-wrapper">






















<div aria-hidden="true" class="line-highlight" data-range="24-27" data-start="24" data-end="27">



</div></div><div class="line-highlight-wrapper">































<div aria-hidden="true" class="line-highlight" data-range="33-36" data-start="33" data-end="36">



</div></div></pre><p>Siguiendo el esquema anterior, <strong>obtener un contacto por ID</strong> quedarรญa...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,8]}" class="language-kotlin kotlin" data-line="4,8"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> ContactoApi <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se han podido obtener el contacto con id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">id</span></span><span class="token string">"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">contacto</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">






<div aria-hidden="true" class="line-highlight" data-range="8" data-start="8">
</div></div></pre><p>Para <strong>insertar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4,7-9]}" class="language-kotlin kotlin" data-line="4,7-9"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"No se ha podido aรฑadir el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// Aquรญ response.body() es un objeto de tipo RespuestaApi </span>
            <span class="token comment">// que simplemente logeamos si no es null.</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">





<div aria-hidden="true" class="line-highlight" data-range="7-9" data-start="7" data-end="9">


</div></div></pre><p>Para <strong>actualizar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4-6]}" class="language-kotlin kotlin" data-line="4-6"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> ContactoApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se ha podido actualizar el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// En este mรฉtodo el API de PHP espera recibir el id del contacto</span>
        <span class="token comment">// que tambiรฉn lo podemos obtener del objeto contacto que le pasamos</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span>id<span class="token punctuation">,</span> contacto<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4-6" data-start="4" data-end="6">


</div></div></pre><p>Para <strong>borrar un contacto</strong> en el API Rest tendremos ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"No se ha podido borrar el contacto"</span></span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"No hay respuesta"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h3 id="usando-nuestra-implementaciรณn-del-servicio-en-el-patrรณn-repository">Usando nuestra implementaciรณn del servicio en el patrรณn Repository </h3>
<p>Al igual que sucedรญa con las anteriores fuentes como los objetos Mock de prueba o las entidades de room. Deberemos definir en <strong><code>RepositoryConverters.kt</code></strong> las funciones de extensiรณn para convertir los objetos de tipo <strong><code>ContactoApi</code></strong> en objetos de tipo <strong><code>Contacto</code></strong> y viceversa.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-fun">fun</span> Contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ContactoApi</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword keyword-fun">fun</span> ContactoApi<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Contacto</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre><p>Por รบltimo, en el fichero <strong><code>ContactoRepository.kt</code></strong> deberemos inyectar la implementaciรณn de nuestro servicio <strong><code>ContactoServiceImplementation</code></strong> y utilizarlo en las funciones de nuestro patrรณn Repository.</p>
<div class="admonition tip">
<p class="admonition-title">Impoatante</p>
<p>Cualquier error que se produzca ya lo resolveremos en el <strong>ViewModel</strong> como sucedรญa con <strong>room</strong>.</p>
</div>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> ContactoRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> contactoService<span class="token operator">:</span> ContactoServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Contacto<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Contacto <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContacto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token operator">:</span> Contacto<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>contacto<span class="token punctuation">.</span><span class="token function">toContactoApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contactoService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div style="page-break-after:always;"></div>
<h4 id="acceder-a-la-api-iniciando-una-sesiรณn-en-el-servidor">Acceder a la API iniciando una sesiรณn en el servidor </h4>
<p>Si queremos incrementar la seguridad del acceso a nuestra APIRest, podemos <strong>iniciar una sesiรณn en el servidor</strong> con determinadas credenciales. Tran enviar la peticiรณn de '<em>login</em>', capturaremos la '<em>cookie</em>' que nos devuelve con el id de la sesiรณn y usaremos esta misma cookie para poder acceder al resto de funcionalidades del APIRest. Para habilitar la autenticaciรณn a traves del uso de sesiones en nuestro APIRest con PHP, volveremos a editar el archivo <strong><code>apirest_variables.php</code></strong> y descomentaremos las siguientes lรญneas donde definimos los usuarios y sus contraseรฑas.</p>
<pre data-role="codeBlock" data-info="php {highlight=6-8}" class="language-php php" data-line="6-8"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token operator">...</span>

    <span class="token comment">// ACCESO USUARIOS (si estรก vacรญo funciona sin usuarios)</span>
    <span class="token variable">$usuarios</span> <span class="token operator">=</span> <span class="token keyword keyword-array">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"juanjo"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis1"</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"xusa"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis2"</span><span class="token punctuation">;</span>
    <span class="token variable">$usuarios</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pepe"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string double-quoted-string">"_IesBalmis3"</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>    
</span></code><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div></pre><p>Tras ello, entremos donde entremos a nuestro API en <strong><code>http://localhost/agenda/</code></strong> nos pedirรก que iniciemos sesiรณn con un usuario y contraseรฑa indicรกndonos como debemos hacerlo con la siguiente pantalla...</p>
<div class="galeria_imagenes">
    <img height="350" src="assets/imagenes/tema_5_2/agenda_api_sesion.png">
</div>
<div style="page-break-after:always;"></div>
<p>Si nos fijamos en la ayuda para autenticarnos necesitamos enviar una peticiรณn <strong><code>GET</code></strong> a la url <strong><code>http://localhost/agenda/?usu=&lt;usuario&gt;&amp;pass=&lt;password&gt;</code></strong>. Por tanto, deberemos definir un nuevo servicio en nuestro APIRest llamado <strong><code>AutenticacionService</code></strong> en el paquete <strong><code>.data.services.autenticacion</code></strong> que nos permita realizar esta peticiรณn y la de cerrar la sesiรณn como mรญnimo.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-interface">interface</span> AutenticacionService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"."</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"usu"</span></span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"pass"</span></span><span class="token punctuation">)</span> password <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"."</span></span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"logout"</span></span><span class="token punctuation">)</span> usuario <span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>RespuestaAutenticacionApi<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><p>En ambos casos la respuesta del APIRest serรก un objeto del tipo <strong><code>RespuestaAutenticacionApi</code></strong> que definiremos como...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">RespuestaAutenticacionApi</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> mensaje <span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> usuario <span class="token operator">:</span> String
<span class="token punctuation">)</span>
</code></pre><p>y que nos devolverรก un mensaje de error o de รฉxito y el usuario que ha iniciado la sesiรณn o null si no se ha podido iniciar la sesiรณn.</p>
<p>A la hora de realizar la implementaciรณn de este servicio de <strong>login</strong>...</p>
<pre data-role="codeBlock" data-info="txt  {highlight=1}" class="language-txt txt" data-line="1"><code>--&gt; GET http://10.0.2.2/agenda/?usu=juanjo&amp;pass=_IesBalmis1
Accept: application/json
Content-Type: application/json
--&gt; END GET
</code><div class="line-highlight-wrapper"><div aria-hidden="true" class="line-highlight" data-range="1" data-start="1">
</div></div></pre><p>deberemos tener en cuenta que en la cabecera de la respuesta del APIRest <strong>se nos devuelve una cookie con el id de la sesiรณn que deberemos almacenar</strong> del algรบn modo para poder acceder al resto de funcionalidades del APIRest. En nuestro caso el valor de esa cookie se encuentra en la cabecera <strong><code>Set-Cookie</code></strong> y es <strong><code>PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o</code></strong>. Sin tener en cuenta que podrรญan llegar otras cookies en en esta misma cabecera.</p>
<pre data-role="codeBlock" data-info="txt {highlight=[5-6]}" class="language-txt txt" data-line="5-6"><code>&lt;-- 200 OK http://10.0.2.2/agenda/?usu=juanjo&amp;pass=_IesBalmis1 (18ms)
Date: ...
Server: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.2.4
X-Powered-By: PHP/8.2.4
Set-Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
Expires: Fecha de expiraciรณn de la Cookie
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 59
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/json; charset=utf-8
&lt;-- END HTTP
</code><div class="line-highlight-wrapper">



<div aria-hidden="true" class="line-highlight" data-range="5-6" data-start="5" data-end="6">

</div></div></pre><p>Para ello, podemos definir <strong>una propiedad estรกtica pรบblica</strong> en la clase <strong><code>AutenticacionServiceImplementation</code></strong> que almacenarรก la cookie de la sesiรณn.</p>
<pre data-role="codeBlock" data-info="kotlin { highlight=[6-8, 22] }" class="language-kotlin kotlin" data-line="6-8,22"><code><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>

    <span class="token keyword keyword-companion">companion</span> <span class="token keyword keyword-object">object</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> cookie<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al loguear a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">userName</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                cookie <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6-8" data-start="6" data-end="8">


</div></div><div class="line-highlight-wrapper">




















<div aria-hidden="true" class="line-highlight" data-range="22" data-start="22">
</div></div></pre><div style="page-break-after:always;"></div>
<p>Esta cookie la utilizaremos en el resto de peticiones que realicemos al APIRest. Para ello, deberemos aรฑadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la peticiรณn <strong><code>http://localhost/agenda/contactos</code></strong> que devuelve un listado de contactos la peticiรณn HTTP deberรญa ser...</p>
<pre data-role="codeBlock" data-info="txt {highlight=4}" class="language-txt txt" data-line="4"><code>--&gt; GET http://10.0.2.2/agenda/contactos
Accept: application/json
Content-Type: application/json
Cookie: PHPSESSID=obqu9co5rqhgdocspnqs4nlv5o; path=/
--&gt; END GET
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre><p>Para ello, deberรญamos modificar la interfaz <strong><code>ContactoService</code></strong> y aรฑadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest. Por ejemplo, para la peticiรณn GET a esa ruta serรก ...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"contactos"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Accept: application/json"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Content-Type: application/json"</span></span><span class="token punctuation">)</span>
<span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">contactos</span><span class="token punctuation">(</span><span class="token annotation builtin">@Header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Cookie"</span></span><span class="token punctuation">)</span> cookie <span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Response<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>ContactoApi<span class="token operator">&gt;</span><span class="token operator">&gt;</span>
</code></pre><p>Fรญjate que hemos aรฑadido la anotaciรณn <strong><code>@Header</code></strong> para indicar que el valor de la cabecera <strong><code>Cookie</code></strong> se obtendrรก del parรกmetro <strong><code>cookie</code></strong> que le pasamos al mรฉtodo y por tanto deberemos aรฑadirlo en la llamada al mรฉtodo que hacรญamos desde el <strong><code>ContactoServiceImplementation</code></strong>.</p>
<p>El problema de esto es que, como hemos mencionado, <strong>deberemos hacer lo mismo en todas las peticiones de todos servicios a '<em>endpoints</em>' que hayamos definido</strong> y pasarlo en todas las llamadas a los mรฉtodos de los servicios en las implementaciones de los mismos.</p>
<p>Para evitar hacer esto, podemos definir un <strong>interceptor</strong> o ('<em><strong>hook</strong></em>') que se ejecutarรก antes de realizar la peticiรณn y que aรฑadirรก la cabecera <strong><code>Cookie</code></strong> a la peticiรณn. Para ello, podemos seguir los siguientes pasos:</p>
<ol>
<li>
<p>En el paquete <strong><code>services</code></strong> vamos a crear un nuevo paquete llamado <strong><code>services.interceptors</code></strong> donde definiremos el interceptor que se encargarรก de guardar la cookie de la sesiรณn y el de aรฑadirla a las peticiones que se realicen al APIRest.</p>
</li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada AlmacenDeCookies guardarรก en un <strong><code>HashSet</code></strong> las cookies que se vayan recibiendo en las respuestas del APIRest. Hilts nos permitirรก inyectar un objeto รบnico esta clase en los interceptores que definamos.</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-class">class</span> AlmacenDeCookies <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">?</span>  <span class="token operator">=</span> cookies
    <span class="token keyword keyword-fun">fun</span> <span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token operator">:</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>cookies <span class="token operator">=</span> cookies
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>ReciveCookiesInterceptor</code></strong> que implementarรก el interfaz <strong><code>Interceptor</code></strong> y se encargarรก de <strong>preprocesar cualquier respuesta del servidor y guardar las cookies recibidas</strong> en la cabecera <strong><code>Set-Cookie</code></strong>, incluida la de la sesiรณn, en el objeto <strong><code>AlmacenDeCookies</code></strong> invalidando el mรฉtodo <strong><code>intercept</code></strong>.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin kotlin" data-line=""><code><span class="token keyword keyword-class">class</span> <span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Procesamos la respuesta actual            </span>
        <span class="token keyword keyword-val">val</span> originalResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// Extraemos de ella las cookies de la cabecera Set-Cookie</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> HashSet<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>header <span class="token keyword keyword-in">in</span> originalResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Set-Cookie"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cookies<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            almacenDeCookies<span class="token punctuation">.</span><span class="token function">setCookies</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Devolvemos la respuesta original</span>
        <span class="token keyword keyword-return">return</span> originalResponse
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="4">
<li>
<p>En el paquete <strong><code>services.interceptors</code></strong> definiremos una clase llamada <strong><code>EnviaCookiesInterceptor</code></strong> que implementarรก el interfaz <strong><code>Interceptor</code></strong> y se encargarรก de <strong>preprocesar cualquier peticiรณn al servidor y aรฑaรฑdir las cookies guardadas</strong> en el objeto <strong><code>AlmacenDeCookies</code></strong> a la cabecera <strong><code>Cookie</code></strong> de la peticiรณn, incluida la de la sesiรณn.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[]}" class="language-kotlin kotlin" data-line=""><code><span class="token keyword keyword-class">class</span> <span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>
    <span class="token comment">// Inyectamos el objeto AlmacenDeCookies</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{</span>
        <span class="token comment">// Builder con el contenido de la peticion original</span>
        <span class="token keyword keyword-val">val</span> builder <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> cookies <span class="token operator">=</span> almacenDeCookies<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>cookie <span class="token keyword keyword-in">in</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Aรฑadimos las cookies a la cabecera Cookie de la </span>
                <span class="token comment">// peticion en el builder</span>
                builder<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Cookie"</span></span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Procesamos la peticion con las cookies aรฑadidas</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<div style="page-break-after:always;"></div>
<ol start="5">
<li>
<p>Redefinimos <strong><code>provideOkHttpClient</code></strong> inyectando el objeto <strong><code>AlmacenDeCookies</code></strong> y aรฑadiendo los interceptores que hemos definido en el builder de nuestro cliente.</p>
<pre data-role="codeBlock" data-info="kotlin {highlight=[4, 11-15]}" class="language-kotlin kotlin" data-line="4,11-15"><code><span class="token annotation builtin">@Provides</span>
<span class="token annotation builtin">@Singleton</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">provideOkHttpClient</span><span class="token punctuation">(</span>
    almacenDeCookies<span class="token operator">:</span> AlmacenDeCookies
<span class="token punctuation">)</span> <span class="token operator">:</span> OkHttpClient <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> loggingInterceptor <span class="token operator">=</span> <span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    loggingInterceptor<span class="token punctuation">.</span>level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>HEADERS

    <span class="token keyword keyword-val">val</span> timeout <span class="token operator">=</span> <span class="token number">10L</span>
    <span class="token keyword keyword-return">return</span> OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">EnviaCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">ReciveCookiesInterceptor</span><span class="token punctuation">(</span>almacenDeCookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// El orden de los interceptores es importante si</span>
        <span class="token comment">// quiero ver la informaciรณn de las cookies en el log.</span>
        <span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loggingInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div><div class="line-highlight-wrapper">









<div aria-hidden="true" class="line-highlight" data-range="11-15" data-start="11" data-end="15">




</div></div></pre></li>
</ol>
<p>Tras esto <strong><code>.data/services/autenticacion/AutenticacionService.kt</code></strong> quedarรก iguรกl que antes, pero su implementaciรณn en <strong><code>.data/services/autenticacion/AutenticacionServiceImplementation.kt</code></strong> ya no necesitarรก quedarse con la cookie de la sesiรณn...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> AutenticacionServiceImplementation <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionService
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> logTag<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"OkHttp"</span></span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName <span class="token operator">:</span> String<span class="token punctuation">,</span>
        password <span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al loguear a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">userName</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
                usuario <span class="token operator">=</span> userName<span class="token punctuation">,</span>
                password <span class="token operator">=</span> password
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RespuestaAutenticacionApi <span class="token punctuation">{</span>
        <span class="token keyword keyword-val">val</span> mensajeError <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Error al cerrar sesiรณn"</span></span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-val">val</span> response <span class="token operator">=</span> autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>isSuccessful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-val">val</span> dato <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> dato <span class="token operator">?:</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"No hay datos"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">errorBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">mensajeError</span></span><span class="token string"> (cรณdigo </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword keyword-this">this</span></span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">body</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>logTag<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>localizedMessage</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token function">ApiServicesException</span><span class="token punctuation">(</span>mensajeError<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Ademรกs, tras hacer login, ya podremos seguir usรกndo nuestro APIRest como lo hacรญamos anteriormente  pero sin tener que aรฑadir la cabecera <strong><code>Cookie</code></strong> en las peticiones que realicemos al APIRest.</p>
<p>Una posible implementaciรณn de <strong><code>./data/AutenticacionRepository.kt</code></strong> que use la implementaciรณn de nuestro servicio podrรญa ser...</p>
<pre data-role="codeBlock" data-info="kotlin" class="language-kotlin kotlin"><code><span class="token keyword keyword-class">class</span> AutenticacionRepository <span class="token annotation builtin">@Inject</span> <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> autenticacionService<span class="token operator">:</span> AutenticacionServiceImplementation
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">login</span><span class="token punctuation">(</span>
        userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
        password<span class="token operator">:</span> String
    <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>
            userName <span class="token operator">=</span> userName<span class="token punctuation">,</span>
            password <span class="token operator">=</span> password
        <span class="token punctuation">)</span><span class="token punctuation">.</span>usuario<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autenticacionService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="admonition info">
<p class="admonition-title">Cรณdigo de los ejemplos</p>
<p>En el siguiente enlace puedes deacargar un proyecto ejemplo con la implementaciรณn que acabamos de describir del uso de APIRest en PHP para autenticarnos con la agenda. Para ello, le hemos aรฑadido una pantalla mรกs donde realizar dicha autenticaciรณn: <strong><a href="0_AgendaRetrofit_son_sesiones_recurso.zip">Proyecto ejemplo</a></strong></p>
</div>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>